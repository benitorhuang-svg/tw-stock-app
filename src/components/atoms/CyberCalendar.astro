---
/**
 * CyberCalendar.astro (Atomic Design Version)
 * Re-architected to solve Astro scoping issues by using Tailwind utility classes
 * for dynamically generated elements.
 */
interface Props {
    id?: string;
    value?: string;
    class?: string;
}

const { id = 'cyber-calendar', value = '', class: className = '' } = Astro.props;
---

<div class={`relative cyber-calendar-wrapper group ${className}`} id={`${id}-wrapper`}>
    <!-- Atom: Trigger Module -->
    <div
        id={`${id}-trigger`}
        class="relative w-full flex items-center gap-3 px-4 py-2.5 bg-surface/60 hover:bg-accent/10 border border-border/40 hover:border-accent/50 rounded-xl transition-all duration-300 cursor-pointer overflow-hidden group/btn z-10 shadow-sm"
        role="button"
        tabindex="0"
    >
        <!-- Decorative Grid -->
        <div
            class="absolute inset-0 opacity-[0.05] pointer-events-none bg-[linear-gradient(rgba(59,130,246,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(59,130,246,0.1)_1px,transparent_1px)] bg-[size:4px_4px]"
        >
        </div>

        <!-- Status Node -->
        <div
            class="relative flex flex-col items-center justify-center w-8 h-8 rounded-lg bg-base-deep/80 border border-accent/20 transition-all duration-500 group-hover/btn:border-accent/50"
        >
            <span class="text-[9px] font-black text-accent tracking-tighter">DAT</span>
            <div class="absolute -top-[1px] left-1.5 right-1.5 h-[2px] bg-accent/40 rounded-full">
            </div>
            <div
                class="absolute -bottom-0.5 -right-0.5 w-1.5 h-1.5 bg-accent rounded-full animate-pulse blur-[1px]"
            >
            </div>
        </div>

        <!-- Label Area -->
        <div class="flex flex-col items-start select-none">
            <span class="text-[9px] font-black text-accent/60 uppercase tracking-[0.25em]"
                >Registry</span
            >
            <span class="text-sm font-mono font-bold text-white tracking-tight" id={`${id}-label`}
                >{value}</span
            >
        </div>

        <div class="ml-auto text-accent/30 group-hover/btn:text-accent transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M19 9l-7 7-7-7"></path></svg
            >
        </div>
    </div>

    <!-- State Storage -->
    <input type="date" id={id} value={value} class="hidden" />

    <!-- Popover Molecule -->
    <div
        id={`${id}-popover`}
        class="hidden absolute top-full left-0 mt-3 z-[200] w-72 bg-[#0d1117] border border-accent/30 rounded-2xl shadow-[0_30px_60px_rgba(0,0,0,0.8),0_0_0_1px_rgba(59,130,246,0.1)] overflow-hidden animate-pop-in origin-top"
    >
        <!-- Header Section -->
        <div class="p-4 bg-surface/40 border-b border-border/20 flex items-center justify-between">
            <button
                type="button"
                class="nav-prev p-1.5 hover:bg-accent/10 rounded-lg text-accent transition-all"
                >◀</button
            >
            <span class="month-year font-mono font-black text-white text-base tracking-[0.1em]"
            ></span>
            <button
                type="button"
                class="nav-next p-1.5 hover:bg-accent/10 rounded-lg text-accent transition-all"
                >▶</button
            >
        </div>

        <!-- Grid System -->
        <div class="p-3">
            <div class="grid grid-cols-7 mb-2 opacity-40">
                {
                    ['日', '一', '二', '三', '四', '五', '六'].map(d => (
                        <div class="text-center text-[10px] font-black text-text-muted">{d}</div>
                    ))
                }
            </div>
            <div id={`${id}-days`} class="grid grid-cols-7 gap-1">
                <!-- Days will be injected as styled Atoms via JS -->
            </div>
        </div>

        <!-- Footer Module -->
        <div class="p-3 bg-accent/5 border-t border-accent/10 flex justify-center">
            <button
                type="button"
                class="today-btn px-10 py-2 rounded-xl bg-[#3b82f6] text-[11px] font-black text-white uppercase tracking-widest hover:bg-[#2563eb] active:scale-95 transition-all shadow-[0_4px_15px_rgba(59,130,246,0.4)]"
            >
                Synchronize Today
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes pop-in {
        from {
            opacity: 0;
            transform: translateY(-8px) scale(0.98);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .animate-pop-in {
        animation: pop-in 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>

<script is:inline define:vars={{ id, initialValue: value }}>
    (function () {
        const wrapper = document.getElementById(`${id}-wrapper`);
        const trigger = document.getElementById(`${id}-trigger`);
        const popover = document.getElementById(`${id}-popover`);
        const input = document.getElementById(id);
        const label = document.getElementById(`${id}-label`);
        const daysGrid = document.getElementById(`${id}-days`);
        const monthYearTxt = popover.querySelector('.month-year');

        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d || 1);
        }

        let currentDate = parseDate(initialValue);
        let displayMonth = currentDate.getMonth();
        let displayYear = currentDate.getFullYear();

        /**
         * Atomic CSS Generator
         * Bypasses Astro scoping by using global Tailwind utility classes
         */
        function createDayNode(content, type = 'normal') {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = content;

            // Base Atomic Classes
            let classes =
                'aspect-square flex items-center justify-center text-[13px] font-mono font-bold rounded-lg transition-all duration-200 border-2 border-transparent ';

            if (type === 'other') {
                classes += 'opacity-10 cursor-default pointer-events-none';
            } else {
                classes += 'cursor-pointer ';

                // State: Selected
                if (type === 'selected') {
                    classes +=
                        'bg-accent text-white border-accent shadow-[0_0_15px_rgba(59,130,246,0.5)] scale-[1.05] z-10 ';
                }
                // State: Today
                else if (type === 'today') {
                    classes += 'bg-accent/10 text-accent border-accent/40 ';
                }
                // State: Normal
                else {
                    classes +=
                        'text-slate-400 bg-white/5 hover:bg-accent/20 hover:text-white hover:scale-110 hover:border-accent/30 ';
                }
            }

            btn.className = classes;
            return btn;
        }

        function renderCalendar() {
            daysGrid.innerHTML = '';
            monthYearTxt.textContent = `${displayYear} / ${String(displayMonth + 1).padStart(2, '0')}`;

            const firstDay = new Date(displayYear, displayMonth, 1).getDay();
            const daysInMonth = new Date(displayYear, displayMonth + 1, 0).getDate();
            const prevMonthDays = new Date(displayYear, displayMonth, 0).getDate();

            const today = new Date();
            const isMatch = (d, m, y, date) =>
                d === date.getDate() && m === date.getMonth() && y === date.getFullYear();

            // Prev month
            for (let i = firstDay - 1; i >= 0; i--) {
                daysGrid.appendChild(createDayNode(prevMonthDays - i, 'other'));
            }

            // Current month
            for (let i = 1; i <= daysInMonth; i++) {
                let state = 'normal';
                if (isMatch(i, displayMonth, displayYear, currentDate)) state = 'selected';
                else if (isMatch(i, displayMonth, displayYear, today)) state = 'today';

                const day = createDayNode(i, state);
                day.addEventListener('click', e => {
                    e.stopPropagation();
                    const selected = new Date(displayYear, displayMonth, i);
                    const formatted = `${selected.getFullYear()}-${String(selected.getMonth() + 1).padStart(2, '0')}-${String(selected.getDate()).padStart(2, '0')}`;

                    input.value = formatted;
                    label.textContent = formatted;
                    currentDate = selected;

                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    popover.classList.add('hidden');
                    renderCalendar();
                });
                daysGrid.appendChild(day);
            }
        }

        trigger.addEventListener('click', e => {
            e.stopPropagation();
            popover.classList.toggle('hidden');
            if (!popover.classList.contains('hidden')) {
                renderCalendar();
                const rect = popover.getBoundingClientRect();
                if (rect.right > window.innerWidth)
                    ((popover.style.left = 'auto'), (popover.style.right = '0'));
                if (rect.left < 0) ((popover.style.left = '0'), (popover.style.right = 'auto'));
            }
        });

        popover.querySelector('.nav-prev').addEventListener('click', e => {
            e.stopPropagation();
            displayMonth--;
            if (displayMonth < 0) {
                displayMonth = 11;
                displayYear--;
            }
            renderCalendar();
        });

        popover.querySelector('.nav-next').addEventListener('click', e => {
            e.stopPropagation();
            displayMonth++;
            if (displayMonth > 11) {
                displayMonth = 0;
                displayYear++;
            }
            renderCalendar();
        });

        popover.querySelector('.today-btn').addEventListener('click', e => {
            e.stopPropagation();
            const now = new Date();
            const formatted = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            input.value = formatted;
            label.textContent = formatted;
            currentDate = now;
            displayMonth = now.getMonth();
            displayYear = now.getFullYear();
            input.dispatchEvent(new Event('change', { bubbles: true }));
            renderCalendar();
            setTimeout(() => popover.classList.add('hidden'), 150);
        });

        document.addEventListener('click', e => {
            if (!wrapper.contains(e.target)) popover.classList.add('hidden');
        });

        renderCalendar();
    })();
</script>
