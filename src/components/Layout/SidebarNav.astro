---
/**
 * å°ˆæ¥­é‡‘èé¢¨æ ¼å´é‚Šå°èˆªæ¬„ - å…¨æ•´åˆç‰ˆ (åŒ…å«é€šçŸ¥æ­·å²èˆ‡å·¥å…·ç¾¤çµ„)
 */

const navItems = [
    { label: 'å€‹è‚¡åˆ†æ', icon: 'ğŸ“Š', href: '/stocks' },
    { label: 'æ™ºèƒ½ç¯©é¸', icon: 'ğŸ”', href: '/filter' },
    { label: 'ç­–ç•¥ä¸­å¿ƒ', icon: 'ğŸ¯', href: '/strategies' },
    { label: 'è‚¡åˆ©æŸ¥è©¢', icon: 'ğŸ’°', href: '/dividends' },
    { label: 'è‡ªé¸è‚¡', icon: 'â­', href: '/watchlist' },
    { label: 'æŠ•è³‡çµ„åˆ', icon: 'ğŸ’¼', href: '/portfolio' },
];

const bottomItems = [{ label: 'ç”¨æˆ¶é¸å–®', icon: 'ğŸ‘¤', href: '/settings' }];
---

<nav class="sidebar-nav" id="sidebar-nav">
    <!-- Utility Cluster (Top) -->
    <div class="sidebar-utilities">
        <!-- Row 1: Theme & Time -->
        <div class="utility-row">
            <button
                class="action-btn theme-toggle-btn"
                id="sidebar-theme-toggle"
                title="åˆ‡æ›äº®/æš—æ¨¡å¼"
            >
                <span class="theme-icon">ğŸŒ™</span>
            </button>
            <div class="status-container" id="sidebar-status">
                <span class="status-dot"></span>
                <span class="status-text">--:--</span>
            </div>
        </div>

        <!-- Row 2: Notifications & Search -->
        <div class="utility-row">
            <button class="action-btn" id="sidebar-notifications-btn" title="ç³»çµ±é€šçŸ¥">
                ğŸ””
                <span class="badge" id="sidebar-notification-badge">3</span>
            </button>
            <div class="search-input-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="sidebar-search-input" placeholder="æœå°‹è‚¡ç¥¨..." />
            </div>
        </div>

        <hr class="sidebar-divider" />
    </div>

    <!-- Notification History Panel (Hidden by default) -->
    <div class="notifications-panel" id="notifications-panel">
        <div class="panel-header">
            <span class="panel-title">é€šçŸ¥æ­·å²</span>
            <button class="clear-all-btn" id="clear-notifications" title="æ¸…é™¤å…¨éƒ¨">ğŸ§¹</button>
        </div>
        <div class="panel-body" id="notifications-list">
            <!-- Items injected by script -->
        </div>
    </div>

    <!-- Logo Section - Below Divider -->
    <div class="nav-header">
        <a href="/" class="logo">
            <span class="logo-icon">ğŸ“ˆ</span>
            <span class="logo-text">TW Stock</span>
        </a>
    </div>

    <!-- Main Navigation -->
    <div class="nav-items">
        {
            navItems.map(item => (
                <a href={item.href} class="nav-item">
                    <span class="item-icon">{item.icon}</span>
                    <span class="item-label">{item.label}</span>
                </a>
            ))
        }
    </div>

    <!-- User Menu (Bottom) -->
    <div class="nav-bottom">
        {
            bottomItems.map(item => (
                <a href={item.href} class="nav-item">
                    <span class="item-icon">{item.icon}</span>
                    <span class="item-label">{item.label}</span>
                </a>
            ))
        }
    </div>
</nav>

<style>
    .sidebar-nav {
        width: 70px;
        height: 100vh;
        background: var(--c-bg-glass);
        backdrop-filter: var(--glass-blur);
        border-right: 1px solid var(--c-border);
        display: flex;
        flex-direction: column;
        padding: 12px;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 100;
        transition:
            width 0.35s cubic-bezier(0.16, 1, 0.3, 1),
            box-shadow 0.3s;
        overflow: visible; /* To allow notifications panel to overflow relative to internal containers */
    }

    .sidebar-nav:hover {
        width: 240px;
        box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
    }

    /* Utilities Cluster */
    .sidebar-utilities {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 8px;
    }

    .utility-row {
        display: flex;
        align-items: center;
        gap: 8px;
        height: 36px;
        overflow: hidden;
        width: 100%;
    }

    .action-btn {
        width: 46px;
        min-width: 46px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--c-border);
        color: var(--c-text-primary);
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .action-btn:hover {
        background: rgba(var(--c-accent-rgb), 0.1);
        border-color: var(--c-accent);
        color: var(--c-accent);
    }

    .badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--c-danger);
        color: white;
        font-size: 8px;
        font-weight: 800;
        padding: 1px 4px;
        border-radius: 10px;
        min-width: 14px;
        text-align: center;
    }

    .status-container {
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
    }

    .sidebar-nav:hover .status-container {
        opacity: 1;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: var(--c-success);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--c-success);
    }

    .status-text {
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        color: var(--c-text-muted);
    }

    /* Search Input Box */
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        height: 32px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        width: 100%;
        min-width: 46px;
        overflow: hidden;
    }

    .search-icon {
        min-width: 46px;
        display: flex;
        justify-content: center;
        font-size: 14px;
        color: var(--c-text-muted);
    }

    #sidebar-search-input {
        background: transparent;
        border: none;
        color: var(--c-text-primary);
        font-size: 12px;
        outline: none;
        width: 100%;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .sidebar-nav:hover #sidebar-search-input {
        opacity: 1;
    }

    .sidebar-divider {
        border: none;
        border-top: 1px solid var(--c-border);
        margin: 4px 0;
        width: 100%;
    }

    /* Notifications Panel */
    .notifications-panel {
        position: absolute;
        top: 60px;
        left: 250px;
        width: 280px;
        background: var(--c-bg-glass-heavy);
        backdrop-filter: var(--glass-blur);
        border: 1px solid var(--c-border);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        display: none;
        flex-direction: column;
        z-index: 1000;
        animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .notifications-panel.visible {
        display: flex;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .panel-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--c-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--c-text-primary);
    }

    .clear-all-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .clear-all-btn:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .panel-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 8px 0;
    }

    .panel-body::-webkit-scrollbar {
        width: 4px;
    }

    .panel-body::-webkit-scrollbar-thumb {
        background: var(--c-border);
        border-radius: 10px;
    }

    /* Logo Section */
    .nav-header {
        display: flex;
        align-items: center;
        margin: 12px 0 20px 0;
        height: 40px;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--c-text-primary);
        font-weight: 800;
        text-decoration: none;
        font-size: 16px;
    }

    .logo-icon {
        font-size: 20px;
        min-width: 46px;
        display: flex;
        justify-content: center;
    }

    .logo-text,
    .item-label {
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
    }

    .sidebar-nav:hover .logo-text,
    .sidebar-nav:hover .item-label {
        opacity: 1;
    }

    /* Nav Items */
    .nav-items {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        color: var(--c-text-secondary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        height: 48px;
    }

    .nav-item:hover {
        background: rgba(var(--c-accent-rgb), 0.1);
        color: var(--c-text-primary);
    }

    .nav-item.active {
        background: rgba(var(--c-accent-rgb), 0.15);
        color: var(--c-accent);
        font-weight: 700;
    }

    .item-icon {
        font-size: 18px;
        min-width: 46px;
        display: flex;
        justify-content: center;
    }

    .nav-bottom {
        border-top: 1px solid var(--c-border);
        padding-top: 12px;
    }

    /* Global item style for small screens hack */
    .sidebar-nav:not(:hover) .nav-item {
        padding: 12px 0;
    }
</style>

<script>
    import { toast } from '../../lib/toast';

    const sidebarNav = document.getElementById('sidebar-nav');
    const updateText = sidebarNav?.querySelector('.status-text');
    const themeBtn = document.getElementById('sidebar-theme-toggle');
    const themeIcon = themeBtn?.querySelector('.theme-icon');
    const notifyBtn = document.getElementById('sidebar-notifications-btn');
    const notifyPanel = document.getElementById('notifications-panel');
    const notifyList = document.getElementById('notifications-list');
    const badge = document.getElementById('sidebar-notification-badge');
    const clearBtn = document.getElementById('clear-notifications');

    // 1. Theme Logic
    function setTheme(theme: string) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('tw-stock-theme', theme);
        if (themeIcon) {
            themeIcon.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
    }

    themeBtn?.addEventListener('click', e => {
        e.stopPropagation();
        const nextStyle =
            document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        setTheme(nextStyle);
        toast.info(`å·²åˆ‡æ›è‡³ ${nextStyle === 'dark' ? 'æ·±è‰²' : 'äº®è‰²'} æ¨¡å¼`);
    });

    // 2. Data Status Time
    function refreshTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        if (updateText) updateText.textContent = timeStr;
    }
    refreshTime();
    setInterval(refreshTime, 60000);

    // 3. Notifications Logic
    let notifications = [
        { id: Date.now() + 1, text: 'ğŸš€ æ•¸æ“šæ›´æ–°æˆåŠŸï¼šå°è‚¡å³æ™‚æˆäº¤æ¸…å–®å·²åŒæ­¥' },
        { id: Date.now() + 2, text: 'âš ï¸ é è­¦é€šçŸ¥ï¼šæ‚¨çš„è‡ªé¸è‚¡ 2330 çªç ´æ”¯æ’ä½' },
        { id: Date.now() + 3, text: 'âœ… çµ„åˆèª¿æ•´ï¼šæŠ•è³‡çµ„åˆæ¯”ä¾‹å·²é‡æ–°è¨ˆç®—' },
    ];

    function renderNotifications() {
        if (!notifyList) return;

        if (notifications.length === 0) {
            notifyList.innerHTML =
                '<div style="padding: 20px; text-align: center; color: var(--c-text-muted); font-size: 11px;">ç›®å‰æ²’æœ‰ä»»ä½•é€šçŸ¥</div>';
            if (badge) badge.style.display = 'none';
            return;
        }

        if (badge) {
            badge.style.display = 'block';
            badge.textContent = notifications.length.toString();
        }

        notifyList.innerHTML = notifications
            .map(
                n => `
            <div class="notification-item-row" style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.02); display: flex; gap: 10px; align-items: flex-start;">
                <span style="font-size: 11px; flex: 1; color: var(--c-text-secondary); line-height: 1.4;">${n.text}</span>
                <button class="remove-notify" data-id="${n.id}" style="background: transparent; border: none; color: var(--c-text-muted); cursor: pointer; padding: 2px;">âœ•</button>
            </div>
        `
            )
            .reverse()
            .join('');

        // Attach delete events
        notifyList.querySelectorAll('.remove-notify').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                const id = parseInt((btn as HTMLElement).dataset.id || '0');
                notifications = notifications.filter(n => n.id !== id);
                renderNotifications();
            });
        });
    }

    notifyBtn?.addEventListener('click', e => {
        e.stopPropagation();
        notifyPanel?.classList.toggle('visible');
    });

    clearBtn?.addEventListener('click', e => {
        e.stopPropagation();
        notifications = [];
        renderNotifications();
        toast.success('å·²æ¸…ç©ºæ‰€æœ‰é€šçŸ¥ç´€éŒ„');
    });

    // Initial render
    renderNotifications();

    // 4. Path Marking & Search
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-item').forEach(item => {
        const href = item.getAttribute('href') || '';
        if (href === currentPath || (href !== '/' && currentPath.startsWith(href))) {
            item.classList.add('active');
        }
    });

    // Close panel when clicking outside
    document.addEventListener('click', e => {
        if (!notifyPanel?.contains(e.target as Node) && !notifyBtn?.contains(e.target as Node)) {
            notifyPanel?.classList.remove('visible');
        }
    });
</script>
