---
/**
 * é ‚éƒ¨Headeræ¬„çµ„ä»¶ - Phase 1å¯¦ç¾
 *
 * åŠŸèƒ½ï¼š
 * - å…¨å±€æœç´¢æ¡† (æ”¯æŒè‚¡ç¥¨ã€ç­–ç•¥ã€çµ„åˆ)
 * - å¿«é€Ÿé€šçŸ¥å’Œæ“ä½œæŒ‰éˆ•
 * - æ™‚é–“æˆ³å’Œæ•¸æ“šæ›´æ–°ç‹€æ…‹
 * - ç”¨æˆ¶èœå–®
 *
 * @module HeaderBar
 * @version 1.0.0
 */
---

<header class="header-bar" id="header-bar">
    <!-- Left: æ¨™ç±¤é æ¬„ -->
    <div class="header-left">
        <!-- æ¨™ç±¤å‹•æ…‹æ’å…¥ -->
    </div>

    <!-- Center: å…¨å±€æœç´¢ -->
    <div class="header-center">
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input
                type="text"
                class="global-search"
                id="global-search-input"
                placeholder="æœç´¢è‚¡ç¥¨ã€ç­–ç•¥ã€çµ„åˆâ€¦"
                aria-label="å…¨å±€æœç´¢"
            />
            <div class="search-suggestions" id="search-suggestions"></div>
        </div>
    </div>

    <!-- Right: æ“ä½œå€ -->
    <div class="header-right">
        <!-- æ•¸æ“šæ›´æ–°ç‹€æ…‹ -->
        <div class="data-status" id="data-status">
            <span class="status-dot"></span>
            <span class="status-text">æœ€å¾Œæ›´æ–°: --:--</span>
        </div>

        <!-- ä¸»é¡Œåˆ‡æ› -->
        <button
            class="header-btn theme-toggle-btn"
            id="theme-toggle"
            title="åˆ‡æ›äº®/æš—æ¨¡å¼"
            aria-label="åˆ‡æ›äº®/æš—æ¨¡å¼"
        >
            <span class="theme-icon">ğŸŒ™</span>
        </button>

        <!-- é€šçŸ¥éˆ´ -->
        <div class="notifications-wrapper">
            <button class="header-btn" id="notifications-btn" title="é€šçŸ¥" aria-label="é€šçŸ¥">
                ğŸ””
                <span class="badge" id="notification-badge">3</span>
            </button>
            <div class="notifications-dropdown" id="notifications-dropdown">
                <div class="dropdown-header">ç³»çµ±é€šçŸ¥</div>
                <div class="notification-list">
                    <div class="notification-item unread">
                        <span class="item-icon">ğŸš€</span>
                        <div class="item-content">
                            <div class="item-title">æ•¸æ“šå·²æ›´æ–°</div>
                            <div class="item-time">å‰›å‰›</div>
                        </div>
                    </div>
                    <div class="notification-item unread">
                        <span class="item-icon">âš ï¸</span>
                        <div class="item-content">
                            <div class="item-title">å°ç©é›»é”åˆ°é è­¦åƒ¹æ ¼</div>
                            <div class="item-time">10 åˆ†é˜å‰</div>
                        </div>
                    </div>
                    <div class="notification-item">
                        <span class="item-icon">âœ…</span>
                        <div class="item-content">
                            <div class="item-title">æŠ•è³‡çµ„åˆåŒæ­¥æˆåŠŸ</div>
                            <div class="item-time">1 å°æ™‚å‰</div>
                        </div>
                    </div>
                </div>
                <a href="/notifications" class="view-all">æŸ¥çœ‹å…¨éƒ¨é€šçŸ¥</a>
            </div>
        </div>

        <!-- è¨­ç½® -->
        <button class="header-btn" id="settings-btn" title="è¨­å®š" aria-label="è¨­å®š"> âš™ï¸ </button>

        <!-- ç”¨æˆ¶èœå–® -->
        <div class="user-menu">
            <button class="user-avatar" id="user-menu-btn" title="ç”¨æˆ¶èœå–®">
                <span class="avatar-icon">ğŸ‘¤</span>
            </button>
            <div class="user-menu-dropdown" id="user-menu-dropdown">
                <a href="/settings" class="menu-item">ğŸ‘¤ å€‹äººè³‡æ–™</a>
                <a href="/settings" class="menu-item">âš™ï¸ åå¥½è¨­ç½®</a>
                <a href="/doc/PHASE1_QUICK_START.md" class="menu-item">â“ å¹«åŠ©</a>
                <div class="menu-divider"></div>
                <a href="#" class="menu-item logout-btn">ğŸšª ç™»å‡º</a>
            </div>
        </div>
    </div>
</header>

<style>
    .header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 56px;
        background: var(--c-bg-glass);
        border-bottom: 1px solid var(--c-border);
        padding: 0 20px;
        gap: 20px;
        position: sticky;
        top: 0;
        z-index: 90;
    }

    .header-left {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 200px;
    }

    .header-center {
        flex: 1;
        display: flex;
        align-items: center;
        max-width: 500px;
        min-width: 250px;
    }

    .header-right {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    /* å…¨å±€æœç´¢ */
    .search-wrapper {
        position: relative;
        width: 100%;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        color: var(--c-text-muted);
        font-size: 14px;
        pointer-events: none;
    }

    .global-search {
        width: 100%;
        height: 36px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        color: var(--c-text-primary);
        padding: 0 12px 0 36px;
        font-size: 12px;
        outline: none;
        transition: all 0.2s var(--ease-out);
    }

    .global-search::placeholder {
        color: var(--c-text-muted);
    }

    .global-search:focus {
        border-color: rgba(var(--c-accent-rgb), 0.5);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 12px rgba(var(--c-accent-rgb), 0.15);
    }

    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--c-bg-glass);
        border: 1px solid var(--c-border);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .search-suggestions.visible {
        display: flex;
        flex-direction: column;
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        color: var(--c-text-secondary);
        font-size: 12px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        transition: all 0.2s;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--c-accent);
    }

    .suggestion-icon {
        font-size: 14px;
        min-width: 16px;
    }

    .suggestion-text {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .suggestion-count {
        font-size: 10px;
        color: var(--c-text-muted);
    }

    /* æ•¸æ“šç‹€æ…‹ */
    .data-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--c-text-muted);
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 8px #10b981;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%,
        100% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
    }

    /* HeaderæŒ‰éˆ• */
    .header-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        color: var(--c-text-secondary);
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s var(--ease-out);
        position: relative;
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--c-accent);
        border-color: rgba(var(--c-accent-rgb), 0.3);
    }

    .badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ef4444;
        color: white;
        font-size: 9px;
        font-weight: 700;
        padding: 2px 4px;
        border-radius: 10px;
        min-width: 16px;
        text-align: center;
    }

    /* ç”¨æˆ¶èœå–® */
    .user-menu {
        position: relative;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(var(--c-accent-rgb), 0.1);
        border: 1px solid rgba(var(--c-accent-rgb), 0.2);
        border-radius: 50%;
        color: var(--c-accent);
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s var(--ease-out);
    }

    .user-avatar:hover {
        background: rgba(var(--c-accent-rgb), 0.2);
        box-shadow: 0 0 12px rgba(var(--c-accent-rgb), 0.2);
    }

    .user-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--c-bg-glass);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        min-width: 160px;
        padding: 4px;
        display: none;
        flex-direction: column;
        gap: 2px;
        z-index: 100;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        margin-top: 4px;
    }

    .user-menu-dropdown.visible {
        display: flex;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        color: var(--c-text-secondary);
        font-size: 12px;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .menu-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--c-text-primary);
    }

    .menu-divider {
        height: 1px;
        background: var(--c-border);
        margin: 2px 0;
    }

    /* Notifications Dropdown */
    .notifications-wrapper {
        position: relative;
    }

    .notifications-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--c-bg-glass-heavy);
        backdrop-filter: var(--glass-blur);
        border: 1px solid var(--c-border);
        border-radius: var(--radius-md);
        min-width: 280px;
        margin-top: 12px;
        display: none;
        flex-direction: column;
        z-index: 100;
        box-shadow: var(--shadow-panel);
        overflow: hidden;
        animation: fadeIn 0.3s var(--ease-out);
    }

    .notifications-dropdown.visible {
        display: flex;
    }

    .dropdown-header {
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 700;
        color: var(--c-text-primary);
        border-bottom: 1px solid var(--c-border);
    }

    .notification-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .notification-item {
        display: flex;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--c-border);
        cursor: pointer;
        transition: background 0.2s;
    }

    .notification-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .notification-item.unread {
        background: rgba(var(--c-accent-rgb), 0.05);
    }

    .notification-item .item-icon {
        font-size: 16px;
    }

    .item-title {
        font-size: 12px;
        color: var(--c-text-primary);
        margin-bottom: 2px;
    }

    .item-time {
        font-size: 10px;
        color: var(--c-text-muted);
    }

    .view-all {
        padding: 10px;
        text-align: center;
        font-size: 11px;
        color: var(--c-accent);
        text-decoration: none;
        background: rgba(var(--c-accent-rgb), 0.05);
    }

    .theme-toggle-btn:hover {
        color: #fbbf24;
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
    }

    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 1024px) {
        .header-bar {
            padding: 0 12px;
            gap: 12px;
        }

        .header-left {
            min-width: 150px;
        }

        .header-center {
            max-width: 350px;
            min-width: 200px;
        }

        .data-status {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .header-bar {
            height: 48px;
            padding: 0 8px;
            flex-wrap: wrap;
        }

        .header-left {
            display: none;
        }

        .header-center {
            order: 2;
            width: 100%;
            max-width: 100%;
            margin-top: 8px;
        }

        .header-right {
            order: 1;
            gap: 8px;
        }

        .global-search {
            font-size: 11px;
        }
    }
</style>

<script>
    /**
     * å…¨å±€æœç´¢åŠŸèƒ½
     * æ”¯æŒè‚¡ç¥¨ã€ç­–ç•¥ã€çµ„åˆæœç´¢
     */

    const searchInput = document.getElementById('global-search-input');
    const suggestionsPanel = document.getElementById('search-suggestions');

    // æ¨¡æ“¬æœç´¢æ•¸æ“š
    const searchData = [
        { type: 'stock', icon: 'ğŸ“ˆ', label: '2330 å°ç©é›»', href: '/stocks/2330' },
        { type: 'stock', icon: 'ğŸ“ˆ', label: '2317 é´»æµ·', href: '/stocks/2317' },
        { type: 'strategy', icon: 'ğŸ¯', label: 'ä½æœ¬ç›Šæ¯”', href: '/strategies/low-pe' },
        { type: 'strategy', icon: 'ğŸ¯', label: 'é«˜æ®–åˆ©ç‡', href: '/strategies/high-dividend' },
        { type: 'portfolio', icon: 'ğŸ’¼', label: 'ä¸»è¦çµ„åˆ', href: '/portfolio' },
    ];

    searchInput?.addEventListener('input', e => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();

        if (!query) {
            suggestionsPanel?.classList.remove('visible');
            return;
        }

        const results = searchData
            .filter(item => item.label.toLowerCase().includes(query))
            .slice(0, 8);

        if (results.length > 0) {
            suggestionsPanel!.innerHTML = results
                .map(
                    result => `
        <a href="${result.href}" class="suggestion-item">
          <span class="suggestion-icon">${result.icon}</span>
          <span class="suggestion-text">${result.label}</span>
        </a>
      `
                )
                .join('');
            suggestionsPanel?.classList.add('visible');
        } else {
            suggestionsPanel?.classList.remove('visible');
        }
    });

    // é»æ“Šå¤–éƒ¨éš±è—å»ºè­°
    document.addEventListener('click', e => {
        if (
            !searchInput?.contains(e.target as Node) &&
            !suggestionsPanel?.contains(e.target as Node)
        ) {
            suggestionsPanel?.classList.remove('visible');
        }
    });

    // Import Toast (client-side)
    let toast: any;
    import('../../lib/toast').then(mod => {
        toast = mod.toast;
    });

    // ç”¨æˆ¶èœå–®
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userMenuDropdown = document.getElementById('user-menu-dropdown');

    userMenuBtn?.addEventListener('click', () => {
        userMenuDropdown?.classList.toggle('visible');
        notificationsDropdown?.classList.remove('visible');
    });

    // é€šçŸ¥èœå–®
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationsDropdown = document.getElementById('notifications-dropdown');
    const notificationBadge = document.getElementById('notification-badge');

    notificationsBtn?.addEventListener('click', () => {
        notificationsDropdown?.classList.toggle('visible');
        userMenuDropdown?.classList.remove('visible');
        if (notificationBadge) notificationBadge.style.display = 'none';
    });

    // ä¸»é¡Œåˆ‡æ›
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle?.querySelector('.theme-icon');

    function setTheme(theme: string) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('tw-stock-theme', theme);
        if (themeIcon) {
            themeIcon.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
    }

    // åˆå§‹åŒ–ä¸»é¡Œ
    const savedTheme = localStorage.getItem('tw-stock-theme') || 'dark';
    setTheme(savedTheme);

    themeToggle?.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        setTheme(next);
        toast?.info(`å·²åˆ‡æ›è‡³ ${next === 'dark' ? 'æ·±è‰²' : 'äº®è‰²'} æ¨¡å¼`);
    });

    // è¨­å®šèˆ‡ç™»å‡ºæ¨¡æ“¬
    document.getElementById('settings-btn')?.addEventListener('click', () => {
        toast?.success('æ­£åœ¨é–‹å•Ÿè¨­å®šé é¢...', 1000);
        setTimeout(() => {
            window.location.href = '/settings';
        }, 500);
    });

    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
            toast?.info('é€šçŸ¥åŠŸèƒ½è©³æƒ…ï¼š' + item.querySelector('.item-title')?.textContent);
            item.classList.remove('unread');
        });
    });

    document.querySelector('.logout-btn')?.addEventListener('click', e => {
        e.preventDefault();
        toast?.warning('ç™»å‡ºåŠŸèƒ½ç›®å‰åƒ…ä¾›å±•ç¤º');
    });

    // é»æ“Šå¤–éƒ¨éš±è—æ‰€æœ‰ä¸‹æ‹‰èœå–®
    document.addEventListener('click', e => {
        const target = e.target as Node;
        if (!userMenuBtn?.contains(target) && !userMenuDropdown?.contains(target)) {
            userMenuDropdown?.classList.remove('visible');
        }
        if (!notificationsBtn?.contains(target) && !notificationsDropdown?.contains(target)) {
            notificationsDropdown?.classList.remove('visible');
        }
    });

    // æ›´æ–°æ™‚é–“æˆ³
    function updateDataStatus() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        const statusText = document.querySelector('.status-text');
        if (statusText) {
            statusText.textContent = `æœ€å¾Œæ›´æ–°: ${timeStr}`;
        }
    }

    updateDataStatus();
    setInterval(updateDataStatus, 60000);
</script>
