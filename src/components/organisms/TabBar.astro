---
/**
 * TabBar.astro â€” 5 analysis tabs for individual stock pages
 * Maps to spec 002~007: Overview, Database, Technical, Chips, Fundamentals, Alerts
 */
interface Props {
    symbol: string;
    activeTab?: string;
}

const { symbol, activeTab = 'overview' } = Astro.props;

const tabs = [
    { id: 'overview', label: 'ç¸½è¦½', icon: 'ğŸ“Š' },
    { id: 'technical', label: 'æŠ€è¡“é¢', icon: 'ğŸ“ˆ' },
    { id: 'chips', label: 'ç±Œç¢¼é¢', icon: 'ğŸ¦' },
    { id: 'fundamentals', label: 'åŸºæœ¬é¢', icon: 'ğŸ’°' },
    { id: 'alerts', label: 'AI å ±å‘Š', icon: 'ğŸ¤–' },
];
---

<nav
    class="flex items-center gap-1 px-2 py-1 glass-panel rounded-xl mb-6"
    id="stock-tab-bar"
    aria-label="åˆ†æåˆ†é "
    role="tablist"
>
    {
        tabs.map(tab => (
            <button
                class:list={[
                    'flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all duration-200 cursor-pointer',
                    activeTab === tab.id
                        ? 'bg-accent/15 text-accent shadow-[inset_0_1px_0_hsl(0_0%_100%/0.1)]'
                        : 'text-text-secondary hover:text-text-primary hover:bg-glass-hover',
                ]}
                data-tab={tab.id}
                data-symbol={symbol}
                aria-selected={activeTab === tab.id}
                role="tab"
            >
                <span class="text-sm">{tab.icon}</span>
                <span class="hidden sm:inline">{tab.label}</span>
            </button>
        ))
    }
</nav>

<script>
    function initTabBar() {
        const tabBar = document.getElementById('stock-tab-bar');
        if (!tabBar) return;
        const tabBtns = Array.from(tabBar.querySelectorAll('[data-tab]')) as HTMLElement[];

        function switchTab(tabId: string) {
            tabBtns.forEach(b => {
                const isActive = b.dataset.tab === tabId;
                b.classList.toggle('bg-accent/15', isActive);
                b.classList.toggle('text-accent', isActive);
                b.classList.toggle('text-text-secondary', !isActive);
                b.setAttribute('aria-selected', String(isActive));
                b.setAttribute('tabindex', isActive ? '0' : '-1');
            });

            document.querySelectorAll('[data-tab-content]').forEach(panel => {
                const panelEl = panel as HTMLElement;
                if (panelEl.dataset.tabContent === tabId) {
                    panelEl.classList.remove('hidden');
                    panelEl.style.animation = 'fade-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) both';
                } else {
                    panelEl.classList.add('hidden');
                }
            });

            history.replaceState(null, '', `#${tabId}`);
        }

        // Initialize from URL hash
        const hash = location.hash.replace('#', '');
        if (hash && tabBtns.some(b => b.dataset.tab === hash)) {
            switchTab(hash);
        }

        // Click handler
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                if (tabId) switchTab(tabId);
            });
        });

        // Keyboard navigation (arrow keys)
        tabBar.addEventListener('keydown', (e: Event) => {
            const event = e as KeyboardEvent;
            const currentIdx = tabBtns.findIndex(b => b.getAttribute('aria-selected') === 'true');
            let nextIdx = currentIdx;

            if (event.key === 'ArrowRight') nextIdx = (currentIdx + 1) % tabBtns.length;
            else if (event.key === 'ArrowLeft')
                nextIdx = (currentIdx - 1 + tabBtns.length) % tabBtns.length;
            else if (event.key === 'Home') nextIdx = 0;
            else if (event.key === 'End') nextIdx = tabBtns.length - 1;
            else return;

            event.preventDefault();
            const tabId = tabBtns[nextIdx].dataset.tab;
            if (tabId) {
                switchTab(tabId);
                tabBtns[nextIdx].focus();
            }
        });
    }

    initTabBar();
    document.addEventListener('astro:page-load', initTabBar);
</script>
