---
/**
 * SentimentTrendModal.astro - Market sentiment trend analysis modal with Chart.js
 */
---

<div
    id="trend-modal"
    class="fixed inset-0 z-[100] hidden p-4 md:p-10 flex items-center justify-center"
>
    <div id="trend-modal-backdrop" class="absolute inset-0 bg-overlay backdrop-blur-md"></div>
    <div
        class="relative w-full max-w-5xl h-[500px] bg-[#0a0c10]/95 border border-accent/20 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col animate-fade-up"
    >
        <header class="relative px-10 pt-10 pb-4 flex items-center justify-between">
            <div>
                <h3 class="text-xl font-mono font-black text-text-primary tracking-[0.2em] uppercase">
                    Market Sentiment Horizon
                </h3>
                <p class="text-[9px] font-mono text-text-muted/70 uppercase tracking-[0.5em] mt-2">
                    Temporal Breadth Variance Analysis
                </p>
            </div>
            <button
                id="close-trend-modal"
                class="w-12 h-12 flex items-center justify-center rounded-2xl bg-surface-hover/50 border border-border text-text-muted hover:text-text-primary hover:border-border-hover transition-all"
            >
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path></svg
                >
            </button>
        </header>
        <div class="flex-1 px-10 pb-10">
            <canvas id="breadth-ratio-chart"></canvas>
        </div>
    </div>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let breadthChart: any = null;

    async function initTrendChart() {
        const canvas = document.getElementById('breadth-ratio-chart') as HTMLCanvasElement;
        if (!canvas) return;

        try {
            const res = await fetch(`/api/market/breadth-timeseries?t=${Date.now()}`);
            const data = await res.json();

            const labels = data.map((d: any) => d.date);
            const ratios = data.map((d: any) => (d.down > 0 ? d.up / d.down : 2));

            if (breadthChart) breadthChart.destroy();

            // @ts-ignore
            breadthChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ratio',
                            data: ratios,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderWidth: 3,
                            yAxisID: 'yRatio',
                            tension: 0.4,
                            fill: {
                                target: { value: 1 },
                                above: 'transparent',
                                below: 'rgba(34, 197, 94, 0.15)',
                            },
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0a0c10',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            titleFont: { size: 10, weight: 'bold' },
                            bodyFont: { size: 12, family: 'monospace' },
                            padding: 12,
                            callbacks: {
                                label: (context: any) => {
                                    const d = data[context.dataIndex];
                                    return ` RATIO : ${context.parsed.y.toFixed(2)} | UP:${d.up} DOWN:${d.down}`;
                                },
                            },
                        },
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8,
                                color: 'rgba(255,255,255,0.2)',
                                font: { family: 'monospace', size: 8 },
                            },
                        },
                        yRatio: {
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.5)',
                                font: { size: 10, weight: 'bold' },
                            },
                        },
                    },
                },
            });
        } catch (err) {
            console.error('[Chart] Initialization failed:', err);
        }
    }

    const trendModal = document.getElementById('trend-modal');
    const closeChartBtn = document.getElementById('close-trend-modal');
    const chartBackdrop = document.getElementById('trend-modal-backdrop');

    const openModal = () => {
        trendModal?.classList.remove('hidden');
        initTrendChart();
    };

    const closeModal = () => trendModal?.classList.add('hidden');

    closeChartBtn?.addEventListener('click', closeModal);
    chartBackdrop?.addEventListener('click', closeModal);

    // Event delegation to support Svelte hydration
    document.addEventListener('click', e => {
        const target = e.target as HTMLElement;
        if (target.closest('#open-breadth-chart')) {
            openModal();
        }
    });

    // Astro transition support
    document.addEventListener('astro:page-load', () => {
        const currentModal = document.getElementById('trend-modal');
        const openBtn = document.getElementById('open-breadth-chart');

        // As a fallback for astro page load, bind directly if present
        if (openBtn && currentModal) {
            openBtn.addEventListener('click', () => {
                currentModal.classList.remove('hidden');
                initTrendChart();
            });
        }
    });
</script>
