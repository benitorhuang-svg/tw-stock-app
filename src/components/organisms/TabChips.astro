---
/**
 * TabChips.astro — Institutional Chips Tab (005-tab-chips)
 * Three institutional investors momentum + combo divergence chart
 */
import {
    getInstitutionalData,
    getLatestInstitutional,
    getConsecutiveDays,
} from '../../data/institutional';
import InstitutionalMomentumCards from '../molecules/InstitutionalMomentumCards.astro';
import ForensicTrendChart from './ForensicTrendChart.svelte';
import BrokerTradeMap from './BrokerTradeMap.svelte';
import OwnershipChart from '../molecules/OwnershipChart.astro';
import ForensicFlowSummary from '../molecules/ForensicFlowSummary.astro';
import type { InstitutionalEntity } from '../../types/stock';

interface Props {
    symbol: string;
    price: number;
}

const { symbol, price } = Astro.props;

const institutionalData = getInstitutionalData(symbol);
const latest = getLatestInstitutional(symbol);
const foreignDays = getConsecutiveDays(symbol, 'foreign');
const investDays = getConsecutiveDays(symbol, 'invest');
const dealerDays = getConsecutiveDays(symbol, 'dealer');

// Forensic Metrics
const recentTotalNet = institutionalData.slice(0, 5).reduce((acc, d) => acc + d.totalNet, 0);
const institutionalAlpha =
    recentTotalNet > 0 && price > 0
        ? 'BULLISH_FLOW'
        : recentTotalNet < 0
          ? 'DISTRIBUTION'
          : 'NEUTRAL';

const entities: InstitutionalEntity[] = [
    {
        name: '外資',
        en: 'Foreign',
        net: latest?.foreignNet ?? 0,
        days: foreignDays,
        color: 'accent',
        trend: institutionalData.slice(0, 5).map(d => d.foreignNet),
    },
    {
        name: '投信',
        en: 'Trust',
        net: latest?.investNet ?? 0,
        days: investDays,
        color: 'bullish',
        trend: institutionalData.slice(0, 5).map(d => d.investNet),
    },
    {
        name: '自營商',
        en: 'Dealer',
        net: latest?.dealerNet ?? 0,
        days: dealerDays,
        color: 'warning',
        trend: institutionalData.slice(0, 5).map(d => d.dealerNet),
    },
];

const fmtNet = (n: number) => {
    if (n === 0) return '—';
    const prefix = n > 0 ? '+' : '';
    return `${prefix}${n.toLocaleString('zh-TW')}`;
};

const chartData = [...institutionalData].slice(0, 10).reverse();
const maxNet = Math.max(
    ...chartData.map(d =>
        Math.max(Math.abs(d.foreignNet), Math.abs(d.investNet), Math.abs(d.dealerNet))
    ),
    1
);

const sparkPoints = (data: number[]) => {
    if (data.length === 0) return '';
    const max = Math.max(...data.map(Math.abs), 1);
    const mid = 20;
    return data
        .map((v, i) => {
            const x = (i / Math.max(data.length - 1, 1)) * 80 + 5;
            const y = mid - (v / max) * 15;
            return `${x},${y}`;
        })
        .join(' ');
};
---

<div class="space-y-6">
    <div class="space-y-6">
        <!-- Forensic Flow Summary -->
        <ForensicFlowSummary
            institutionalAlpha={institutionalAlpha}
            recentTotalNet={recentTotalNet}
        />

        <!-- Institutional Momentum Cards -->
        <InstitutionalMomentumCards entities={entities} fmtNet={fmtNet} sparkPoints={sparkPoints} />

        <!-- Advanced Forensic Trend Chart (Svelte Integration) -->
        <ForensicTrendChart client:load symbol={symbol} price={price} />

        <!-- Individual Broker Participant Map -->
        <BrokerTradeMap client:visible symbol={symbol} />

        <!-- Ownership Distribution -->
        <OwnershipChart
            bigMoneyRatio={80.2}
            retailRatio={19.8}
            trendData={[68, 70, 69, 72, 74, 73, 75, 76, 74, 77, 78, 80]}
        />
    </div>
</div>
