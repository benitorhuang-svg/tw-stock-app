---
/**
 * TabChips.astro ‚Äî Institutional Chips Tab (005-tab-chips)
 * Three institutional investors momentum + combo divergence chart
 */
import { getInstitutionalData, getLatestInstitutional, getConsecutiveDays } from '../../data/institutional';
import type { InstitutionalData } from '../../data/institutional';

interface Props {
    symbol: string;
    price: number;
}

const { symbol, price } = Astro.props;

const institutionalData = getInstitutionalData(symbol);
const latest = getLatestInstitutional(symbol);
const foreignDays = getConsecutiveDays(symbol, 'foreign');
const investDays = getConsecutiveDays(symbol, 'invest');
const dealerDays = getConsecutiveDays(symbol, 'dealer');

// Forensic Metrics
const recentTotalNet = institutionalData.slice(0, 5).reduce((acc, d) => acc + d.totalNet, 0);
const institutionalAlpha = (recentTotalNet > 0 && price > 0) ? 'BULLISH_FLOW' : (recentTotalNet < 0) ? 'DISTRIBUTION' : 'NEUTRAL';

const entities = [
    {
        name: 'Â§ñË≥á',
        en: 'Foreign',
        net: latest?.foreignNet ?? 0,
        days: foreignDays,
        color: 'accent',
        trend: institutionalData.slice(0, 5).map(d => d.foreignNet),
    },
    {
        name: 'Êäï‰ø°',
        en: 'Trust',
        net: latest?.investNet ?? 0,
        days: investDays,
        color: 'bullish',
        trend: institutionalData.slice(0, 5).map(d => d.investNet),
    },
    {
        name: 'Ëá™ÁáüÂïÜ',
        en: 'Dealer',
        net: latest?.dealerNet ?? 0,
        days: dealerDays,
        color: 'warning',
        trend: institutionalData.slice(0, 5).map(d => d.dealerNet),
    },
];

const fmtNet = (n: number) => {
    if (n === 0) return '‚Äî';
    const prefix = n > 0 ? '+' : '';
    return `${prefix}${n.toLocaleString('zh-TW')}`;
};

const chartData = [...institutionalData].slice(0, 10).reverse();
const maxNet = Math.max(...chartData.map(d => Math.max(Math.abs(d.foreignNet), Math.abs(d.investNet), Math.abs(d.dealerNet))), 1);

const sparkPoints = (data: number[]) => {
    if (data.length === 0) return '';
    const max = Math.max(...data.map(Math.abs), 1);
    const mid = 20;
    return data.map((v, i) => {
        const x = (i / Math.max(data.length - 1, 1)) * 80 + 5;
        const y = mid - (v / max) * 15;
        return `${x},${y}`;
    }).join(' ');
};
---

<div class="space-y-6">
<div class="space-y-6">
    <!-- Forensic Flow Summary -->
    <div class="glass-card p-4 flex items-center justify-between border-l-4 border-accent bg-accent/[0.02]">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center text-accent">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20h20"/><path d="m7 10 2 2 2-2 2 2 2-2 2 2 2-2"/><path d="M20 12V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10"/></svg>
            </div>
            <div>
                <h3 class="text-xs font-mono font-bold text-white/40 uppercase tracking-widest">Forensic Flow Analysis</h3>
                <div class="flex items-center gap-2 mt-0.5">
                    <span class:list={["text-sm font-bold", institutionalAlpha === 'BULLISH_FLOW' ? 'text-bullish' : institutionalAlpha === 'DISTRIBUTION' ? 'text-bearish' : 'text-text-muted']}>
                        {institutionalAlpha.replace('_', ' ')}
                    </span>
                    <span class="text-[10px] text-text-muted px-1.5 py-0.5 rounded bg-white/5 font-mono">CONFIDENCE: HIGHER</span>
                </div>
            </div>
        </div>
        <div class="flex gap-8 px-6 border-l border-white/5">
            <div>
                <div class="text-[9px] text-text-muted uppercase mb-1">5D Net Flow</div>
                <div class:list={["font-mono text-sm font-bold", recentTotalNet >= 0 ? "text-bullish" : "text-bearish"]}>
                    {fmtNet(recentTotalNet)} <span class="text-[10px] font-normal opacity-40">Âºµ</span>
                </div>
            </div>
            <div>
                <div class="text-[9px] text-text-muted uppercase mb-1">Big Money Bias</div>
                <div class="font-mono text-sm font-bold text-accent">ACCUMULATING</div>
            </div>
        </div>
    </div>

    <!-- Institutional Momentum Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 stagger-children">
        {entities.map((entity) => {
            const isPos = entity.net > 0;
            return (
                <div class:list={[
                    'glass-card group hover:bg-white/[0.02] px-5 py-4 flex flex-col gap-3 transition-all duration-300',
                    isPos ? 'border-r-2 border-r-bullish/20' : entity.net < 0 ? 'border-r-2 border-r-bearish/20' : 'border-r-2 border-r-transparent'
                ]}>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                             <div class:list={["w-1.5 h-1.5 rounded-full", entity.color === 'accent' ? 'bg-accent' : entity.color === 'bullish' ? 'bg-bullish' : 'bg-warning']}></div>
                             <span class="text-[10px] font-bold text-white/50 uppercase tracking-tighter">{entity.name} Ë≥áÈáëÂãïËÉΩ</span>
                        </div>
                        {entity.days !== 0 && (
                            <span class:list={[
                                'text-[9px] font-bold font-mono px-2 py-0.5 rounded bg-white/5 border border-white/5',
                                entity.days > 0 ? 'text-bullish' : 'text-bearish'
                            ]}>
                                ÈÄ£ {Math.abs(entity.days)} {entity.days > 0 ? 'B' : 'S'}
                            </span>
                        )}
                    </div>
                    <div class="flex items-end justify-between">
                        <span class:list={[
                            'text-2xl font-mono font-black tracking-tighter',
                            isPos ? 'text-bullish' : entity.net < 0 ? 'text-bearish' : 'text-text-muted'
                        ]}>
                            {fmtNet(entity.net)}
                        </span>
                        <div class="flex flex-col items-end opacity-40 group-hover:opacity-100 transition-opacity">
                             <span class="text-[8px] font-mono text-text-muted uppercase mb-1">Momentum Trend</span>
                             <svg viewBox="0 0 90 20" class="w-16 h-4">
                                <polyline
                                    points={sparkPoints(entity.trend)}
                                    fill="none"
                                    stroke={isPos ? 'hsl(142,71%,45%)' : entity.net < 0 ? 'hsl(346,77%,50%)' : 'rgba(255,255,255,0.2)'}
                                    stroke-width="2"
                                    stroke-linecap="round"
                                />
                             </svg>
                        </div>
                    </div>
                </div>
            );
        })}
    </div>

    <!-- Combo Divergence Chart -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="terminal-label mb-1">Ë§áÂêàËÉåÈõ¢Âúñ</h3>
                <p class="text-xs text-text-muted">ËÇ°ÂÉπ √ó ‰∏âÂ§ßÊ≥ï‰∫∫Ë≤∑Ë≥£Ë∂Ö ‚Äî ÈõôËª∏Â†ÜÁñä</p>
            </div>
            <div class="flex items-center gap-3 text-[10px]">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-bearish/60"></span> Â§ñË≥á</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-warning/60"></span> Êäï‰ø°</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-text-muted"></span> Ëá™Ááü</span>
            </div>
        </div>

        {chartData.length > 0 ? (
            <div class="relative h-[320px]">
                <!-- Y-axis labels -->
                <div class="absolute left-0 top-0 bottom-8 w-12 flex flex-col justify-between text-[9px] font-mono text-text-muted">
                    <span>+{(maxNet/1000).toFixed(0)}K</span>
                    <span>0</span>
                    <span>-{(maxNet/1000).toFixed(0)}K</span>
                </div>
                <!-- Chart area -->
                <div class="ml-14 mr-4 h-full flex flex-col">
                    <div class="flex-1 relative">
                        <!-- Zero line -->
                        <div class="absolute left-0 right-0 top-1/2 border-t border-white/[0.08]"></div>
                        <!-- Grid -->
                        <div class="absolute left-0 right-0 top-1/4 border-t border-dashed border-white/[0.03]"></div>
                        <div class="absolute left-0 right-0 top-3/4 border-t border-dashed border-white/[0.03]"></div>

                        <!-- Stacked bars -->
                        <div class="absolute inset-0 flex items-center justify-around px-2">
                            {chartData.map((d) => {
                                const fPct = (d.foreignNet / maxNet) * 45;
                                const iPct = (d.investNet / maxNet) * 45;
                                const dPct = (d.dealerNet / maxNet) * 45;
                                const totalPct = (d.totalNet / maxNet) * 45;
                                return (
                                    <div class="flex flex-col items-center gap-0.5 group relative" style="width: 16%">
                                        {/* Stacked bar segments */}
                                        <div class="w-full flex flex-col items-center" style="height: 90%">
                                            {/* Foreign */}
                                            <div
                                                class="w-3/4 rounded-sm transition-all duration-300 group-hover:w-full"
                                                style={`height: ${Math.abs(fPct)}%; margin-top: ${fPct < 0 ? '0' : 'auto'}; margin-bottom: ${fPct >= 0 ? '0' : 'auto'}; background: ${fPct >= 0 ? 'hsl(346,77%,50%,0.6)' : 'hsl(142,71%,45%,0.6)'}; transform: translateY(${fPct >= 0 ? '-' : ''}0%);`}
                                            ></div>
                                        </div>
                                        {/* Date label */}
                                        <span class="text-[8px] font-mono text-text-muted mt-1 whitespace-nowrap">
                                            {d.date.slice(5)}
                                        </span>
                                        {/* Tooltip on hover */}
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-base border border-border rounded-lg text-[10px] font-mono opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-10 whitespace-nowrap shadow-elevated">
                                            <div class="text-text-primary mb-1 font-bold">{d.date}</div>
                                            <div class="text-bearish/80">Â§ñË≥á: {fmtNet(d.foreignNet)}</div>
                                            <div class="text-warning/80">Êäï‰ø°: {fmtNet(d.investNet)}</div>
                                            <div class="text-text-muted">Ëá™Ááü: {fmtNet(d.dealerNet)}</div>
                                            <div class:list={['font-bold mt-1 pt-1 border-t border-border', d.totalNet > 0 ? 'text-bullish' : 'text-bearish']}>
                                                ÂêàË®à: {fmtNet(d.totalNet)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            </div>
        ) : (
            <div class="h-[320px] flex flex-col items-center justify-center">
                <span class="text-3xl mb-3">üè¶</span>
                <p class="text-sm text-text-muted">Â∞öÁÑ°Ê≠§Ê™îÁ±åÁ¢ºË≥áÊñô</p>
                <p class="text-xs text-text-muted mt-1">ÁÑ°Ê≥ïÂèñÂæóÊ®ôÁöÑ {symbol} ÁöÑÊ≥ï‰∫∫Á±åÁ¢ºÊï∏Êìö</p>
            </div>
        )}
    </div>

    <!-- Ownership Distribution -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass-card p-5 glow-interactive">
            <h3 class="terminal-label mb-3">Â§ßÊà∂ÊåÅËÇ°ÊØîÁéáË∂®Âã¢</h3>
            <div class="h-[120px] flex items-end justify-around gap-1 px-2">
                {[68, 70, 69, 72, 74, 73, 75, 76, 74, 77, 78, 80].map((v, i) => (
                    <div class="flex flex-col items-center gap-1 flex-1">
                        <div
                            class="w-full rounded-t-sm bg-accent/40 hover:bg-accent/60 transition-colors"
                            style={`height: ${(v / 100) * 100}%`}
                        ></div>
                        {i % 3 === 0 && <span class="text-[7px] font-mono text-text-muted">{12 - i}ÊúàÂâç</span>}
                    </div>
                ))}
            </div>
            <div class="flex items-center justify-between mt-3 text-xs text-text-muted font-mono">
                <span>400Âºµ‰ª•‰∏äÂ§ßÊà∂</span>
                <span class="text-bullish font-bold">80.2%</span>
            </div>
        </div>

        <div class="glass-card p-5 glow-interactive">
            <h3 class="terminal-label mb-3">ËÇ°Êù±ÁµêÊßãÂàÜ‰Ωà</h3>
            <div class="flex items-center justify-center h-[120px] gap-6">
                <!-- Donut ring via SVG -->
                <svg viewBox="0 0 100 100" class="w-24 h-24">
                    <circle cx="50" cy="50" r="40" fill="none" stroke="hsl(217,91%,60%,0.3)" stroke-width="12"/>
                    <circle cx="50" cy="50" r="40" fill="none" stroke="hsl(217,91%,60%,0.8)" stroke-width="12"
                        stroke-dasharray={`${0.80 * 251.3} ${251.3}`} stroke-dashoffset="0"
                        transform="rotate(-90 50 50)" stroke-linecap="round"/>
                    <text x="50" y="48" text-anchor="middle" fill="white" font-size="14" font-weight="bold" font-family="var(--font-mono)">80%</text>
                    <text x="50" y="62" text-anchor="middle" fill="hsl(240,4%,40%)" font-size="8">Â§ßÊà∂</text>
                </svg>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-accent"></span>
                        <span class="text-text-secondary">ÂçÉÂºµÂ§ßËÇ°Êù± <span class="font-mono text-accent font-bold">80%</span></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-accent/30"></span>
                        <span class="text-text-secondary">50Âºµ‰ª•‰∏ãÊï£Êà∂ <span class="font-mono text-text-muted font-bold">20%</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
