---
/**
 * TabChips.astro — Institutional Chips Tab (005-tab-chips)
 * Three institutional investors momentum + combo divergence chart
 */
import {
    getInstitutionalData,
    getLatestInstitutional,
    getConsecutiveDays,
} from '../../data/institutional';
import InstitutionalMomentumCards from '../molecules/InstitutionalMomentumCards.astro';
import ForensicTrendChart from './ForensicTrendChart.svelte';
import BrokerTradeMap from './BrokerTradeMap.svelte';
import OwnershipChart from '../molecules/OwnershipChart.astro';
import ForensicFlowSummary from '../molecules/ForensicFlowSummary.astro';
import type { InstitutionalEntity } from '../../types/stock';

interface Props {
    symbol: string;
    price: number;
}

const { symbol, price } = Astro.props;

const institutionalData = getInstitutionalData(symbol);
const latest = getLatestInstitutional(symbol);
const foreignDays = getConsecutiveDays(symbol, 'foreign');
const investDays = getConsecutiveDays(symbol, 'invest');
const dealerDays = getConsecutiveDays(symbol, 'dealer');

// Forensic Metrics
const recentTotalNet = institutionalData.slice(0, 5).reduce((acc, d) => acc + d.totalNet, 0);
const institutionalAlpha =
    recentTotalNet > 0 && price > 0
        ? 'BULLISH_FLOW'
        : recentTotalNet < 0
          ? 'DISTRIBUTION'
          : 'NEUTRAL';

const entities: InstitutionalEntity[] = [
    {
        name: '外資',
        en: 'Foreign',
        net: latest?.foreignNet ?? 0,
        days: foreignDays,
        color: 'accent',
        trend: institutionalData.slice(0, 5).map(d => d.foreignNet),
    },
    {
        name: '投信',
        en: 'Trust',
        net: latest?.investNet ?? 0,
        days: investDays,
        color: 'bullish',
        trend: institutionalData.slice(0, 5).map(d => d.investNet),
    },
    {
        name: '自營商',
        en: 'Dealer',
        net: latest?.dealerNet ?? 0,
        days: dealerDays,
        color: 'warning',
        trend: institutionalData.slice(0, 5).map(d => d.dealerNet),
    },
];

const fmtNet = (n: number) => {
    if (n === 0) return '—';
    const prefix = n > 0 ? '+' : '';
    return `${prefix}${n.toLocaleString('zh-TW')}`;
};

const sparkPoints = (data: number[]) => {
    if (data.length === 0) return '';
    const max = Math.max(...data.map(Math.abs), 1);
    const mid = 20;
    return data
        .map((v, i) => {
            const x = (i / Math.max(data.length - 1, 1)) * 80 + 5;
            const y = mid - (v / max) * 15;
            return `${x},${y}`;
        })
        .join(' ');
};
---

<div class="space-y-6 animate-fade-up">
    <!-- Forensic Score HUD (Skill #6) -->
    <div class="glass-card p-6 border-l-4 border-accent relative overflow-hidden group shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-r from-accent/10 to-transparent"></div>
        <div class="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
            <div class="flex-1 space-y-4 text-center md:text-left">
                <div class="flex flex-col">
                    <h4
                        class="text-[10px] font-mono font-black text-accent uppercase tracking-[0.3em]"
                    >
                        Institutional_Forensic_Score
                    </h4>
                    <p class="text-[9px] text-text-muted mt-0.5 uppercase tracking-widest">
                        Alpha intent decoding & capital footprint scan
                    </p>
                </div>
                <div class="flex items-center gap-6 justify-center md:justify-start">
                    <div
                        class="text-6xl font-mono font-black text-text-primary tracking-tighter tabular-nums drop-shadow-md"
                    >
                        {recentTotalNet > 0 ? '82' : '45'}
                        <span class="text-xs opacity-40 ml-1 font-bold">/100</span>
                    </div>
                    <div
                        class="px-4 py-2 rounded-2xl bg-bullish/10 border border-bullish/30 text-[10px] font-mono font-bold text-bullish uppercase tracking-widest animate-pulse"
                    >
                        {
                            institutionalAlpha === 'BULLISH_FLOW'
                                ? 'True_Accumulation'
                                : 'Neutral_Flow'
                        }
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full md:w-auto">
                <div class="p-4 rounded-xl bg-surface/50 border border-border/20 backdrop-blur-sm">
                    <div class="text-[9px] font-mono font-bold text-text-muted uppercase mb-1">
                        Concentration
                    </div>
                    <div class="text-lg font-mono font-black text-text-primary">76.2%</div>
                </div>
                <div class="p-4 rounded-xl bg-surface/50 border border-border/20 backdrop-blur-sm">
                    <div class="text-[9px] font-mono font-bold text-text-muted uppercase mb-1">
                        Intensity
                    </div>
                    <div class="text-lg font-mono font-black text-accent">High</div>
                </div>
            </div>
        </div>

        <!-- Intent Analyzer Strip -->
        <div class="mt-8 pt-6 border-t border-border/30 flex flex-wrap gap-4 relative z-10">
            <div
                class="flex items-center gap-2 bg-surface-hover/30 px-3 py-1.5 rounded-full border border-border/20"
            >
                <span class="w-2 h-2 rounded-full bg-bullish"></span>
                <span class="text-[10px] font-mono font-bold text-text-secondary uppercase"
                    >投信連買 {investDays}D</span
                >
            </div>
            <div
                class="flex items-center gap-2 bg-surface-hover/30 px-3 py-1.5 rounded-full border border-border/20"
            >
                <span class="w-2 h-2 rounded-full bg-accent"></span>
                <span class="text-[10px] font-mono font-bold text-text-secondary uppercase"
                    >外資真買確認</span
                >
            </div>
            <div
                class="flex items-center gap-2 bg-surface-hover/30 px-3 py-1.5 rounded-full border border-border/20"
            >
                <span class="w-2 h-2 rounded-full bg-warning"></span>
                <span class="text-[10px] font-mono font-bold text-text-secondary uppercase"
                    >分點主力偏多</span
                >
            </div>
        </div>
    </div>

    <!-- Forensic Flow Summary Component -->
    <ForensicFlowSummary institutionalAlpha={institutionalAlpha} recentTotalNet={recentTotalNet} />

    <!-- Institutional Momentum Cards -->
    <InstitutionalMomentumCards entities={entities} fmtNet={fmtNet} sparkPoints={sparkPoints} />

    <!-- Advanced Forensic Trend Chart -->
    <ForensicTrendChart client:load symbol={symbol} price={price} />

    <!-- Individual Broker Participant Map -->
    <BrokerTradeMap client:visible symbol={symbol} />

    <!-- Ownership Distribution -->
    <OwnershipChart
        bigMoneyRatio={80.2}
        retailRatio={19.8}
        trendData={[68, 70, 69, 72, 74, 73, 75, 76, 74, 77, 78, 80]}
    />
</div>
