---
import TechToolbar from '../molecules/TechToolbar.astro';
import PriceLabels from '../molecules/PriceLabels.astro';
import TechnicalLegend from '../molecules/TechnicalLegend.astro';
import TechnicalChart from '../molecules/TechnicalChart.astro';
import IndicatorMacd from '../molecules/IndicatorMacd.astro';
import IndicatorRsi from '../molecules/IndicatorRsi.astro';

/**
 * TabTechnical.astro â€” Technical Analysis Tab (004-tab-technical)
 * K-line chart, MACD, KDJ, RSI sub-indicators with floating toolbar
 */

interface PriceRecord {
    Date: string;
    Open: number;
    High: number;
    Low: number;
    Close: number;
    Volume: number;
}

interface Props {
    symbol: string;
    price: number;
    change: number;
    priceData?: PriceRecord[];
}

const { price, priceData } = Astro.props;

const timeframes = ['15åˆ†', '60åˆ†', 'æ—¥', 'é€±', 'æœˆ'];
const overlays = ['å‡ç·š (MA)', 'æ³¢æµªæŒ‡æ¨™', 'æ”¯æ’å£“åŠ›'];
const subIndicators = ['MACD', 'KDJ', 'RSI'];

// Use real price data or fallback to simulation
const hasRealData = !!(priceData && priceData.length > 0);
const displayCount = 60;

const candles =
    hasRealData && priceData
        ? priceData.slice(-displayCount).map(r => ({
              o: r.Open,
              c: r.Close,
              h: r.High,
              l: r.Low,
              vol: r.Volume,
              bull: r.Close >= r.Open,
              date: r.Date,
          }))
        : (() => {
              const baseP = price > 0 ? price : 100;
              return Array.from({ length: 30 }, (_, i) => {
                  const drift = (i - 15) * 0.3 + (Math.random() - 0.5) * 5;
                  const o = baseP + drift + (Math.random() - 0.5) * 3;
                  const c = o + (Math.random() - 0.5) * 4;
                  const h = Math.max(o, c) + Math.random() * 2;
                  const l = Math.min(o, c) - Math.random() * 2;
                  const vol = Math.floor(Math.random() * 30000) + 5000;
                  return {
                      o: +o.toFixed(2),
                      c: +c.toFixed(2),
                      h: +h.toFixed(2),
                      l: +l.toFixed(2),
                      vol,
                      bull: c >= o,
                      date: '',
                  };
              });
          })();

const priceMax = Math.max(...candles.map(c => c.h));
const priceMin = Math.min(...candles.map(c => c.l));
const priceRange = priceMax - priceMin || 1;
const volMax = Math.max(...candles.map(c => c.vol), 1);

// SVG chart dimensions
const chartW = 800;
const chartH = 400;
const barW = (chartW / candles.length) * 0.7;
const gap = chartW / candles.length;

// Price mapping
const pToY = (p: number) => ((priceMax - p) / priceRange) * (chartH * 0.7) + 20;
const vToH = (v: number) => (v / volMax) * (chartH * 0.15);

import {
    calcMAPath,
    calcBollingerBands,
    calcRSI,
    calcMACD,
} from '../../utils/technical-indicators';

// ðŸ“ˆ MA Suite (5, 10, 20, 60)
const ma5Path = calcMAPath(candles, 5, gap, pToY);
const ma10Path = calcMAPath(candles, 10, gap, pToY);
const ma20Path = calcMAPath(candles, 20, gap, pToY);
const ma60Path = calcMAPath(candles, 60, gap, pToY);

// ðŸ› ï¸ Bollinger Bands (20, 2)
const bBands = calcBollingerBands(candles, gap, pToY);

// ðŸ“Š RSI Calculation (14)
const rsiValues = calcRSI(candles, 14);

// ðŸ“‰ MACD
const closes = candles.map(c => c.c);
const { difValues, deaValues, macdHist, macdMax } = calcMACD(closes);

// Technical confidence score
const lastCandle = candles[candles.length - 1];
const maAlignment = lastCandle.c > (closes[closes.length - 6] || 0) ? 1 : -1;
const rsiScore =
    rsiValues[rsiValues.length - 1] > 70 ? -1 : rsiValues[rsiValues.length - 1] < 30 ? 1 : 0;
const strength = maAlignment + rsiScore;

const showNoData = price <= 0;
---

<div class="relative h-[calc(100dvh-280px)] min-h-[500px] bg-[#050914] rounded-xl overflow-hidden">
    <TechToolbar timeframes={timeframes} overlays={overlays} />

    <!-- Sub-indicator toggles (top-right) -->
    <div
        class="absolute top-4 right-4 z-40 flex items-center gap-1 px-3 py-1.5 rounded-full bg-surface/70 backdrop-blur-md border border-white/[0.08]"
    >
        {
            subIndicators.map((ind, i) => (
                <button
                    class:list={[
                        'px-2.5 py-1 rounded-full text-[10px] font-mono font-bold transition-all',
                        i === 0
                            ? 'bg-accent/20 text-accent'
                            : 'text-text-muted hover:text-text-secondary',
                    ]}
                >
                    {ind}
                </button>
            ))
        }
    </div>

    <PriceLabels priceMax={priceMax} priceMin={priceMin} />

    <TechnicalLegend
        lastCandle={lastCandle}
        strength={strength}
        rsiValue={rsiValues[rsiValues.length - 1]}
    />

    <!-- Main Chart Canvas -->
    <TechnicalChart
        candles={candles}
        chartW={chartW}
        chartH={chartH}
        gap={gap}
        barW={barW}
        pToY={pToY}
        vToH={vToH}
        ma5Path={ma5Path}
        ma10Path={ma10Path}
        ma20Path={ma20Path}
        ma60Path={ma60Path}
        bBands={bBands}
        hasRealData={hasRealData}
    />

    <!-- Indicators Strip (MACD / RSI Toggleable) -->
    <div
        class="indicator-container h-[140px] px-10 border-t border-white/[0.05] bg-black/20 flex flex-col relative"
        id="indicator-module"
    >
        <!-- MACD View -->
        <IndicatorMacd
            chartW={chartW}
            gap={gap}
            barW={barW}
            macdHist={macdHist}
            macdMax={macdMax}
            difValues={difValues}
            deaValues={deaValues}
        />

        <!-- RSI View -->
        <IndicatorRsi chartW={chartW} gap={gap} rsiValues={rsiValues} />
    </div>

    <!-- Styles for Toggling -->
    <style>
        .indicator-view.hidden {
            display: none !important;
        }
        .indicator-view.active {
            display: flex !important;
        }
    </style>

    <script>
        const container = document.getElementById('indicator-module');
        if (container) {
            container.addEventListener('click', e => {
                const target = e.target as HTMLElement;
                if (target.classList.contains('indicator-switch')) {
                    const to = target.getAttribute('data-to');
                    const macd = document.getElementById('view-macd');
                    const rsi = document.getElementById('view-rsi');
                    if (to === 'rsi' && macd && rsi) {
                        macd.classList.add('hidden');
                        macd.classList.remove('active');
                        rsi.classList.remove('hidden');
                        rsi.classList.add('active');
                    } else if (to === 'macd' && macd && rsi) {
                        rsi.classList.add('hidden');
                        rsi.classList.remove('active');
                        macd.classList.remove('hidden');
                        macd.classList.add('active');
                    }
                }
            });
        }
    </script>

    <!-- No data overlay -->
    {
        showNoData && (
            <div class="absolute inset-0 flex flex-col items-center justify-center bg-[#050914]/95 z-50 backdrop-blur-sm">
                <div class="w-12 h-12 border-2 border-accent/20 border-t-accent rounded-full animate-spin mb-4" />
                <p class="text-xs font-mono text-white/40 uppercase tracking-[0.3em]">
                    Synching Market Nodes...
                </p>
            </div>
        )
    }
</div>
