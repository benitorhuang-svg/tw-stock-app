---
import type { StockData } from '../../data/stocks';
import { formatChange } from '../../data/stocks';

interface Props {
    stock: StockData;
    variant?: 'default' | 'compact' | 'detailed' | 'heatmap';
    showWatchlistBtn?: boolean;
}

const { stock, variant = 'default', showWatchlistBtn = true } = Astro.props;

// Heatmap Color Logic
let heatClass = '';
if (variant === 'heatmap') {
    const p = stock.changePercent;
    if (p > 3) heatClass = 'bg-green-dark';
    else if (p > 1) heatClass = 'bg-green-mid';
    else if (p > 0) heatClass = 'bg-green-soft';
    else if (p === 0) heatClass = 'bg-gray';
    else if (p > -1) heatClass = 'bg-red-soft';
    else if (p > -3) heatClass = 'bg-red-mid';
    else heatClass = 'bg-red-dark';
}
---

<a
    href={`/stocks/${stock.symbol}`}
    class={`stock-card variant-${variant} ${heatClass}`}
    data-symbol={stock.symbol}
>
    <!-- Watchlist Button (Star) -->
    {
        showWatchlistBtn && (
            <button
                class="watchlist-btn"
                data-symbol={stock.symbol}
                title="加入自選股"
                onclick="event.preventDefault(); event.stopPropagation();"
            >
                <span class="star">☆</span>
            </button>
        )
    }

    <!-- Info Section -->
    <div class="info-group">
        <span class="symbol-badge">{stock.symbol}</span>
        <span class="stock-name">{stock.name}</span>
    </div>

    <!-- Sparkline Section (Trend Visual) -->
    {
        variant !== 'heatmap' && (
            <div class="sparkline-box">
                {stock.change >= 0 ? (
                    /* Gainer: Trend Up visual */
                    <>
                        <div class="spark-bar pos" style="height: 40%; left: 0" />
                        <div class="spark-bar pos" style="height: 50%; left: 20%" />
                        <div class="spark-bar pos" style="height: 45%; left: 40%" />
                        <div class="spark-bar pos" style="height: 70%; left: 60%" />
                        <div class="spark-bar pos" style="height: 90%; left: 80%" />
                    </>
                ) : (
                    /* Loser: Trend Down visual */
                    <>
                        <div class="spark-bar neg" style="height: 80%; left: 0" />
                        <div class="spark-bar neg" style="height: 60%; left: 20%" />
                        <div class="spark-bar neg" style="height: 70%; left: 40%" />
                        <div class="spark-bar neg" style="height: 40%; left: 60%" />
                        <div class="spark-bar neg" style="height: 30%; left: 80%" />
                    </>
                )}
            </div>
        )
    }

    <!-- Price Section -->
    <div class="price-group">
        <span class="stock-price">{stock.price.toFixed ? stock.price.toFixed(2) : stock.price}</span
        >
        <span class={`stock-change ${stock.change >= 0 ? 'pos' : 'neg'}`}>
            {stock.change >= 0 ? '+' : ''}{
                stock.changePercent.toFixed ? stock.changePercent.toFixed(2) : stock.changePercent
            }%
        </span>
    </div>

    <!-- Detailed View Metrics -->
    {
        variant === 'detailed' && (
            <div class="detail-metrics">
                <div class="metric">
                    <span class="metric-label">PE Ratio</span>
                    <span class="metric-value">{stock.pe}x</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Div. Yield</span>
                    <span class="metric-value pos">{stock.yield}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ROE</span>
                    <span class="metric-value">{stock.roe}%</span>
                </div>
            </div>
        )
    }
</a>

<style>
    .stock-card {
        display: grid;
        grid-template-columns: 32px 1fr 100px 90px; /* Star | Info | Spark | Price */
        align-items: center;
        width: 100%;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.01);
        border-bottom: 1px solid var(--c-border);
        text-decoration: none;
        transition: var(--transition-premium);
        position: relative;
        overflow: hidden;
        height: 64px;
    }

    .stock-card:hover {
        background: var(--c-bg-glass-hover);
        padding-left: 20px;
    }

    /* Holographic Foil Sweep */
    .stock-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
            110deg,
            transparent 30%,
            rgba(var(--c-accent-rgb), 0.05) 45%,
            rgba(255, 255, 255, 0.1) 50%,
            rgba(var(--c-accent-rgb), 0.05) 55%,
            transparent 70%
        );
        transform: translateX(-100%);
        transition: transform 1.2s var(--ease-out);
        pointer-events: none;
        z-index: 1;
    }

    .stock-card:hover::after {
        transform: translateX(100%);
    }

    .stock-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--c-accent);
        opacity: 0;
        transition: var(--transition-premium);
        z-index: 2;
    }

    .stock-card:hover::before {
        opacity: 1;
    }

    /* Info Group */
    .info-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .symbol-badge {
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        font-weight: 700;
        color: var(--c-accent);
        letter-spacing: 0.5px;
    }

    .stock-name {
        font-size: 13px;
        font-weight: 700;
        color: var(--c-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Sparkline - Bar Chart Style for Visibility */
    .sparkline-box {
        height: 24px;
        width: 100%;
        max-width: 80px;
        margin: 0 16px;
        position: relative;
        display: flex;
        align-items: flex-end;
        gap: 2px;
    }

    .spark-bar {
        width: 16%;
        position: absolute;
        bottom: 0;
        background: currentColor;
        opacity: 0.4;
        border-radius: 2px 2px 0 0;
    }

    .spark-bar.pos {
        background: var(--c-success);
    }
    .spark-bar.neg {
        background: var(--c-danger);
    }

    /* Price Group */
    .price-group {
        text-align: right;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .stock-price {
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
        font-weight: 700;
        color: var(--c-text-primary);
    }

    .stock-change {
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        font-weight: 700;
    }

    .pos {
        color: var(--c-success);
    }
    .neg {
        color: var(--c-danger);
    }

    /* Watchlist Button */
    .watchlist-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
        z-index: 10;
        opacity: 0.5;
        transition: all 0.2s;
        margin-right: 8px;
    }

    .watchlist-btn:hover,
    .watchlist-btn.active {
        opacity: 1;
        transform: scale(1.1);
    }

    .star {
        font-size: 16px;
        line-height: 1;
        color: #ddd; /* Visible white/grey */
    }

    .watchlist-btn.active .star {
        color: #fbbf24; /* Gold */
        text-shadow: 0 0 5px rgba(251, 191, 36, 0.5);
    }

    /* Detailed Variant */
    .variant-detailed {
        grid-template-columns: 32px 1fr 100px 90px;
        gap: 8px 16px;
        height: auto;
        padding: 16px;
    }

    .detail-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-column: 1 / -1;
        gap: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--c-border);
        margin-top: 8px;
    }

    .metric {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .metric-label {
        font-size: 9px;
        font-weight: 800;
        color: var(--c-text-muted);
        text-transform: uppercase;
    }

    .metric-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        font-weight: 700;
    }

    /* Heatmap Block Variant */
    .variant-heatmap {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1;
        padding: 8px;
        border-radius: 4px;
        transition: transform 0.2s;
    }

    .variant-heatmap:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: var(--shadow-panel);
    }
</style>

<script>
    document.querySelectorAll('.watchlist-btn').forEach(btn => {
        const symbol = btn.getAttribute('data-symbol');
        if (!symbol) return;

        const watchlist = JSON.parse(localStorage.getItem('tw-watchlist') || '[]');

        if (watchlist.includes(symbol)) {
            btn.classList.add('active');
            const star = btn.querySelector('.star');
            if (star) star.textContent = '★';
        }

        btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            const currentWatchlist = JSON.parse(localStorage.getItem('tw-watchlist') || '[]');
            const index = currentWatchlist.indexOf(symbol);
            const star = btn.querySelector('.star');

            if (index >= 0) {
                currentWatchlist.splice(index, 1);
                btn.classList.remove('active');
                if (star) star.textContent = '☆';
            } else {
                currentWatchlist.push(symbol);
                btn.classList.add('active');
                if (star) star.textContent = '★';
            }

            localStorage.setItem('tw-watchlist', JSON.stringify(currentWatchlist));
            window.dispatchEvent(
                new CustomEvent('watchlist-updated', { detail: currentWatchlist })
            );
        });
    });
</script>
