---
/**
 * TabOverview.astro â€” Overview Tab Content (002-tab-overview)
 * Intraday chart, order book, trade tape, AI quick insights
 */
import IntradayChart from '../molecules/IntradayChart.astro';
import OrderBook from '../molecules/OrderBook.astro';
import TradeTape from '../molecules/TradeTape.astro';
import AiQuickInsights from '../molecules/AiQuickInsights.astro';
import type { PriceHistoryRecord } from '../../types/stock';

interface Props {
    symbol: string;
    price: number;
    change: number;
    changePercent: number;
    open: number;
    high: number;
    low: number;
    volume: number;
    priceData?: PriceHistoryRecord[];
}

const { symbol, price, change, priceData = [] } = Astro.props;

const isBullish = change > 0;
const isBearish = change < 0;
const priceColor = isBullish ? 'text-bullish' : isBearish ? 'text-bearish' : 'text-text-muted';

// Simulated order book data (5 levels)
const basePrice = price > 0 ? price : 100;
const bidPrices = Array.from({ length: 5 }, (_, i) => +(basePrice - (i + 1) * 0.5).toFixed(2));
const askPrices = Array.from({ length: 5 }, (_, i) => +(basePrice + (i + 1) * 0.5).toFixed(2));
const bidVolumes = [385, 242, 178, 156, 312];
const askVolumes = [290, 195, 410, 223, 167];
const maxBookVol = Math.max(...bidVolumes, ...askVolumes);

// Simulated trade tape
const tradeTape = Array.from({ length: 12 }, (_, i) => ({
    time: `13:${String(30 - i * 2).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
    price: +(basePrice + (Math.random() - 0.5) * 3).toFixed(2),
    vol: Math.floor(Math.random() * 80) + 1,
    type: (Math.random() > 0.5 ? 'buy' : 'sell') as 'buy' | 'sell',
}));

// AI Insights mock
const insights = [
    `${symbol} è¿‘æœŸèµ°å‹¢å${isBullish ? 'å¤š' : 'ç©º'}ï¼ŒçŸ­ç·šç•™æ„é‡èƒ½è®ŠåŒ–ã€‚`,
    `å¤–è³‡è¿‘ 3 æ—¥ç´¯è¨ˆ${isBullish ? 'è²·è¶…' : 'è³£è¶…'}ï¼Œç±Œç¢¼é¢${isBullish ? 'åæ­£é¢' : 'éœ€ç•™æ„'}ã€‚`,
    `æŠ€è¡“é¢ KD æŒ‡æ¨™${isBullish ? 'å‘ˆç¾é»ƒé‡‘äº¤å‰' : 'æ¥è¿‘è¶…è³£å€'}ï¼Œå¯è§€å¯Ÿåå½ˆè¨Šè™Ÿã€‚`,
];
---

<div class="space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left: Intraday Chart Area -->
        <div class="lg:col-span-8 space-y-4">
            <!-- Intraday Chart -->
            <IntradayChart price={price} isBullish={isBullish} isBearish={isBearish} priceData={priceData} />

            <!-- Day Trading Momentum Pulse (Skill #7) -->
            <div class="glass-card p-5 border-l-4 border-accent relative overflow-hidden group">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-accent/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"
                >
                </div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="flex flex-col">
                        <h4
                            class="text-[10px] font-mono font-black text-accent uppercase tracking-[0.2em]"
                        >
                            Momentum_Pulse
                        </h4>
                        <p class="text-[9px] text-text-muted mt-0.5 uppercase tracking-widest">
                            Intraday Attack Velocity
                        </p>
                    </div>
                    <div
                        class="px-3 py-1 rounded bg-accent/10 border border-accent/20 text-[10px] font-mono font-bold text-accent animate-pulse"
                    >
                        LIVE_SCANNING
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 relative z-10">
                    <div class="space-y-1">
                        <span class="text-[9px] text-text-muted uppercase font-bold tracking-widest"
                            >Flow_Strength</span
                        >
                        <div
                            class="flex items-end gap-2 text-xl font-mono font-black {isBullish ? 'text-bullish' : 'text-bearish'}"
                        >
                            {isBullish ? 'âš¡88' : 'ğŸ“‰24'}
                            <span class="text-[10px] opacity-40 mb-1 tracking-tighter">/100</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <span class="text-[9px] text-text-muted uppercase font-bold tracking-widest"
                            >Volatility_Index</span
                        >
                        <div class="text-xl font-mono font-black text-text-primary">1.24%</div>
                    </div>
                    <div class="space-y-1">
                        <span class="text-[9px] text-text-muted uppercase font-bold tracking-widest"
                            >Tick_Speed</span
                        >
                        <div class="text-xl font-mono font-black text-warning">Rapid</div>
                    </div>
                    <div class="space-y-1">
                        <span class="text-[9px] text-text-muted uppercase font-bold tracking-widest"
                            >Volume_Ratio</span
                        >
                        <div class="text-xl font-mono font-black text-accent">1.82x</div>
                    </div>
                </div>

                <!-- Momentum Meter -->
                <div class="mt-6 h-1 w-full bg-surface-hover rounded-full overflow-hidden flex">
                    <div class="h-full bg-bullish transition-all duration-1000" style="width: 65%;">
                    </div>
                    <div
                        class="h-full bg-bearish/30 transition-all duration-1000"
                        style="width: 35%;"
                    >
                    </div>
                </div>
            </div>

            <!-- AI Quick Insights -->
            <AiQuickInsights symbol={symbol} insights={insights} />
        </div>

        <!-- Right: Order Book + Trade Tape -->
        <div class="lg:col-span-4 space-y-4">
            <!-- Order Book -->
            <OrderBook
                price={price}
                change={change}
                isBullish={isBullish}
                isBearish={isBearish}
                priceColor={priceColor}
                askPrices={askPrices}
                askVolumes={askVolumes}
                bidPrices={bidPrices}
                bidVolumes={bidVolumes}
                maxBookVol={maxBookVol}
            />

            <!-- Trade Tape -->
            <TradeTape tradeTape={tradeTape} />
        </div>
    </div>
</div>

<script define:vars={{ symbol }} is:inline>
    // Fetch live quote via the unified intraday API (includes price in meta)
    async function fetchLiveQuote() {
        try {
            const res = await fetch(`/api/intraday?symbol=${encodeURIComponent(symbol)}`);
            if (!res.ok) return;
            const json = await res.json();
            if (json.status !== 'success' || !json.meta) return;

            const price = json.meta.prevClose;
            // Use last data point price if available (more current than prevClose)
            const lastPoint = json.data?.[json.data.length - 1];
            const currentPrice = lastPoint?.price ?? price;
            if (!currentPrice) return;

            // Update all price displays in the parent page
            const priceTag = document.querySelector('[data-tab-content="overview"] .data-value');
            if (priceTag) {
                priceTag.textContent = currentPrice.toFixed(2);
            }

            // Update the floating price tag in the chart
            const floatingPrice = document.querySelector('#chart-area .font-mono.font-bold');
            if (floatingPrice) {
                floatingPrice.textContent = currentPrice.toFixed(2);
            }

            // Update LIVE indicator timestamp
            const liveLabel = document.querySelector(
                '[data-tab-content="overview"] .terminal-label'
            );
            if (liveLabel && liveLabel.textContent?.includes('æ—¥å…§èµ°å‹¢')) {
                const timeStr = lastPoint
                    ? new Date(lastPoint.time).toLocaleTimeString('zh-TW', {
                          hour: '2-digit',
                          minute: '2-digit',
                      })
                    : '';
                const statusEl = liveLabel.parentElement?.querySelector('.text-text-muted');
                if (statusEl && timeStr) statusEl.textContent = `å³æ™‚ ${timeStr}`;
            }
        } catch {
            // silently fail - SSR data is still shown
        }
    }

    // Fetch once on tab visibility, then every 60s
    if (document.querySelector('[data-tab-content="overview"]:not(.hidden)')) {
        fetchLiveQuote();
    }
    const refreshInterval = setInterval(fetchLiveQuote, 60000);
    document.addEventListener('astro:before-swap', () => clearInterval(refreshInterval), {
        once: true,
    });
</script>
