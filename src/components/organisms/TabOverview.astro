---
/**
 * TabOverview.astro â€” Overview Tab Content (002-tab-overview)
 * Intraday chart, order book, trade tape, AI quick insights
 */
interface Props {
    symbol: string;
    price: number;
    change: number;
    changePercent: number;
    open: number;
    high: number;
    low: number;
    volume: number;
}

const { symbol, price, change, changePercent, open, high, low, volume } = Astro.props;

const isBullish = change > 0;
const isBearish = change < 0;
const priceColor = isBullish ? 'text-bullish' : isBearish ? 'text-bearish' : 'text-text-muted';

// Simulated order book data (5 levels)
const basePrice = price > 0 ? price : 100;
const bidPrices = Array.from({ length: 5 }, (_, i) => +(basePrice - (i + 1) * 0.5).toFixed(2));
const askPrices = Array.from({ length: 5 }, (_, i) => +(basePrice + (i + 1) * 0.5).toFixed(2));
const bidVolumes = [385, 242, 178, 156, 312];
const askVolumes = [290, 195, 410, 223, 167];
const maxBookVol = Math.max(...bidVolumes, ...askVolumes);

// Simulated trade tape
const tradeTape = Array.from({ length: 12 }, (_, i) => ({
    time: `13:${String(30 - i * 2).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
    price: +(basePrice + (Math.random() - 0.5) * 3).toFixed(2),
    vol: Math.floor(Math.random() * 80) + 1,
    type: Math.random() > 0.5 ? 'buy' : 'sell',
}));

// AI Insights mock
const insights = [
    `${symbol} è¿‘æœŸèµ°å‹¢å${isBullish ? 'å¤š' : 'ç©º'}ï¼ŒçŸ­ç·šç•™æ„é‡èƒ½è®ŠåŒ–ã€‚`,
    `å¤–è³‡è¿‘ 3 æ—¥ç´¯è¨ˆ${isBullish ? 'è²·è¶…' : 'è³£è¶…'}ï¼Œç±Œç¢¼é¢${isBullish ? 'åæ­£é¢' : 'éœ€ç•™æ„'}ã€‚`,
    `æŠ€è¡“é¢ KD æŒ‡æ¨™${isBullish ? 'å‘ˆç¾é»ƒé‡‘äº¤å‰' : 'æ¥è¿‘è¶…è³£å€'}ï¼Œå¯è§€å¯Ÿåå½ˆè¨Šè™Ÿã€‚`,
];
---

<div class="space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left: Intraday Chart Area -->
        <div class="lg:col-span-8 space-y-4">
            <!-- Intraday Chart -->
            <div class="glass-card p-6 h-[360px] flex flex-col relative overflow-hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="terminal-label">æ—¥å…§èµ°å‹¢</h3>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-bullish animate-glow-pulse"></span>
                        <span class="text-[10px] font-mono text-text-muted tracking-wider"
                            >å³æ™‚é€£ç·š</span
                        >
                    </div>
                </div>
                <!-- Simulated chart area with CSS gradient -->
                <div class="flex-1 relative rounded-lg overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-accent/5 to-transparent">
                    </div>
                    <!-- Chart grid lines -->
                    <div class="absolute inset-0 flex flex-col justify-between py-4">
                        {
                            [0, 1, 2, 3, 4].map(() => (
                                <div class="border-b border-white/[0.03] w-full" />
                            ))
                        }
                    </div>
                    <!-- Price line simulation via SVG -->
                    <svg
                        class="absolute inset-0 w-full h-full"
                        preserveAspectRatio="none"
                        viewBox="0 0 400 200"
                    >
                        <defs>
                            <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                                <stop
                                    offset="0%"
                                    stop-color={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                                    stop-opacity="0.3"></stop>
                                <stop
                                    offset="100%"
                                    stop-color={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                                    stop-opacity="0"></stop>
                            </linearGradient>
                        </defs>
                        <path
                            d="M0,120 Q30,115 60,100 T120,90 T180,95 T240,70 T300,60 T360,65 T400,50"
                            fill="none"
                            stroke={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                            stroke-width="2"></path>
                        <path
                            d="M0,120 Q30,115 60,100 T120,90 T180,95 T240,70 T300,60 T360,65 T400,50 L400,200 L0,200 Z"
                            fill="url(#chartGrad)"></path>
                    </svg>
                    <!-- Floating price tag -->
                    <div
                        class:list={[
                            'absolute right-4 top-1/4 px-3 py-1.5 rounded-md font-mono text-sm font-bold',
                            isBullish
                                ? 'bg-bullish/20 text-bullish shadow-[0_0_15px_hsl(142,71%,45%,0.3)]'
                                : isBearish
                                  ? 'bg-bearish/20 text-bearish shadow-[0_0_15px_hsl(346,77%,50%,0.3)]'
                                  : 'bg-surface text-text-muted',
                        ]}
                    >
                        {price > 0 ? price.toFixed(2) : 'â€”'}
                    </div>
                </div>
            </div>

            <!-- AI Quick Insights -->
            <div class="glass-card p-5 border-t-2 border-accent/30">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-base">ğŸ¤–</span>
                    <h3 class="terminal-label">AI å¿«è©•</h3>
                    <span class="w-2 h-2 bg-accent rounded-full animate-glow-pulse"></span>
                </div>
                <div class="space-y-2.5">
                    {
                        insights.map((text, i) => (
                            <p
                                class="text-sm text-text-secondary leading-relaxed flex items-start gap-2"
                                style={`animation: fade-up 0.5s cubic-bezier(0.16,1,0.3,1) ${i * 150}ms both`}
                            >
                                <span class="text-accent mt-0.5 flex-shrink-0">â€¢</span>
                                <span>{text}</span>
                            </p>
                        ))
                    }
                </div>
            </div>
        </div>

        <!-- Right: Order Book + Trade Tape -->
        <div class="lg:col-span-4 space-y-4">
            <!-- Order Book -->
            <div class="glass-card p-4">
                <h3 class="terminal-label mb-3">äº”æª”å ±åƒ¹</h3>
                <!-- Asks (sell side) - reversed -->
                <div class="space-y-0.5 mb-2">
                    {
                        askPrices
                            .slice()
                            .reverse()
                            .map((p, i) => {
                                const vol = askVolumes[4 - i];
                                const pct = (vol / maxBookVol) * 100;
                                return (
                                    <div class="relative flex items-center justify-between px-2 py-1 rounded text-xs font-mono">
                                        <div
                                            class="absolute inset-y-0 right-0 bg-bearish/10 rounded"
                                            style={`width: ${pct}%`}
                                        />
                                        <span class="relative text-bearish">{p.toFixed(2)}</span>
                                        <span class="relative text-text-muted">{vol}</span>
                                    </div>
                                );
                            })
                    }
                </div>
                <!-- Current price divider -->
                <div class="flex items-center gap-2 py-1.5 px-2 my-1 bg-white/[0.03] rounded">
                    <span class:list={['font-mono font-bold text-sm', priceColor]}>
                        {price > 0 ? price.toFixed(2) : 'â€”'}
                    </span>
                    <span class:list={['text-[10px] font-mono', priceColor]}>
                        {isBullish ? 'â–²' : isBearish ? 'â–¼' : 'â€”'}{
                            change !== 0 ? Math.abs(change).toFixed(2) : ''
                        }
                    </span>
                </div>
                <!-- Bids (buy side) -->
                <div class="space-y-0.5 mt-2">
                    {
                        bidPrices.map((p, i) => {
                            const vol = bidVolumes[i];
                            const pct = (vol / maxBookVol) * 100;
                            return (
                                <div class="relative flex items-center justify-between px-2 py-1 rounded text-xs font-mono">
                                    <div
                                        class="absolute inset-y-0 right-0 bg-bullish/10 rounded"
                                        style={`width: ${pct}%`}
                                    />
                                    <span class="relative text-bullish">{p.toFixed(2)}</span>
                                    <span class="relative text-text-muted">{vol}</span>
                                </div>
                            );
                        })
                    }
                </div>
            </div>

            <!-- Trade Tape -->
            <div class="glass-card p-4 max-h-[300px] overflow-y-auto">
                <h3 class="terminal-label mb-3">é€ç­†æ˜ç´°</h3>
                <div class="space-y-0.5">
                    {
                        tradeTape.map(t => (
                            <div class="flex items-center justify-between text-xs font-mono px-1 py-1 rounded hover:bg-white/[0.02] transition-colors">
                                <span class="text-text-muted">{t.time}</span>
                                <span
                                    class:list={[
                                        t.type === 'buy' ? 'text-bullish' : 'text-bearish',
                                    ]}
                                >
                                    {t.price.toFixed(2)}
                                </span>
                                <span class="text-text-muted">{t.vol}</span>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ symbol }}>
    // Fetch live quote for the current stock and update the price display
    async function fetchLiveQuote() {
        try {
            const res = await fetch(`/api/live-quote.json?symbol=${encodeURIComponent(symbol)}`);
            if (!res.ok) return;
            const data = await res.json();
            if (!data.price) return;

            // Update all price displays in the parent page
            const priceTag = document.querySelector('[data-tab-content="overview"] .data-value');
            if (priceTag) {
                priceTag.textContent = data.price.toFixed(2);
            }

            // Update the floating price tag in the chart
            const floatingPrice = document.querySelector('#chart-area .font-mono.font-bold');
            if (floatingPrice) {
                floatingPrice.textContent = data.price.toFixed(2);
            }

            // Update LIVE indicator timestamp
            const liveLabel = document.querySelector(
                '[data-tab-content="overview"] .terminal-label'
            );
            if (liveLabel && liveLabel.textContent?.includes('æ—¥å…§èµ°å‹¢')) {
                const timeStr = new Date(data.time).toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                });
                const statusEl = liveLabel.parentElement?.querySelector('.text-text-muted');
                if (statusEl) statusEl.textContent = `å³æ™‚ ${timeStr}`;
            }
        } catch {
            // silently fail - SSR data is still shown
        }
    }

    // Fetch once on tab visibility, then every 60s
    if (document.querySelector('[data-tab-content="overview"]:not(.hidden)')) {
        fetchLiveQuote();
    }
    const refreshInterval = setInterval(fetchLiveQuote, 60000);
    document.addEventListener('astro:before-swap', () => clearInterval(refreshInterval), {
        once: true,
    });
</script>
