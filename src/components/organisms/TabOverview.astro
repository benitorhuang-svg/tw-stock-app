---
/**
 * TabOverview.astro — Overview Tab Content (002-tab-overview)
 * Intraday chart, order book, trade tape, AI quick insights
 */
import IntradayChart from '../molecules/IntradayChart.astro';
import OrderBook from '../molecules/OrderBook.astro';
import TradeTape from '../molecules/TradeTape.astro';
import AiQuickInsights from '../molecules/AiQuickInsights.astro';

interface Props {
    symbol: string;
    price: number;
    change: number;
    changePercent: number;
    open: number;
    high: number;
    low: number;
    volume: number;
}

const { symbol, price, change } = Astro.props;

const isBullish = change > 0;
const isBearish = change < 0;
const priceColor = isBullish ? 'text-bullish' : isBearish ? 'text-bearish' : 'text-text-muted';

// Simulated order book data (5 levels)
const basePrice = price > 0 ? price : 100;
const bidPrices = Array.from({ length: 5 }, (_, i) => +(basePrice - (i + 1) * 0.5).toFixed(2));
const askPrices = Array.from({ length: 5 }, (_, i) => +(basePrice + (i + 1) * 0.5).toFixed(2));
const bidVolumes = [385, 242, 178, 156, 312];
const askVolumes = [290, 195, 410, 223, 167];
const maxBookVol = Math.max(...bidVolumes, ...askVolumes);

// Simulated trade tape
const tradeTape = Array.from({ length: 12 }, (_, i) => ({
    time: `13:${String(30 - i * 2).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
    price: +(basePrice + (Math.random() - 0.5) * 3).toFixed(2),
    vol: Math.floor(Math.random() * 80) + 1,
    type: (Math.random() > 0.5 ? 'buy' : 'sell') as 'buy' | 'sell',
}));

// AI Insights mock
const insights = [
    `${symbol} 近期走勢偏${isBullish ? '多' : '空'}，短線留意量能變化。`,
    `外資近 3 日累計${isBullish ? '買超' : '賣超'}，籌碼面${isBullish ? '偏正面' : '需留意'}。`,
    `技術面 KD 指標${isBullish ? '呈現黃金交叉' : '接近超賣區'}，可觀察反彈訊號。`,
];
---

<div class="space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left: Intraday Chart Area -->
        <div class="lg:col-span-8 space-y-4">
            <!-- Intraday Chart -->
            <IntradayChart price={price} isBullish={isBullish} isBearish={isBearish} />

            <!-- AI Quick Insights -->
            <AiQuickInsights symbol={symbol} insights={insights} />
        </div>

        <!-- Right: Order Book + Trade Tape -->
        <div class="lg:col-span-4 space-y-4">
            <!-- Order Book -->
            <OrderBook
                price={price}
                change={change}
                isBullish={isBullish}
                isBearish={isBearish}
                priceColor={priceColor}
                askPrices={askPrices}
                askVolumes={askVolumes}
                bidPrices={bidPrices}
                bidVolumes={bidVolumes}
                maxBookVol={maxBookVol}
            />

            <!-- Trade Tape -->
            <TradeTape tradeTape={tradeTape} />
        </div>
    </div>
</div>

<script define:vars={{ symbol }} is:inline>
    // Fetch live quote via the unified intraday API (includes price in meta)
    async function fetchLiveQuote() {
        try {
            const res = await fetch(`/api/intraday?symbol=${encodeURIComponent(symbol)}`);
            if (!res.ok) return;
            const json = await res.json();
            if (json.status !== 'success' || !json.meta) return;

            const price = json.meta.prevClose;
            // Use last data point price if available (more current than prevClose)
            const lastPoint = json.data?.[json.data.length - 1];
            const currentPrice = lastPoint?.price ?? price;
            if (!currentPrice) return;

            // Update all price displays in the parent page
            const priceTag = document.querySelector('[data-tab-content="overview"] .data-value');
            if (priceTag) {
                priceTag.textContent = currentPrice.toFixed(2);
            }

            // Update the floating price tag in the chart
            const floatingPrice = document.querySelector('#chart-area .font-mono.font-bold');
            if (floatingPrice) {
                floatingPrice.textContent = currentPrice.toFixed(2);
            }

            // Update LIVE indicator timestamp
            const liveLabel = document.querySelector(
                '[data-tab-content="overview"] .terminal-label'
            );
            if (liveLabel && liveLabel.textContent?.includes('日內走勢')) {
                const timeStr = lastPoint
                    ? new Date(lastPoint.time).toLocaleTimeString('zh-TW', {
                          hour: '2-digit',
                          minute: '2-digit',
                      })
                    : '';
                const statusEl = liveLabel.parentElement?.querySelector('.text-text-muted');
                if (statusEl && timeStr) statusEl.textContent = `即時 ${timeStr}`;
            }
        } catch {
            // silently fail - SSR data is still shown
        }
    }

    // Fetch once on tab visibility, then every 60s
    if (document.querySelector('[data-tab-content="overview"]:not(.hidden)')) {
        fetchLiveQuote();
    }
    const refreshInterval = setInterval(fetchLiveQuote, 60000);
    document.addEventListener('astro:before-swap', () => clearInterval(refreshInterval), {
        once: true,
    });
</script>
