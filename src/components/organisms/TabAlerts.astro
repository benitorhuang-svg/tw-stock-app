---
/**
 * TabAlerts.astro ??AI Report & Smart Alerts Tab (007-tab-alerts)
 * Sentiment gauge, AI analysis report, suggested alerts, custom rules
 */
import SentimentGauge from '../molecules/SentimentGauge.astro';
import NeuralHealthMonitor from '../molecules/NeuralHealthMonitor.astro';
import AiReportMatrix from '../molecules/AiReportMatrix.astro';
import StrategicActionMatrix from '../molecules/StrategicActionMatrix.astro';

interface Props {
    symbol: string;
    name: string;
    price: number;
    change: number;
    changePercent: number;
}
const { symbol, price } = Astro.props;
---

<div class="space-y-6 animate-fade-up">
    <!-- Risk Context & Position Sizing HUD (Skill #8) -->
    <div class="glass-card p-6 border-l-4 border-bearish relative overflow-hidden group shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-r from-bearish/10 to-transparent"></div>
        <div class="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
            <div class="flex-1">
                <div class="flex flex-col mb-4">
                    <h4
                        class="text-[10px] font-mono font-black text-bearish uppercase tracking-[0.3em]"
                    >
                        Risk_Management_Protocol
                    </h4>
                    <p class="text-[9px] text-text-muted mt-0.5 uppercase tracking-widest">
                        Volatility analysis & exit strategy protection
                    </p>
                </div>
                <div class="flex items-center gap-6">
                    <div class="space-y-1 text-center md:text-left">
                        <span class="text-[9px] font-mono text-text-muted uppercase"
                            >Recommended_Stop</span
                        >
                        <div class="text-3xl font-mono font-black text-bearish">
                            {(price * 0.92).toFixed(1)}
                            <span class="text-xs opacity-60 ml-0.5 font-bold">(-8%)</span>
                        </div>
                    </div>
                    <div class="w-px h-10 bg-border/20"></div>
                    <div class="space-y-1 text-center md:text-left">
                        <span class="text-[9px] font-mono text-text-muted uppercase"
                            >Sizing_Suggestion</span
                        >
                        <div class="text-3xl font-mono font-black text-text-primary">
                            15.4% <span class="text-xs opacity-40 ml-0.5 font-bold">CAPITAL</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full md:w-auto">
                <div class="p-4 rounded-xl bg-surface/50 border border-border/20 backdrop-blur-sm">
                    <div class="text-[9px] font-mono font-bold text-text-muted uppercase mb-1">
                        ATR (14D)
                    </div>
                    <div class="text-lg font-mono font-black text-text-primary">12.5</div>
                </div>
                <div class="p-4 rounded-xl bg-surface/50 border border-border/20 backdrop-blur-sm">
                    <div class="text-[9px] font-mono font-bold text-text-muted uppercase mb-1">
                        Risk/Reward
                    </div>
                    <div class="text-lg font-mono font-black text-bullish">2.4:1</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6" id="ai-tab-root">
        <!-- Left: AI Report -->
        <div class="lg:col-span-7 space-y-4">
            <!-- Sentiment Gauge -->
            <SentimentGauge />

            <!-- AI Report Body -->
            <AiReportMatrix symbol={symbol} />
        </div>

        <!-- Right: Alert Center -->
        <div class="lg:col-span-5 space-y-4">
            <!-- Suggested Action Matrix -->
            <StrategicActionMatrix />

            <!-- Neural Health Monitor -->
            <NeuralHealthMonitor />
        </div>
    </div>

    <script is:inline define:vars={{ symbol }}>
        async function hydrate() {
            try {
                const res = await fetch(`/api/ai-report/${symbol}`);
                const data = await res.json();

                // 1. Update Gauge & Summary
                const score = document.getElementById('gauge-score')
                    ? 60 + Math.floor(Math.random() * 25)
                    : 75;
                const needle = document.getElementById('gauge-needle');
                const path = document.getElementById('gauge-path');
                const scoreDisplay = document.getElementById('gauge-score');
                const statusTag = document.getElementById('status-tag');
                const summary = document.getElementById('ai-summary');

                if (needle && path && scoreDisplay) {
                    const angle = (score / 100) * 180 - 90;
                    needle.style.transform = `rotate(${angle}deg)`;
                    const offset = 157 - (score / 100) * 157;
                    path.style.strokeDashoffset = offset;
                    scoreDisplay.innerText = score;
                    statusTag.innerText = score > 65 ? 'OPTIMIZED' : 'CAUTION';
                    statusTag.className = `px-2 py-0.5 rounded-full border text-[10px] animate-pulse ${score > 65 ? 'bg-bullish/10 border-bullish text-bullish' : 'bg-warning/10 border-warning text-warning'}`;
                }

                if (summary && data.reportSections[2]) {
                    summary.innerText = data.reportSections[2].content;
                }

                // 2. Update Report Sections
                const container = document.getElementById('report-content');
                if (container) {
                    container.innerHTML = data.reportSections
                        .map(
                            s => `
                    <div class="group">
                        <h4 class="text-[10px] font-mono font-bold text-accent uppercase tracking-widest mb-2 flex items-center gap-2">
                             <span class="w-1 h-3 bg-accent/40 rounded-full"></span> ${s.title}
                        </h4>
                        <div class="text-sm text-text-secondary leading-relaxed pl-3 border-l border-border/50 transition-all group-hover:border-accent/40">
                            ${s.content}
                        </div>
                    </div>
                `
                        )
                        .join('');
                }

                // 3. Update Alerts
                const alertsContainer = document.getElementById('alerts-container');
                if (alertsContainer) {
                    alertsContainer.innerHTML = data.suggestedAlerts
                        .map(
                            a => `
                    <div class="p-4 rounded-xl bg-surface-hover/20 border border-border/50 hover:border-accent/40 transition-all group cursor-pointer relative overflow-hidden">
                        <div class="absolute inset-0 bg-accent/[0.02] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="flex items-start justify-between relative">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${a.icon}</span>
                                    <span class="text-[10px] font-mono font-bold text-text-muted/70 uppercase group-hover:text-accent transition-colors">${a.insight}</span>
                                </div>
                                <p class="text-xs font-bold text-text-secondary">${a.rule}</p>
                                <p class="text-[9px] text-text-muted/70 font-mono">${a.action} ??READY</p>
                            </div>
                            <div class="w-8 h-8 rounded-full border border-border flex items-center justify-center text-text-muted/50 group-hover:border-accent group-hover:text-accent transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            </div>
                        </div>
                    </div>
                `
                        )
                        .join('');
                }

                const timestamp = document.getElementById('report-timestamp');
                if (timestamp)
                    timestamp.innerText = `Timestamp: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('AI Hydration Error:', e);
            }
        }
        hydrate();
    </script>
</div>
