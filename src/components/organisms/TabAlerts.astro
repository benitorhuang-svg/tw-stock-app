---
/**
 * TabAlerts.astro â€” AI Report & Smart Alerts Tab (007-tab-alerts)
 * Sentiment gauge, AI analysis report, suggested alerts, custom rules
 */
interface Props {
    symbol: string;
    name: string;
    price: number;
    change: number;
    changePercent: number;
}

const { symbol, name, price, change, changePercent } = Astro.props;

const isBullish = change > 0;
const isBearish = change < 0;

// Sentiment score (0-100, higher = more bullish)
const sentimentScore = isBullish
    ? 65 + Math.floor(changePercent * 5)
    : 35 - Math.floor(Math.abs(changePercent) * 5);
const clampedScore = Math.max(10, Math.min(90, sentimentScore));
const sentimentLabel =
    clampedScore > 70
        ? 'åå¤š'
        : clampedScore > 55
          ? 'ä¸­æ€§åå¤š'
          : clampedScore > 45
            ? 'ä¸­æ€§'
            : clampedScore > 30
              ? 'ä¸­æ€§åç©º'
              : 'åç©º';
const sentimentAdvice =
    clampedScore > 60
        ? `çŸ­ç·šåå¤šï¼Œå¯ç•™æ„å›æ¸¬æ”¯æ’å¾Œçš„é€²å ´æ™‚æ©Ÿ`
        : clampedScore > 40
          ? `è§€æœ›ç‚ºä¸»ï¼Œç­‰å¾…æ–¹å‘ç¢ºèªå¾Œå†åšæ±ºç­–`
          : `çŸ­ç·šåå¼±ï¼Œå»ºè­°æ¸›ç¢¼æˆ–è¨­å®šåœæ`;

// Gauge SVG angle (0 = far left = bearish, 180 = far right = bullish)
const needleAngle = (clampedScore / 100) * 180 - 90; // -90 to 90 degrees

// AI Report markdown content (initial placeholder, will be replaced by server data)
let reportSections = [];

// Suggested alerts from AI (placeholder)
let suggestedAlerts: any[] = [];

let reportLoading = true;

// fetch server-side AI report when running in client
if (typeof window !== 'undefined') {
    fetch(`/api/ai-report/${encodeURIComponent(symbol)}`)
        .then(r => r.json())
        .then(data => {
            reportSections = data.reportSections || [];
            suggestedAlerts = data.suggestedAlerts || [];
        })
        .catch(() => {
            // keep empty on error
        })
        .finally(() => {
            reportLoading = false;
            // trigger re-render by forcing Astro to update? not required as mapping occurs in client?
            // Actually Astro components do not re-render automatically; we may need client hydration.
        });
}

// Highlight terms for GenUI
const highlightTerms = [
    'é»ƒé‡‘äº¤å‰',
    'MA20',
    'æŠ•ä¿¡é€£è²·',
    'è·Œç ´',
    'çªç ´',
    'åœæ',
    'EPS',
    'KDæŒ‡æ¨™',
    'MACD',
];
---

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left: AI Report -->
    <div class="lg:col-span-7 space-y-4">
        <!-- Sentiment Gauge -->
        <div class="glass-card p-5 flex items-center gap-6">
            <div class="flex-shrink-0">
                <svg viewBox="0 0 120 70" class="w-28 h-16">
                    <!-- Gauge arc background -->
                    <path
                        d="M15,60 A45,45 0 0,1 105,60"
                        fill="none"
                        stroke="hsl(0,0%,100%,0.06)"
                        stroke-width="8"
                        stroke-linecap="round"></path>
                    <!-- Red to green gradient arc -->
                    <defs>
                        <linearGradient id="gaugeGrad" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="hsl(346,77%,50%)"></stop>
                            <stop offset="50%" stop-color="hsl(38,92%,50%)"></stop>
                            <stop offset="100%" stop-color="hsl(142,71%,45%)"></stop>
                        </linearGradient>
                    </defs>
                    <path
                        d="M15,60 A45,45 0 0,1 105,60"
                        fill="none"
                        stroke="url(#gaugeGrad)"
                        stroke-width="8"
                        stroke-linecap="round"
                        opacity="0.4"></path>
                    <!-- Needle -->
                    <line
                        x1="60"
                        y1="60"
                        x2="60"
                        y2="22"
                        stroke="white"
                        stroke-width="2"
                        stroke-linecap="round"
                        transform={`rotate(${needleAngle}, 60, 60)`}
                    >
                    </line>
                    <circle cx="60" cy="60" r="4" fill="white"></circle>
                    <!-- Score text -->
                    <text
                        x="60"
                        y="56"
                        text-anchor="middle"
                        fill="white"
                        font-size="12"
                        font-weight="bold"
                        font-family="var(--font-mono)">{clampedScore}</text
                    >
                </svg>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="terminal-label">AI å…±è­˜</span>
                    <span
                        class:list={[
                            'text-xs font-bold px-2 py-0.5 rounded-full',
                            clampedScore > 55
                                ? 'bg-bullish/15 text-bullish'
                                : clampedScore < 45
                                  ? 'bg-bearish/15 text-bearish'
                                  : 'bg-warning/15 text-warning',
                        ]}
                    >
                        {sentimentLabel}
                    </span>
                </div>
                <p class="text-sm text-text-secondary leading-relaxed">{sentimentAdvice}</p>
            </div>
        </div>

        <!-- AI Report Body -->
        <style>
.loader {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
<div class="glass-card p-6 bg-gradient-to-br from-indigo-900/[0.06] to-fuchsia-900/[0.03]">
            <div class="flex items-center gap-2 mb-5">
                <span class="text-xl">ğŸ¤–</span>
                <h3 class="text-base font-bold text-text-primary">AI æ·±åº¦åˆ†æå ±å‘Š</h3>
                <span
                    class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-accent/15 text-accent animate-glow-pulse"
                >
                    Generated
                </span>
            </div>
            {reportLoading ? (
                <div class="text-center py-6">
                    <span class="loader"></span> ç”Ÿæˆå ±å‘Šä¸­...
                </div>
            ) : (
                <div class="prose prose-invert prose-sm max-w-none space-y-5">
                    {
                        reportSections.map((section, i) => (
                            <div
                                style={`animation: fade-up 0.5s cubic-bezier(0.16,1,0.3,1) ${i * 200}ms both`}
                            >
                                <h4 class="text-sm font-bold text-text-primary mb-2">
                                    {section.title}
                                </h4>
                                <p class="text-sm text-text-secondary leading-relaxed">
                                    {section.content}
                                </p>
                            </div>
                        ))
                    }
                </div>
            )}
            <div class="flex items-center gap-2 mt-6 pt-4 border-t border-border/50">
                <span class="w-2 h-2 bg-accent rounded-full animate-glow-pulse"></span>
                <span class="text-xs text-text-muted font-mono"
                    >Report generated â€¢ Model: GPT-4o â€¢ Confidence: {clampedScore}%</span
                >
            </div>
        </div>
    </div>

    <!-- Right: Alert Center -->
    <div class="lg:col-span-5 space-y-4">
        <!-- Suggested Alerts -->
        <div class="glass-card p-5 border-l-2 border-accent">
            <h3 class="terminal-label mb-4">ğŸ¯ AI æ¨è–¦è¡Œå‹•</h3>
            <div class="space-y-3">
                {
                    suggestedAlerts.map((alert, i) => (
                        <div
                            class="rounded-xl border border-border p-4 bg-glass hover:bg-glass-hover transition-all"
                            style={`animation: fade-up 0.5s cubic-bezier(0.16,1,0.3,1) ${i * 150}ms both`}
                        >
                            <p class="text-xs text-text-secondary mb-2 flex items-start gap-1.5">
                                <span>{alert.icon}</span>
                                <span class="italic">{alert.insight}</span>
                            </p>
                            <div class="flex items-center justify-between bg-white/[0.02] rounded-lg px-3 py-2">
                                <div class="flex-1">
                                    <p class="text-xs text-text-primary font-medium">
                                        {alert.rule}
                                    </p>
                                    <p class="text-[10px] text-text-muted mt-0.5">{alert.action}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer flex-shrink-0 ml-3">
                                    <input type="checkbox" class="sr-only peer" />
                                    <div class="w-9 h-5 bg-surface rounded-full peer peer-checked:bg-accent/30 border border-border peer-checked:border-accent/50 transition-colors">
                                        <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-text-muted rounded-full transition-transform peer-checked:translate-x-4 peer-checked:bg-accent" />
                                    </div>
                                </label>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Custom Alerts -->
        <div class="glass-card p-5">
            <h3 class="terminal-label mb-4">âš¡ è‡ªè¨‚è­¦ç¤º</h3>
            <!-- Existing alerts placeholder -->
            <div class="space-y-2 mb-4">
                <div
                    class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs"
                >
                    <div>
                        <span class="text-text-secondary"
                            >æ”¶ç›¤åƒ¹ &lt; {(price * 0.9).toFixed(0)}</span
                        >
                        <span class="text-[10px] text-text-muted ml-2">åœæç·š</span>
                    </div>
                    <span class="w-2 h-2 rounded-full bg-bullish"></span>
                </div>
                <div
                    class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs"
                >
                    <div>
                        <span class="text-text-secondary">æˆäº¤é‡ &gt; 50,000 å¼µ</span>
                        <span class="text-[10px] text-text-muted ml-2">çˆ†é‡è­¦ç¤º</span>
                    </div>
                    <span class="w-2 h-2 rounded-full bg-text-muted"></span>
                </div>
            </div>
            <button class="btn-cyber w-full justify-center text-sm"> + æ–°å¢å®¢è£½åŒ–è­¦ç¤º </button>
        </div>

        <!-- Performance badges -->
        <div class="glass-card p-4">
            <h3 class="terminal-label mb-3">ğŸ“Š å ±å‘Šå“è³ªæŒ‡æ¨™</h3>
            <div class="grid grid-cols-2 gap-2">
                {
                    [
                        { label: 'è³‡æ–™å®Œæ•´åº¦', value: '92%', color: 'bullish' },
                        {
                            label: 'ä¿¡å¿ƒæŒ‡æ•¸',
                            value: `${clampedScore}%`,
                            color: clampedScore > 50 ? 'bullish' : 'warning',
                        },
                        { label: 'è¦†è“‹é¢å‘', value: '4/5', color: 'accent' },
                        { label: 'æ›´æ–°æ™‚é–“', value: 'Now', color: 'accent' },
                    ].map(badge => (
                        <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs">
                            <span class="text-text-muted">{badge.label}</span>
                            <span class={`font-mono font-bold text-${badge.color}`}>
                                {badge.value}
                            </span>
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
</div>
