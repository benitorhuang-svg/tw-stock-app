---
/**
 * TabAlerts.astro — AI Report & Smart Alerts Tab (007-tab-alerts)
 * Sentiment gauge, AI analysis report, suggested alerts, custom rules
 */
import SentimentGauge from '../molecules/SentimentGauge.astro';
import NeuralHealthMonitor from '../molecules/NeuralHealthMonitor.astro';
import AiReportMatrix from '../molecules/AiReportMatrix.astro';
import StrategicActionMatrix from '../molecules/StrategicActionMatrix.astro';

interface Props {
    symbol: string;
    name: string;
    price: number;
    change: number;
    changePercent: number;
}

const { symbol } = Astro.props;
---

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6" id="ai-tab-root">
    <!-- Left: AI Report -->
    <div class="lg:col-span-7 space-y-4">
        <!-- Sentiment Gauge -->
        <SentimentGauge />

        <!-- AI Report Body -->
        <AiReportMatrix symbol={symbol} />
    </div>

    <!-- Right: Alert Center -->
    <div class="lg:col-span-5 space-y-4">
        <!-- Suggested Action Matrix -->
        <StrategicActionMatrix />

        <!-- Neural Health Monitor -->
        <NeuralHealthMonitor />
    </div>
</div>

<script is:inline define:vars={{ symbol }}>
    async function hydrate() {
        try {
            const res = await fetch(`/api/ai-report/${symbol}`);
            const data = await res.json();

            // 1. Update Gauge & Summary
            const score = document.getElementById('gauge-score')
                ? 60 + Math.floor(Math.random() * 25)
                : 75;
            const needle = document.getElementById('gauge-needle');
            const path = document.getElementById('gauge-path');
            const scoreDisplay = document.getElementById('gauge-score');
            const statusTag = document.getElementById('status-tag');
            const summary = document.getElementById('ai-summary');

            if (needle && path && scoreDisplay) {
                const angle = (score / 100) * 180 - 90;
                needle.style.transform = `rotate(${angle}deg)`;
                const offset = 157 - (score / 100) * 157;
                path.style.strokeDashoffset = offset;
                scoreDisplay.innerText = score;
                statusTag.innerText = score > 65 ? 'OPTIMIZED' : 'CAUTION';
                statusTag.className = `px-2 py-0.5 rounded-full border text-[10px] animate-pulse ${score > 65 ? 'bg-bullish/10 border-bullish text-bullish' : 'bg-warning/10 border-warning text-warning'}`;
            }

            if (summary && data.reportSections[2]) {
                summary.innerText = data.reportSections[2].content;
            }

            // 2. Update Report Sections
            const container = document.getElementById('report-content');
            if (container) {
                container.innerHTML = data.reportSections
                    .map(
                        s => `
                    <div class="group">
                        <h4 class="text-[10px] font-mono font-bold text-accent uppercase tracking-widest mb-2 flex items-center gap-2">
                             <span class="w-1 h-3 bg-accent/40 rounded-full"></span> ${s.title}
                        </h4>
                        <div class="text-sm text-white/70 leading-relaxed pl-3 border-l border-white/5 transition-all group-hover:border-accent/40">
                            ${s.content}
                        </div>
                    </div>
                `
                    )
                    .join('');
            }

            // 3. Update Alerts
            const alertsContainer = document.getElementById('alerts-container');
            if (alertsContainer) {
                alertsContainer.innerHTML = data.suggestedAlerts
                    .map(
                        a => `
                    <div class="p-4 rounded-xl bg-white/[0.03] border border-white/5 hover:border-accent/40 transition-all group cursor-pointer relative overflow-hidden">
                        <div class="absolute inset-0 bg-accent/[0.02] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="flex items-start justify-between relative">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${a.icon}</span>
                                    <span class="text-[10px] font-mono font-bold text-white/30 uppercase group-hover:text-accent transition-colors">${a.insight}</span>
                                </div>
                                <p class="text-xs font-bold text-white/80">${a.rule}</p>
                                <p class="text-[9px] text-white/30 font-mono">${a.action} • READY</p>
                            </div>
                            <div class="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-white/20 group-hover:border-accent group-hover:text-accent transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            </div>
                        </div>
                    </div>
                `
                    )
                    .join('');
            }

            const timestamp = document.getElementById('report-timestamp');
            if (timestamp) timestamp.innerText = `Timestamp: ${new Date().toLocaleTimeString()}`;
        } catch (e) {
            console.error('AI Hydration Error:', e);
        }
    }
    hydrate();
</script>
