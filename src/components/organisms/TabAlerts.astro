---
/**
 * TabAlerts.astro â€” AI Report & Smart Alerts Tab (007-tab-alerts)
 * Sentiment gauge, AI analysis report, suggested alerts, custom rules
 */
interface Props {
    symbol: string;
    name: string;
    price: number;
    change: number;
    changePercent: number;
}

const { symbol, name, price, change, changePercent } = Astro.props;

const isBullish = change > 0;
const isBearish = change < 0;

// Sentiment score (0-100, higher = more bullish)
const sentimentScore = isBullish
    ? 65 + Math.floor(changePercent * 5)
    : 35 - Math.floor(Math.abs(changePercent) * 5);
const clampedScore = Math.max(10, Math.min(90, sentimentScore));
const sentimentLabel =
    clampedScore > 70
        ? 'åå¤š'
        : clampedScore > 55
          ? 'ä¸­æ€§åå¤š'
          : clampedScore > 45
            ? 'ä¸­æ€§'
            : clampedScore > 30
              ? 'ä¸­æ€§åç©º'
              : 'åç©º';
const sentimentAdvice =
    clampedScore > 60
        ? `çŸ­ç·šåå¤šï¼Œå¯ç•™æ„å›æ¸¬æ”¯æ’å¾Œçš„é€²å ´æ™‚æ©Ÿ`
        : clampedScore > 40
          ? `è§€æœ›ç‚ºä¸»ï¼Œç­‰å¾…æ–¹å‘ç¢ºèªå¾Œå†åšæ±ºç­–`
          : `çŸ­ç·šåå¼±ï¼Œå»ºè­°æ¸›ç¢¼æˆ–è¨­å®šåœæ`;

// Gauge SVG angle (0 = far left = bearish, 180 = far right = bullish)
const needleAngle = (clampedScore / 100) * 180 - 90; // -90 to 90 degrees

// AI Report markdown content (simulated)
const reportSections = [
    {
        title: 'ğŸ“Š åŸºæœ¬é¢äº®é»',
        content: `${name} (${symbol}) è¿‘æœŸç‡Ÿæ”¶è¡¨ç¾${isBullish ? 'ç©©å¥æˆé•·' : 'ç•¥æœ‰æ³¢å‹•'}ã€‚æœ€æ–°å­£åº¦æ¯›åˆ©ç‡ç¶­æŒé«˜æª”ï¼Œç‡Ÿæ¥­åˆ©ç›Šç‡${isBullish ? 'æŒçºŒæ“´å¼µ' : 'å°å¹…æ”¶ç¸®'}ã€‚EPS å¹´å¢ç‡${isBullish ? 'å„ªæ–¼å¸‚å ´é æœŸ' : 'ç¬¦åˆé æœŸ'}ï¼Œæ•´é«”åŸºæœ¬é¢${isBullish ? 'å…·å‚™æ”¯æ’' : 'éœ€å¯†åˆ‡è§€å¯Ÿ'}ã€‚`,
    },
    {
        title: 'ğŸ¦ ç±Œç¢¼å‹•èƒ½è¿½è¹¤',
        content: `å¤–è³‡è¿‘äº”æ—¥${isBullish ? 'å‘ˆç¾æ·¨è²·è¶…æ…‹å‹¢' : 'æŒçºŒèª¿ç¯€æŒè‚¡'}ï¼ŒæŠ•ä¿¡${isBullish ? 'åŒæ­¥åŠ ç¢¼' : 'ç¶­æŒè§€æœ›'}ã€‚ç±Œç¢¼é¢${isBullish ? 'é›†ä¸­åº¦æå‡ï¼Œæœ‰åˆ©æ–¼çŸ­ç·šæ¨å‡' : 'ç•¥æœ‰é¬†å‹•ï¼Œç•™æ„æ˜¯å¦å‡ºç¾é€£çºŒè³£è¶…'}ã€‚èè³‡åˆ¸è®ŠåŒ–å°šå±¬æ­£å¸¸ç¯„åœã€‚`,
    },
    {
        title: 'ğŸ“ˆ æŠ€è¡“å‹æ…‹æƒæ',
        content: `ç•¶å‰è‚¡åƒ¹ä½æ–¼${isBullish ? 'æ‰€æœ‰å‡ç·šä¹‹ä¸Š' : 'MA20 é™„è¿‘'}ã€‚KD æŒ‡æ¨™${isBullish ? 'å‘ˆç¾é»ƒé‡‘äº¤å‰' : 'æ¥è¿‘ä½æª”'}ï¼ŒMACD æŸ±ç‹€é«”${isBullish ? 'ç¿»ç´…ä¸”æŒçºŒæ“´å¤§' : 'ç¸®æ¸›ä¸­'}ã€‚çŸ­ç·š${isBullish ? 'ä¸Šæ–¹å£“åŠ›ä½åœ¨' : 'ä¸‹æ–¹æ”¯æ’ä½åœ¨'} ${(price * (isBullish ? 1.05 : 0.95)).toFixed(0)} å…ƒé™„è¿‘ã€‚`,
    },
    {
        title: 'âš ï¸ é¢¨éšªæç¤º',
        content: `éœ€ç•™æ„å¤§ç›¤ç³»çµ±æ€§é¢¨éšªï¼Œä»¥åŠåœ‹éš›åŠå°é«”æ™¯æ°£å¾ªç’°è®ŠåŒ–ã€‚è‹¥${isBullish ? 'é‡èƒ½ç„¡æ³•æŒçºŒæ”¾å¤§' : 'è·Œç ´é—œéµæ”¯æ’'}ï¼Œå»ºè­°${isBullish ? 'é€¢é«˜æ¸›ç¢¼éƒ¨åˆ†æŒè‚¡' : 'åš´æ ¼åŸ·è¡Œåœæç´€å¾‹'}ã€‚`,
    },
];

// Suggested alerts from AI
const suggestedAlerts = [
    {
        icon: 'ğŸ“',
        insight: `AI ç™¼ç¾ç›®å‰è‚¡åƒ¹${isBullish ? 'æ¥è¿‘å‰é«˜å£“åŠ›å€' : 'é è¿‘æœˆç·šæ”¯æ’'}ã€‚`,
        rule: `ç•¶ ${symbol} æ”¶ç›¤åƒ¹ ${isBullish ? 'å‘ä¸Šçªç ´' : 'å‘ä¸‹è·Œç ´'} ${(price * (isBullish ? 1.03 : 0.97)).toFixed(0)} å…ƒ`,
        action: 'ç™¼é€æ¨æ’­é€šçŸ¥',
    },
    {
        icon: 'ğŸ¦',
        insight: `å¤–è³‡é€£çºŒ${isBullish ? 'è²·è¶…' : 'è³£è¶…'}ï¼Œç•™æ„è¶¨å‹¢å»¶çºŒã€‚`,
        rule: `ç•¶ ${symbol} å¤–è³‡é€£çºŒ ${isBullish ? 'è²·' : 'è³£'}è¶…å¤©æ•¸é” 5 æ—¥`,
        action: 'ç™¼é€ Email è­¦ç¤º',
    },
];

// Highlight terms for GenUI
const highlightTerms = [
    'é»ƒé‡‘äº¤å‰',
    'MA20',
    'æŠ•ä¿¡é€£è²·',
    'è·Œç ´',
    'çªç ´',
    'åœæ',
    'EPS',
    'KDæŒ‡æ¨™',
    'MACD',
];
---

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left: AI Report -->
    <div class="lg:col-span-7 space-y-4">
        <!-- Sentiment Gauge -->
        <div class="glass-card p-5 flex items-center gap-6">
            <div class="flex-shrink-0">
                <svg viewBox="0 0 120 70" class="w-28 h-16">
                    <!-- Gauge arc background -->
                    <path
                        d="M15,60 A45,45 0 0,1 105,60"
                        fill="none"
                        stroke="hsl(0,0%,100%,0.06)"
                        stroke-width="8"
                        stroke-linecap="round"></path>
                    <!-- Red to green gradient arc -->
                    <defs>
                        <linearGradient id="gaugeGrad" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="hsl(346,77%,50%)"></stop>
                            <stop offset="50%" stop-color="hsl(38,92%,50%)"></stop>
                            <stop offset="100%" stop-color="hsl(142,71%,45%)"></stop>
                        </linearGradient>
                    </defs>
                    <path
                        d="M15,60 A45,45 0 0,1 105,60"
                        fill="none"
                        stroke="url(#gaugeGrad)"
                        stroke-width="8"
                        stroke-linecap="round"
                        opacity="0.4"></path>
                    <!-- Needle -->
                    <line
                        x1="60"
                        y1="60"
                        x2="60"
                        y2="22"
                        stroke="white"
                        stroke-width="2"
                        stroke-linecap="round"
                        transform={`rotate(${needleAngle}, 60, 60)`}
                    >
                    </line>
                    <circle cx="60" cy="60" r="4" fill="white"></circle>
                    <!-- Score text -->
                    <text
                        x="60"
                        y="56"
                        text-anchor="middle"
                        fill="white"
                        font-size="12"
                        font-weight="bold"
                        font-family="var(--font-mono)">{clampedScore}</text
                    >
                </svg>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="terminal-label">AI å…±è­˜</span>
                    <span
                        class:list={[
                            'text-xs font-bold px-2 py-0.5 rounded-full',
                            clampedScore > 55
                                ? 'bg-bullish/15 text-bullish'
                                : clampedScore < 45
                                  ? 'bg-bearish/15 text-bearish'
                                  : 'bg-warning/15 text-warning',
                        ]}
                    >
                        {sentimentLabel}
                    </span>
                </div>
                <p class="text-sm text-text-secondary leading-relaxed">{sentimentAdvice}</p>
            </div>
        </div>

        <!-- AI Report Body -->
        <div class="glass-card p-6 bg-gradient-to-br from-indigo-900/[0.06] to-fuchsia-900/[0.03]">
            <div class="flex items-center gap-2 mb-5">
                <span class="text-xl">ğŸ¤–</span>
                <h3 class="text-base font-bold text-text-primary">AI æ·±åº¦åˆ†æå ±å‘Š</h3>
                <span
                    class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-accent/15 text-accent animate-glow-pulse"
                >
                    Generated
                </span>
            </div>
            <div class="prose prose-invert prose-sm max-w-none space-y-5">
                {
                    reportSections.map((section, i) => (
                        <div
                            style={`animation: fade-up 0.5s cubic-bezier(0.16,1,0.3,1) ${i * 200}ms both`}
                        >
                            <h4 class="text-sm font-bold text-text-primary mb-2">
                                {section.title}
                            </h4>
                            <p class="text-sm text-text-secondary leading-relaxed">
                                {section.content}
                            </p>
                        </div>
                    ))
                }
            </div>
            <div class="flex items-center gap-2 mt-6 pt-4 border-t border-border/50">
                <span class="w-2 h-2 bg-accent rounded-full animate-glow-pulse"></span>
                <span class="text-xs text-text-muted font-mono"
                    >Report generated â€¢ Model: GPT-4o â€¢ Confidence: {clampedScore}%</span
                >
            </div>
        </div>
    </div>

    <!-- Right: Alert Center -->
    <div class="lg:col-span-5 space-y-4">
        <!-- Suggested Alerts -->
        <div class="glass-card p-5 border-l-2 border-accent">
            <h3 class="terminal-label mb-4">ğŸ¯ AI æ¨è–¦è¡Œå‹•</h3>
            <div class="space-y-3">
                {
                    suggestedAlerts.map((alert, i) => (
                        <div
                            class="rounded-xl border border-border p-4 bg-glass hover:bg-glass-hover transition-all"
                            style={`animation: fade-up 0.5s cubic-bezier(0.16,1,0.3,1) ${i * 150}ms both`}
                        >
                            <p class="text-xs text-text-secondary mb-2 flex items-start gap-1.5">
                                <span>{alert.icon}</span>
                                <span class="italic">{alert.insight}</span>
                            </p>
                            <div class="flex items-center justify-between bg-white/[0.02] rounded-lg px-3 py-2">
                                <div class="flex-1">
                                    <p class="text-xs text-text-primary font-medium">
                                        {alert.rule}
                                    </p>
                                    <p class="text-[10px] text-text-muted mt-0.5">{alert.action}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer flex-shrink-0 ml-3">
                                    <input type="checkbox" class="sr-only peer" />
                                    <div class="w-9 h-5 bg-surface rounded-full peer peer-checked:bg-accent/30 border border-border peer-checked:border-accent/50 transition-colors">
                                        <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-text-muted rounded-full transition-transform peer-checked:translate-x-4 peer-checked:bg-accent" />
                                    </div>
                                </label>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Custom Alerts -->
        <div class="glass-card p-5">
            <h3 class="terminal-label mb-4">âš¡ è‡ªè¨‚è­¦ç¤º</h3>
            <!-- Existing alerts placeholder -->
            <div class="space-y-2 mb-4">
                <div
                    class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs"
                >
                    <div>
                        <span class="text-text-secondary"
                            >æ”¶ç›¤åƒ¹ &lt; {(price * 0.9).toFixed(0)}</span
                        >
                        <span class="text-[10px] text-text-muted ml-2">åœæç·š</span>
                    </div>
                    <span class="w-2 h-2 rounded-full bg-bullish"></span>
                </div>
                <div
                    class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs"
                >
                    <div>
                        <span class="text-text-secondary">æˆäº¤é‡ &gt; 50,000 å¼µ</span>
                        <span class="text-[10px] text-text-muted ml-2">çˆ†é‡è­¦ç¤º</span>
                    </div>
                    <span class="w-2 h-2 rounded-full bg-text-muted"></span>
                </div>
            </div>
            <button class="btn-cyber w-full justify-center text-sm"> + æ–°å¢å®¢è£½åŒ–è­¦ç¤º </button>
        </div>

        <!-- Performance badges -->
        <div class="glass-card p-4">
            <h3 class="terminal-label mb-3">ğŸ“Š å ±å‘Šå“è³ªæŒ‡æ¨™</h3>
            <div class="grid grid-cols-2 gap-2">
                {
                    [
                        { label: 'è³‡æ–™å®Œæ•´åº¦', value: '92%', color: 'bullish' },
                        {
                            label: 'ä¿¡å¿ƒæŒ‡æ•¸',
                            value: `${clampedScore}%`,
                            color: clampedScore > 50 ? 'bullish' : 'warning',
                        },
                        { label: 'è¦†è“‹é¢å‘', value: '4/5', color: 'accent' },
                        { label: 'æ›´æ–°æ™‚é–“', value: 'Now', color: 'accent' },
                    ].map(badge => (
                        <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-glass border border-border text-xs">
                            <span class="text-text-muted">{badge.label}</span>
                            <span class={`font-mono font-bold text-${badge.color}`}>
                                {badge.value}
                            </span>
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
</div>
