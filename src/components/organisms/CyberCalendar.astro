---
/**
 * CyberCalendar.astro (Organism) — Market Heat Map Calendar (戳戳樂)
 *
 * Atomic Design: ORGANISM
 * Composes: Date trigger (Atom) + Popover grid (Molecule) + API data fetching
 *
 * Fetches ratio data from /api/market/monthly-ratios and dispatches
 * 'calendarDateSelect' events for parent pages to handle data sync.
 */
interface Props {
    id?: string;
    value?: string;
    class?: string;
}

const { id = 'cyber-calendar', value = '', class: className = '' } = Astro.props;
const todayDisplay = value || '2026-02-24';
---

<div class={`relative cyber-calendar-wrapper group ${className}`} id={`${id}-wrapper`}>
    <!-- Main Trigger (Registry Atom) -->
    <div
        id={`${id}-trigger`}
        class="relative w-full flex items-center gap-3 px-4 py-3 bg-[#0a0c10]/80 hover:bg-[#111827]/90 border border-accent/20 hover:border-accent/50 rounded-2xl transition-all duration-500 cursor-pointer overflow-hidden group/btn z-10 shadow-[0_0_20px_rgba(0,0,0,0.5)]"
        role="button"
        tabindex="0"
    >
        <div
            class="absolute inset-0 opacity-[0.08] pointer-events-none bg-gradient-to-br from-accent via-transparent to-accent"
        >
        </div>
        <div
            class="absolute inset-0 opacity-[0.05] pointer-events-none bg-[linear-gradient(rgba(59,130,246,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(59,130,246,0.1)_1px,transparent_1px)] bg-[size:6px_6px]"
        >
        </div>

        <div
            class="relative flex flex-col items-center justify-center w-12 h-12 rounded-xl bg-base-deep/90 border border-accent/30 group-hover/btn:border-accent/60 transition-all duration-500 shadow-inner"
        >
            <svg class="w-6 h-6 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
            </svg>
            <div class="absolute -top-[1px] left-3 right-3 h-[2px] bg-accent/50 rounded-full"></div>
        </div>

        <div class="flex flex-col items-start select-none ml-2">
            <div class="flex items-baseline gap-2">
                <span
                    class="text-[9px] font-black text-accent/50 uppercase tracking-[0.3em] whitespace-nowrap"
                    >Temporal Registry</span
                >
            </div>
            <span
                class="text-base font-mono font-black text-white tracking-widest leading-none mt-1"
                id={`${id}-label`}>{todayDisplay}</span
            >
        </div>
    </div>

    <input type="date" id={id} value={value} class="hidden" />

    <!-- Popover -->
    <div
        id={`${id}-popover`}
        class="hidden absolute top-full left-0 mt-3 z-[200] w-72 bg-[#0d1117] border border-accent/30 rounded-2xl shadow-[0_30px_60px_rgba(0,0,0,0.8),0_0_0_1px_rgba(59,130,246,0.1)] overflow-hidden animate-pop-in origin-top"
    >
        <div class="p-4 bg-surface/40 border-b border-border/20 flex items-center justify-between">
            <button
                type="button"
                class="nav-prev p-1.5 hover:bg-accent/10 rounded-lg text-accent transition-all cursor-pointer"
                >◀</button
            >
            <span class="month-year font-mono font-black text-white text-base tracking-[0.1em]"
            ></span>
            <button
                type="button"
                class="nav-next p-1.5 hover:bg-accent/10 rounded-lg text-accent transition-all cursor-pointer"
                >▶</button
            >
        </div>

        <div class="p-3">
            <div class="grid grid-cols-7 mb-2 opacity-40">
                {
                    ['日', '一', '二', '三', '四', '五', '六'].map(d => (
                        <div class="text-center text-[10px] font-black text-text-muted">{d}</div>
                    ))
                }
            </div>
            <div id={`${id}-days`} class="grid grid-cols-7 gap-1"></div>
        </div>

        <div class="p-3 bg-accent/5 border-t border-accent/10 flex justify-center">
            <button
                type="button"
                class="today-btn px-10 py-2 rounded-xl bg-[#3b82f6] text-[11px] font-black text-white uppercase tracking-widest hover:bg-[#2563eb] active:scale-95 transition-all shadow-[0_4px_15px_rgba(59,130,246,0.4)] cursor-pointer"
            >
                Synchronize Today
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes pop-in {
        from {
            opacity: 0;
            transform: translateY(-8px) scale(0.98);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .animate-pop-in {
        animation: pop-in 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>

<script src="../../scripts/cyber-calendar-engine.ts"></script>
