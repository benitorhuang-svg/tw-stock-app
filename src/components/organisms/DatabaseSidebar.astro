---
/**
 * DatabaseSidebar.astro - Table navigator with layer grouping
 */
interface TableStat {
    name: string;
    rows: number;
    cols: number;
}

interface Props {
    tables: string[];
    tableStats: TableStat[];
}

import SidebarLayerHeader from '../molecules/SidebarLayerHeader.astro';
import DatabaseSidebarItem from '../atoms/DatabaseSidebarItem.astro';

const { tables, tableStats } = Astro.props;

/**
 * 資料庫四層分離架構
 * 各分頁讀取快照/聚合層 → 秒開無卡頓
 */
const TABLE_LAYERS: { label: string; tag: string; color: string; tables: string[] }[] = [
    {
        label: '原始層 Raw',
        tag: '①',
        color: 'gray',
        tables: [
            'stocks',
            'price_history',
            'chips',
            'margin_short',
            'shareholder_distribution',
            'government_chips',
            'major_broker_chips',
            'director_holdings',
            'security_lending',
            'dealer_details',
            'valuation_history',
            'fundamentals',
            'monthly_revenue',
            'dividends',
        ],
    },
    {
        label: '運算層 Computed',
        tag: '②',
        color: 'yellow',
        tables: ['daily_indicators', 'chip_features', 'tech_features', 'valuation_features'],
    },
    {
        label: '聚合層 Aggregated',
        tag: '③',
        color: 'green',
        tables: ['market_breadth_history', 'institutional_trend', 'sector_daily'],
    },
    {
        label: '快照層 Snapshot',
        tag: '④',
        color: 'accent',
        tables: ['latest_prices', 'institutional_snapshot', 'ai_reports', 'screener_scores', 'backtest_results'],
    },
];

// Build grouped stats
const statMap = new Map(tableStats.map(t => [t.name, t]));
const groupedStats = TABLE_LAYERS.map(layer => ({
    ...layer,
    items: layer.tables.map(name => statMap.get(name)).filter((s): s is TableStat => s != null),
}));
// Any tables not in our layer config
const knownTables = new Set(TABLE_LAYERS.flatMap(l => l.tables));
const ungrouped = tableStats.filter(t => !knownTables.has(t.name));
---

<aside
    id="db-sidebar"
    class="w-72 bg-base-deep/80 backdrop-blur-md border-r border-border flex flex-col z-20 flex-shrink-0 max-md:fixed max-md:inset-y-0 max-md:top-[64px] max-md:left-0 max-md:-translate-x-full max-md:transition-transform max-md:duration-300 shadow-elevated"
>
    <!-- Sync Button at Top -->
    <div class="p-3 border-b border-border/50 bg-surface/30">
        <button
            class="w-full text-left px-4 py-3 rounded-xl text-[12px] font-mono text-text-secondary hover:bg-glass-hover hover:text-text-primary transition-all flex items-center justify-between group border border-transparent active:scale-[0.98]"
            data-table="refresh"
            id="sidebar-refresh-btn"
        >
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <div
                    class="w-7 h-7 shrink-0 rounded-lg overflow-hidden flex items-center justify-center bg-glass border border-border group-hover:border-accent/40 group-hover:bg-accent/10 transition-all"
                >
                    <svg
                        class="w-4 h-4 text-text-muted group-hover:text-accent"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        ></path>
                    </svg>
                </div>
                <span
                    class="tracking-wide group-hover:translate-x-1 transition-transform font-bold text-accent"
                >
                    資料更新
                </span>
            </div>
            <span
                id="last-sync-date"
                class="text-[9px] text-accent/80 shrink-0 ml-2 font-mono tracking-widest font-bold"
            >
                [2026-02-26]
            </span>
        </button>
    </div>

    <!-- Table List Header -->
    <div class="px-6 py-4 flex items-center justify-between bg-surface/50 border-b border-border">
        <span class="text-[9px] font-black text-text-muted uppercase tracking-[0.2em]"
            >資料庫註冊表</span
        >
        <span class="text-[9px] font-mono text-text-secondary uppercase tracking-widest"
            >COUNT: {tables.length}</span
        >
    </div>

    <!-- Table List -->
    <nav class="flex-1 overflow-y-auto py-2 custom-scrollbar flex flex-col justify-between">
        <ul class="space-y-1 px-3" id="table-list">
            {
                groupedStats.map((group, idx) => (
                    <li class="layer-group" data-layer-id={idx}>
                        <SidebarLayerHeader
                            label={group.label}
                            tag={group.tag}
                            count={group.items.length}
                            color={group.color}
                            isExpanded={false}
                        />

                        <ul
                            class="space-y-1 mt-1 layer-content origin-top transition-all duration-300 overflow-hidden"
                            style="max-height: 0px; opacity: 0; pointer-events: none;"
                        >
                            {group.items.map(t => (
                                <DatabaseSidebarItem
                                    name={t.name}
                                    rows={t.rows}
                                    color={group.color}
                                />
                            ))}
                        </ul>
                    </li>
                ))
            }
            {/* Ungrouped tables (fallback) */}
            {
                ungrouped.length > 0 && (
                    <li class="layer-group">
                        <SidebarLayerHeader
                            label="其他 Other"
                            count={ungrouped.length}
                            color="gray"
                        />

                        <ul
                            class="space-y-1 mt-1 layer-content origin-top transition-all duration-300 overflow-hidden"
                            style="max-height: 0px; opacity: 0; pointer-events: none;"
                        >
                            {ungrouped.map(t => (
                                <DatabaseSidebarItem name={t.name} rows={t.rows} color="gray" />
                            ))}
                        </ul>
                    </li>
                )
            }
        </ul>
    </nav>
</aside>

<script>
    function setupSidebarFolding() {
        console.log('Setting up sidebar folding...');
        const groups = document.querySelectorAll('.layer-group');
        console.log(`Found ${groups.length} layer groups`);

        groups.forEach((group, idx) => {
            const btn = group.querySelector('.layer-toggle-btn') as HTMLButtonElement;
            const content = group.querySelector('.layer-content') as HTMLElement;
            const chevron = group.querySelector('.chevron-icon') as SVGElement;

            if (!btn || !content || !chevron) {
                console.warn(`Missing elements for group ${idx}`, { btn, content, chevron });
                return;
            }

            // Sync visual state if needed (though Astro props handle this partially)
            // But let's re-verify to be safe
            const isInitialExpanded = btn.getAttribute('aria-expanded') === 'true';
            if (isInitialExpanded) {
                content.style.maxHeight = '2000px';
                chevron.style.transform = 'rotate(0deg)';
            }

            // Define toggle function
            const toggle = (e: Event) => {
                e.preventDefault();
                e.stopPropagation();

                const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                console.log(`Toggling group ${idx}. Current expanded state: ${isExpanded}`);

                if (isExpanded) {
                    btn.setAttribute('aria-expanded', 'false');
                    content.style.maxHeight = '0px';
                    content.style.opacity = '0';
                    content.style.pointerEvents = 'none';
                    chevron.style.transform = 'rotate(-90deg)';
                } else {
                    btn.setAttribute('aria-expanded', 'true');
                    content.style.maxHeight = '2000px';
                    content.style.opacity = '1';
                    content.style.pointerEvents = 'auto';
                    chevron.style.transform = 'rotate(0deg)';
                }
            };

            btn.onclick = toggle;
        });
    }

    // Initial run
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupSidebarFolding);
    } else {
        setupSidebarFolding();
    }

    // Support View Transitions
    document.addEventListener('astro:page-load', () => {
        console.log('Astro page load detected');
        setupSidebarFolding();
    });

    // Final fallback
    setTimeout(setupSidebarFolding, 500);
</script>
