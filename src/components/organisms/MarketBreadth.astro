---
/**
 * MarketBreadth.astro â€” Market overview dashboard organism
 * Shows today's market breadth: advances, declines, volume.
 */
import Badge from '../atoms/Badge.astro';

// SSR: fetch market data from service
let marketData: {
    advances: number;
    declines: number;
    unchanged: number;
    totalVolume: string;
    taiexIndex: string;
    taiexChange: number;
    taiexChangePercent: number;
    lastUpdated: string;
} | null = null;

try {
    // Attempt to load data from stock service
    const { getMarketBreadth } = await import('../../utils/marketService');
    const raw = getMarketBreadth();
    marketData = {
        advances: raw.up,
        declines: raw.down,
        unchanged: raw.flat,
        totalVolume: 'â€”',
        taiexIndex: 'â€”',
        taiexChange: 0,
        taiexChangePercent: raw.upRatio - raw.downRatio > 0 ? raw.upRatio : -raw.downRatio,
        lastUpdated: new Date().toLocaleTimeString('zh-TW'),
    };
} catch {
    // Fallback static data for development
    marketData = {
        advances: 523,
        declines: 401,
        unchanged: 89,
        totalVolume: '3,421 å„„',
        taiexIndex: '22,156.78',
        taiexChange: 125.34,
        taiexChangePercent: 0.57,
        lastUpdated: new Date().toLocaleTimeString('zh-TW'),
    };
}

const total =
    (marketData?.advances ?? 0) + (marketData?.declines ?? 0) + (marketData?.unchanged ?? 0);
const advPct = total > 0 ? ((marketData?.advances ?? 0) / total) * 100 : 0;
const decPct = total > 0 ? ((marketData?.declines ?? 0) / total) * 100 : 0;
const unchPct = total > 0 ? ((marketData?.unchanged ?? 0) / total) * 100 : 0;

const isBullish = (marketData?.taiexChange ?? 0) > 0;
---

<section class="glass-card glow-interactive" id="market-breadth-panel">
    <!-- Header -->
    <div class="flex items-center justify-between px-5 py-3 border-b border-border">
        <div class="flex items-center gap-2">
            <span class="text-base">ğŸ“Š</span>
            <h2 class="text-sm font-bold tracking-wide text-text-primary">å¤§ç›¤å¸‚æ³</h2>
        </div>
        <Badge variant={isBullish ? 'bullish' : 'bearish'}>
            {isBullish ? 'åå¤š' : 'åç©º'}
        </Badge>
    </div>

    <!-- TAIEX Index -->
    <div class="px-5 py-4 border-b border-border">
        <div class="flex items-baseline justify-between">
            <div class="flex items-baseline gap-3">
                <span class="data-value text-3xl">{marketData?.taiexIndex ?? 'â€”'}</span>
                <span
                    class:list={[
                        'data-value text-base',
                        isBullish ? 'text-bullish' : 'text-bearish',
                    ]}
                >
                    {isBullish ? 'â–²' : 'â–¼'}
                    {Math.abs(marketData?.taiexChange ?? 0).toFixed(2)}
                </span>
                <span
                    class:list={[
                        'text-sm font-mono font-semibold',
                        isBullish ? 'text-bullish' : 'text-bearish',
                    ]}
                >
                    ({isBullish ? '+' : ''}{(marketData?.taiexChangePercent ?? 0).toFixed(2)}%)
                </span>
            </div>
            <span class="text-xs text-text-muted font-mono">{marketData?.lastUpdated ?? ''}</span>
        </div>
    </div>

    <!-- Breadth Bar -->
    <div class="px-5 py-4 space-y-3">
        <div class="w-full h-2 rounded-full overflow-hidden bg-surface flex">
            <div
                class="h-full bg-bullish/80 transition-all duration-700"
                style={`width: ${advPct}%`}
            >
            </div>
            <div
                class="h-full bg-text-muted/30 transition-all duration-700"
                style={`width: ${unchPct}%`}
            >
            </div>
            <div
                class="h-full bg-bearish/80 transition-all duration-700"
                style={`width: ${decPct}%`}
            >
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4 text-center">
            <div>
                <span class="terminal-label">ä¸Šæ¼²</span>
                <div class="data-value text-lg text-bullish">{marketData?.advances ?? 0}</div>
            </div>
            <div>
                <span class="terminal-label">å¹³ç›¤</span>
                <div class="data-value text-lg text-text-muted">{marketData?.unchanged ?? 0}</div>
            </div>
            <div>
                <span class="terminal-label">ä¸‹è·Œ</span>
                <div class="data-value text-lg text-bearish">{marketData?.declines ?? 0}</div>
            </div>
        </div>

        <div class="flex items-center justify-between pt-2 border-t border-border">
            <span class="terminal-label">æˆäº¤é‡</span>
            <span class="data-value text-sm text-text-secondary"
                >{marketData?.totalVolume ?? 'â€”'}</span
            >
        </div>
    </div>
</section>
