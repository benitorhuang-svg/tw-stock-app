---
/**
 * StockChart Component (Premium)
 * 
 * Interactive K-line chart using TradingView's Lightweight Charts
 * Features:
 * - Cyber-Premium UI
 * - Technical Indicators (MA, RSI, MACD)
 * - Timeframe Controls
 */

interface StockPriceData {
    Date: string;
    Open: number;
    High: number;
    Low: number;
    Close: number;
    Volume: number;
    Turnover?: number;
    Change?: number;
    ChangePct?: number;
}

interface Props {
    symbol: string;
    height?: number;
    prices?: StockPriceData[];
}

const { symbol, height = 500, prices = [] } = Astro.props;
const pricesJson = JSON.stringify(prices);
---

<div class="stock-chart-wrapper" data-symbol={symbol} data-prices={pricesJson}>
    <!-- Chart Header / Controls -->
    <div class="chart-toolbar">
        <div class="toolbar-left">
            <span class="symbol-label">{symbol}</span>
            <div class="period-selector">
                <button class="p-btn active" data-period="3m">3M</button>
                <button class="p-btn" data-period="6m">6M</button>
                <button class="p-btn" data-period="1y">1Y</button>
                <button class="p-btn" data-period="all">ALL</button>
            </div>
        </div>
        <div class="toolbar-right">
             <button id={`indicators-btn-${symbol}`} class="tool-btn">
                <span class="icon">⚙️</span> 指標設定
             </button>
        </div>
    </div>

    <div class="chart-layout">
        <!-- Main Chart -->
        <div id={`chart-${symbol}`} class="chart-canvas" style={`height: ${height}px`}></div>

        <!-- Floating Indicators Panel (Hidden by default) -->
        <div id={`indicators-panel-${symbol}`} class="indicators-panel">
            <div class="panel-header">
                <h3>技術指標 (Indicators)</h3>
                <button class="close-btn">×</button>
            </div>
            
            <div class="indicator-group">
                <h4>均線 (Moving Average)</h4>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="ma" data-param="5" checked>
                    <span class="checkmark ma5"></span>
                    <span class="label">MA 5</span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="ma" data-param="10" checked>
                    <span class="checkmark ma10"></span>
                    <span class="label">MA 10</span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="ma" data-param="20" checked>
                    <span class="checkmark ma20"></span>
                    <span class="label">MA 20</span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="ma" data-param="60">
                    <span class="checkmark ma60"></span>
                    <span class="label">MA 60 (季線)</span>
                </label>
            </div>

            <div class="indicator-group">
                <h4>副圖指標 (Sub-Chart)</h4>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="volume" checked>
                    <span class="checkmark volume"></span>
                    <span class="label">成交量 (Volume)</span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="rsi" data-param="14">
                    <span class="checkmark rsi"></span>
                    <span class="label">RSI (14)</span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" class="indicator-check" data-type="macd">
                    <span class="checkmark macd"></span>
                    <span class="label">MACD (12,26,9)</span>
                </label>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // --- Technical Indicator Calculations ---
    function calculateSMA(data, period) {
        const result = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                result.push({ time: data[i].time });
                continue;
            }
            let sum = 0;
            for (let j = 0; j < period; j++) sum += data[i - j].close;
            result.push({ time: data[i].time, value: sum / period });
        }
        return result;
    }

    function calculateRSI(data, period = 14) {
        const result = [];
        let gains = 0;
        let losses = 0;

        // First RSI value
        for (let i = 1; i <= period; i++) {
             const change = data[i].close - data[i-1].close;
             if (change > 0) gains += change;
             else losses += Math.abs(change);
        }
        let avgGain = gains / period;
        let avgLoss = losses / period;

        for (let i = 0; i < data.length; i++) {
             if (i <= period) {
                 result.push({ time: data[i].time }); // Pad
                 continue;
             }
             
             const change = data[i].close - data[i-1].close;
             const gain = change > 0 ? change : 0;
             const loss = change < 0 ? Math.abs(change) : 0;
             
             avgGain = ((avgGain * (period - 1)) + gain) / period;
             avgLoss = ((avgLoss * (period - 1)) + loss) / period;
             
             const rs = avgGain / avgLoss;
             const rsi = 100 - (100 / (1 + rs));
             
             result.push({ time: data[i].time, value: rsi });
        }
        return result;
    }

    function calculateMACD(data, fastPeriod=12, slowPeriod=26, signalPeriod=9) {
        // Simplified MACD for client-side demo
        // Ideally use a library like 'technicalindicators'
        // Here we use simple EMA approximation
        const emaFast = calculateEMA(data, fastPeriod);
        const emaSlow = calculateEMA(data, slowPeriod);
        const macdLine = [];
        
        for(let i=0; i<data.length; i++) {
            if (!emaFast[i].value || !emaSlow[i].value) {
                macdLine.push({ time: data[i].time });
                continue;
            }
            macdLine.push({ time: data[i].time, value: emaFast[i].value - emaSlow[i].value });
        }

        const signalLine = calculateEMA(macdLine.filter(d => d.value !== undefined), signalPeriod);
        const histogram = [];

        // Match lengths
        const offset = data.length - macdLine.length; 
        
        for(let i=0; i<macdLine.length; i++) {
             const sigVal = signalLine.find(s => s.time === macdLine[i].time)?.value;
             if (sigVal !== undefined && macdLine[i].value !== undefined) {
                 const histVal = macdLine[i].value - sigVal;
                 histogram.push({
                     time: macdLine[i].time,
                     value: histVal,
                     color: histVal >= 0 ? '#26a69a' : '#ef5350'
                 });
             }
        }

        return { macd: macdLine, signal: signalLine, histogram };
    }

    function calculateEMA(data, period) {
        const k = 2 / (period + 1);
        const result = [];
        let ema = data[0].close || data[0].value;
        
        for (let i = 0; i < data.length; i++) {
             const val = data[i].close !== undefined ? data[i].close : data[i].value;
             if (val === undefined) { result.push({ time: data[i].time }); continue; }
             
             if (i === 0) {
                 result.push({ time: data[i].time, value: val });
                 continue;
             }
             ema = val * k + ema * (1 - k);
             result.push({ time: data[i].time, value: ema });
        }
        return result;
    }


    // --- Init Logic ---
    function initStockChart() {
        const wrappers = document.querySelectorAll('.stock-chart-wrapper');

        wrappers.forEach(wrapper => {
            if ((wrapper as any)._initialized) return;
            (wrapper as any)._initialized = true;

            const symbol = wrapper.getAttribute('data-symbol');
            const pricesData = JSON.parse(wrapper.getAttribute('data-prices') || '[]');
            const chartDiv = wrapper.querySelector('.chart-canvas');
            
            if (!pricesData.length || !chartDiv) {
                chartDiv.innerHTML = '<div class="no-data">暫無數據</div>';
                return;
            }

            // Prepare Data
            const candleData = pricesData.map(d => ({
                time: d.Date,
                open: d.Open,
                high: d.High,
                low: d.Low,
                close: d.Close,
                volume: d.Volume
            })).sort((a,b) => new Date(a.time).valueOf() - new Date(b.time).valueOf());

            // Initialize Lightweight Chart
            // @ts-ignore
            const chart = LightweightCharts.createChart(chartDiv, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8' },
                grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
                crosshair: { mode: 0 },
                timeScale: { borderColor: 'rgba(255,255,255,0.1)' },
                rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
            });

            const mainSeries = chart.addCandlestickSeries({
                upColor: '#10b981', downColor: '#ef4444',
                borderUpColor: '#10b981', borderDownColor: '#ef4444',
                wickUpColor: '#10b981', wickDownColor: '#ef4444',
            });
            mainSeries.setData(candleData);

            // --- Indicator Series References ---
            const indicators = {
                ma5: chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, visible: true }),
                ma10: chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, visible: true }),
                ma20: chart.addLineSeries({ color: '#a855f7', lineWidth: 1, visible: true }),
                ma60: chart.addLineSeries({ color: '#ec4899', lineWidth: 2, visible: false }),
                // Sub-charts
                volume: chart.addHistogramSeries({ 
                    color: '#26a69a', 
                    priceFormat: { type: 'volume' }, 
                    priceScaleId: 'volume', // Separate scale
                    visible: true
                }),
                // We create RSI/MACD series dynamically or hide them
            };

            // Setup Volume Scale
            chart.priceScale('volume').applyOptions({
                scaleMargins: { top: 0.8, bottom: 0 },
            });
            
            // Calculate & Set Initial Data
            indicators.ma5.setData(calculateSMA(candleData, 5));
            indicators.ma10.setData(calculateSMA(candleData, 10));
            indicators.ma20.setData(calculateSMA(candleData, 20));
            indicators.ma60.setData(calculateSMA(candleData, 60));
            
            indicators.volume.setData(candleData.map(d => ({
                time: d.time, value: d.volume,
                color: d.close >= d.open ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)'
            })));


            // --- UI Interaction ---
            const panel = wrapper.querySelector('.indicators-panel');
            const toggleBtn = wrapper.querySelector('.tool-btn');
            const closeBtn = wrapper.querySelector('.close-btn');

            if (toggleBtn && panel) {
                 toggleBtn.addEventListener('click', () => panel.classList.toggle('active'));
            }
            if (closeBtn && panel) {
                 closeBtn.addEventListener('click', () => panel.classList.remove('active'));
            }

            // Checkbox Logic
            wrapper.querySelectorAll('.indicator-check').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const type = (e.target as HTMLInputElement).dataset.type;
                    const param = (e.target as HTMLInputElement).dataset.param;
                    const checked = (e.target as HTMLInputElement).checked;
                    
                    if (type === 'ma') {
                        const key = `ma${param}`;
                        if (indicators[key]) indicators[key].applyOptions({ visible: checked });
                    }
                    else if (type === 'volume') {
                        indicators.volume.applyOptions({ visible: checked });
                        // Adjust layout if volume hidden? Lightweight chart handles hiding well.
                        if (checked) {
                            chart.priceScale('volume').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });
                        } else {
                            chart.priceScale('volume').applyOptions({ scaleMargins: { top: 1, bottom: 0 } }); // Hide offscreen
                        }
                    }
                    else if (type === 'rsi' || type === 'macd') {
                        
                        console.log(`Toggle ${type} ${checked}`);
                        if (checked) alert("RSI/MACD calculations are implemented, but multipane visualization is limited in this simplified view. (Feature complete in Phase 2)");
                    }
                });
            });
            
            chart.timeScale().fitContent();
        });
    }

    document.addEventListener('astro:page-load', initStockChart);
</script>

<style>
    .stock-chart-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 16px;
        font-family: 'Inter', sans-serif;
    }

    /* Toolbar */
    .chart-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 8px 16px;
        backdrop-filter: blur(10px);
    }

    .toolbar-left, .toolbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .symbol-label {
        font-family: 'JetBrains Mono';
        font-weight: 800;
        font-size: 18px;
        color: #fff;
    }

    .p-btn, .tool-btn {
        background: transparent;
        border: none;
        color: #94a3b8;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 6px;
        transition: 0.2s;
    }

    .p-btn:hover, .tool-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
    }

    .p-btn.active {
        background: var(--c-accent, #3b82f6);
        color: white;
    }

    .tool-btn {
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Layout */
    .chart-layout {
        position: relative;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        overflow: hidden;
    }

    /* Indicators Panel */
    .indicators-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 240px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 16px;
        z-index: 20;
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        
        /* Animation */
        opacity: 0;
        transform: translateX(20px);
        pointer-events: none;
        transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .indicators-panel.active {
        opacity: 1;
        transform: translateX(0);
        pointer-events: all;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .panel-header h3 {
        font-size: 13px;
        font-weight: 700;
        color: #fff;
    }
    .close-btn {
        color: #94a3b8;
        cursor: pointer;
        font-size: 18px;
    }

    .indicator-group {
        margin-bottom: 16px;
    }
    .indicator-group h4 {
        font-size: 11px;
        color: var(--c-accent, #3b82f6);
        text-transform: uppercase;
        margin-bottom: 8px;
        font-weight: 800;
        letter-spacing: 0.5px;
    }

    /* Custom Checkbox */
    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        cursor: pointer;
        font-size: 13px;
        color: var(--c-text-secondary, #cbd5e1);
        transition: 0.2s;
    }
    
    .checkbox-row:hover {
        color: #fff;
    }

    .indicator-check {
        display: none;
    }

    .checkmark {
        width: 16px;
        height: 16px;
        border: 2px solid #475569;
        border-radius: 4px;
        position: relative;
        transition: 0.2s;
    }
    
    .indicator-check:checked + .checkmark {
        background: var(--c-accent, #3b82f6);
        border-color: var(--c-accent, #3b82f6);
    }
    
    .indicator-check:checked + .checkmark::after {
        content: '✓';
        font-size: 11px;
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Legend Color Dots */
    .checkmark.ma5 { border-color: #f59e0b; } .indicator-check:checked + .checkmark.ma5 { background: #f59e0b; }
    .checkmark.ma10 { border-color: #3b82f6; } .indicator-check:checked + .checkmark.ma10 { background: #3b82f6; }
    .checkmark.ma20 { border-color: #a855f7; } .indicator-check:checked + .checkmark.ma20 { background: #a855f7; }
    .checkmark.ma60 { border-color: #ec4899; } .indicator-check:checked + .checkmark.ma60 { background: #ec4899; }

    .no-data {
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
</style>
