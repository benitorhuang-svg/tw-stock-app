---
/**
 * StockScreener.astro â€” Interactive stock screening organism
 * Connects to M3 screener logic for filtering stocks.
 */
import Badge from '../atoms/Badge.astro';

// Import strategies from data layer
type StrategyMeta = {
    id: string;
    name: string;
    description: string;
    icon: string;
    category?: 'fundamental' | 'technical' | 'sentiment';
};

let strategies: StrategyMeta[] = [];
try {
    const { strategies: s } = await import('../../data/strategies');
    strategies = s?.slice(0, 12) ?? [];
} catch {
    strategies = [
        {
            id: 'low-pe',
            name: 'ä½æœ¬ç›Šæ¯”',
            description: 'æœ¬ç›Šæ¯”ä½æ–¼ 15 ä¸¦æ’é™¤è™§æå…¬å¸',
            icon: 'ğŸ’°',
            category: 'fundamental',
        },
        {
            id: 'high-dividend',
            name: 'é«˜è‚¡æ¯æ®–åˆ©ç‡',
            description: 'æ®–åˆ©ç‡é«˜æ–¼ 5%',
            icon: 'ğŸ’µ',
            category: 'fundamental',
        },
        {
            id: 'volume-breakout',
            name: 'é‡åƒ¹é½Šæš',
            description: 'æˆäº¤é‡æ”¾å¤§ + ç«™ä¸Šå‡ç·š',
            icon: 'ğŸš€',
            category: 'technical',
        },
        {
            id: 'foreign-buy',
            name: 'å¤–è³‡é€£è²·',
            description: 'æœ€æ–°å¤–è³‡è²·è¶…ç‚ºæ­£',
            icon: 'ğŸŒ',
            category: 'sentiment',
        },
    ];
}

const categoryLabel: Record<string, string> = {
    fundamental: 'åŸºæœ¬é¢',
    technical: 'æŠ€è¡“é¢',
    sentiment: 'ç±Œç¢¼é¢',
};
---

<section id="screener-panel" class="grid grid-cols-1 xl:grid-cols-12 gap-4 min-h-[calc(100dvh-210px)]">
    <aside class="xl:col-span-4 glass-card p-4 flex flex-col gap-3 overflow-hidden">
        <div class="flex items-center justify-between border-b border-border pb-3">
            <div>
                <div class="terminal-label">Strategy Presets</div>
                <h3 class="text-sm font-bold text-text-primary mt-1">ç­–ç•¥æ¢ä»¶ç·¨è­¯å™¨</h3>
            </div>
            <Badge variant="accent">M3</Badge>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div class="bg-surface rounded border border-border p-2">
                <div class="text-[9px] uppercase tracking-widest text-text-muted font-bold">ç­–ç•¥æ•¸</div>
                <div class="data-value text-accent mt-1">{strategies.length}</div>
            </div>
            <div class="bg-surface rounded border border-border p-2">
                <div class="text-[9px] uppercase tracking-widest text-text-muted font-bold">æ¨¡å¼</div>
                <div class="text-xs font-mono text-text-primary mt-1">SQL</div>
            </div>
            <div class="bg-surface rounded border border-border p-2">
                <div class="text-[9px] uppercase tracking-widest text-text-muted font-bold">è³‡æ–™æº</div>
                <div class="text-xs font-mono text-bullish mt-1">LOCAL</div>
            </div>
        </div>

        <div class="space-y-2 overflow-y-auto pr-1 custom-scrollbar">
            {
                strategies.map(strategy => (
                    <button
                        class="w-full text-left glass-card glow-interactive p-3 transition-all duration-300 hover:border-accent/30 cursor-pointer group"
                        data-strategy={strategy.id}
                    >
                        <div class="flex items-start gap-2.5">
                            <span class="text-xl leading-none">{strategy.icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <h4 class="text-sm font-bold text-text-primary group-hover:text-accent transition-colors truncate">
                                        {strategy.name}
                                    </h4>
                                    {
                                        strategy.category && (
                                            <Badge variant="muted" class="shrink-0">
                                                {categoryLabel[strategy.category]}
                                            </Badge>
                                        )
                                    }
                                </div>
                                <p class="text-xs text-text-secondary mt-1 line-clamp-2">{strategy.description}</p>
                            </div>
                        </div>
                    </button>
                ))
            }
        </div>
    </aside>

    <main class="xl:col-span-8 glass-card p-0 overflow-hidden flex flex-col">
        <header class="terminal-toolbar">
            <div class="terminal-toolbar-left">
                <span class="terminal-toolbar-title">Screening Results</span>
                <span id="active-strategy-label" class="terminal-toolbar-meta">å°šæœªé¸æ“‡ç­–ç•¥</span>
            </div>
            <div class="terminal-toolbar-right">
                <button
                    id="csv-export-btn"
                    class="hidden px-3 py-1 text-[11px] font-mono font-bold rounded bg-accent/10 text-accent border border-accent/20 hover:bg-accent/20 transition-colors cursor-pointer"
                    aria-label="åŒ¯å‡º CSV"
                >
                    ğŸ“¥ åŒ¯å‡º CSV
                </button>
                <span id="screener-count" class="data-value text-sm text-accent">0</span>
                <span class="terminal-toolbar-meta">Matches</span>
            </div>
        </header>

        <div id="screener-empty" class="flex-1 grid place-items-center p-8">
            <div class="text-center max-w-md">
                <div class="text-4xl mb-4">ğŸ”</div>
                <h3 class="text-lg font-bold text-text-primary mb-2">é¸æ“‡ä¸€å€‹ç­–ç•¥é–‹å§‹ç¯©é¸</h3>
                <p class="text-sm text-text-secondary">
                    é»æ“Šå·¦å´ç­–ç•¥å¾Œï¼Œç³»çµ±æœƒä»¥ SQLite æ¢ä»¶æŸ¥è©¢å›å‚³ç¬¦åˆæ¨™çš„ï¼Œçµæœç¶­æŒé«˜å¯†åº¦çµ‚ç«¯è¡¨æ ¼æ ¼å¼ã€‚
                </p>
            </div>
        </div>

        <div id="screener-results" class="hidden flex-1 overflow-auto custom-scrollbar">
            <table class="w-full text-left border-collapse min-w-[860px]" id="screener-table">
                <thead class="sticky top-0 bg-base-deep z-10 border-b border-border/60">
                    <tr>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted">Symbol</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted">Name</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">Price</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">Change%</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">PE</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">PB</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">Yield</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted text-right">Volume</th>
                        <th class="px-3 py-2 text-[10px] uppercase tracking-wider text-text-muted">Tag</th>
                    </tr>
                </thead>
                <tbody id="screener-results-grid" class="divide-y divide-border/30"></tbody>
            </table>
        </div>
    </main>
</section>

<script>
    import { downloadCSV } from '../../lib/csv-export';
    import { toast } from '../../lib/toast';

    let activeStrategyName = '';
    let lastResults: any[] = [];
    const resultsContainer = document.getElementById('screener-results');
    const resultsGrid = document.getElementById('screener-results-grid');
    const resultsCount = document.getElementById('screener-count');
    const emptyState = document.getElementById('screener-empty');
    const activeStrategyLabel = document.getElementById('active-strategy-label');
    const csvExportBtn = document.getElementById('csv-export-btn');

    const PRESET_PAYLOAD: Record<string, any> = {
        'low-pe': { pe: { max: 15 } },
        'low-pb': { pb: { max: 1.5 } },
        'high-dividend': { dividendYield: { min: 5 } },
        'revenue-growth': { revenueYoY: { min: 10 } },
        'volume-breakout': {},
        breakout: {},
        'foreign-buy': {},
        'trust-buy': {},
    };

    const formatNum = (value: number | undefined, digits = 2) => {
        if (value === undefined || value === null || Number.isNaN(value)) return 'â€”';
        return Number(value).toFixed(digits);
    };

    function renderResults(stocks: any[]) {
        if (!resultsGrid) return;

        resultsGrid.innerHTML = stocks
            .map(
                stock => `
            <tr class="hover:bg-accent/5 transition-colors cursor-pointer" data-link="/stocks/${stock.symbol}" data-symbol="${stock.symbol}">
                <td class="px-3 py-2 text-xs font-mono text-text-secondary">${stock.symbol}</td>
                <td class="px-3 py-2 text-sm font-semibold text-text-primary">${stock.name || 'â€”'}</td>
                <td class="px-3 py-2 text-xs font-mono text-right text-text-secondary">${formatNum(stock.price)}</td>
                <td class="px-3 py-2 text-xs font-mono text-right ${Number(stock.changePercent) >= 0 ? 'text-bullish' : 'text-bearish'}">${formatNum(stock.changePercent)}%</td>
                <td class="px-3 py-2 text-xs font-mono text-right text-text-secondary">${formatNum(stock.fundamentals?.pe, 1)}</td>
                <td class="px-3 py-2 text-xs font-mono text-right text-text-secondary">${formatNum(stock.fundamentals?.pb, 2)}</td>
                <td class="px-3 py-2 text-xs font-mono text-right text-text-secondary">${formatNum(stock.fundamentals?.dividendYield, 2)}%</td>
                <td class="px-3 py-2 text-xs font-mono text-right text-text-secondary">${Number(stock.volume || 0).toLocaleString()}</td>
                <td class="px-3 py-2 text-xs text-accent">${(stock.matchedStrategies || []).join(' / ')}</td>
            </tr>
        `
            )
            .join('');
    }

    resultsGrid?.addEventListener('click', event => {
        const target = event.target as HTMLElement;
        const row = target.closest<HTMLTableRowElement>('tr[data-link]');
        const href = row?.dataset.link;
        if (href) window.location.href = href;
    });

    // Strategy card click handling
    document.querySelectorAll('[data-strategy]').forEach(card => {
        card.addEventListener('click', async () => {
            const strategyId = (card as HTMLElement).dataset.strategy;
            if (!strategyId) return;

            // Visual active state
            document.querySelectorAll('[data-strategy]').forEach(c => {
                c.classList.remove('border-accent/50', 'bg-accent/5');
            });
            card.classList.add('border-accent/50', 'bg-accent/5');

            activeStrategyName =
                card.querySelector('h4')?.textContent?.trim() || card.querySelector('h3')?.textContent?.trim() || strategyId;
            if (activeStrategyLabel) activeStrategyLabel.textContent = activeStrategyName;

            const filters: any = {
                page: 1,
                limit: 50,
                strategyId,
                ...(PRESET_PAYLOAD[strategyId] || {}),
            };

            try {
                // Show loading state
                if (resultsCount) resultsCount.textContent = '...';
                emptyState?.classList.add('hidden');
                resultsContainer?.classList.remove('hidden');
                if (resultsGrid)
                    resultsGrid.innerHTML =
                        Array.from({ length: 8 })
                            .map(
                                () =>
                                    '<tr class="table-loading-row border-b border-border/30"><td colspan="9"><div class="skeleton"></div></td></tr>'
                            )
                            .join('');

                const res = await fetch('/api/screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters),
                });

                const data = await res.json();

                if (data.success) {
                    if (resultsCount) resultsCount.textContent = data.pagination.total;
                    lastResults = data.results;
                    renderResults(data.results);
                    csvExportBtn?.classList.toggle('hidden', data.results.length === 0);

                    if (data.results.length === 0) {
                        if (resultsGrid)
                            resultsGrid.innerHTML =
                                '<tr><td colspan="9" class="py-12 text-center text-text-muted text-sm italic">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</td></tr>';
                    } else {
                        toast.show({ message: `æ‰¾åˆ° ${data.results.length} æª”ç¬¦åˆã€Œ${activeStrategyName}ã€`, type: 'success', duration: 2500 });
                    }
                } else {
                    if (resultsGrid)
                        resultsGrid.innerHTML =
                            `<tr><td colspan="9" class="py-12 text-center text-bearish text-sm">${data.error || 'æŸ¥è©¢å¤±æ•—'}</td></tr>`;
                    if (resultsCount) resultsCount.textContent = '0';
                    csvExportBtn?.classList.add('hidden');
                    toast.show({ message: data.error || 'ç¯©é¸æŸ¥è©¢å¤±æ•—', type: 'error' });
                }
            } catch (err) {
                console.error('[Screener] Fetch error:', err);
                if (resultsGrid)
                    resultsGrid.innerHTML =
                        '<tr><td colspan="9" class="py-12 text-center text-bearish text-sm">ç„¡æ³•é€£ç·šåˆ°ç¯©é¸æœå‹™ï¼Œè«‹ç¨å¾Œå†è©¦</td></tr>';
                if (resultsCount) resultsCount.textContent = '0';
                csvExportBtn?.classList.add('hidden');
                toast.show({ message: 'ç„¡æ³•é€£ç·šåˆ°ç¯©é¸æœå‹™', type: 'error' });
            }
        });
    });

    // CSV Export
    csvExportBtn?.addEventListener('click', () => {
        if (lastResults.length === 0) return;
        const headers = ['è‚¡ç¥¨ä»£è™Ÿ', 'è‚¡ç¥¨åç¨±', 'åƒ¹æ ¼', 'æ¼²è·Œå¹…%', 'æœ¬ç›Šæ¯”', 'è‚¡åƒ¹æ·¨å€¼æ¯”', 'æ®–åˆ©ç‡', 'æˆäº¤é‡', 'ç­–ç•¥'];
        const rows = lastResults.map((s: any) => [
            s.symbol,
            s.name || '',
            s.price ?? '',
            s.changePercent ?? '',
            s.fundamentals?.pe ?? '',
            s.fundamentals?.pb ?? '',
            s.fundamentals?.dividendYield ?? '',
            s.volume ?? '',
            (s.matchedStrategies || []).join('; '),
        ]);
        const csvContent = [headers.join(','), ...rows.map((r: any[]) => r.map((c: any) => `"${c}"`).join(','))].join('\n');
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const date = new Date().toISOString().slice(0, 10);
        link.download = `é¸è‚¡çµæœ_${activeStrategyName}_${date}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        toast.show({ message: `å·²åŒ¯å‡º ${lastResults.length} ç­†çµæœ`, type: 'success', duration: 2000 });
    });

    // real-time price updates for screener results
    if (typeof EventSource !== 'undefined') {
        const es = new EventSource('/api/sse/stream');
        es.addEventListener('tick', e => {
            try {
                const ticks = JSON.parse(e.data);
                ticks.forEach((t: any) => {
                    const row = document.querySelector(`tr[data-symbol="${t.symbol}"]`);
                    if (row) {
                        const priceCell = row.querySelector('td:nth-child(3)');
                        if (priceCell) priceCell.textContent = t.price.toFixed(2);
                        row.classList.add('flash');
                        setTimeout(() => row.classList.remove('flash'), 800);
                    }
                });
            } catch {}
        });
    }
</script>
