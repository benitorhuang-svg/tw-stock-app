---
/**
 * StockScreener.astro â€” Interactive stock screening organism
 * Connects to M3 screener logic for filtering stocks.
 */
import Badge from '../atoms/Badge.astro';

// Import strategies from data layer
let strategies: { id: string; name: string; description: string; icon: string }[] = [];
try {
    const { strategies: s } = await import('../../data/strategies');
    strategies = s?.slice(0, 6) ?? [];
} catch {
    strategies = [
        { id: 'value', name: 'åƒ¹å€¼ä½ä¼°', description: 'æœ¬ç›Šæ¯”ä½æ–¼æ­·å²å¹³å‡', icon: 'ğŸ’' },
        { id: 'momentum', name: 'å‹•èƒ½çªç ´', description: 'åƒ¹æ ¼çªç ´ MA20/MA60', icon: 'ğŸš€' },
        { id: 'dividend', name: 'é«˜æ®–åˆ©ç‡', description: 'æ®–åˆ©ç‡ > 5% ä¸”ç©©å®š', icon: 'ğŸ’°' },
        { id: 'institutional', name: 'æ³•äººåŒè²·', description: 'å¤–è³‡æŠ•ä¿¡åŒæ­¥è²·è¶…', icon: 'ğŸ¦' },
        { id: 'growth', name: 'ç‡Ÿæ”¶æˆé•·', description: 'é€£çºŒä¸‰æœˆ YoY å¢é•·', icon: 'ğŸ“ˆ' },
        { id: 'turnaround', name: 'è½‰æ©Ÿé»‘é¦¬', description: 'ç”±è™§è½‰ç›ˆæˆ–ç‡Ÿæ”¶ç¿»æ­£', icon: 'ğŸ”„' },
    ];
}
---

<section class="space-y-6" id="screener-panel">
    <!-- Strategy Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 stagger-children">
        {
            strategies.map(strategy => (
                <button
                    class="glass-card glow-interactive p-5 text-left transition-all duration-300 hover:scale-[1.02] hover:border-accent/30 cursor-pointer group"
                    data-strategy={strategy.id}
                >
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">{strategy.icon}</span>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-text-primary group-hover:text-accent transition-colors">
                                {strategy.name}
                            </h3>
                            <p class="text-xs text-text-secondary mt-1">{strategy.description}</p>
                        </div>
                        <Badge variant="muted">ç­–ç•¥</Badge>
                    </div>
                </button>
            ))
        }
    </div>

    <!-- Results Area (populated by client-side JS) -->
    <div id="screener-results" class="hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-text-primary">ç¯©é¸çµæœ</h3>
            <div class="flex items-center gap-2">
                <span id="screener-count" class="data-value text-sm text-accent">0</span>
                <span class="text-xs text-text-muted">æª”ç¬¦åˆ</span>
            </div>
        </div>
        <div
            id="screener-results-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Empty State -->
    <div id="screener-empty" class="glass-card p-12 text-center">
        <div class="text-4xl mb-4">ğŸ”</div>
        <h3 class="text-lg font-bold text-text-primary mb-2">é¸æ“‡ä¸€å€‹ç­–ç•¥é–‹å§‹ç¯©é¸</h3>
        <p class="text-sm text-text-secondary max-w-md mx-auto">
            é»æ“Šä¸Šæ–¹çš„ç­–ç•¥å¡ç‰‡ï¼Œç³»çµ±å°‡å¾æœ¬åœ° SQLite è³‡æ–™åº«ä¸­å¿«é€Ÿç¯©é¸ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ã€‚
        </p>
    </div>
</section>

<script>
    import type { StockFullData } from '../../utils/stockDataService';

    let activeStrategy = '';
    const resultsContainer = document.getElementById('screener-results');
    const resultsGrid = document.getElementById('screener-results-grid');
    const resultsCount = document.getElementById('screener-count');
    const emptyState = document.getElementById('screener-empty');

    function renderResults(stocks: any[]) {
        if (!resultsGrid) return;

        resultsGrid.innerHTML = stocks
            .map(
                stock => `
            <a href="/stocks/${stock.symbol}" class="glass-card p-4 hover:border-accent/40 transition-all group">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="text-[10px] font-mono text-text-muted mb-0.5">${stock.symbol}</div>
                        <div class="text-sm font-bold text-text-primary group-hover:text-accent transition-colors">${stock.name}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-mono font-bold ${stock.fundamentals?.pe > 0 ? 'text-accent' : 'text-text-muted'}">
                            PE: ${stock.fundamentals?.pe?.toFixed(1) || 'â€”'}
                        </div>
                        <div class="text-[9px] text-text-muted">Yield: ${stock.fundamentals?.dividendYield?.toFixed(2)}%</div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-1 mt-3">
                    ${stock.matchedStrategies
                        .map(
                            (s: string) => `
                        <span class="px-1.5 py-0.5 rounded text-[8px] bg-accent/10 text-accent border border-accent/20 font-bold uppercase tracking-tighter">
                            ${s}
                        </span>
                    `
                        )
                        .join('')}
                </div>
            </a>
        `
            )
            .join('');
    }

    // Strategy card click handling
    document.querySelectorAll('[data-strategy]').forEach(card => {
        card.addEventListener('click', async () => {
            const strategyId = (card as HTMLElement).dataset.strategy;
            if (!strategyId) return;

            // Visual active state
            document.querySelectorAll('[data-strategy]').forEach(c => {
                c.classList.remove('border-accent/50', 'bg-accent/5');
            });
            card.classList.add('border-accent/50', 'bg-accent/5');

            activeStrategy = strategyId;

            // Prepare filter conditions based on strategy
            const filters: any = { page: 1, limit: 12 };
            if (strategyId === 'value') filters.pe = { max: 15 };
            if (strategyId === 'dividend') filters.dividendYield = { min: 5 };
            if (strategyId === 'growth') filters.roe = { min: 15 };
            if (strategyId === 'momentum') filters.pe = { max: 25 };

            try {
                // Show loading state
                if (resultsCount) resultsCount.textContent = '...';
                emptyState?.classList.add('hidden');
                resultsContainer?.classList.remove('hidden');
                if (resultsGrid)
                    resultsGrid.innerHTML =
                        '<div class="col-span-full py-12 flex justify-center"><div class="w-6 h-6 border-2 border-accent border-t-transparent rounded-full animate-spin"></div></div>';

                const res = await fetch('/api/screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters),
                });

                const data = await res.json();

                if (data.success) {
                    if (resultsCount) resultsCount.textContent = data.pagination.total;
                    renderResults(data.results);

                    if (data.results.length === 0) {
                        if (resultsGrid)
                            resultsGrid.innerHTML =
                                '<div class="col-span-full py-12 text-center text-text-muted text-sm italic">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</div>';
                    }
                }
            } catch (err) {
                console.error('[Screener] Fetch error:', err);
            }
        });
    });
</script>
