---
/**
 * MarketStatusPanel.astro — (Molecule) 市場概況面板
 *
 * Atomic Design: Molecule
 * Composed of: CyberCalendar (Organism) + MarketBreadth (Molecule) + Metric Atoms
 *
 * Displays: Date Picker, Volume, Avg Change, Breadth Bar, Ratio, Up/Down/Flat counts.
 * All elements carry IDs for client-side hydration (SSE / Temporal Shift).
 */
import CyberCalendar from '../organisms/CyberCalendar.astro';
import MarketBreadth from './MarketBreadth.astro';
import { fmtVol } from '../../utils/format';

interface Props {
    dataDate: string;
    totalVolume: number;
    avgChange: number;
    upCount: number;
    downCount: number;
    flatCount: number;
    totalStocks: number;
    class?: string;
}

const {
    dataDate,
    totalVolume,
    avgChange,
    upCount,
    downCount,
    flatCount,
    totalStocks,
    class: className = '',
} = Astro.props;

const ratio = downCount > 0 ? upCount / downCount : 999;
const isBullishRatio = ratio >= 1;
---

<div class:list={['glass-card relative z-30 overflow-visible border-border/40 group', className]}>
    <!-- Decorative top glow -->
    <div
        class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-accent/40 to-transparent"
    >
    </div>

    <div class="px-4 py-3 space-y-3">
        <!-- Header: Session Information -->
        <div class="flex items-center justify-between py-1 gap-3">
            <CyberCalendar
                id="market-date-picker"
                value={dataDate || '2026-02-24'}
                class="flex-1"
            />

            <!-- Analytics Trigger -->
            <button
                id="open-breadth-chart"
                class="relative h-12 w-12 flex items-center justify-center rounded-2xl bg-[#0a0c10]/80 border border-accent/20 hover:border-accent/50 hover:bg-accent/10 transition-all duration-500 group/chart shadow-[0_0_20px_rgba(0,0,0,0.5)] cursor-pointer"
                title="市場統計趨勢"
            >
                <div
                    class="absolute inset-0 opacity-[0.05] pointer-events-none bg-[linear-gradient(rgba(59,130,246,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(59,130,246,0.1)_1px,transparent_1px)] bg-[size:4px_4px]"
                >
                </div>
                <svg
                    class="w-5 h-5 text-accent/40 group-hover/chart:text-accent group-hover/chart:scale-110 transition-all duration-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 gap-2 pt-1 pb-2">
            <!-- Volume Block -->
            <div
                class="flex flex-col p-2.5 rounded-lg bg-surface/50 border border-border/10 group-hover:border-accent/40 transition-all duration-300"
            >
                <div class="flex items-center gap-1.5 mb-0.5">
                    <span class="text-[9px] text-text-muted font-bold uppercase">成交量</span>
                    <span class="text-[10px] text-text-muted/40 font-mono">VOL</span>
                </div>
                <span
                    class="text-lg font-mono font-bold text-stock-volume leading-none tracking-tighter"
                    id="market-volume"
                >
                    {fmtVol(totalVolume)}
                </span>
            </div>

            <!-- Change Block -->
            <div
                class="flex flex-col p-2.5 rounded-lg bg-surface/50 border border-border/10 group-hover:border-accent/40 transition-all duration-300"
            >
                <div class="flex items-center gap-1.5 mb-0.5">
                    <span class="text-[9px] text-text-muted font-bold uppercase">平均漲跌</span>
                    <span class="text-[10px] text-text-muted/40 font-mono">VEL</span>
                </div>
                <span
                    class:list={[
                        'text-lg font-mono font-bold leading-none tracking-tighter',
                        avgChange >= 0 ? 'text-bullish' : 'text-bearish',
                    ]}
                    id="market-change"
                >
                    {avgChange >= 0 ? '+' : ''}{avgChange.toFixed(2)}%
                </span>
            </div>
        </div>

        <!-- Consolidated Market Breadth Module -->
        <div class="px-2 pt-3 pb-1 border-t border-border/10 space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-black text-text-muted/60 uppercase tracking-widest"
                    >Market Breadth</span
                >
                <div
                    id="breadth-ratio-container"
                    class:list={[
                        'text-[10px] font-mono px-2 py-0.5 rounded border-2 transition-all duration-500 font-black',
                        isBullishRatio
                            ? 'bg-bullish/20 text-[#ff4d4d] border-bullish/40 shadow-[0_0_10px_rgba(239,68,68,0.2)]'
                            : 'bg-bearish/20 text-[#00ff88] border-bearish/40 shadow-[0_0_10px_rgba(34,197,94,0.2)]',
                    ]}
                >
                    RATIO <span id="breadth-ratio"
                        >{downCount > 0 ? (upCount / downCount).toFixed(2) : 'MAX'}</span
                    >
                </div>
            </div>

            <MarketBreadth up={upCount} down={downCount} flat={flatCount} total={totalStocks} />

            <!-- Detail Counts -->
            <div class="flex items-center justify-between px-1">
                <div class="flex flex-col items-start">
                    <span class="text-[11px] font-bold text-bearish" id="breadth-down"
                        >{downCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Down</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[11px] font-bold text-text-muted/80" id="breadth-flat"
                        >{flatCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Flat</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[11px] font-bold text-bullish" id="breadth-up">{upCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Up</span>
                </div>
            </div>
        </div>
    </div>
</div>
