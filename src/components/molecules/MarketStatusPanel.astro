---
/**
 * MarketStatusPanel.astro — (Molecule) 市場概況面板
 *
 * Atomic Design: Molecule
 * Composed of: CyberCalendar (Organism) + MarketBreadth (Molecule) + Metric Atoms
 *
 * Displays: Date Picker, Volume, Avg Change, Breadth Bar, Ratio, Up/Down/Flat counts.
 * All elements carry IDs for client-side hydration (SSE / Temporal Shift).
 */
import CyberCalendar from '../organisms/CyberCalendar.astro';
import MarketBreadth from './MarketBreadth.astro';
import { fmtVol } from '../../utils/format';

interface Props {
    dataDate: string;
    totalVolume: number;
    avgChange: number;
    upCount: number;
    downCount: number;
    flatCount: number;
    totalStocks: number;
    class?: string;
}

const {
    dataDate,
    totalVolume,
    avgChange,
    upCount,
    downCount,
    flatCount,
    totalStocks,
    class: className = '',
} = Astro.props;

const ratio = downCount > 0 ? upCount / downCount : 999;
const isBullishRatio = ratio >= 1;
---

<div class:list={['glass-card relative z-30 overflow-visible border-border/40 group', className]}>
    <!-- Decorative top glow -->
    <div
        class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-accent/40 to-transparent"
    >
    </div>

    <div class="px-4 py-3 space-y-3">
        <!-- Header: Session Information -->
        <div class="flex items-center justify-center py-1">
            <CyberCalendar
                id="market-date-picker"
                value={dataDate || '2026-02-24'}
                class="w-full"
            />
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 gap-2 pt-1 pb-2">
            <!-- Volume Block -->
            <div
                class="flex flex-col p-2.5 rounded-lg bg-surface/50 border border-border/10 group-hover:border-accent/40 transition-all duration-300"
            >
                <div class="flex items-center gap-1.5 mb-0.5">
                    <span class="text-[9px] text-text-muted font-bold uppercase">成交量</span>
                    <span class="text-[10px] text-text-muted/40 font-mono">VOL</span>
                </div>
                <span
                    class="text-lg font-mono font-bold text-stock-volume leading-none tracking-tighter"
                    id="market-volume"
                >
                    {fmtVol(totalVolume)}
                </span>
            </div>

            <!-- Change Block -->
            <div
                class="flex flex-col p-2.5 rounded-lg bg-surface/50 border border-border/10 group-hover:border-accent/40 transition-all duration-300"
            >
                <div class="flex items-center gap-1.5 mb-0.5">
                    <span class="text-[9px] text-text-muted font-bold uppercase">平均漲跌</span>
                    <span class="text-[10px] text-text-muted/40 font-mono">VEL</span>
                </div>
                <span
                    class:list={[
                        'text-lg font-mono font-bold leading-none tracking-tighter',
                        avgChange >= 0 ? 'text-bullish' : 'text-bearish',
                    ]}
                    id="market-change"
                >
                    {avgChange >= 0 ? '+' : ''}{avgChange.toFixed(2)}%
                </span>
            </div>
        </div>

        <!-- Consolidated Market Breadth Module -->
        <div class="px-2 pt-3 pb-1 border-t border-border/10 space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-black text-text-muted/60 uppercase tracking-widest"
                    >Market Breadth</span
                >
                <div
                    id="breadth-ratio-container"
                    class:list={[
                        'text-[10px] font-mono px-2 py-0.5 rounded border-2 transition-all duration-500 font-black',
                        isBullishRatio
                            ? 'bg-bullish/20 text-[#ff4d4d] border-bullish/40 shadow-[0_0_10px_rgba(239,68,68,0.2)]'
                            : 'bg-bearish/20 text-[#00ff88] border-bearish/40 shadow-[0_0_10px_rgba(34,197,94,0.2)]',
                    ]}
                >
                    RATIO <span id="breadth-ratio"
                        >{downCount > 0 ? (upCount / downCount).toFixed(2) : 'MAX'}</span
                    >
                </div>
            </div>

            <MarketBreadth up={upCount} down={downCount} flat={flatCount} total={totalStocks} />

            <!-- Detail Counts -->
            <div class="flex items-center justify-between px-1">
                <div class="flex flex-col items-start">
                    <span class="text-[11px] font-bold text-bearish" id="breadth-down"
                        >{downCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Down</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[11px] font-bold text-text-muted/80" id="breadth-flat"
                        >{flatCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Flat</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[11px] font-bold text-bullish" id="breadth-up">{upCount}</span
                    >
                    <span class="text-[8px] text-text-muted/40 uppercase font-black">Up</span>
                </div>
            </div>
        </div>
    </div>
</div>
