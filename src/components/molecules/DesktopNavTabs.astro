---
import { NAV_ITEMS } from '../../config/navigation';
import NavTab from '../atoms/NavTab.astro';

const currentPath = Astro.url.pathname;
const isActive = (path: string) =>
    currentPath === path || (path !== '/' && currentPath.startsWith(path));
---

<nav class="hidden md:flex items-center" aria-label="主要導覽" id="desktop-nav">
    <div class="top-nav-tabs">
        {
            NAV_ITEMS.map(item => (
                <NavTab
                    variant="desktop"
                    path={item.path}
                    label={item.label}
                    icon={item.icon}
                    isActive={isActive(item.path)}
                />
            ))
        }
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>
</nav>

<script>
    // Tab indicator positioning
    function updateTabIndicator() {
        const activeTab = document.querySelector('.top-nav-tab.active') as HTMLElement;
        const indicator = document.getElementById('tab-indicator') as HTMLElement;
        if (activeTab && indicator) {
            const tabsContainer = activeTab.parentElement as HTMLElement;
            const containerRect = tabsContainer.getBoundingClientRect();
            const tabRect = activeTab.getBoundingClientRect();
            indicator.style.width = `${tabRect.width}px`;
            indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
            indicator.style.opacity = '1';
        }
    }

    // Run on load and after view transitions
    updateTabIndicator();
    document.addEventListener('astro:page-load', updateTabIndicator);

    // Hover preview for tabs
    document.querySelectorAll<HTMLElement>('.top-nav-tab').forEach(tab => {
        tab.addEventListener('mouseenter', () => {
            const indicator = document.getElementById('tab-indicator') as HTMLElement;
            const tabsContainer = tab.parentElement as HTMLElement;
            if (indicator && tabsContainer) {
                const containerRect = tabsContainer.getBoundingClientRect();
                const tabRect = tab.getBoundingClientRect();
                indicator.style.width = `${tabRect.width}px`;
                indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
            }
        });
    });

    // Reset indicator on mouse leave from tab container
    document.querySelector('.top-nav-tabs')?.addEventListener('mouseleave', () => {
        updateTabIndicator();
    });
</script>
