---
import { NAV_ITEMS } from '../../config/navigation';
import NavTab from '../atoms/NavTab.astro';

const currentPath = Astro.url.pathname;
const isActive = (path: string) =>
    currentPath === path || (path !== '/' && currentPath.startsWith(path));
---

<nav class="hidden md:flex items-center" aria-label="主要導覽" id="desktop-nav">
    <div class="top-nav-tabs">
        {
            NAV_ITEMS.filter(item => item.label !== '數據觀測' && item.label !== '即時開盤').map(
                item => (
                    <NavTab
                        variant="desktop"
                        path={item.path}
                        label={item.label}
                        icon={item.icon}
                        isActive={isActive(item.path)}
                    />
                )
            )
        }
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>
</nav>

<script>
    function updateActiveTabs() {
        const currentPath = window.location.pathname;

        const updateFn = (tab: HTMLElement) => {
            const path = tab.getAttribute('href');
            if (!path) return;
            // isActive = exact match OR prefix match except for root "/"
            const isActive =
                currentPath === path || (path !== '/' && currentPath.startsWith(path + '/'));
            if (isActive) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        };

        document.querySelectorAll<HTMLElement>('.top-nav-tab').forEach(updateFn);
        document.querySelectorAll<HTMLElement>('.mobile-nav-item').forEach(updateFn);

        ['/database', '/live'].forEach(basePath => {
            const btn = document.querySelector(`header a[href="${basePath}"]`) as HTMLElement;
            if (btn) {
                const isActive = currentPath === basePath || currentPath.startsWith(basePath + '/');
                if (isActive) {
                    btn.classList.add(
                        'bg-accent/15',
                        'border-accent/40',
                        'text-accent',
                        'shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)]',
                        'shadow-inner'
                    );
                    btn.classList.remove(
                        'bg-glass',
                        'border-border',
                        'text-text-muted',
                        'hover:text-text-primary',
                        'hover:border-border-highlight',
                        'hover:bg-glass-hover'
                    );
                } else {
                    btn.classList.remove(
                        'bg-accent/15',
                        'border-accent/40',
                        'text-accent',
                        'shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)]',
                        'shadow-inner'
                    );
                    btn.classList.add(
                        'bg-glass',
                        'border-border',
                        'text-text-muted',
                        'hover:text-text-primary',
                        'hover:border-border-highlight',
                        'hover:bg-glass-hover'
                    );
                }
            }
        });
    }

    // Tab indicator positioning
    function updateTabIndicator() {
        const activeTab = document.querySelector('.top-nav-tab.active') as HTMLElement;
        const indicator = document.getElementById('tab-indicator') as HTMLElement;
        if (activeTab && indicator) {
            const tabsContainer = activeTab.parentElement as HTMLElement;
            const containerRect = tabsContainer.getBoundingClientRect();
            const tabRect = activeTab.getBoundingClientRect();
            indicator.style.width = `${tabRect.width}px`;
            indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
            indicator.style.opacity = '1';
        }
    }

    let navInitialized = false;

    document.addEventListener('astro:page-load', () => {
        // Run update logic across DOM instances manually since this area is now frozen with transition:persist
        updateActiveTabs();
        updateTabIndicator();

        if (navInitialized) return;
        navInitialized = true;

        // Use event delegation once for hover preview
        const tabsContainer = document.querySelector('.top-nav-tabs');
        const indicator = document.getElementById('tab-indicator') as HTMLElement;

        if (tabsContainer && indicator) {
            tabsContainer.addEventListener('mouseover', e => {
                const tab = (e.target as HTMLElement).closest('.top-nav-tab') as HTMLElement;
                if (tab) {
                    const containerRect = tabsContainer.getBoundingClientRect();
                    const tabRect = tab.getBoundingClientRect();
                    indicator.style.width = `${tabRect.width}px`;
                    indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
                }
            });

            tabsContainer.addEventListener('mouseleave', () => {
                updateTabIndicator();
            });
        }
    });
</script>
