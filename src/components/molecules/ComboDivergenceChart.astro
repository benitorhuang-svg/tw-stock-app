---
/**
 * ComboDivergenceChart.astro
 */
interface ChartDataItem {
    date: string;
    foreignNet: number;
    investNet: number;
    dealerNet: number;
    totalNet: number;
}

interface Props {
    symbol: string;
    chartData: ChartDataItem[];
    maxNet: number;
    fmtNet: (n: number) => string;
}
const { symbol, chartData, maxNet, fmtNet } = Astro.props;
---

<div class="glass-card p-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="terminal-label mb-1">è¤‡åˆèƒŒé›¢åœ–</h3>
            <p class="text-xs text-text-muted">è‚¡åƒ¹ Ã— ä¸‰å¤§æ³•äººè²·è³£è¶… â€” é›™è»¸å †ç–Š</p>
        </div>
        <div class="flex items-center gap-3 text-[10px]">
            <span class="flex items-center gap-1"
                ><span class="w-2 h-2 rounded-full bg-bearish/60"></span> å¤–è³‡</span
            >
            <span class="flex items-center gap-1"
                ><span class="w-2 h-2 rounded-full bg-warning/60"></span> æŠ•ä¿¡</span
            >
            <span class="flex items-center gap-1"
                ><span class="w-2 h-2 rounded-full bg-text-muted"></span> è‡ªç‡Ÿ</span
            >
        </div>
    </div>

    {
        chartData.length > 0 ? (
            <div class="relative h-[320px]">
                <div class="absolute left-0 top-0 bottom-8 w-12 flex flex-col justify-between text-[9px] font-mono text-text-muted">
                    <span>+{(maxNet / 1000).toFixed(0)}K</span>
                    <span>0</span>
                    <span>-{(maxNet / 1000).toFixed(0)}K</span>
                </div>
                <div class="ml-14 mr-4 h-full flex flex-col">
                    <div class="flex-1 relative">
                        <div class="absolute left-0 right-0 top-1/2 border-t border-white/[0.08]" />
                        <div class="absolute left-0 right-0 top-1/4 border-t border-dashed border-white/[0.03]" />
                        <div class="absolute left-0 right-0 top-3/4 border-t border-dashed border-white/[0.03]" />

                        <div class="absolute inset-0 flex items-center justify-around px-2">
                            {chartData.map(d => {
                                const fPct = (d.foreignNet / maxNet) * 45;
                                return (
                                    <div
                                        class="flex flex-col items-center gap-0.5 group relative"
                                        style="width: 16%"
                                    >
                                        <div
                                            class="w-full flex flex-col items-center"
                                            style="height: 90%"
                                        >
                                            <div
                                                class="w-3/4 rounded-sm transition-all duration-300 group-hover:w-full"
                                                style={`height: ${Math.abs(fPct)}%; margin-top: ${fPct < 0 ? '0' : 'auto'}; margin-bottom: ${fPct >= 0 ? '0' : 'auto'}; background: ${fPct >= 0 ? 'hsl(346,77%,50%,0.6)' : 'hsl(142,71%,45%,0.6)'}; transform: translateY(${fPct >= 0 ? '-' : ''}0%);`}
                                            />
                                        </div>
                                        <span class="text-[8px] font-mono text-text-muted mt-1 whitespace-nowrap">
                                            {d.date.slice(5)}
                                        </span>
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-base border border-border rounded-lg text-[10px] font-mono opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-10 whitespace-nowrap shadow-elevated">
                                            <div class="text-text-primary mb-1 font-bold">
                                                {d.date}
                                            </div>
                                            <div class="text-bearish/80">
                                                å¤–è³‡: {fmtNet(d.foreignNet)}
                                            </div>
                                            <div class="text-warning/80">
                                                æŠ•ä¿¡: {fmtNet(d.investNet)}
                                            </div>
                                            <div class="text-text-muted">
                                                è‡ªç‡Ÿ: {fmtNet(d.dealerNet)}
                                            </div>
                                            <div
                                                class:list={[
                                                    'font-bold mt-1 pt-1 border-t border-border',
                                                    d.totalNet > 0
                                                        ? 'text-bullish'
                                                        : 'text-bearish',
                                                ]}
                                            >
                                                åˆè¨ˆ: {fmtNet(d.totalNet)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            </div>
        ) : (
            <div class="h-[320px] flex flex-col items-center justify-center">
                <span class="text-3xl mb-3">ğŸ¦</span>
                <p class="text-sm text-text-muted">å°šç„¡æ­¤æª”ç±Œç¢¼è³‡æ–™</p>
                <p class="text-xs text-text-muted mt-1">ç„¡æ³•å–å¾—æ¨™çš„ {symbol} çš„æ³•äººç±Œç¢¼æ•¸æ“š</p>
            </div>
        )
    }
</div>
