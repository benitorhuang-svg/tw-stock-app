---
/**
 * IntradayChart.astro — Recent price trend (real daily data)
 */
import type { PriceHistoryRecord } from '../../types/stock';

interface Props {
    price: number;
    isBullish: boolean;
    isBearish: boolean;
    priceData?: PriceHistoryRecord[];
}
const { price, isBullish, isBearish, priceData = [] } = Astro.props;

// Use last 20 trading days for mini area chart
const recent = priceData.slice(-20);
const hasData = recent.length >= 2;

let linePath = '';
let areaPath = '';

if (hasData) {
    const closes = recent.map(p => p.Close);
    const minP = Math.min(...closes);
    const maxP = Math.max(...closes);
    const range = maxP - minP || 1;
    const W = 400;
    const H = 200;

    const pts = closes.map((c, i) => ({
        x: (i / (closes.length - 1)) * W,
        y: 10 + (1 - (c - minP) / range) * (H - 20),
    }));

    linePath = pts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(0)},${p.y.toFixed(0)}`).join(' ');
    areaPath = linePath + ` L${W},${H} L0,${H} Z`;
}
---

<!-- Intraday Chart -->
<div class="glass-card p-6 h-[360px] flex flex-col relative overflow-hidden">
    <div class="flex items-center justify-between mb-4">
        <h3 class="terminal-label">近期走勢</h3>
        <div class="flex items-center gap-2">
            <span class="text-[10px] font-mono text-text-muted tracking-wider">
                {hasData ? `${recent.length}日` : '—'}
            </span>
        </div>
    </div>
    <div class="flex-1 relative rounded-lg overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-accent/5 to-transparent"></div>
        <!-- Chart grid lines -->
        <div class="absolute inset-0 flex flex-col justify-between py-4">
            {[0, 1, 2, 3, 4].map(() => <div class="border-b border-border/30 w-full" />)}
        </div>
        {hasData ? (
            <svg
                class="absolute inset-0 w-full h-full"
                preserveAspectRatio="none"
                viewBox="0 0 400 200"
            >
                <defs>
                    <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop
                            offset="0%"
                            stop-color={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                            stop-opacity="0.3"
                        />
                        <stop
                            offset="100%"
                            stop-color={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                            stop-opacity="0"
                        />
                    </linearGradient>
                </defs>
                <path
                    d={linePath}
                    fill="none"
                    stroke={isBullish ? 'hsl(142,71%,45%)' : 'hsl(346,77%,50%)'}
                    stroke-width="2"
                />
                <path d={areaPath} fill="url(#chartGrad)" />
            </svg>
        ) : (
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-[10px] font-mono text-text-muted/50 uppercase">No price data</span>
            </div>
        )}
        <!-- Floating price tag -->
        <div
            class:list={[
                'absolute right-4 top-1/4 px-3 py-1.5 rounded-md font-mono text-sm font-bold',
                isBullish
                    ? 'bg-bullish/20 text-bullish shadow-[0_0_15px_hsl(142,71%,45%,0.3)]'
                    : isBearish
                      ? 'bg-bearish/20 text-bearish shadow-[0_0_15px_hsl(346,77%,50%,0.3)]'
                      : 'bg-surface text-text-muted',
            ]}
        >
            {price > 0 ? price.toFixed(2) : '—'}
        </div>
    </div>
</div>
