---
/**
 * RevenueMomentumChart.astro
 */
interface Props {
    hasAcceleration: boolean;
    revBars: any[];
    maxRev: number;
}
const { hasAcceleration, revBars, maxRev } = Astro.props;
---

<div class="glass-card p-5 glow-interactive relative overflow-hidden group">
    <div
        class="absolute top-0 right-0 w-32 h-32 bg-accent/5 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-accent/10 transition-colors"
    >
    </div>

    {
        hasAcceleration && (
            <span class="absolute top-3 right-3 text-[10px] font-bold text-bullish bg-bullish/15 px-2 py-0.5 rounded-full animate-glow-pulse z-10">
                ?�長?�速中 ??
            </span>
        )
    }
    <h3 class="terminal-label mb-1">?�收?�能趨勢</h3>
    <p class="text-[10px] text-text-muted mb-6 uppercase tracking-widest">
        Revenue Streams & YoY Momentum
    </p>

    <!-- Multi-layer Analysis Chart -->
    <div class="relative h-[180px] w-full mt-4">
        <!-- YoY Growth Line (SVG Overlay) -->
        <svg
            class="absolute inset-x-0 top-0 w-full h-full pointer-events-none z-20"
            preserveAspectRatio="none"
            viewBox="0 0 100 100"
        >
            <defs>
                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="2" result="blur"></feGaussianBlur>
                    <feComposite in="SourceGraphic" in2="blur" operator="over"></feComposite>
                </filter>
            </defs>
            <path
                d={(() => {
                    const points = revBars
                        .slice()
                        .reverse()
                        .map((r, i) => {
                            const x = (i / (revBars.length - 1)) * 100;
                            // Map YoY % to Y (0 to 100). Assume -50% to +50% range
                            // 50 is center (0%), 10 is 40%, 90 is -40%
                            const y = 50 - (r.revenueYoY || 0);
                            return `${x},${Math.max(5, Math.min(95, y))}`;
                        });
                    return points.length > 0 ? `M ${points.join(' L ')}` : '';
                })()}
                fill="none"
                stroke="rgb(var(--accent-rgb))"
                stroke-opacity="0.6"
                stroke-width="1.5"
                stroke-dasharray="0"
                style="filter: url(#glow);"></path>
        </svg>

        <div class="absolute inset-0 flex items-end gap-1 px-1">
            {
                revBars
                    .slice()
                    .reverse()
                    .map(r => {
                        const pct = (r.revenue / maxRev) * 100;
                        const isYoYPositive = r.revenueYoY > 0;
                        return (
                            <div class="flex flex-col items-center gap-1.5 flex-1 group relative h-full justify-end">
                                {/* Revenue Bar */}
                                <div
                                    class:list={[
                                        'w-full rounded-t-[2px] transition-all duration-500 group-hover:opacity-100 relative',
                                        isYoYPositive
                                            ? 'bg-surface-hover group-hover:bg-accent/30'
                                            : 'bg-surface-hover/50 group-hover:bg-bearish/30',
                                    ]}
                                    style={`height: ${pct * 0.7}%;`}
                                >
                                    <div
                                        class:list={[
                                            'absolute top-0 left-0 right-0 h-0.5 rounded-full transform -translate-y-1/2',
                                            isYoYPositive ? 'bg-accent' : 'bg-bearish/50',
                                        ]}
                                    />
                                </div>

                                <span class="text-[7px] font-mono text-text-muted transform scale-90">
                                    {r.month}M
                                </span>

                                {/* Tooltip */}
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 px-3 py-2 bg-surface-deep/95 border border-border rounded-xl text-[10px] font-mono opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-30 shadow-2xl backdrop-blur-md">
                                    <div class="text-text-muted mb-1 border-b border-border/50 pb-1">
                                        {r.year}/{r.month}
                                    </div>
                                    <div class="flex justify-between gap-4 mb-0.5">
                                        <span class="text-text-muted">REVENUE</span>
                                        <span class="text-accent font-bold">
                                            {(r.revenue / 10000).toFixed(1)}??{' '}
                                        </span>
                                    </div>
                                    <div class="flex justify-between gap-4">
                                        <span class="text-text-muted">YoY %</span>
                                        <span
                                            class:list={[
                                                r.revenueYoY > 0 ? 'text-bullish' : 'text-bearish',
                                                'font-bold',
                                            ]}
                                        >
                                            {r.revenueYoY > 0 ? '+' : ''}
                                            {r.revenueYoY.toFixed(1)}%
                                        </span>
                                    </div>
                                    <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-surface-deep rotate-45 border-r border-b border-border" />
                                </div>
                            </div>
                        );
                    })
            }
        </div>
    </div>

    <!-- Legend & Meta -->
    <div class="mt-8 pt-4 border-t border-border/50 flex items-center justify-between">
        <div class="flex gap-4">
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-accent/30 border border-accent"></span>
                <span class="text-[9px] font-mono text-text-muted uppercase">Revenue Value</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-0.5 bg-accent"></span>
                <span class="text-[9px] font-mono text-text-muted uppercase">YoY Growth</span>
            </div>
        </div>
        <div class="px-2 py-0.5 bg-surface-hover/50 rounded text-[8px] font-mono text-text-muted">
            SAMPLED_MONTHS: 12
        </div>
    </div>

    <!-- New: Revenue Analytics Table (Mini) -->
    <div class="mt-6">
        <table class="w-full text-[10px] font-mono">
            <thead>
                <tr class="text-text-muted/70 border-b border-border/50">
                    <th class="text-left py-2 font-normal">PERIOD</th>
                    <th class="text-right py-2 font-normal">REVENUE (??</th>
                    <th class="text-right py-2 font-normal">MoM %</th>
                    <th class="text-right py-2 font-normal">YoY %</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/[0.02]">
                {
                    revBars.slice(0, 6).map(r => (
                        <tr class="hover:bg-surface-hover/30 transition-colors">
                            <td class="py-2 text-text-muted">
                                {r.year}/{String(r.month).padStart(2, '0')}
                            </td>
                            <td class="py-2 text-right text-accent">
                                {(r.revenue / 10000).toFixed(1)}
                            </td>
                            <td
                                class:list={[
                                    'py-2 text-right',
                                    r.revenueMoM >= 0 ? 'text-bullish' : 'text-bearish',
                                ]}
                            >
                                {r.revenueMoM > 0 ? '+' : ''}
                                {r.revenueMoM.toFixed(1)}%
                            </td>
                            <td
                                class:list={[
                                    'py-2 text-right',
                                    r.revenueYoY >= 0 ? 'text-bullish' : 'text-bearish',
                                ]}
                            >
                                {r.revenueYoY > 0 ? '+' : ''}
                                {r.revenueYoY.toFixed(1)}%
                            </td>
                        </tr>
                    ))
                }
            </tbody>
        </table>
    </div>
</div>
