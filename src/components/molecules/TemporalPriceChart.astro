---
/**
 * TemporalPriceChart.astro
 * Interactive price trend visualization — renders REAL price history
 */
import type { PriceHistoryRecord } from '../../types/stock';

interface Props {
    change: number;
    symbol: string;
    priceData?: PriceHistoryRecord[];
}

const { change, symbol, priceData = [] } = Astro.props;

// Prepare chart data: last 60 trading days
const chartPoints = priceData.slice(-60);
const hasData = chartPoints.length >= 2;

// Build SVG path from real close prices
let linePath = '';
let areaPath = '';
let priceLabels: { x: number; label: string }[] = [];
let yLabels: { y: number; label: string }[] = [];

if (hasData) {
    const closes = chartPoints.map(p => p.Close);
    const minPrice = Math.min(...closes);
    const maxPrice = Math.max(...closes);
    const range = maxPrice - minPrice || 1;
    const W = 100;
    const H = 100;
    const pad = 5;

    const pts = closes.map((c, i) => {
        const x = (i / (closes.length - 1)) * W;
        const y = pad + (1 - (c - minPrice) / range) * (H - 2 * pad);
        return { x, y };
    });

    linePath = pts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
    areaPath = linePath + ` L${W} ${H} L0 ${H} Z`;

    // X-axis date labels (every ~15 days)
    const step = Math.max(1, Math.floor(chartPoints.length / 4));
    for (let i = 0; i < chartPoints.length; i += step) {
        const d = chartPoints[i].Date;
        priceLabels.push({ x: pts[i].x, label: d.slice(5) }); // MM-DD
    }
    // Always include last point
    const lastD = chartPoints[chartPoints.length - 1].Date;
    priceLabels.push({ x: pts[pts.length - 1].x, label: lastD.slice(5) });

    // Y-axis price labels (5 levels)
    for (let i = 0; i <= 4; i++) {
        const price = minPrice + (range * i) / 4;
        const y = pad + (1 - i / 4) * (H - 2 * pad);
        yLabels.push({ y, label: price.toFixed(1) });
    }
}

const latestPrice = hasData ? chartPoints[chartPoints.length - 1].Close : 0;
const prevPrice = hasData && chartPoints.length > 1 ? chartPoints[chartPoints.length - 2].Close : latestPrice;
const priceChange = latestPrice - prevPrice;
---

<div class="lg:col-span-8 glass-card p-8 flex-1 flex flex-col relative overflow-hidden group h-full w-full">
    <div
        class="absolute top-0 right-0 p-8 opacity-[0.02] group-hover:opacity-[0.05] transition-opacity pointer-events-none"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="120"
            height="120"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg
        >
    </div>

    <div class="flex items-center justify-between mb-6 relative z-10">
        <div>
            <h2 class="text-[10px] font-mono font-black text-accent uppercase tracking-[0.3em]">
                Temporal Price Variance
            </h2>
            <div class="flex items-center gap-2 mt-1">
                <div class="w-1.5 h-1.5 rounded-full bg-bullish animate-pulse"></div>
                <span class="text-[9px] font-mono text-text-muted/70 uppercase tracking-widest">
                    {hasData ? `${chartPoints.length} 交易日` : 'NO_DATA'}
                </span>
            </div>
        </div>

        {hasData && (
            <div class="flex items-center gap-3">
                <span class:list={['text-sm font-mono font-bold', change >= 0 ? 'text-bullish' : 'text-bearish']}>
                    {latestPrice.toFixed(2)}
                </span>
                <span class:list={['text-[10px] font-mono', priceChange >= 0 ? 'text-bullish' : 'text-bearish']}>
                    {priceChange >= 0 ? '+' : ''}{priceChange.toFixed(2)}
                </span>
            </div>
        )}
    </div>

    <!-- Chart area -->
    <div
        class="flex-1 relative rounded-3xl overflow-hidden border border-border/50 bg-input-bg/50"
        id="chart-area"
    >
        <div class="absolute inset-0 bg-gradient-to-b from-accent/5 to-transparent"></div>

        {hasData ? (
            <div class="absolute inset-0 px-10 py-6">
                <svg
                    class="w-full h-full overflow-visible"
                    preserveAspectRatio="none"
                    viewBox="0 0 100 100"
                >
                    <defs>
                        <linearGradient id={`chart-gradient-${symbol}`} x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="currentColor" stop-opacity="0.3" />
                            <stop offset="100%" stop-color="currentColor" stop-opacity="0" />
                        </linearGradient>
                    </defs>
                    {/* Area fill */}
                    <path
                        d={areaPath}
                        fill={`url(#chart-gradient-${symbol})`}
                        class:list={[change >= 0 ? 'text-bullish' : 'text-bearish']}
                    />
                    {/* Price line */}
                    <path
                        d={linePath}
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.5"
                        vector-effect="non-scaling-stroke"
                        class:list={[change >= 0 ? 'text-bullish' : 'text-bearish']}
                    />
                </svg>
                {/* Y-axis labels */}
                <div class="absolute top-6 bottom-6 left-1 flex flex-col justify-between pointer-events-none">
                    {yLabels.reverse().map(l => (
                        <span class="text-[8px] font-mono text-text-muted/40">{l.label}</span>
                    ))}
                </div>
            </div>
        ) : (
            <div class="absolute inset-0 flex items-center justify-center">
                <p class="text-[10px] font-mono text-text-muted/50 uppercase tracking-widest">
                    Price data unavailable for {symbol}
                </p>
            </div>
        )}
    </div>
</div>
