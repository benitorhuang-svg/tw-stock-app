---
import Layout from '../layouts/Layout.astro';
import PageHero from '../components/molecules/PageHero.astro';
---

<Layout title="Dividend History | TW Stock App">
    <div class="div-container">
        <!-- Hero Header -->
        <!-- Hero Header -->
        <PageHero
            icon="üí∞"
            title="DIVIDEND_ARCHIVE"
            subtitle="Historical yield distributions & payout metrics"
            glowClass="accent-glow"
        >
            <div class="sys-status" slot="action">
                <span class="pulse-dot"></span>
                <span class="mono">DATABASE_SYNCED</span>
            </div>
        </PageHero>

        <!-- Search Section -->
        <section class="search-panel glass-card cyber-reveal" style="animation-delay: 0.2s;">
            <div class="cyber-search-box">
                <span class="search-icon">üîç</span>
                <input
                    type="text"
                    id="stock-search"
                    class="cyber-input mono"
                    placeholder="ENTER SYMBOL FOR YIELD HISTORY (ex: 2330)..."
                    autocomplete="off"
                />
                <button id="search-btn" class="cyber-btn mono">EXECUTE_QUERY</button>
            </div>
        </section>

        <!-- Empty State -->
        <div
            id="empty-state"
            class="empty-state glass-card cyber-reveal"
            style="animation-delay: 0.3s;"
        >
            <span class="state-icon">üìä</span>
            <h3 class="mono">AWAITING_INPUT</h3>
            <p class="text-muted">Enter a symbol above to retrieve historical dividend data.</p>
        </div>

        <!-- Metric Cards -->
        <div id="dividend-summary" class="metric-grid" style="display:none;">
            <div
                class="metric-card glass-card glow-wrapper cyber-reveal"
                style="animation-delay: 0.1s;"
            >
                <div class="glow-bg pos-glow"></div>
                <span class="m-label mono">10YR_AVG_CASH</span>
                <span id="avg-cash" class="m-val mono text-pos">$0</span>
            </div>
            <div
                class="metric-card glass-card glow-wrapper cyber-reveal"
                style="animation-delay: 0.2s;"
            >
                <div class="glow-bg accent-glow"></div>
                <span class="m-label mono">10YR_AVG_YIELD</span>
                <span id="avg-yield" class="m-val mono text-accent">0%</span>
            </div>
            <div
                class="metric-card glass-card glow-wrapper cyber-reveal"
                style="animation-delay: 0.3s;"
            >
                <div class="glow-bg neutral-glow"></div>
                <span class="m-label mono">CONSEC_PAYOUTS</span>
                <span id="consecutive-years" class="m-val mono">0 YEARS</span>
            </div>
            <div
                class="metric-card glass-card glow-wrapper cyber-reveal"
                style="animation-delay: 0.4s;"
            >
                <div class="glow-bg neutral-glow"></div>
                <span class="m-label mono">FILL_RATE</span>
                <span id="fill-rate" class="m-val mono">0%</span>
            </div>
        </div>

        <!-- Main Workspace (Chart + Table) -->
        <div class="workspace-grid">
            <!-- Chart -->
            <section
                id="dividend-chart-section"
                class="chart-panel glass-card glow-wrapper cyber-reveal"
                style="display:none; animation-delay: 0.5s;"
            >
                <div class="glow-bg neutral-glow"></div>
                <header class="panel-header">
                    <h2 class="mono">HISTORICAL_TREND //</h2>
                </header>
                <div class="chart-container">
                    <canvas id="dividend-chart"></canvas>
                </div>
            </section>

            <!-- Table -->
            <section
                id="dividend-table-section"
                class="table-panel glass-card glow-wrapper cyber-reveal"
                style="display:none; animation-delay: 0.6s;"
            >
                <div class="glow-bg neutral-glow"></div>
                <header class="panel-header">
                    <h2 class="mono">PAYOUT_RECORDS //</h2>
                </header>
                <div class="table-scroll">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th class="mono">YEAR</th>
                                <th class="mono">CASH_UNIT</th>
                                <th class="mono">STOCK_UNIT</th>
                                <th class="mono">TOTAL</th>
                                <th class="mono">YIELD_%</th>
                            </tr>
                        </thead>
                        <tbody id="dividend-body"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</Layout>

<style>
    .div-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
        max-width: 1400px;
        margin: 0 auto;
        padding-bottom: 40px;
    }

    /* Glass Effect Base */
    .glass-card {
        background: var(--c-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--c-border-glass, rgba(60, 80, 120, 0.2));
        border-radius: 16px;
        position: relative;
    }
    .glow-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
    }
    .glow-bg {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        transition: opacity 0.3s ease;
        background: radial-gradient(
            400px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
            var(--glow-color, rgba(255, 255, 255, 0.05)),
            transparent 40%
        );
    }
    .glow-wrapper:hover .glow-bg {
        opacity: 1;
    }
    .neutral-glow {
        --glow-color: rgba(200, 200, 210, 0.05);
    }
    .accent-glow {
        --glow-color: rgba(59, 130, 246, 0.1);
    }
    .pos-glow {
        --glow-color: rgba(16, 185, 129, 0.1);
    }

    /* Hero */
    .page-hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        z-index: 10;
    }
    .hero-left {
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 1;
    }
    .icon-box {
        width: 56px;
        height: 56px;
        background: rgba(var(--c-accent-rgb), 0.1);
        border: 1px solid rgba(var(--c-accent-rgb), 0.3);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .hero-left h1 {
        font-size: 16px;
        margin: 0;
        letter-spacing: 2px;
    }
    .hero-left p {
        font-size: 11px;
        margin: 4px 0 0;
    }
    .sys-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        z-index: 1;
        color: var(--c-text-muted);
    }
    .pulse-dot {
        width: 6px;
        height: 6px;
        background: var(--c-success);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--c-success);
    }

    /* Search */
    .search-panel {
        padding: 24px;
        z-index: 5;
    }
    .cyber-search-box {
        display: flex;
        align-items: center;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 4px;
        transition: 0.3s;
    }
    .cyber-search-box:focus-within {
        border-color: var(--c-accent);
        box-shadow: 0 0 15px rgba(var(--c-accent-rgb), 0.2);
    }
    .search-icon {
        padding: 0 16px;
        opacity: 0.5;
    }
    .cyber-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 16px;
        padding: 16px 0;
        outline: none;
    }
    .cyber-btn {
        background: linear-gradient(135deg, var(--c-accent), #2563eb);
        color: #fff;
        border: none;
        padding: 14px 24px;
        border-radius: 6px;
        font-weight: 800;
        font-size: 12px;
        cursor: pointer;
        transition: 0.3s;
        margin-left: 8px;
    }
    .cyber-btn:hover {
        box-shadow: 0 0 15px rgba(var(--c-accent-rgb), 0.5);
    }

    /* Empty State */
    .empty-state {
        padding: 80px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 16px;
        border: 1px dashed rgba(255, 255, 255, 0.1);
    }
    .state-icon {
        font-size: 48px;
        opacity: 0.5;
    }
    .empty-state h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 2px;
    }

    /* Metrics */
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }
    .metric-card {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .m-label {
        font-size: 10px;
        color: var(--c-text-muted);
        position: relative;
        z-index: 1;
        letter-spacing: 1px;
    }
    .m-val {
        font-size: 24px;
        font-weight: 800;
        color: #fff;
        position: relative;
        z-index: 1;
    }

    /* Workspace */
    .workspace-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        align-items: start;
    }

    .panel-header {
        padding: 16px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        z-index: 1;
    }
    .panel-header h2 {
        font-size: 12px;
        margin: 0;
        color: var(--c-text-muted);
        letter-spacing: 2px;
    }

    .chart-panel {
        display: flex;
        flex-direction: column;
    }
    .chart-container {
        padding: 24px;
        height: 350px;
        position: relative;
        z-index: 1;
    }
    #dividend-chart {
        width: 100%;
        height: 100%;
    }

    .table-panel {
        display: flex;
        flex-direction: column;
    }
    .table-scroll {
        max-height: 400px;
        overflow-y: auto;
        position: relative;
        z-index: 1;
    }
    .table-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }

    .premium-table {
        width: 100%;
        border-collapse: collapse;
        text-align: right;
    }
    .premium-table th {
        background: rgba(10, 15, 25, 0.95);
        backdrop-filter: blur(10px);
        z-index: 10;
        font-size: 10px;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--c-text-muted);
        position: sticky;
        top: 0;
    }
    .premium-table td {
        padding: 14px 20px;
        font-size: 13px;
        color: #fff;
        font-family: 'JetBrains Mono', monospace;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        vertical-align: middle;
        transition: 0.2s;
    }
    .premium-table tbody tr:hover td {
        background: rgba(255, 255, 255, 0.04);
    }
    .premium-table th:first-child,
    .premium-table td:first-child {
        text-align: left;
    }

    @media (max-width: 1024px) {
        .metric-grid {
            grid-template-columns: 1fr 1fr;
        }
        .workspace-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 600px) {
        .metric-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Glow Tracker
    document.addEventListener('mousemove', e => {
        const wrappers = document.querySelectorAll('.glow-wrapper');
        wrappers.forEach(wrapper => {
            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            (wrapper as HTMLElement).style.setProperty('--mouse-x', `${x}px`);
            (wrapper as HTMLElement).style.setProperty('--mouse-y', `${y}px`);
        });
    });

    const mockDividends = {
        '2330': [
            { year: 2024, cash: 13.0, stock: 0, yield: 2.2 },
            { year: 2023, cash: 11.5, stock: 0, yield: 2.1 },
            { year: 2022, cash: 11.0, stock: 0, yield: 2.0 },
            { year: 2021, cash: 10.0, stock: 0, yield: 1.8 },
            { year: 2020, cash: 10.0, stock: 0, yield: 2.4 },
            { year: 2019, cash: 8.0, stock: 0, yield: 2.9 },
            { year: 2018, cash: 8.0, stock: 0, yield: 3.4 },
            { year: 2017, cash: 7.0, stock: 0, yield: 3.2 },
            { year: 2016, cash: 6.0, stock: 0, yield: 3.5 },
            { year: 2015, cash: 4.5, stock: 0, yield: 3.3 },
        ],
        '2317': [
            { year: 2024, cash: 5.3, stock: 0, yield: 5.0 },
            { year: 2023, cash: 5.3, stock: 0, yield: 5.2 },
            { year: 2022, cash: 5.2, stock: 0, yield: 5.0 },
            { year: 2021, cash: 4.0, stock: 0, yield: 3.8 },
            { year: 2020, cash: 4.0, stock: 0, yield: 4.5 },
            { year: 2019, cash: 4.0, stock: 0, yield: 4.4 },
            { year: 2018, cash: 4.0, stock: 0, yield: 4.8 },
            { year: 2017, cash: 2.0, stock: 0, yield: 2.2 },
            { year: 2016, cash: 2.0, stock: 0, yield: 2.5 },
            { year: 2015, cash: 2.5, stock: 0, yield: 2.8 },
        ],
    };

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('stock-search');

    searchBtn?.addEventListener('click', searchDividends);
    searchInput?.addEventListener('keydown', e => {
        if (e.key === 'Enter') searchDividends();
    });

    function searchDividends() {
        const symbol = searchInput.value.trim();
        if (!symbol) return;

        const data = mockDividends[symbol];
        if (!data) return alert('ERR_NO_DATA_FOUND_FOR_SYMBOL');

        document.getElementById('empty-state').style.display = 'none';

        const sum = document.getElementById('dividend-summary');
        const crt = document.getElementById('dividend-chart-section');
        const tbl = document.getElementById('dividend-table-section');

        sum.style.display = 'grid';
        crt.style.display = 'flex';
        tbl.style.display = 'flex';

        const avgCash = data.reduce((s, d) => s + d.cash, 0) / data.length;
        const avgYield = data.reduce((s, d) => s + d.yield, 0) / data.length;

        document.getElementById('avg-cash').textContent = `$${avgCash.toFixed(2)}`;
        document.getElementById('avg-yield').textContent = `${avgYield.toFixed(1)}%`;
        document.getElementById('consecutive-years').textContent = `${data.length} YEARS`;
        document.getElementById('fill-rate').textContent = '80%'; // Mock

        drawDividendChart(data);

        const tbody = document.getElementById('dividend-body');
        tbody.innerHTML = data
            .map(
                d => `
            <tr>
                <td style="color:var(--c-text-muted)">${d.year}</td>
                <td class="text-pos">${d.cash.toFixed(2)}</td>
                <td>${d.stock > 0 ? d.stock.toFixed(2) : '-'}</td>
                <td style="font-weight:800">${(d.cash + d.stock).toFixed(2)}</td>
                <td>${d.yield.toFixed(1)}%</td>
            </tr>
        `
            )
            .join('');
    }

    function drawDividendChart(data) {
        const canvas = document.getElementById('dividend-chart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        canvas.width = container.offsetWidth * window.devicePixelRatio;
        canvas.height = container.offsetHeight * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

        const width = container.offsetWidth;
        const height = container.offsetHeight;
        const padding = { top: 20, right: 20, bottom: 40, left: 40 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const reversed = [...data].reverse();
        const maxValue = Math.max(...reversed.map(d => d.cash + d.stock)) * 1.1;
        const barWidth = (chartWidth / reversed.length) * 0.5;
        const barGap = (chartWidth / reversed.length) * 0.5;

        ctx.clearRect(0, 0, width, height);

        // Y Grid
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.font = '10px JetBrains Mono';
        for (let i = 0; i <= 5; i++) {
            const y = padding.top + (chartHeight / 5) * i;
            const val = maxValue - (maxValue / 5) * i;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();
            ctx.textAlign = 'right';
            ctx.fillText(val.toFixed(1), padding.left - 8, y + 4);
        }

        // Bars
        reversed.forEach((d, i) => {
            const x = padding.left + (chartWidth / reversed.length) * i + barGap / 2;
            const barHeight = (d.cash / maxValue) * chartHeight;
            const y = padding.top + chartHeight - barHeight;

            const grad = ctx.createLinearGradient(0, y, 0, y + barHeight);
            grad.addColorStop(0, '#10b981'); // success
            grad.addColorStop(1, 'rgba(16, 185, 129, 0.2)');

            ctx.fillStyle = grad;
            ctx.fillRect(x, y, barWidth, barHeight);

            // Labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.textAlign = 'center';
            ctx.fillText(d.year.toString(), x + barWidth / 2, height - padding.bottom + 20);
        });
    }
</script>
