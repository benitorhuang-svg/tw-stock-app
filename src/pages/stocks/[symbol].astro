---
/**
 * Stock Terminal (Analysis Page)
 *
 * Clean-Slate Rebuild following Spec 004 & 005.
 */
import Layout from '../../layouts/Layout.astro';
import StockHero from '../../components/organisms/StockHero.astro';
import StockChart from '../../components/organisms/StockChart.astro';
import DataTabs from '../../components/organisms/DataTabs.astro';
import { getStockDetails, getStockChips } from '../../utils/marketService';
import { fetchStockPrices } from '../../utils/priceService';
import { getDb } from '../../lib/db';

export async function getStaticPaths() {
    const db = getDb();
    const stocks = db.prepare('SELECT symbol FROM stocks LIMIT 100').all();
    return stocks.map((s: any) => ({ params: { symbol: s.symbol } }));
}

const { symbol } = Astro.params;

// Fetch Real Data
const details = getStockDetails(symbol as string);
const chips = getStockChips(symbol as string);
const prices = await fetchStockPrices(symbol as string);

// Fallback if not found
if (!details) {
    return Astro.redirect('/404');
}

const pageTitle = `${symbol} ${details.name} | TW Stock Terminal`;
---

<Layout title={pageTitle}>
    <main class="terminal-container">
        <!-- Back Link -->
        <nav class="breadcrumb">
            <a href="/screener" class="mono">/ SCANNER</a>
            <span class="sep">></span>
            <span class="current mono">{symbol}</span>
        </nav>

        <!-- Top Hero Section -->
        <StockHero
            symbol={details.symbol}
            name={details.name}
            price={details.price}
            change={details.change}
            changePct={details.change_pct}
            market={details.market}
            sector={details.sector}
        />

        <div class="main-workspace">
            <!-- Central Chart Terminal -->
            <section class="chart-section glass-panel">
                <div class="section-tag mono">CHART_TERMINAL_V4</div>
                <StockChart symbol={details.symbol} prices={prices} height={500} />
            </section>

            <!-- Bottom Analysis Tabs -->
            <section class="analysis-section">
                <div class="section-tag mono">DEEP_RECON_ANALYSIS</div>
                <DataTabs symbol={details.symbol} details={details} chips={chips} />
            </section>
        </div>
    </main>
</Layout>

<style>
    .terminal-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 11px;
        color: #64748b;
        margin-bottom: 8px;
    }

    .breadcrumb a {
        color: #94a3b8;
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: var(--c-accent);
    }

    .breadcrumb .sep {
        opacity: 0.3;
    }

    .breadcrumb .current {
        color: var(--c-accent);
        font-weight: 700;
    }

    .main-workspace {
        display: flex;
        flex-direction: column;
        gap: 40px;
    }

    .section-tag {
        font-size: 10px;
        color: var(--c-accent);
        letter-spacing: 2px;
        margin-bottom: 16px;
        padding-left: 4px;
        border-left: 2px solid var(--c-accent);
    }

    .chart-section {
        padding: 20px;
    }

    .analysis-section {
        margin-top: 20px;
    }

    /* Standard Glass Panel overrides if needed */
    .glass-panel {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        backdrop-filter: blur(12px);
    }

    @media (max-width: 1024px) {
        .terminal-container {
            padding: 16px;
        }
    }
</style>
