---
/**
 * [symbol].astro ‚Äî Individual Stock Analysis Terminal
 * High-performance forensic analysis for individual entities.
 */
import MainTerminal from '../../layouts/MainTerminal.astro';
import StockAnalysisHero from '../../components/molecules/StockAnalysisHero.astro';
import StockChartSection from '../../components/organisms/StockChartSection.astro';
import TabBar from '../../components/organisms/TabBar.astro';
import TabOverview from '../../components/organisms/TabOverview.astro';
import TabTechnical from '../../components/organisms/TabTechnical.astro';
import TabChips from '../../components/organisms/TabChips.astro';
import TabFundamentals from '../../components/organisms/TabFundamentals.astro';
import TabAlerts from '../../components/organisms/TabAlerts.astro';
import ForensicTicker from '../../components/molecules/ForensicTicker.astro';

const { symbol } = Astro.params;

if (!symbol) {
    return Astro.redirect('/');
}

// SSR: Data loading
import type { StockFullData } from '../../utils/stockDataService';
import { fetchStockPrices } from '../../utils/priceService';

let stock: StockFullData | null = null;
let priceHistory: any = [];

try {
    const { getStockBySymbol } = await import('../../utils/stockDataService');
    stock = (await getStockBySymbol?.(symbol)) ?? null;
    priceHistory = await fetchStockPrices(symbol);
} catch (e) {
    console.error('[Stock Engine] Data load error:', e);
}

if (!stock) {
    stock = {
        symbol: symbol,
        name: `${symbol}`,
        market: 'TWSE',
        price: 0,
        change: 0,
        changePercent: 0,
        open: 0,
        high: 0,
        low: 0,
        volume: 0,
        pe: 0,
        pb: 0,
        yield: 0,
        roe: 0,
        eps: 0,
        revenueYoY: 0,
        grossMargin: 0,
        operatingMargin: 0,
        netMargin: 0,
        foreignStreak: 0,
        trustStreak: 0,
        dealerStreak: 0,
        sector: 'other',
    };
}

const stockData = stock as StockFullData;
const isNotFound = stockData.price === 0 && stockData.name === symbol;
---

<MainTerminal title={`${stockData.name} Intelligence Terminal`}>
    <div class="space-y-8 relative pb-20 p-4 lg:p-10">
        {isNotFound ? (
            <div class="glass-card p-12 text-center animate-fade-up border border-bearish/20">
                <div class="text-6xl mb-6 opacity-20">üì°</div>
                <h2 class="text-xl font-black text-white/90 mb-4 tracking-tighter uppercase">Entity Not Found</h2>
                <p class="text-[10px] font-mono text-white/30 uppercase tracking-[0.3em] mb-8">Unable to establish uplink with target: {symbol}</p>
                <a href="/screener" class="px-8 py-3 rounded-2xl bg-white/5 border border-white/10 text-[9px] font-black font-mono text-white/40 hover:text-white hover:border-white/20 transition-all uppercase tracking-[0.3em] no-underline">ËøîÂõûÈÅ∏ËÇ°‰∏≠ÂøÉ</a>
            </div>
        ) : (
            <>
                <!-- Analysis Hero (Molecule) -->
                <StockAnalysisHero 
                    symbol={stockData.symbol}
                    name={stockData.name}
                    price={stockData.price}
                    change={stockData.change}
                    changePercent={stockData.changePercent}
                    sector={stockData.sector || ''}
                />

                <!-- Chart & Matrix Sections (Organism) -->
                <StockChartSection stock={stockData} />

                <!-- Deep Analysis Tabs -->
                <div class="space-y-6">
                    <TabBar symbol={symbol} />
                    
                    <div id="tab-content" class="min-h-[400px]">
                        <div id="tab-overview"><TabOverview {...stockData} /></div>
                        <div id="tab-technical" class="hidden"><TabTechnical symbol={symbol} price={stockData.price} change={stockData.change} priceData={priceHistory} /></div>
                        <div id="tab-chips" class="hidden"><TabChips symbol={symbol} price={stockData.price} /></div>
                        <div id="tab-fundamentals" class="hidden"><TabFundamentals 
                            symbol={symbol} 
                            pe={stockData.pe} 
                            pb={stockData.pb} 
                            yield_={stockData.yield} 
                            roe={stockData.roe} 
                            eps={stockData.eps} 
                            priceData={priceHistory} 
                        /></div>
                        <div id="tab-alerts" class="hidden"><TabAlerts 
                            symbol={symbol} 
                            name={stockData.name} 
                            price={stockData.price} 
                            change={stockData.change} 
                            changePercent={stockData.changePercent} 
                        /></div>
                    </div>
                </div>

                <!-- Footer Signal Stream -->
                <div class="pt-10 mt-10 border-t border-white/5 flex items-center justify-between">
                    <ForensicTicker />
                    <div class="flex items-center gap-4">
                        <span class="text-[9px] font-mono text-white/20 uppercase tracking-widest">Entity_Status: MONITORED</span>
                        <div class="w-2 h-2 rounded-full bg-bullish shadow-[0_0_8px_rgba(34,197,94,0.4)]"></div>
                    </div>
                </div>
            </>
        )}
    </div>

    <script>
        function setupWatchToggle() {
            const btn = document.getElementById('watch-toggle-hero');
            if (!btn) return;
            
            // Interaction logic (mocking persistence for now)
            btn.addEventListener('click', () => {
                btn.classList.toggle('text-accent');
                btn.classList.toggle('border-accent/40');
                btn.classList.toggle('bg-accent/10');
            });
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = {
                overview: document.getElementById('tab-overview'),
                technical: document.getElementById('tab-technical'),
                chips: document.getElementById('tab-chips'),
                fundamentals: document.getElementById('tab-fundamentals'),
                alerts: document.getElementById('tab-alerts')
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = (e.currentTarget as HTMLElement).dataset.tab;
                    if (!targetId) return;

                    // Update UI
                    tabs.forEach(t => t.classList.remove('active', 'border-accent', 'text-accent'));
                    (e.currentTarget as HTMLElement).classList.add('active', 'border-accent', 'text-accent');

                    // Switch content
                    Object.values(contents).forEach(c => c?.classList.add('hidden'));
                    const targetContent = document.getElementById(`tab-${targetId}`);
                    if (targetContent) targetContent.classList.remove('hidden');
                    
                    // Trigger custom events for specific tab initializations if needed
                    if (targetId === 'technical') window.dispatchEvent(new CustomEvent('tab-switched-technical'));
                });
            });
        }

        document.addEventListener('astro:page-load', () => {
            setupWatchToggle();
            setupTabs();
        });
        
        // Initial setup
        setupWatchToggle();
        setupTabs();
    </script>
</MainTerminal>

<style is:global>
    /* Tab active state refinement */
    .tab-btn.active {
        background: rgba(var(--accent-rgb), 0.05);
        color: var(--accent);
        border-color: rgba(var(--accent-rgb), 0.5) !important;
    }
</style>
