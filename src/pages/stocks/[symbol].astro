---
/**
 * [symbol].astro â€” Individual Stock Analysis Page (5-tab)
 * Spec: 002-tab-overview through 007-tab-alerts
 *
 * Route: /stocks/:symbol
 * Contains 5 analysis tabs: Overview, Technical, Chips, Fundamentals, AI Alerts
 */
import MainTerminal from '../../layouts/MainTerminal.astro';
import Badge from '../../components/atoms/Badge.astro';
import TabBar from '../../components/organisms/TabBar.astro';
import StatCard from '../../components/molecules/StatCard.astro';
import TabOverview from '../../components/organisms/TabOverview.astro';
import TabTechnical from '../../components/organisms/TabTechnical.astro';
import TabChips from '../../components/organisms/TabChips.astro';
import TabFundamentals from '../../components/organisms/TabFundamentals.astro';
import TabAlerts from '../../components/organisms/TabAlerts.astro';
import { fmtVol } from '../../utils/format';

const { symbol } = Astro.params;

if (!symbol) {
    return Astro.redirect('/');
}

// SSR: Load stock data using actual StockFullData type from service
import type { StockFullData } from '../../utils/stockDataService';
import { fetchStockPrices } from '../../utils/priceService';

let stock: StockFullData | null = null;

try {
    const { getStockBySymbol } = await import('../../utils/stockDataService');
    stock = (await getStockBySymbol?.(symbol)) ?? null;
} catch {
    // Fallback
}

// Load historical price data for Technical tab
let priceHistory: Awaited<ReturnType<typeof fetchStockPrices>> = [];
try {
    priceHistory = await fetchStockPrices(symbol);
} catch {
    // Graceful fallback to simulated data in TabTechnical
}

if (!stock) {
    stock = {
        symbol: symbol,
        name: `${symbol}`,
        market: 'TWSE',
        price: 0,
        change: 0,
        changePercent: 0,
        open: 0,
        high: 0,
        low: 0,
        volume: 0,
        pe: 0,
        pb: 0,
        yield: 0,
        roe: 0,
        eps: 0,
        revenueYoY: 0,
        grossMargin: 0,
        operatingMargin: 0,
        netMargin: 0,
        sector: 'other',
    };
}

// TypeScript assertion: stock is guaranteed non-null after fallback
const stockData = stock as StockFullData;

const isBullish = stockData.change > 0;
const isBearish = stockData.change < 0;
const isStockNotFound = stockData.price === 0 && stockData.name === symbol;
---

<MainTerminal title={`${stockData.name} ${stockData.symbol}`}>
    {
        isStockNotFound && (
            <div class="glass-card p-8 mb-6 text-center animate-fade-up border border-warning/20">
                <div class="text-4xl mb-3">ğŸ”</div>
                <h2 class="text-lg font-bold text-warning mb-2">æŸ¥ç„¡æ­¤è‚¡ç¥¨è³‡æ–™</h2>
                <p class="text-sm text-text-muted mb-4">
                    æ‰¾ä¸åˆ°ä»£è™Ÿ <span class="font-mono text-text-primary">{symbol}</span>{' '}
                    çš„è‚¡ç¥¨è³‡æ–™ï¼Œå¯èƒ½å°šæœªæ”¶éŒ„æˆ–ä»£è™Ÿæœ‰èª¤ã€‚
                </p>
                <a href="/stocks" class="btn-cyber text-xs" data-astro-prefetch>
                    â† è¿”å›è‚¡ç¥¨åˆ—è¡¨
                </a>
            </div>
        )
    }

    <!-- â•â•â• Compact Hero Header â•â•â• -->
    <header class="mb-5 animate-fade-up">
        <div class="flex items-start justify-between gap-4">
            <div class="flex items-center gap-3 min-w-0">
                <div class="min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                        <h1 class="text-xl lg:text-2xl font-bold truncate text-stock-name">
                            {stockData.name}
                        </h1>
                        <span class="font-mono text-xs text-stock-symbol shrink-0"
                            >{stockData.symbol}</span
                        >
                        <Badge variant={isBullish ? 'bullish' : isBearish ? 'bearish' : 'muted'}>
                            {isBullish ? 'â–² ä¸Šæ¼²' : isBearish ? 'â–¼ ä¸‹è·Œ' : 'â€” å¹³ç›¤'}
                        </Badge>
                    </div>
                    {stockData.sector && <span class="tag-chip mt-1">{stockData.sector}</span>}
                </div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
                <button id="watch-toggle" class="btn-cyber text-xs">â­ åŠ å…¥è‡ªé¸</button>
                <a href="/screener" class="btn-ghost text-xs" data-astro-prefetch>â† è¿”å›é¸è‚¡</a>
            </div>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- CHARTS-FIRST LAYOUT: Chart + Price/Stats        -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-5">
        <!-- Main: Intraday Chart (Priority Visual) -->
        <div
            class="lg:col-span-8 xl:col-span-9 glass-card p-5 h-[380px] lg:h-[420px] flex flex-col relative overflow-hidden animate-fade-up"
        >
            <div class="flex items-center justify-between mb-3">
                <h2 class="terminal-label text-xs">èµ°å‹¢åœ–</h2>
                <div class="flex items-center gap-3">
                    <div class="flex gap-1 text-[10px] font-mono">
                        {
                            ['1æ—¥', '5æ—¥', '1æœˆ', '3æœˆ', '1å¹´'].map((t, i) => (
                                <button
                                    class:list={[
                                        'px-2 py-0.5 rounded transition-colors',
                                        i === 0
                                            ? 'bg-accent/15 text-accent'
                                            : 'text-text-muted hover:text-text-primary',
                                    ]}
                                >
                                    {t}
                                </button>
                            ))
                        }
                    </div>
                </div>
            </div>
            <!-- Chart area -->
            <div class="flex-1 relative rounded-lg overflow-hidden" id="chart-area">
                <div class="absolute inset-0 bg-gradient-to-b from-accent/5 to-transparent"></div>
                <!-- Grid lines -->
                <div
                    class="absolute inset-0 flex flex-col justify-between py-4 pointer-events-none"
                >
                    {[0, 1, 2, 3, 4].map(() => <div class="border-b border-white/[0.03] w-full" />)}
                </div>
                <!-- Price line SVG -->
                <svg
                    class="absolute inset-0 w-full h-full"
                    preserveAspectRatio="none"
                    viewBox="0 0 400 200"
                >
                    <defs>
                        <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                            <stop
                                offset="0%"
                                stop-color={isBullish
                                    ? 'hsl(142,71%,45%)'
                                    : isBearish
                                      ? 'hsl(346,77%,50%)'
                                      : 'hsl(217,91%,60%)'}
                                stop-opacity="0.25"></stop>
                            <stop
                                offset="100%"
                                stop-color={isBullish
                                    ? 'hsl(142,71%,45%)'
                                    : isBearish
                                      ? 'hsl(346,77%,50%)'
                                      : 'hsl(217,91%,60%)'}
                                stop-opacity="0"></stop>
                        </linearGradient>
                    </defs>
                    <path
                        d="M0,140 C20,138 40,130 60,120 S100,105 120,100 S160,92 180,95 S220,85 240,75 S280,65 300,60 S340,62 360,58 L400,50"
                        fill="none"
                        stroke={isBullish
                            ? 'hsl(142,71%,45%)'
                            : isBearish
                              ? 'hsl(346,77%,50%)'
                              : 'hsl(217,91%,60%)'}
                        stroke-width="2"
                        stroke-linecap="round"></path>
                    <path
                        d="M0,140 C20,138 40,130 60,120 S100,105 120,100 S160,92 180,95 S220,85 240,75 S280,65 300,60 S340,62 360,58 L400,50 L400,200 L0,200 Z"
                        fill="url(#chartGrad)"></path>
                </svg>
                <!-- Floating price tag (top-right) -->
                <div
                    id="chart-price"
                    class:list={[
                        'absolute right-3 top-6 px-3 py-1.5 rounded-md font-mono text-base font-bold',
                        isBullish
                            ? 'bg-bullish/15 text-bullish'
                            : isBearish
                              ? 'bg-bearish/15 text-bearish'
                              : 'bg-surface text-text-muted',
                    ]}
                >
                    {stockData.price > 0 ? stockData.price.toFixed(2) : 'â€”'}
                </div>
            </div>
        </div>

        <!-- Sidebar: Price & Key Stats (Compact) -->
        <div
            class="lg:col-span-4 xl:col-span-3 space-y-3 animate-fade-up"
            style="animation-delay: 0.05s;"
        >
            <!-- Current Price Card -->
            <div class="glass-card p-4">
                <div class="text-[10px] text-text-muted mb-1.5 uppercase tracking-wider font-bold">
                    å³æ™‚åƒ¹æ ¼
                </div>
                <div class="flex items-baseline gap-2 mb-2">
                    <span id="current-price" class="data-value text-3xl text-stock-price"
                        >{stockData.price > 0 ? stockData.price.toFixed(2) : 'â€”'}</span
                    >
                    <span
                        id="current-change"
                        class:list={[
                            'text-sm font-mono font-semibold',
                            isBullish && 'text-bullish',
                            isBearish && 'text-bearish',
                            !isBullish && !isBearish && 'text-text-muted',
                        ]}
                    >
                        {isBullish ? 'â–²' : isBearish ? 'â–¼' : 'â€”'}
                    </span>
                </div>
                <div
                    id="current-change-percent"
                    class:list={[
                        'text-sm font-mono',
                        isBullish && 'text-bullish',
                        isBearish && 'text-bearish',
                        !isBullish && !isBearish && 'text-text-muted',
                    ]}
                >
                    {isBullish ? '+' : ''}{
                        stockData.change !== 0 ? stockData.change.toFixed(2) : '0.00'
                    } ({isBullish ? '+' : ''}{stockData.changePercent.toFixed(2)}%)
                </div>
            </div>

            <!-- Quick Stats Grid -->
            <div class="glass-card p-4">
                <div class="text-[10px] text-text-muted mb-2.5 uppercase tracking-wider font-bold">
                    é—œéµæ•¸æ“š
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-[11px]">
                    <div class="flex justify-between">
                        <span class="text-text-muted">é–‹ç›¤</span>
                        <span class="font-mono text-text-primary"
                            >{stockData.open > 0 ? stockData.open.toFixed(2) : 'â€”'}</span
                        >
                    </div>
                    <div class="flex justify-between">
                        <span class="text-text-muted">æœ€é«˜</span>
                        <span class="font-mono text-bullish"
                            >{stockData.high > 0 ? stockData.high.toFixed(2) : 'â€”'}</span
                        >
                    </div>
                    <div class="flex justify-between">
                        <span class="text-text-muted">æœ€ä½</span>
                        <span class="font-mono text-bearish"
                            >{stockData.low > 0 ? stockData.low.toFixed(2) : 'â€”'}</span
                        >
                    </div>
                    <div class="flex justify-between">
                        <span class="text-text-muted">æœ¬ç›Šæ¯”</span>
                        <span class="font-mono text-text-primary"
                            >{stockData.pe > 0 ? stockData.pe.toFixed(1) : 'â€”'}</span
                        >
                    </div>
                    <div class="flex justify-between">
                        <span class="text-text-muted">æˆäº¤é‡</span>
                        <span class="font-mono text-stock-volume">{fmtVol(stockData.volume)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-text-muted">æ®–åˆ©ç‡</span>
                        <span class="font-mono text-accent"
                            >{stockData.yield > 0 ? stockData.yield.toFixed(2) : 'â€”'}%</span
                        >
                    </div>
                </div>
            </div>

            <!-- PB & ROE -->
            <div class="glass-card p-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div
                            class="text-[10px] text-text-muted uppercase tracking-wider font-bold mb-1"
                        >
                            PB
                        </div>
                        <div class="data-value text-lg">
                            {stockData.pb > 0 ? stockData.pb.toFixed(2) : 'â€”'}
                        </div>
                    </div>
                    <div>
                        <div
                            class="text-[10px] text-text-muted uppercase tracking-wider font-bold mb-1"
                        >
                            ROE
                        </div>
                        <div class="data-value text-lg">
                            {stockData.roe > 0 ? `${stockData.roe.toFixed(1)}%` : 'â€”'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <TabBar symbol={symbol} activeTab="overview" />

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TAB CONTENT PANELS                              -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- Tab 1: Overview (002-tab-overview) -->
    <div data-tab-content="overview" class="space-y-6">
        <TabOverview
            symbol={symbol}
            price={stockData.price}
            change={stockData.change}
            changePercent={stockData.changePercent}
            open={stockData.open}
            high={stockData.high}
            low={stockData.low}
            volume={stockData.volume}
        />
    </div>

    <!-- Tab 2: Technical (004-tab-technical) -->
    <div data-tab-content="technical" class="hidden">
        <TabTechnical
            symbol={symbol}
            price={stockData.price}
            change={stockData.change}
            priceData={priceHistory}
        />
    </div>

    <!-- Tab 3: Chips (005-tab-chips) -->
    <div data-tab-content="chips" class="hidden">
        <TabChips symbol={symbol} price={stockData.price} />
    </div>

    <!-- Tab 4: Fundamentals (006-tab-fundamentals) -->
    <div data-tab-content="fundamentals" class="hidden">
        <TabFundamentals
            symbol={symbol}
            pe={stockData.pe}
            pb={stockData.pb}
            yield_={stockData.yield}
            roe={stockData.roe}
            eps={stockData.eps}
        />
    </div>

    <!-- Tab 5: AI Alerts (007-tab-alerts) -->
    <div data-tab-content="alerts" class="hidden">
        <TabAlerts
            symbol={symbol}
            name={stockData.name}
            price={stockData.price}
            change={stockData.change}
            changePercent={stockData.changePercent}
        />
    </div>

    <!-- realâ€‘time price updates via SSE and watchlist -->
    <script type="module">
        import { isInWatchlist, addToWatchlist, removeFromWatchlist } from '../../lib/user-account';
        import { toast } from '../../lib/toast';

        const currentSymbol = '{symbol}';
        const watchBtn = document.getElementById('watch-toggle');
        let inList = false;

        function updateWatchBtn() {
            if (!watchBtn) return;
            watchBtn.textContent = inList ? 'â˜… å·²è‡ªé¸' : 'â­ åŠ å…¥è‡ªé¸';
        }

        function syncWatchStatus() {
            inList = isInWatchlist(currentSymbol);
            updateWatchBtn();
        }

        watchBtn?.addEventListener('click', () => {
            if (inList) {
                removeFromWatchlist(currentSymbol);
                toast.show({ message: 'å·²å¾è‡ªé¸ç§»é™¤', type: 'info' });
            } else {
                addToWatchlist(currentSymbol);
                toast.show({ message: 'å·²åŠ å…¥è‡ªé¸', type: 'success' });
            }
            syncWatchStatus();
        });

        // initialize status on load
        if (typeof window !== 'undefined') {
            syncWatchStatus();

            // Log to Analysis History
            try {
                const history = JSON.parse(localStorage.getItem('analysis_history') || '[]');
                const entry = {
                    symbol: '{symbol}',
                    name: '{stockData.name}',
                    date: new Date().toLocaleDateString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                    }),
                };
                const filtered = history.filter(h => h.symbol !== entry.symbol);
                filtered.unshift(entry);
                localStorage.setItem('analysis_history', JSON.stringify(filtered.slice(0, 10)));
            } catch (e) {}
        }

        if (typeof EventSource !== 'undefined') {
            const es = new EventSource('/api/sse/stream');
            es.addEventListener('tick', e => {
                try {
                    const ticks = JSON.parse(e.data);
                    ticks.forEach(t => {
                        if (t.symbol === currentSymbol) {
                            const price = t.price.toFixed(2);
                            [
                                document.getElementById('chart-price'),
                                document.getElementById('current-price'),
                            ].forEach(el => {
                                if (el) {
                                    el.textContent = price;
                                    el.classList.add('flash');
                                    setTimeout(() => el.classList.remove('flash'), 800);
                                }
                            });
                            const chEl = document.getElementById('current-change');
                            const cpEl = document.getElementById('current-change-percent');
                            if (chEl && typeof t.change === 'number') {
                                chEl.textContent = `${t.change >= 0 ? '+' : ''}${t.change.toFixed(2)}`;
                            }
                            if (cpEl && typeof t.changePercent === 'number') {
                                cpEl.textContent = `${t.changePercent >= 0 ? '+' : ''}${t.changePercent.toFixed(2)}%`;
                            }
                        }
                    });
                } catch {}
            });
        }
    </script>
</MainTerminal>
