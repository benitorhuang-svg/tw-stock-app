---
/**
 * [symbol].astro ‚Äî Individual Stock Analysis Page (5-tab)
 * Spec: 002-tab-overview through 007-tab-alerts
 *
 * Route: /stocks/:symbol
 * Contains 5 analysis tabs: Overview, Technical, Chips, Fundamentals, AI Alerts
 */
import MainTerminal from '../../layouts/MainTerminal.astro';
import Badge from '../../components/atoms/Badge.astro';
import TabBar from '../../components/organisms/TabBar.astro';
import StatCard from '../../components/molecules/StatCard.astro';
import TabOverview from '../../components/organisms/TabOverview.astro';
import TabTechnical from '../../components/organisms/TabTechnical.astro';
import TabChips from '../../components/organisms/TabChips.astro';
import TabFundamentals from '../../components/organisms/TabFundamentals.astro';
import TabAlerts from '../../components/organisms/TabAlerts.astro';

const { symbol } = Astro.params;

if (!symbol) {
    return Astro.redirect('/');
}

// SSR: Load stock data using actual StockFullData type from service
import type { StockFullData } from '../../utils/stockDataService';

let stock: StockFullData | null = null;

try {
    const { getStockBySymbol } = await import('../../utils/stockDataService');
    stock = (await getStockBySymbol?.(symbol)) ?? null;
} catch {
    // Fallback
}

if (!stock) {
    stock = {
        symbol: symbol,
        name: `${symbol}`,
        market: 'TWSE',
        price: 0,
        change: 0,
        changePercent: 0,
        open: 0,
        high: 0,
        low: 0,
        volume: 0,
        pe: 0,
        pb: 0,
        yield: 0,
        roe: 0,
        eps: 0,
        sector: 'other',
    };
}

/** Format volume for display */
const fmtVol = (v: number) => (v > 0 ? v.toLocaleString('zh-TW') : '‚Äî');

const isBullish = stock.change > 0;
const isBearish = stock.change < 0;
---

<MainTerminal title={`${stock.name} ${stock.symbol}`}>
    <!-- Stock Hero Section -->
    <header class="mb-6 animate-fade-up">
        <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-4">
            <!-- Left: Name & Price -->
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-2xl lg:text-3xl font-bold">{stock.name}</h1>
                    <span class="font-mono text-sm text-text-muted">{stock.symbol}</span>
                    <Badge variant={isBullish ? 'bullish' : isBearish ? 'bearish' : 'muted'}>
                        {isBullish ? '‰∏äÊº≤' : isBearish ? '‰∏ãË∑å' : 'Âπ≥Áõ§'}
                    </Badge>
                </div>
                <div class="flex items-baseline gap-3">
                    <span class="data-value text-4xl lg:text-5xl">
                        {stock.price > 0 ? stock.price.toFixed(2) : '‚Äî'}
                    </span>
                    <span
                        class:list={[
                            'data-value text-xl',
                            isBullish && 'text-bullish',
                            isBearish && 'text-bearish',
                            !isBullish && !isBearish && 'text-text-muted',
                        ]}
                    >
                        {isBullish ? '‚ñ≤' : isBearish ? '‚ñº' : '‚Äî'}
                        {stock.change !== 0 ? Math.abs(stock.change).toFixed(2) : ''}
                    </span>
                    <span
                        class:list={[
                            'text-sm font-mono font-semibold',
                            isBullish && 'text-bullish',
                            isBearish && 'text-bearish',
                            !isBullish && !isBearish && 'text-text-muted',
                        ]}
                    >
                        ({isBullish ? '+' : ''}{stock.changePercent.toFixed(2)}%)
                    </span>
                </div>
            </div>

            <!-- Right: Quick Actions -->
            <div class="flex items-center gap-3">
                <button class="btn-ghost text-xs"> ‚≠ê Âä†ÂÖ•Ëá™ÈÅ∏ </button>
                <button class="btn-cyber text-xs"> ü§ñ AI ÂàÜÊûêÂ†±Âëä </button>
            </div>
        </div>
    </header>

    <!-- Quick Stats Row -->
    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6 stagger-children">
        <StatCard label="ÈñãÁõ§" value={stock.open > 0 ? stock.open.toFixed(2) : '‚Äî'} />
        <StatCard label="ÊúÄÈ´ò" value={stock.high > 0 ? stock.high.toFixed(2) : '‚Äî'} />
        <StatCard label="ÊúÄ‰Ωé" value={stock.low > 0 ? stock.low.toFixed(2) : '‚Äî'} />
        <StatCard label="Êú¨ÁõäÊØî" value={stock.pe > 0 ? stock.pe.toFixed(1) : '‚Äî'} unit="ÂÄç" />
        <StatCard label="Êàê‰∫§Èáè" value={fmtVol(stock.volume)} unit="Âºµ" />
        <StatCard label="ÊÆñÂà©Áéá" value={stock.yield > 0 ? stock.yield.toFixed(2) : '‚Äî'} unit="%" />
    </div>

    <!-- Tab Navigation -->
    <TabBar symbol={symbol} activeTab="overview" />

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB CONTENT PANELS                              -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- Tab 1: Overview (002-tab-overview) -->
    <div data-tab-content="overview" class="space-y-6">
        <TabOverview
            symbol={symbol}
            price={stock.price}
            change={stock.change}
            changePercent={stock.changePercent}
            open={stock.open}
            high={stock.high}
            low={stock.low}
            volume={stock.volume}
        />
    </div>

    <!-- Tab 2: Technical (004-tab-technical) -->
    <div data-tab-content="technical" class="hidden">
        <TabTechnical symbol={symbol} price={stock.price} change={stock.change} />
    </div>

    <!-- Tab 3: Chips (005-tab-chips) -->
    <div data-tab-content="chips" class="hidden">
        <TabChips symbol={symbol} price={stock.price} />
    </div>

    <!-- Tab 4: Fundamentals (006-tab-fundamentals) -->
    <div data-tab-content="fundamentals" class="hidden">
        <TabFundamentals
            symbol={symbol}
            pe={stock.pe}
            pb={stock.pb}
            yield_={stock.yield}
            roe={stock.roe}
            eps={stock.eps}
        />
    </div>

    <!-- Tab 5: AI Alerts (007-tab-alerts) -->
    <div data-tab-content="alerts" class="hidden">
        <TabAlerts
            symbol={symbol}
            name={stock.name}
            price={stock.price}
            change={stock.change}
            changePercent={stock.changePercent}
        />
    </div>
</MainTerminal>
