---
import Layout from "../../layouts/Layout.astro";
import StockCard from "../../components/StockCard.astro";
import { getStocksWithPrices } from "../../utils/stockDataService";

// Load real stock data from CSV files
const allStocks = await getStocksWithPrices();

// Format stocks for StockCard component
const stockList = allStocks.map(s => ({
    symbol: s.symbol,
    name: s.name,
    price: s.price,
    change: s.change,
    changePercent: s.changePercent,
    volume: s.volume,
    pe: s.pe,
    pb: s.pb,
    yield: s.yield,
    roe: s.roe,
    eps: s.eps,
}));
---

<Layout title="ÂÄãËÇ°ÂàÜÊûê">
    <h1>üìä ÂÄãËÇ°ÂàÜÊûê</h1>
    <p class="page-desc">ÁÄèË¶ΩÂè∞ÁÅ£‰∏äÂ∏ÇÊ´ÉËÇ°Á•®ÔºåÈªûÊìäÈÄ≤ÂÖ•Ë©≥Á¥∞ÂàÜÊûêÈ†ÅÈù¢„ÄÇ</p>

    <!-- ÊêúÂ∞ã -->
    <div class="search-section">
        <input
            type="text"
            id="stock-search"
            placeholder="üîç ÊêúÂ∞ãËÇ°Á•®‰ª£ËôüÊàñÂêçÁ®±..."
            class="search-input"
        />
        <span id="result-count" class="result-count"
            >{stockList.length} Ê™îËÇ°Á•®</span
        >
    </div>

    <!-- ËÇ°Á•®ÂàóË°® -->
    <div class="stock-grid" id="stock-list">
        <!-- Will be populated by JS -->
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
        <button id="prev-page" class="page-btn" disabled>‰∏ä‰∏ÄÊ≠•</button>
        <span id="page-info" class="page-info">Á¨¨ 1 / 1 È†Å</span>
        <button id="next-page" class="page-btn">‰∏ã‰∏ÄÊ≠•</button>
    </div>
</Layout>

<style>
    /* ... existing styles ... */
    .pagination-section {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 40px;
        padding: 20px 0;
    }

    .page-btn {
        padding: 10px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-info {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }
    .page-desc {
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .search-section {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 32px;
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        max-width: 400px;
        padding: 14px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 1rem;
        outline: none;
        transition: border-color 0.15s;
    }

    .search-input:focus {
        border-color: var(--accent);
    }

    .result-count {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .stock-item.hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .stock-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script define:vars={{ initialStocks: stockList }}>
    const stocks = initialStocks;
    let filteredStocks = [...stocks];
    let currentPage = 1;
    const pageSize = 48;

    const stockListElement = document.getElementById("stock-list");
    const searchInput = document.getElementById("stock-search");
    const resultCount = document.getElementById("result-count");
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageInfo = document.getElementById("page-info");

    function renderPage() {
        if (!stockListElement) return;

        const totalPages = Math.ceil(filteredStocks.length / pageSize) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageStocks = filteredStocks.slice(start, end);

        // Render stocks
        stockListElement.innerHTML = pageStocks.map(stock => `
            <div class="stock-item" data-symbol="${stock.symbol}" data-name="${stock.name}">
                <a href="/stocks/${stock.symbol}/" class="stock-card-link">
                    <div class="stock-card-mini">
                        <div class="card-header">
                            <span class="symbol">${stock.symbol}</span>
                            <span class="name">${stock.name}</span>
                        </div>
                        <div class="card-body">
                            <span class="price">${stock.price.toFixed(2)}</span>
                            <span class="change ${stock.change >= 0 ? 'pos' : 'neg'}">
                                ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.changePercent).toFixed(2)}%
                            </span>
                        </div>
                    </div>
                </a>
            </div>
        `).join('');

        // Update UI
        pageInfo.textContent = `Á¨¨ ${currentPage} / ${totalPages} È†Å`;
        resultCount.textContent = `${filteredStocks.length} Ê™îËÇ°Á•®`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    searchInput?.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase().trim();
        filteredStocks = stocks.filter(s => 
            s.symbol.toLowerCase().includes(query) || 
            s.name.toLowerCase().includes(query)
        );
        currentPage = 1;
        renderPage();
    });

    prevBtn?.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderPage();
        }
    });

    nextBtn?.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredStocks.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            renderPage();
        }
    });

    // Initial render
    renderPage();
</script>

<style is:global>
    .stock-card-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .stock-card-mini {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s;
        height: 100%;
    }

    .stock-card-mini:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .symbol {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--c-accent, #00d4aa);
    }

    .name {
        font-weight: 600;
        font-size: 1rem;
    }

    .card-body {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }

    .price {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .change {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .pos { color: #10b981; }
    .neg { color: #ef4444; }
</style>

