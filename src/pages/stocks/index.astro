---
/**
 * stocks/index.astro ‚Äî Stock Listing / Analysis Hub
 * Lists all available stocks with search and filtering.
 */
import MainTerminal from '../../layouts/MainTerminal.astro';
import PageHero from '../../components/molecules/PageHero.astro';
import StockCard from '../../components/organisms/StockCard.astro';

// SSR: Load stock list
import type { StockFullData } from '../../utils/stockDataService';

const fmtVol = (v: number) => (v > 0 ? v.toLocaleString('zh-TW') : '‚Äî');

let stocks: StockFullData[] = [];

try {
    const { getTopStocksByVolume } = await import('../../utils/stockDataService');
    stocks = (await getTopStocksByVolume?.(30)) ?? [];
} catch {
    // Fallback demo data
    stocks = [
        {
            symbol: '2330',
            name: 'Âè∞Á©çÈõª',
            market: 'TWSE',
            price: 892.0,
            change: 15.0,
            changePercent: 1.71,
            volume: 32456,
            high: 895,
            low: 880,
            open: 885,
            pe: 22.5,
            pb: 6.1,
            yield: 1.8,
            roe: 0,
            eps: 0,
            sector: 'semiconductor',
        },
        {
            symbol: '2454',
            name: 'ËÅØÁôºÁßë',
            market: 'TWSE',
            price: 1280.0,
            change: 25.0,
            changePercent: 1.99,
            volume: 8234,
            high: 1290,
            low: 1260,
            open: 1265,
            pe: 18.2,
            pb: 4.5,
            yield: 2.1,
            roe: 0,
            eps: 0,
            sector: 'semiconductor',
        },
        {
            symbol: '2317',
            name: 'È¥ªÊµ∑',
            market: 'TWSE',
            price: 156.0,
            change: 3.5,
            changePercent: 2.29,
            volume: 45678,
            high: 158,
            low: 153,
            open: 154,
            pe: 11.5,
            pb: 1.4,
            yield: 5.2,
            roe: 0,
            eps: 0,
            sector: 'electronics',
        },
    ];
}
---

<MainTerminal title="Analysis ÂàÜÊûê">
    <PageHero title="Stock Analysis" subtitle="ÂÄãËÇ°ÂàÜÊûê‰∏≠ÂøÉ ‚Äî ÈªûÊìäÈÄ≤ÂÖ•ÂÄãËÇ°Ë®∫Êñ∑È†Å">
        <span class="terminal-label">
            {stocks.length} Ê™î
        </span>
    </PageHero>

    <!-- Filter Bar -->
    <div class="flex items-center gap-3 mb-6">
        <input
            type="text"
            placeholder="üîç ÊêúÂ∞ã‰ª£ËôüÊàñÂêçÁ®±..."
            class="bg-glass border border-border rounded-lg px-4 py-2 text-sm font-mono text-text-primary placeholder:text-text-muted outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 transition-all w-full max-w-xs"
            id="stock-list-search"
        />
        <select
            class="bg-glass border border-border text-text-secondary text-xs font-medium px-3 py-2 rounded-md outline-none cursor-pointer transition-colors hover:border-accent"
        >
            <option>ÂÖ®ÈÉ®</option>
            <option>‰∏äÊº≤</option>
            <option>‰∏ãË∑å</option>
        </select>
    </div>

    <!-- Stock Cards Grid -->
    <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 stagger-children"
        id="stock-list-grid"
    >
        {
            stocks.map(stock => (
                <StockCard
                    symbol={stock.symbol}
                    name={stock.name}
                    price={stock.price}
                    change={stock.change}
                    changePercent={stock.changePercent}
                    volume={fmtVol(stock.volume)}
                />
            ))
        }
    </div>
</MainTerminal>
