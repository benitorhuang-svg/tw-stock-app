---
/**
 * stocks/index.astro â€” Analysis Hub (Landing Page for Deep Dive)
 * Focuses on selecting or searching for a specific stock to analyze.
 */
import MainTerminal from '../../layouts/MainTerminal.astro';

// SSR: Quick list for "Recently Viewed" or "Suggested"
const suggestedStocks = [
    { symbol: '2330', name: 'å°ç©é›»', sector: 'åŠå°é«”' },
    { symbol: '2317', name: 'é´»æµ·', sector: 'é›»å­' },
    { symbol: '2454', name: 'è¯ç™¼ç§‘', sector: 'åŠå°é«”' },
    { symbol: '3481', name: 'ç¾¤å‰µ', sector: 'å…‰é›»' },
    { symbol: '2303', name: 'è¯é›»', sector: 'åŠå°é«”' },
];
---

<MainTerminal title="åˆ†æä¸­å¿ƒ">
    <div class="max-w-[1000px] mx-auto pt-10 lg:pt-20 px-4">
        <!-- Centerpiece Header -->
        <div class="text-center mb-12 animate-fade-up">
            <h1 class="text-3xl lg:text-4xl font-extrabold tracking-tight text-text-primary mb-4">
                å€‹è‚¡æ•¸æ“šåˆ†æä¸­å¿ƒ
            </h1>
            <p class="text-text-muted text-sm lg:text-base max-w-xl mx-auto">
                è¼¸å…¥ä»£è™Ÿæˆ–åç¨±ï¼Œé–‹å•Ÿæ·±åº¦è¦–è¦ºåŒ–åˆ†æã€‚åŒ…å«æŠ€è¡“æŒ‡æ¨™ã€æ³•äººç±Œç¢¼ã€åŸºæœ¬é¢è¨ºæ–·åŠ AI è­¦ç¤ºã€‚
            </p>
        </div>

        <!-- Hero Search Bar -->
        <div
            class="relative max-w-2xl mx-auto mb-16 animate-fade-up"
            style="animation-delay: 100ms"
        >
            <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
                <svg
                    class="w-5 h-5 text-text-muted"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2.5"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input
                type="text"
                id="analysis-hub-search"
                placeholder="æœå°‹ä»£è™Ÿæˆ–åç¨±ï¼Œä¾‹å¦‚ 2330 æˆ– å°ç©é›»..."
                class="w-full bg-glass-deep border-2 border-border/80 focus:border-accent/60 rounded-2xl pl-14 pr-6 py-5 text-lg font-mono placeholder:text-text-muted/50 outline-none transition-all shadow-2xl shadow-accent/5"
            />

            <!-- Quick Search Results (Popovers) -->
            <div
                id="search-results"
                class="hidden absolute top-full left-0 right-0 mt-3 glass-card overflow-hidden z-50 border-accent/20 shadow-2xl"
            >
                <div class="p-2 divide-y divide-border/20" id="results-container">
                    <!-- Dynamic Items -->
                </div>
            </div>
        </div>

        <!-- Quick Access Sections -->
        <div
            class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-up"
            style="animation-delay: 200ms"
        >
            <!-- Recently Viewed -->
            <div class="glass-card p-6 border-border/40">
                <div class="flex items-center justify-between mb-5">
                    <h3
                        class="text-sm font-bold text-text-primary uppercase tracking-widest flex items-center gap-2"
                    >
                        <span class="text-accent">âŒš</span> æœ€è¿‘ç€è¦½
                    </h3>
                    <button class="text-[10px] text-text-muted hover:text-accent transition-colors"
                        >æ¸…é™¤è¨˜éŒ„</button
                    >
                </div>
                <div class="space-y-3" id="recent-analyses">
                    <div
                        class="text-center py-6 text-xs text-text-muted border border-dashed border-border/30 rounded-lg italic"
                    >
                        å°šç„¡ç€è¦½è¨˜éŒ„
                    </div>
                </div>
            </div>

            <!-- High Dividend Yield Wall (Intelligence Component) -->
            <div class="glass-card p-6 border-border/40 flex flex-col">
                <div class="flex items-center justify-between mb-5">
                    <h3
                        class="text-sm font-bold text-text-primary uppercase tracking-widest flex items-center gap-2"
                    >
                        <span class="text-accent">ğŸ’</span> é«˜æ®–åˆ©ç‡æƒ…å ±ç‰†
                    </h3>
                    <span
                        class="text-[9px] px-1.5 py-0.5 rounded bg-bullish/10 text-bullish border border-bullish/20 font-bold"
                        >Top 8 æ®–åˆ©ç‡</span
                    >
                </div>
                <div class="space-y-2 flex-1" id="dividend-wall">
                    <div class="flex items-center justify-center h-full py-10 opacity-30">
                        <div
                            class="animate-spin h-5 w-5 border-2 border-accent border-t-transparent rounded-full"
                        >
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Overview -->
    <div class="max-w-[1200px] mx-auto mt-24 mb-20 px-4 stagger-fade-up">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div
                class="p-6 glass-card border border-accent/10 hover:border-accent/30 transition-all text-center group"
            >
                <div class="text-2xl mb-3 group-hover:scale-110 transition-transform">ğŸ“ˆ</div>
                <h4 class="text-sm font-bold text-text-primary mb-2">å¤šç¶­åº¦èµ°å‹¢</h4>
                <p class="text-xs text-text-muted leading-relaxed">
                    å³æ™‚å ±åƒ¹ã€Kç·šåŠå¤šé€±æœŸæŠ€è¡“åˆ†æåœ–è¡¨
                </p>
            </div>
            <div
                class="p-6 glass-card border border-accent/10 hover:border-accent/30 transition-all text-center group"
            >
                <div class="text-2xl mb-3 group-hover:scale-110 transition-transform">ğŸ’</div>
                <h4 class="text-sm font-bold text-text-primary mb-2">æ³•äººç±Œç¢¼</h4>
                <p class="text-xs text-text-muted leading-relaxed">
                    å¤–è³‡ã€æŠ•ä¿¡è²·è³£è¶…åŠå¤§æˆ¶æŒè‚¡çµæ§‹
                </p>
            </div>
            <div
                class="p-6 glass-card border border-accent/10 hover:border-accent/30 transition-all text-center group"
            >
                <div class="text-2xl mb-3 group-hover:scale-110 transition-transform">ğŸ¦</div>
                <h4 class="text-sm font-bold text-text-primary mb-2">åŸºæœ¬é¢åˆ†æ</h4>
                <p class="text-xs text-text-muted leading-relaxed">
                    ç‡Ÿæ”¶æˆé•·ã€ç²åˆ©èƒ½åŠ›åŠå®Œæ•´è²¡å‹™æ•¸æ“š
                </p>
            </div>
            <div
                class="p-6 glass-card border border-accent/10 hover:border-accent/30 transition-all text-center group"
            >
                <div class="text-2xl mb-3 group-hover:scale-110 transition-transform">ğŸ¤–</div>
                <h4 class="text-sm font-bold text-text-primary mb-2">AI æ™ºèƒ½è­¦å ±</h4>
                <p class="text-xs text-text-muted leading-relaxed">
                    è‡ªå‹•åŒ–è¶¨å‹¢åˆ¤åˆ¥èˆ‡ç•°å¸¸æ³¢å‹•å³æ™‚æé†’
                </p>
            </div>
        </div>
    </div>
</MainTerminal>

<script lang="ts">
    import { getStocksWithPrices } from '../../utils/stockDataService';

    async function initAnalysisSearch() {
        const input = document.getElementById('analysis-hub-search') as HTMLInputElement;
        const results = document.getElementById('search-results');
        const container = document.getElementById('results-container');

        if (!input || !results || !container) return;

        let allStocks = [];
        try {
            allStocks = await getStocksWithPrices();
        } catch (e) {
            console.error('Failed to load stock list for search', e);
        }

        input.addEventListener('input', () => {
            const q = input.value.trim().toLowerCase();
            if (q.length < 1) {
                results.classList.add('hidden');
                return;
            }

            const matches = allStocks
                .filter(s => s.symbol.includes(q) || s.name.toLowerCase().includes(q))
                .slice(0, 8);

            if (matches.length > 0) {
                container.innerHTML = matches
                    .map(
                        s => `
                    <a href="/stocks/${s.symbol}" class="flex items-center justify-between p-3 hover:bg-accent/5 transition-colors no-underline group">
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-sm font-bold text-accent">${s.symbol}</span>
                            <span class="text-sm text-text-primary font-medium group-hover:text-accent transition-colors">${s.name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-mono text-text-secondary">${s.price.toFixed(2)}</span>
                            <span class="text-[10px] text-text-muted uppercase tracking-tighter">${s.sector || ''}</span>
                        </div>
                    </a>
                `
                    )
                    .join('');
                results.classList.remove('hidden');
            } else {
                container.innerHTML =
                    '<div class="p-6 text-center text-xs text-text-muted">æŸ¥ç„¡æœå°‹æ¨™çš„</div>';
                results.classList.remove('hidden');
            }
        });

        // Close search on click outside
        document.addEventListener('click', e => {
            if (!input.contains(e.target as Node) && !results.contains(e.target as Node)) {
                results.classList.add('hidden');
            }
        });

        // Initialize Dividend Wall
        function updateDividendWall() {
            const wallContainer = document.getElementById('dividend-wall');
            if (!wallContainer || allStocks.length === 0) return;

            const highYield = [...allStocks]
                .filter(s => s.yield > 0)
                .sort((a, b) => b.yield - a.yield)
                .slice(0, 8);

            wallContainer.innerHTML = highYield
                .map(
                    s => `
                <a href="/stocks/${s.symbol}" class="flex items-center justify-between p-2.5 rounded-lg hover:bg-bullish/5 transition-all border border-transparent hover:border-bullish/20 group no-underline">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-mono font-bold bg-surface px-1.5 py-0.5 rounded text-accent tracking-tighter">${s.symbol}</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-text-primary group-hover:text-bullish transition-colors">${s.name}</span>
                            <span class="text-[9px] text-text-muted hidden sm:block">${s.sector || ''}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono font-bold text-bullish">${s.yield.toFixed(2)}%</span>
                        <div class="w-8 h-1 bg-surface rounded-full overflow-hidden">
                            <div class="bg-bullish h-full rounded-full" style="width: ${Math.min(s.yield * 10, 100)}%"></div>
                        </div>
                    </div>
                </a>
            `
                )
                .join('');
        }

        updateRecent();
        updateDividendWall();
    }

    document.addEventListener('DOMContentLoaded', initAnalysisSearch);
    document.addEventListener('astro:page-load', initAnalysisSearch);
</script>
