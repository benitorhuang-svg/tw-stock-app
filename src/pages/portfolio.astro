---
import Layout from '../layouts/Layout.astro';
import { getStocksWithPrices } from '../utils/stockDataService';

const allStocks = await getStocksWithPrices();
---

<Layout title="æŠ•è³‡çµ„åˆ">
    <div class="page-header">
        <h1>ğŸ’¼ æŠ•è³‡çµ„åˆ</h1>
        <div class="header-actions">
            <button id="add-stock-btn" class="btn-primary">â• æ–°å¢æŒè‚¡</button>
            <button id="export-btn" class="btn-secondary">ğŸ“¥ åŒ¯å‡º CSV</button>
        </div>
    </div>
    <p class="page-desc">è¿½è¹¤æ‚¨çš„æŒè‚¡ã€è¨ˆç®—æç›Šï¼Œè³‡æ–™å„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­ã€‚</p>

    <!-- ç¸½è¦½å¡ç‰‡ -->
    <div class="overview-cards grid grid-4">
        <div class="card overview-card">
            <div class="card-header">ç¸½æˆæœ¬</div>
            <div id="total-cost" class="card-value">$0</div>
        </div>
        <div class="card overview-card">
            <div class="card-header">ç¸½å¸‚å€¼</div>
            <div id="total-value" class="card-value">$0</div>
        </div>
        <div class="card overview-card">
            <div class="card-header">æœªå¯¦ç¾æç›Š</div>
            <div id="total-pl" class="card-value">$0</div>
        </div>
        <div class="card overview-card">
            <div class="card-header">å ±é…¬ç‡</div>
            <div id="total-return" class="card-value">0%</div>
        </div>
    </div>

    <!-- æŒè‚¡åˆ—è¡¨ -->
    <section class="section">
        <h2>ğŸ“Š æŒè‚¡æ˜ç´°</h2>
        <div id="portfolio-empty" class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <h3>å°šç„¡æŒè‚¡</h3>
            <p>é»æ“Šã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹è¿½è¹¤æ‚¨çš„æŠ•è³‡çµ„åˆ</p>
        </div>
        <div id="portfolio-table" class="table-container hidden">
            <table>
                <thead>
                    <tr>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>æŒè‚¡</th>
                        <th>æˆæœ¬</th>
                        <th>ç¾åƒ¹</th>
                        <th>å¸‚å€¼</th>
                        <th>æç›Š</th>
                        <th>å ±é…¬ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="portfolio-body"></tbody>
            </table>
        </div>
    </section>

    <!-- æ–°å¢/ç·¨è¼¯å°è©±æ¡† -->
    <div id="add-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content card">
            <h3 id="modal-title">æ–°å¢æŒè‚¡</h3>
            <form id="add-form">
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" id="input-symbol" placeholder="ä¾‹: 2330" required />
                </div>
                <div class="form-group">
                    <label>æŒè‚¡æ•¸é‡ï¼ˆè‚¡ï¼‰</label>
                    <input
                        type="number"
                        id="input-shares"
                        placeholder="ä¾‹: 1000"
                        min="1"
                        required
                    />
                </div>
                <div class="form-group">
                    <label>å¹³å‡æˆæœ¬</label>
                    <input
                        type="number"
                        id="input-cost"
                        placeholder="ä¾‹: 580"
                        step="0.01"
                        min="0"
                        required
                    />
                </div>
                <div class="form-group">
                    <label>è²·å…¥æ—¥æœŸ</label>
                    <input type="date" id="input-date" />
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="input-notes" placeholder="é¸å¡«"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-btn" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</Layout>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn-primary {
        padding: 10px 20px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-secondary {
        padding: 10px 20px;
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
    }

    .page-desc {
        color: var(--text-secondary);
        margin-bottom: 32px;
    }

    .overview-cards {
        margin-bottom: 48px;
    }

    .overview-card {
        text-align: center;
    }

    .empty-state {
        text-align: center;
        padding: 60px 24px;
        background: var(--bg-card);
        border: 1px dashed var(--border);
        border-radius: 16px;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--text-secondary);
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 14px 16px;
        text-align: right;
        border-bottom: 1px solid var(--border);
    }

    th:first-child,
    td:first-child {
        text-align: left;
    }

    th {
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .symbol {
        font-weight: 700;
        color: var(--accent);
    }

    .action-btns {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px;
    }

    .hidden {
        display: none !important;
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 450px;
    }

    .modal-content h3 {
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
    }
</style>

<script define:vars={{ initialStocks: allStocks }}>
    // ä½¿ç”¨çœŸå¯¦è‚¡åƒ¹è³‡æ–™
    const stockMap = {};
    initialStocks.forEach(s => {
        stockMap[s.symbol] = { name: s.name, price: s.price };
    });

    const STORAGE_KEY = 'tw-portfolio';

    function getPortfolio() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function savePortfolio(items) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function renderPortfolio() {
        const items = getPortfolio();
        const tbody = document.getElementById('portfolio-body');
        const emptyState = document.getElementById('portfolio-empty');
        const tableContainer = document.getElementById('portfolio-table');

        if (!tbody || !emptyState || !tableContainer) return;

        if (items.length === 0) {
            emptyState.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            updateOverview(0, 0);
            return;
        }

        emptyState.classList.add('hidden');
        tableContainer.classList.remove('hidden');

        let totalCost = 0;
        let totalValue = 0;

        tbody.innerHTML = items
            .map(item => {
                const stockInfo = stockMap[item.symbol] || {
                    name: item.name || item.symbol,
                    price: item.avgCost,
                };
                const currentPrice = stockInfo.price;
                const cost = item.shares * item.avgCost;
                const value = item.shares * currentPrice;
                const pl = value - cost;
                const plPercent = cost > 0 ? ((pl / cost) * 100).toFixed(2) : '0.00';

                totalCost += cost;
                totalValue += value;

                const plClass = pl >= 0 ? 'positive' : 'negative';

                return `
                <tr>
                    <td class="symbol">${item.symbol}</td>
                    <td>${stockInfo.name}</td>
                    <td>${item.shares.toLocaleString()}</td>
                    <td>${item.avgCost.toFixed(2)}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${value.toLocaleString()}</td>
                    <td class="${plClass}">${pl >= 0 ? '+' : ''}${pl.toLocaleString()}</td>
                    <td class="${plClass}">${pl >= 0 ? '+' : ''}${plPercent}%</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn edit-btn" data-id="${item.id}" title="ç·¨è¼¯">âœï¸</button>
                            <button class="action-btn delete-btn" data-id="${item.id}" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `;
            })
            .join('');

        updateOverview(totalCost, totalValue);

        // ç¶å®šåˆªé™¤æŒ‰éˆ•
        tbody.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æŒè‚¡å—ï¼Ÿ')) {
                    const items = getPortfolio().filter(item => item.id !== id);
                    savePortfolio(items);
                    renderPortfolio();
                }
            });
        });
    }

    function updateOverview(totalCost, totalValue) {
        const pl = totalValue - totalCost;
        const returnRate = totalCost > 0 ? ((pl / totalCost) * 100).toFixed(2) : '0.00';
        const plClass = pl >= 0 ? 'positive' : 'negative';

        const costEl = document.getElementById('total-cost');
        if (costEl) costEl.textContent = `$${totalCost.toLocaleString()}`;

        const valueEl = document.getElementById('total-value');
        if (valueEl) valueEl.textContent = `$${totalValue.toLocaleString()}`;

        const plElement = document.getElementById('total-pl');
        if (plElement) {
            plElement.textContent = `${pl >= 0 ? '+' : ''}$${pl.toLocaleString()}`;
            plElement.className = `card-value ${plClass}`;
        }

        const returnElement = document.getElementById('total-return');
        if (returnElement) {
            returnElement.textContent = `${pl >= 0 ? '+' : ''}${returnRate}%`;
            returnElement.className = `card-value ${plClass}`;
        }
    }

    // Modal æ§åˆ¶
    const modal = document.getElementById('add-modal');
    const addForm = document.getElementById('add-form');

    document.getElementById('add-stock-btn')?.addEventListener('click', () => {
        modal?.classList.remove('hidden');
        if (addForm instanceof HTMLFormElement) addForm.reset();
    });

    document.getElementById('cancel-btn')?.addEventListener('click', () => {
        modal?.classList.add('hidden');
    });

    modal?.querySelector('.modal-backdrop')?.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    addForm?.addEventListener('submit', e => {
        e.preventDefault();

        const symbol = document.getElementById('input-symbol').value.trim();
        const shares = parseInt(document.getElementById('input-shares').value);
        const avgCost = parseFloat(document.getElementById('input-cost').value);
        const buyDate = document.getElementById('input-date').value;
        const notes = document.getElementById('input-notes').value;

        const items = getPortfolio();
        items.push({
            id: Date.now().toString(),
            symbol,
            name: stockMap[symbol]?.name || symbol,
            shares,
            avgCost,
            buyDate: buyDate || undefined,
            notes: notes || undefined,
        });

        savePortfolio(items);
        modal?.classList.add('hidden');
        renderPortfolio();
    });

    // åŒ¯å‡º CSV
    document.getElementById('export-btn')?.addEventListener('click', () => {
        const items = getPortfolio();
        if (items.length === 0) {
            alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
            return;
        }

        const headers = ['ä»£è™Ÿ', 'åç¨±', 'æŒè‚¡æ•¸', 'å¹³å‡æˆæœ¬', 'è²·å…¥æ—¥æœŸ', 'å‚™è¨»'];
        const rows = items.map(item => [
            item.symbol,
            item.name,
            item.shares,
            item.avgCost,
            item.buyDate || '',
            item.notes || '',
        ]);

        const BOM = '\uFEFF';
        const csv = BOM + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    });

    // åˆå§‹åŒ–
    if (getPortfolio().length === 0) {
        savePortfolio([
            {
                id: '1',
                symbol: '2330',
                name: 'å°ç©é›»',
                shares: 1000,
                avgCost: 580,
                buyDate: '2023-10-01',
            },
            {
                id: '2',
                symbol: '2317',
                name: 'é´»æµ·',
                shares: 2000,
                avgCost: 105,
                buyDate: '2023-11-15',
            },
        ]);
    }
    renderPortfolio();
</script>
