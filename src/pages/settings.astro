---
import Layout from '../layouts/Layout.astro';
---

<Layout title="è¨­å®š">
    <h1>âš™ï¸ è¨­å®š</h1>
    <p class="page-desc">ç®¡ç†æ‚¨çš„å€‹äººè¨­å®šã€è³‡æ–™å‚™ä»½èˆ‡åŒ¯å‡ºã€‚</p>

    <!-- å€‹äººè³‡æ–™ -->
    <section class="section card">
        <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>
        <div class="form-group">
            <label>ä½¿ç”¨è€…åç¨±</label>
            <input type="text" id="user-name" placeholder="æŠ•è³‡è€…" class="input" />
        </div>
        <button id="save-profile-btn" class="btn-primary">å„²å­˜</button>
    </section>

    <!-- é¡¯ç¤ºè¨­å®š -->
    <section class="section card">
        <h2>ğŸ¨ é¡¯ç¤ºè¨­å®š</h2>
        <div class="setting-row">
            <span>ä¸»é¡Œ</span>
            <select id="theme-select" class="select">
                <option value="dark">æ·±è‰²æ¨¡å¼</option>
                <option value="light">æ·ºè‰²æ¨¡å¼</option>
            </select>
        </div>
        <div class="setting-row">
            <span>é è¨­é¡¯ç¤ºæ–¹å¼</span>
            <select id="view-select" class="select">
                <option value="grid">å¡ç‰‡</option>
                <option value="list">åˆ—è¡¨</option>
            </select>
        </div>
        <div class="setting-row">
            <span>é¡¯ç¤ºæˆäº¤é‡</span>
            <label class="toggle">
                <input type="checkbox" id="show-volume" checked />
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-row">
            <span>é¡¯ç¤ºå‡ç·š</span>
            <label class="toggle">
                <input type="checkbox" id="show-ma" checked />
                <span class="slider"></span>
            </label>
        </div>
    </section>

    <!-- è³‡æ–™ç®¡ç† -->
    <section class="section card">
        <h2>ğŸ’¾ è³‡æ–™ç®¡ç†</h2>
        <div class="data-actions">
            <button id="backup-btn" class="btn-secondary">ğŸ“¤ å‚™ä»½è³‡æ–™ (JSON)</button>
            <button id="restore-btn" class="btn-secondary">ğŸ“¥ é‚„åŸè³‡æ–™</button>
            <input type="file" id="restore-file" accept=".json" class="hidden" />
        </div>
        <div class="storage-info">
            <span id="storage-used">ä½¿ç”¨ä¸­: è¨ˆç®—ä¸­...</span>
        </div>
    </section>

    <!-- é›¢ç·šåŒ¯å‡º -->
    <section class="section card highlight">
        <h2>ğŸ“¦ é›¢ç·š HTML åŒ¯å‡º</h2>
        <p class="description">ä¸€éµåŒ¯å‡ºå®Œæ•´çš„é›¢ç·šç‰ˆæœ¬ï¼Œç„¡éœ€ç¶²è·¯å³å¯ç€è¦½æ‰€æœ‰è³‡æ–™ã€‚</p>
        <div class="export-options">
            <label class="checkbox-label">
                <input type="checkbox" id="export-portfolio" checked />
                åŒ…å«æŠ•è³‡çµ„åˆ
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="export-watchlist" checked />
                åŒ…å«è‡ªé¸è‚¡
            </label>
        </div>
        <button id="export-html-btn" class="btn-primary btn-large">
            ğŸš€ ä¸€éµåŒ¯å‡ºé›¢ç·š HTML
        </button>
    </section>

    <!-- å±éšªå€åŸŸ -->
    <section class="section card danger">
        <h2>âš ï¸ å±éšªå€åŸŸ</h2>
        <p class="warning-text">ä»¥ä¸‹æ“ä½œä¸å¯å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
        <button id="clear-cache-btn" class="btn-danger">æ¸…é™¤å¿«å–</button>
        <button id="reset-all-btn" class="btn-danger">é‡è¨­æ‰€æœ‰è³‡æ–™</button>
    </section>
</Layout>

<style>
    .page-desc {
        color: var(--c-text-secondary, #888);
        margin-bottom: 32px;
    }

    /* Container for settings sections */
    h1 + .page-desc + .section,
    .section + .section {
        max-width: 600px;
    }

    .section {
        margin-bottom: 24px;
    }

    .card {
        background: var(--c-bg-glass, rgba(255, 255, 255, 0.02));
        border: 1px solid var(--c-border, rgba(255, 255, 255, 0.1));
        border-radius: 16px;
        padding: 24px;
    }

    .section h2 {
        margin-bottom: 20px;
        font-size: 1.1rem;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .input, .select {
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        width: 100%;
        max-width: 300px;
    }

    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
    }

    .setting-row:last-child {
        border-bottom: none;
    }

    .toggle {
        position: relative;
        width: 50px;
        height: 26px;
    }

    .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--border);
        border-radius: 26px;
        transition: 0.3s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .toggle input:checked + .slider {
        background: var(--accent);
    }

    .toggle input:checked + .slider:before {
        transform: translateX(24px);
    }

    .data-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .storage-info {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .btn-primary {
        padding: 12px 24px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-secondary {
        padding: 12px 24px;
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-danger {
        padding: 12px 24px;
        background: rgba(255, 71, 87, 0.1);
        color: #ff4757;
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 8px;
        cursor: pointer;
        margin-right: 12px;
    }

    .btn-large {
        padding: 16px 32px;
        font-size: 1.1rem;
    }

    .highlight {
        border: 1px solid var(--accent) !important;
        background: rgba(0, 212, 170, 0.05) !important;
    }

    .danger {
        border: 1px solid rgba(255, 71, 87, 0.3) !important;
    }

    .description {
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    .export-options {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .warning-text {
        color: #ff4757;
        margin-bottom: 16px;
        font-size: 0.9rem;
    }

    .hidden {
        display: none;
    }
</style>

<script>
    // è¼‰å…¥è¨­å®š
    function loadSettings() {
        const userData = JSON.parse(localStorage.getItem('tw-stock-user') || '{}');
        
        if (userData.profile?.name) {
            (document.getElementById('user-name') as HTMLInputElement).value = userData.profile.name;
        }
        
        if (userData.settings?.theme) {
            (document.getElementById('theme-select') as HTMLSelectElement).value = userData.settings.theme;
        }
    }

    loadSettings();

    // è¨ˆç®—å„²å­˜ç©ºé–“
    function calculateStorage() {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += localStorage.getItem(key)!.length * 2; // UTF-16
            }
        }
        const kb = (total / 1024).toFixed(2);
        document.getElementById('storage-used')!.textContent = `ä½¿ç”¨ä¸­: ${kb} KB`;
    }
    calculateStorage();

    // å„²å­˜å€‹äººè³‡æ–™
    document.getElementById('save-profile-btn')?.addEventListener('click', () => {
        const name = (document.getElementById('user-name') as HTMLInputElement).value;
        const userData = JSON.parse(localStorage.getItem('tw-stock-user') || '{}');
        userData.profile = userData.profile || {};
        userData.profile.name = name;
        localStorage.setItem('tw-stock-user', JSON.stringify(userData));
        alert('å·²å„²å­˜ï¼');
    });

    // ä¸»é¡Œè®Šæ›´
    document.getElementById('theme-select')?.addEventListener('change', (e) => {
        const theme = (e.target as HTMLSelectElement).value;
        if (theme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
        } else {
            document.documentElement.removeAttribute('data-theme');
        }
        localStorage.setItem('tw-stock-theme', theme);
    });

    // å‚™ä»½
    document.getElementById('backup-btn')?.addEventListener('click', () => {
        const data = {
            user: JSON.parse(localStorage.getItem('tw-stock-user') || '{}'),
            portfolio: JSON.parse(localStorage.getItem('tw-portfolio') || '[]'),
            watchlist: JSON.parse(localStorage.getItem('tw-watchlist') || '[]'),
            theme: localStorage.getItem('tw-stock-theme')
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tw-stock-backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    });

    // é‚„åŸ
    document.getElementById('restore-btn')?.addEventListener('click', () => {
        document.getElementById('restore-file')?.click();
    });

    document.getElementById('restore-file')?.addEventListener('change', async (e) => {
        const file = (e.target as HTMLInputElement).files?.[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.user) localStorage.setItem('tw-stock-user', JSON.stringify(data.user));
            if (data.portfolio) localStorage.setItem('tw-portfolio', JSON.stringify(data.portfolio));
            if (data.watchlist) localStorage.setItem('tw-watchlist', JSON.stringify(data.watchlist));
            if (data.theme) localStorage.setItem('tw-stock-theme', data.theme);
            
            alert('é‚„åŸæˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥...');
            location.reload();
        } catch (err) {
            alert('é‚„åŸå¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
        }
    });

    // é›¢ç·š HTML åŒ¯å‡º
    document.getElementById('export-html-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('export-html-btn') as HTMLButtonElement;
        btn.textContent = 'â³ æ­£åœ¨åŒ¯å‡º...';
        btn.disabled = true;

        try {
            // å‹•æ…‹è¼‰å…¥åŒ¯å‡ºæ¨¡çµ„
            const { exportOfflineHTML } = await import('../lib/offline-export');
            await exportOfflineHTML({
                includePortfolio: (document.getElementById('export-portfolio') as HTMLInputElement).checked,
                includeWatchlist: (document.getElementById('export-watchlist') as HTMLInputElement).checked
            });
            btn.textContent = 'âœ… åŒ¯å‡ºæˆåŠŸï¼';
        } catch (err) {
            console.error(err);
            btn.textContent = 'âŒ åŒ¯å‡ºå¤±æ•—';
        }

        setTimeout(() => {
            btn.textContent = 'ğŸš€ ä¸€éµåŒ¯å‡ºé›¢ç·š HTML';
            btn.disabled = false;
        }, 2000);
    });

    // æ¸…é™¤å¿«å–
    document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–å—ï¼Ÿ')) {
            Object.keys(localStorage)
                .filter(k => k.startsWith('tw-cache-'))
                .forEach(k => localStorage.removeItem(k));
            alert('å·²æ¸…é™¤å¿«å–');
            calculateStorage();
        }
    });

    // é‡è¨­æ‰€æœ‰è³‡æ–™
    document.getElementById('reset-all-btn')?.addEventListener('click', () => {
        if (confirm('âš ï¸ æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
            if (confirm('æœ€å¾Œç¢ºèªï¼šæ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                localStorage.clear();
                alert('å·²é‡è¨­æ‰€æœ‰è³‡æ–™ã€‚é é¢å°‡é‡æ–°è¼‰å…¥...');
                location.reload();
            }
        }
    });
</script>
