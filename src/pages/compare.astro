---
import Layout from '../layouts/Layout.astro';
import { getTopVolume } from '../utils/marketService';
import PageHero from '../components/molecules/PageHero.astro';
import SystemStatus from '../components/atoms/SystemStatus.astro';

// Load real stocks for selection
const allStocks = getTopVolume(1000);

// Format for client-side search
const stockLookup = allStocks.reduce((acc: any, s: any) => {
    acc[s.symbol] = {
        symbol: s.symbol,
        name: s.name,
        price: s.price,
        change: s.change_pct,
        pe: s.pe,
        pb: s.pb,
        yield: s.yield,
        roe: s.roe,
        volume: s.volume,
    };
    return acc;
}, {});
---

<Layout title="Comparison | TW Stock App">
    <div class="page-container">
        <!-- Hero Header -->
        <PageHero
            icon="‚öñÔ∏è"
            title="ASSET_COMPARISON"
            subtitle="Side-by-side technical and fundamental metrics"
            glowClass="neutral-glow"
        >
            <SystemStatus slot="action" text="MAX_4_ASSETS" />
        </PageHero>

        <!-- Selector Section -->
        <section class="selector-panel glass-card cyber-reveal" style="animation-delay: 0.2s;">
            <div class="cyber-search-box">
                <span class="search-icon">üîç</span>
                <input
                    type="text"
                    id="stock-search"
                    class="cyber-input mono"
                    placeholder="ENTER SYMBOL OR NAME TO ADD TO POOL..."
                    autocomplete="off"
                />
            </div>

            <!-- Floating Cyber Dropdown -->
            <div
                id="search-dropdown"
                class="cyber-dropdown glass-card glow-wrapper"
                style="display:none;"
            >
                <div class="glow-bg accent-glow"></div>
                <div class="dropdown-content">
                    {
                        allStocks.map(stock => (
                            <button
                                class="dd-item mono"
                                data-symbol={stock.symbol}
                                data-name={stock.name}
                            >
                                <span class="dd-sym text-accent">{stock.symbol}</span>
                                <span class="dd-name text-muted">{stock.name}</span>
                            </button>
                        ))
                    }
                </div>
            </div>

            <!-- Active Pool -->
            <div id="selected-stocks" class="active-pool"></div>
        </section>

        <!-- Comparison Table Area -->
        <main
            id="comparison-section"
            class="comparison-workspace glass-card glow-wrapper cyber-reveal"
            style="display:none; animation-delay: 0.3s;"
        >
            <div class="glow-bg neutral-glow"></div>

            <header class="workspace-header">
                <h2 class="mono">COMPARISON_MATRIX //</h2>
            </header>

            <div class="table-scroll">
                <table id="comparison-table" class="premium-table">
                    <thead>
                        <tr>
                            <th class="metric-col sticky-col mono">METRIC</th>
                            <!-- JS injected headers -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-metric="price"
                            ><td class="metric-name sticky-col mono text-muted">MARKET_PRICE</td
                            ></tr
                        >
                        <tr data-metric="change"
                            ><td class="metric-name sticky-col mono text-muted">CHANGE_%</td></tr
                        >
                        <tr data-metric="pe"
                            ><td class="metric-name sticky-col mono text-muted">P/E_RATIO</td></tr
                        >
                        <tr data-metric="pb"
                            ><td class="metric-name sticky-col mono text-muted">P/B_RATIO</td></tr
                        >
                        <tr data-metric="yield"
                            ><td class="metric-name sticky-col mono text-muted">DIV_YIELD_%</td></tr
                        >
                        <tr data-metric="roe"
                            ><td class="metric-name sticky-col mono text-muted">ROE_%</td></tr
                        >
                        <tr data-metric="volume"
                            ><td class="metric-name sticky-col mono text-muted">VOLUME</td></tr
                        >
                    </tbody>
                </table>
            </div>

            <div class="matrix-legend">
                <span class="legend-item"><span class="box best-box"></span> OVERPERFORMING</span>
                <span class="legend-item"><span class="box worst-box"></span> UNDERPERFORMING</span>
            </div>
        </main>
    </div>
</Layout>

<style>
    .page-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding-bottom: 40px;
    }

    /* Glass Effect Base */
    .glass-card {
        background: var(--c-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--c-border-glass, rgba(60, 80, 120, 0.2));
        border-radius: 16px;
        position: relative;
    }

    .glow-wrapper {
        position: relative;
    }
    .glow-bg {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        transition: opacity 0.3s ease;
        background: radial-gradient(
            400px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
            var(--glow-color, rgba(255, 255, 255, 0.05)),
            transparent 40%
        );
    }
    .glow-wrapper:hover .glow-bg {
        opacity: 1;
    }
    .neutral-glow {
        --glow-color: rgba(200, 200, 210, 0.05);
    }
    .accent-glow {
        --glow-color: rgba(59, 130, 246, 0.1);
    }

    /* Hero */
    .page-hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        z-index: 10;
        overflow: hidden;
    }
    .hero-left {
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 1;
    }
    .icon-box {
        width: 56px;
        height: 56px;
        background: rgba(var(--c-accent-rgb), 0.1);
        border: 1px solid rgba(var(--c-accent-rgb), 0.3);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .hero-left h1 {
        font-size: 16px;
        margin: 0;
        letter-spacing: 2px;
    }
    .hero-left p {
        font-size: 11px;
        margin: 4px 0 0;
    }
    .sys-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        z-index: 1;
        color: var(--c-text-muted);
    }
    .pulse-dot {
        width: 6px;
        height: 6px;
        background: currentColor;
        border-radius: 50%;
        opacity: 0.5;
    }

    /* Selector */
    .selector-panel {
        padding: 24px;
        z-index: 20;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .cyber-search-box {
        position: relative;
        display: flex;
        align-items: center;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 4px;
        transition: 0.3s;
    }
    .cyber-search-box:focus-within {
        border-color: var(--c-accent);
        box-shadow: 0 0 15px rgba(var(--c-accent-rgb), 0.2);
    }
    .search-icon {
        padding: 0 16px;
        opacity: 0.5;
    }
    .cyber-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 14px;
        padding: 12px 0;
        outline: none;
    }

    .cyber-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 24px;
        right: 24px;
        z-index: 100;
        overflow: hidden;
    }
    .dropdown-content {
        position: relative;
        z-index: 1;
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .dropdown-content::-webkit-scrollbar {
        width: 6px;
    }
    .dropdown-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }

    .dd-item {
        background: transparent;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 16px 20px;
        text-align: left;
        cursor: pointer;
        display: flex;
        gap: 16px;
        align-items: baseline;
        transition: 0.2s;
    }
    .dd-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .dd-sym {
        font-weight: 800;
        font-size: 14px;
        min-width: 60px;
    }

    /* Active Pool Tags */
    .active-pool {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    .pool-tag {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        background: rgba(var(--c-accent-rgb), 0.1);
        border: 1px solid var(--c-accent);
        padding: 8px 16px;
        border-radius: 20px;
        color: #fff;
        font-size: 12px;
        box-shadow: 0 0 10px rgba(var(--c-accent-rgb), 0.1);
    }
    .pool-tag .rm-btn {
        background: none;
        border: none;
        color: var(--c-accent);
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        transition: 0.2s;
    }
    .pool-tag .rm-btn:hover {
        color: #fff;
        text-shadow: 0 0 8px #fff;
    }

    /* Main Table Workspace */
    .comparison-workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .workspace-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        z-index: 1;
    }
    .workspace-header h2 {
        font-size: 12px;
        margin: 0;
        color: var(--c-text-muted);
        letter-spacing: 2px;
    }

    .table-scroll {
        flex: 1;
        overflow-x: auto;
        position: relative;
        z-index: 1;
    }
    .premium-table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
    }
    .premium-table th {
        background: rgba(10, 15, 25, 0.95);
        backdrop-filter: blur(10px);
        font-size: 12px;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .col-head-sym {
        display: block;
        font-size: 18px;
        font-weight: 800;
        color: var(--c-accent);
        margin-bottom: 4px;
    }
    .col-head-name {
        display: block;
        font-size: 11px;
        color: var(--c-text-muted);
        font-family: 'Inter', sans-serif;
        font-weight: 400;
    }

    .premium-table td {
        padding: 16px 20px;
        font-size: 14px;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        vertical-align: middle;
        transition: 0.3s;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        text-align: left !important;
        background: var(--c-bg-glass);
        z-index: 11;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    .premium-table tbody tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    /* Conditionals */
    :global(.best-val) {
        color: var(--c-success) !important;
        font-weight: 800;
        text-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
    }
    :global(.worst-val) {
        color: var(--c-danger) !important;
        font-weight: 800;
    }

    .matrix-legend {
        padding: 16px 24px;
        display: flex;
        gap: 20px;
        font-size: 10px;
        color: var(--c-text-muted);
        border-top: 1px dashed rgba(255, 255, 255, 0.05);
        position: relative;
        z-index: 1;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .box {
        width: 10px;
        height: 10px;
        border-radius: 2px;
    }
    .best-box {
        background: var(--c-success);
        box-shadow: 0 0 8px var(--c-success);
    }
    .worst-box {
        background: var(--c-danger);
    }
</style>

<script define:vars={{ fullStockData: stockLookup }}>
    // @ts-nocheck
    // Glow Tracker
    let selectedStocks = [];
    const maxStocks = 4;

    // --- DOM Elements ---
    const input = document.getElementById('stock-search');
    const dropdown = document.getElementById('search-dropdown');
    const container = document.getElementById('selected-stocks');
    const matrix = document.getElementById('comparison-section');

    if (!input || !dropdown || !container || !matrix) return;

    // Search Logic
    input.addEventListener('focus', () => (dropdown.style.display = 'block'));
    input.addEventListener('input', e => {
        const query = e.target.value.toLowerCase();
        dropdown.querySelectorAll('.dd-item').forEach(item => {
            const sym = item.getAttribute('data-symbol')?.toLowerCase() || '';
            const nm = item.getAttribute('data-name')?.toLowerCase() || '';
            if (sym.includes(query) || nm.includes(query)) item.style.display = 'flex';
            else item.style.display = 'none';
        });
    });

    document.addEventListener('click', e => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // Selection
    dropdown.querySelectorAll('.dd-item').forEach(item => {
        item.addEventListener('click', () => {
            const sym = item.getAttribute('data-symbol');
            if (sym && !selectedStocks.includes(sym) && selectedStocks.length < maxStocks) {
                selectedStocks.push(sym);
                updateView();
                dropdown.style.display = 'none';
                input.value = '';
            }
        });
    });

    function updateView() {
        container.innerHTML = selectedStocks
            .map(sym => {
                const stock = fullStockData[sym] || { symbol: sym, name: 'Unknown' };
                return `
                <div class="pool-tag mono">
                    <span>${stock.symbol} ${stock.name}</span>
                    <button class="rm-btn" data-symbol="${sym}">√ó</button>
                </div>
            `;
            })
            .join('');

        container.querySelectorAll('.rm-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const sym = btn.getAttribute('data-symbol');
                if (sym) {
                    selectedStocks = selectedStocks.filter(s => s !== sym);
                    updateView();
                }
            });
        });

        updateMatrix();
    }

    function updateMatrix() {
        if (selectedStocks.length < 2) {
            matrix.style.display = 'none';
            return;
        }
        matrix.style.display = 'flex';

        const table = document.getElementById('comparison-table');
        if (!table) return;

        const theadTr = table.querySelector('thead tr');
        const tbodyTrs = table.querySelectorAll('tbody tr');

        if (!theadTr || !tbodyTrs.length) return;

        // Clear dynamic columns
        while (theadTr.children.length > 1) theadTr.removeChild(theadTr.lastChild);
        tbodyTrs.forEach(tr => {
            while (tr.children.length > 1) tr.removeChild(tr.lastChild);
        });

        // Add Data
        selectedStocks.forEach(sym => {
            const stock = fullStockData[sym];
            if (!stock) return;

            const th = document.createElement('th');
            th.innerHTML = `<span class="col-head-sym mono">${stock.symbol}</span><span class="col-head-name">${stock.name}</span>`;
            theadTr.appendChild(th);

            const mData = {
                price: stock.price.toFixed(2),
                change: `${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%`,
                pe: stock.pe.toFixed(1),
                pb: stock.pb.toFixed(1),
                yield: stock.yield.toFixed(1),
                roe: stock.roe.toFixed(1),
                volume: stock.volume.toLocaleString(),
            };

            tbodyTrs.forEach(tr => {
                const mKey = tr.getAttribute('data-metric');
                if (mKey) {
                    const td = document.createElement('td');
                    td.className = 'mono';
                    td.textContent = mData[mKey];
                    tr.appendChild(td);
                }
            });
        });

        // Compute styling
        const highIsPos = ['yield', 'roe', 'change'];
        const lowIsPos = ['pe', 'pb'];

        tbodyTrs.forEach(tr => {
            const mKey = tr.getAttribute('data-metric');
            const tds = Array.from(tr.querySelectorAll('td:not(.metric-name)'));
            if (tds.length < 2) return;

            const vals = tds.map(td => parseFloat(td.textContent.replace(/[,%+]/g, '')) || 0);
            const max = Math.max(...vals);
            const min = Math.min(...vals.filter(v => v > 0));

            tds.forEach((td, i) => {
                td.classList.remove('best-val', 'worst-val');
                if (highIsPos.includes(mKey)) {
                    if (vals[i] === max) td.classList.add('best-val');
                    if (vals[i] === min && min > 0) td.classList.add('worst-val');
                } else if (lowIsPos.includes(mKey)) {
                    if (vals[i] === min && min > 0) td.classList.add('best-val');
                    if (vals[i] === max) td.classList.add('worst-val');
                }
            });
        });
    }
</script>
