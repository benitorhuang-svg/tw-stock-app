---
/**
 * index.astro — Dashboard / 總覽 (Atomic Design Edition)
 * Professional market data dashboard with Strategic HUD, Liquidity Sidebar,
 * and Movers Matrix.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import StrategicHUD from '../components/organisms/StrategicHUD.astro';
import LiquidityLeaders from '../components/molecules/LiquidityLeaders.astro';
import MoversMatrix from '../components/organisms/MoversMatrix.astro';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';
import SentimentTrendModal from '../components/organisms/SentimentTrendModal.astro';
import type { StockFullData } from '../utils/stockDataService';

let gainers: StockFullData[] = [];
let losers: StockFullData[] = [];
let topVolume: StockFullData[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    totalStocks = all.length;
    dataDate = all.find(s => s.date)?.date || '';

    const withPrice = all.filter(s => s.price > 0);
    upCount = withPrice.filter(s => s.changePercent > 0).length;
    downCount = withPrice.filter(s => s.changePercent < 0).length;
    flatCount = withPrice.filter(s => s.changePercent === 0).length;
    totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
    avgChange =
        withPrice.length > 0
            ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
            : 0;

    gainers = withPrice
        .filter(s => s.changePercent > 0)
        .sort((a, b) => b.changePercent - a.changePercent)
        .slice(0, 10);
    losers = withPrice
        .filter(s => s.changePercent < 0)
        .sort((a, b) => a.changePercent - b.changePercent)
        .slice(0, 10);
    topVolume = withPrice.sort((a, b) => b.volume - a.volume).slice(0, 10);
} catch (e) {
    console.error('Dashboard data load error:', e);
}
---

<MainTerminal title="市場漲幅">
    <div class="space-y-6 relative pb-20">
        <!-- Strategic Intelligence HUD (Organism) -->
        <StrategicHUD
            upCount={upCount}
            downCount={downCount}
            flatCount={flatCount}
            totalStocks={totalStocks}
            totalVolume={totalVolume}
            avgChange={avgChange}
            dataDate={dataDate}
        />

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <!-- Sidebar: Liquidity Intelligence (Molecule) -->
            <aside class="lg:col-span-3 space-y-4">
                <LiquidityLeaders topVolume={topVolume} />
            </aside>

            <!-- Main Panel: Movers Grid (Organism) -->
            <div class="lg:col-span-9 space-y-6">
                <MoversMatrix gainers={gainers} losers={losers} />

                <!-- Signal Stream & Trend Actions -->
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 pt-4">
                    <ForensicTicker />
                    <button
                        id="open-breadth-chart"
                        class="px-8 py-3 rounded-xl bg-white/5 border border-white/10 text-[10px] font-bold text-white/40 hover:text-white hover:border-white/20 transition-all uppercase tracking-widest active:scale-95 flex items-center gap-3"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-accent/40"
                            ><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path
                                d="M22 12A10 10 0 0 0 12 2v10z"></path></svg
                        >
                        Analyse Sentiment Trends
                    </button>
                </div>

                <!-- Analysis Modal (Organism) -->
                <SentimentTrendModal />
            </div>
        </div>
    </div>
</MainTerminal>

<script src="../scripts/dashboard-engine.ts"></script>
