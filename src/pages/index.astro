---
/**
 * index.astro ‚Äî Dashboard / Á∏ΩË¶Ω
 * Spec: 005-ui-layout/002-tab-overview.md (adapted for market-wide dashboard)
 *
 * Features:
 * - Market breadth overview (TAIEX, advances/declines)
 * - Top gainers & losers panels
 * - Quick stock cards grid
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import PageHero from '../components/molecules/PageHero.astro';
import StatCard from '../components/molecules/StatCard.astro';
import MarketBreadth from '../components/organisms/MarketBreadth.astro';
import MoversPanel from '../components/organisms/MoversPanel.astro';
import StockCard from '../components/organisms/StockCard.astro';

// SSR: Try loading real data from services
import type { StockFullData } from '../utils/stockDataService';

const fmtVol = (v: number) => (v > 0 ? v.toLocaleString('zh-TW') : '‚Äî');

let topStocks: StockFullData[] = [];

try {
    const { getTopStocksByVolume } = await import('../utils/stockDataService');
    topStocks = (await getTopStocksByVolume?.(6)) ?? [];
} catch {
    // Fallback demo data
    topStocks = [
        {
            symbol: '2330',
            name: 'Âè∞Á©çÈõª',
            market: 'TWSE',
            price: 892.0,
            change: 15.0,
            changePercent: 1.71,
            volume: 32456,
            high: 895,
            low: 880,
            open: 885,
            pe: 22.5,
            pb: 6.1,
            yield: 1.8,
            roe: 0,
            eps: 0,
            sector: 'semiconductor',
        },
        {
            symbol: '2454',
            name: 'ËÅØÁôºÁßë',
            market: 'TWSE',
            price: 1280.0,
            change: 25.0,
            changePercent: 1.99,
            volume: 8234,
            high: 1290,
            low: 1260,
            open: 1265,
            pe: 18.2,
            pb: 4.5,
            yield: 2.1,
            roe: 0,
            eps: 0,
            sector: 'semiconductor',
        },
        {
            symbol: '2317',
            name: 'È¥ªÊµ∑',
            market: 'TWSE',
            price: 156.0,
            change: 3.5,
            changePercent: 2.29,
            volume: 45678,
            high: 158,
            low: 153,
            open: 154,
            pe: 11.5,
            pb: 1.4,
            yield: 5.2,
            roe: 0,
            eps: 0,
            sector: 'electronics',
        },
    ];
}
---

<MainTerminal title="Dashboard">
    <!-- Page Hero -->
    <PageHero title="Market Dashboard" subtitle="Âè∞ËÇ°Âç≥ÊôÇÂ∏ÇÂ†¥Ê¶ÇË¶Ω" />

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 stagger-children">
        <StatCard label="Âä†Ê¨äÊåáÊï∏" value="22,156.78" change={0.57} />
        <StatCard label="Ê´ÉË≤∑ÊåáÊï∏" value="237.45" change={-0.32} />
        <StatCard label="Êàê‰∫§Èáè" value="3,421" unit="ÂÑÑ" />
        <StatCard label="Êº≤Ë∑åÊØî" value="523 / 401" />
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 stagger-children">
        <!-- Left: Market Breadth -->
        <div class="lg:col-span-5">
            <MarketBreadth />
        </div>

        <!-- Right: Top Movers -->
        <div class="lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-6">
            <MoversPanel type="gainers" />
            <MoversPanel type="losers" />
        </div>
    </div>

    <!-- Stock Cards Grid -->
    <section class="mt-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-text-primary">üè∑Ô∏è ÁÜ±ÈñÄÂÄãËÇ°</h2>
            <a href="/screener" class="btn-ghost text-xs" data-astro-prefetch> Êü•ÁúãÊõ¥Â§ö ‚Üí </a>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 stagger-children">
            {
                topStocks.map(stock => (
                    <StockCard
                        symbol={stock.symbol}
                        name={stock.name}
                        price={stock.price}
                        change={stock.change}
                        changePercent={stock.changePercent}
                        volume={fmtVol(stock.volume)}
                    />
                ))
            }
        </div>
    </section>
</MainTerminal>
