---
import MainTerminal from '../layouts/MainTerminal.astro';
import DashboardController from '../components/organisms/DashboardController.svelte';
import SentimentTrendModal from '../components/organisms/SentimentTrendModal.astro';

/**
 * Lightweight SSR: Only compute summary numbers (1 SQL row).
 * Heavy data (stocks, breadth) is fetched client-side by DashboardController.
 * This keeps the HTML payload ~5KB for instant view-transition navigation.
 */
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;
let distribution: any = null;

try {
    const { dbService } = await import('../lib/db/sqlite-service');

    const summary = dbService.queryOne<{
        up: number;
        down: number;
        flat: number;
        total_vol: number;
        avg_chg: number;
        latest_date: string;
        p9: number;
        p6_9: number;
        p3_6: number;
        p0_3: number;
        zero: number;
        m0_3: number;
        m3_6: number;
        m6_9: number;
        m9: number;
    }>(`
        SELECT
            SUM(CASE WHEN change_pct > 0 THEN 1 ELSE 0 END) as up,
            SUM(CASE WHEN change_pct < 0 THEN 1 ELSE 0 END) as down,
            SUM(CASE WHEN change_pct = 0 AND close > 0 THEN 1 ELSE 0 END) as flat,
            SUM(volume) as total_vol,
            AVG(change_pct) as avg_chg,
            MAX(date) as latest_date,
            SUM(CASE WHEN change_pct >= 9 THEN 1 ELSE 0 END) as p9,
            SUM(CASE WHEN change_pct >= 6 AND change_pct < 9 THEN 1 ELSE 0 END) as p6_9,
            SUM(CASE WHEN change_pct >= 3 AND change_pct < 6 THEN 1 ELSE 0 END) as p3_6,
            SUM(CASE WHEN change_pct > 0 AND change_pct < 3 THEN 1 ELSE 0 END) as p0_3,
            SUM(CASE WHEN change_pct = 0 THEN 1 ELSE 0 END) as zero,
            SUM(CASE WHEN change_pct > -3 AND change_pct < 0 THEN 1 ELSE 0 END) as m0_3,
            SUM(CASE WHEN change_pct > -6 AND change_pct <= -3 THEN 1 ELSE 0 END) as m3_6,
            SUM(CASE WHEN change_pct > -9 AND change_pct <= -6 THEN 1 ELSE 0 END) as m6_9,
            SUM(CASE WHEN change_pct <= -9 THEN 1 ELSE 0 END) as m9
        FROM latest_prices WHERE close > 0
    `);

    if (summary) {
        upCount = summary.up;
        downCount = summary.down;
        flatCount = summary.flat;
        totalVolume = summary.total_vol || 0;
        avgChange = summary.avg_chg || 0;
        dataDate = summary.latest_date || '';
        distribution = {
            p9: summary.p9,
            p6_9: summary.p6_9,
            p3_6: summary.p3_6,
            p0_3: summary.p0_3,
            zero: summary.zero,
            m0_3: summary.m0_3,
            m3_6: summary.m3_6,
            m6_9: summary.m6_9,
            m9: summary.m9,
        };
    }
} catch {
    // Fallback: JSON-based data loading (static build / no DB)
    try {
        const svc = await import('../utils/stockDataService');
        const all = await svc.getStocksWithPrices();
        dataDate = all.find(s => s.date)?.date || '';
        const withPrice = all.filter(s => s.price > 0);
        upCount = withPrice.filter(s => s.changePercent > 0).length;
        downCount = withPrice.filter(s => s.changePercent < 0).length;
        flatCount = withPrice.filter(s => s.changePercent === 0).length;
        totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
        avgChange =
            withPrice.length > 0
                ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
                : 0;
    } catch (e2) {
        console.error('Dashboard data load error:', e2);
    }
}
---

<MainTerminal title="市場漲幅" fullWidth={true}>
    <div class="relative pb-20 pt-0 px-4 lg:px-6">
        <DashboardController
            client:idle
            upCount={upCount}
            downCount={downCount}
            flatCount={flatCount}
            totalVolume={totalVolume}
            avgChange={avgChange}
            dataDate={dataDate}
            distribution={distribution}
        />

        <SentimentTrendModal />
    </div>
</MainTerminal>
```
