---
/**
 * index.astro â€” Dashboard / ç¸½è¦½
 * Professional market data dashboard with market breadth, top movers,
 * volume leaders, and high yield stocks.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import MarketStatusPanel from '../components/molecules/MarketStatusPanel.astro';
import MoversPanel from '../components/organisms/MoversPanel.astro';
import StockCard from '../components/molecules/StockCard.astro';
import { fmtVol } from '../utils/format';
import type { StockFullData } from '../utils/stockDataService';


let gainers: StockFullData[] = [];
let losers: StockFullData[] = [];
let topVolume: StockFullData[] = [];
let highYield: StockFullData[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    totalStocks = all.length;
    dataDate = all.find(s => s.date)?.date || '';

    const withPrice = all.filter(s => s.price > 0);
    upCount = withPrice.filter(s => s.changePercent > 0).length;
    downCount = withPrice.filter(s => s.changePercent < 0).length;
    flatCount = withPrice.filter(s => s.changePercent === 0).length;
    totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
    avgChange = withPrice.length > 0
        ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
        : 0;

    gainers = withPrice
        .filter(s => s.changePercent > 0)
        .sort((a, b) => b.changePercent - a.changePercent)
        .slice(0, 10);
    losers = withPrice
        .filter(s => s.changePercent < 0)
        .sort((a, b) => a.changePercent - b.changePercent)
        .slice(0, 10);
    topVolume = withPrice
        .sort((a, b) => b.volume - a.volume)
        .slice(0, 10);
    highYield = withPrice
        .filter(s => s.yield > 0 && s.pe > 0)
        .sort((a, b) => b.yield - a.yield)
        .slice(0, 8);
} catch (e) {
    console.error('Dashboard data load error:', e);
}
---

<MainTerminal title="å¸‚å ´æ¼²å¹…">
    {totalStocks === 0 ? (
        <div class="empty-state py-20 animate-fade-up">
            <div class="empty-state-icon animate-glow-pulse">ğŸ“¡</div>
            <h2 class="text-xl font-bold text-text-primary mb-2">æš«ç„¡å¸‚å ´è³‡æ–™</h2>
            <p class="text-sm text-text-muted max-w-sm mb-6">
                å°šæœªè¼‰å…¥è‚¡ç¥¨è³‡æ–™ï¼Œè«‹ç¢ºèª <code class="font-mono text-accent">public/data/</code> ç›®éŒ„ä¸‹çš„ JSON è³‡æ–™å·²å»ºæ§‹å®Œæˆã€‚
            </p>
            <button onclick="location.reload()" class="btn-cyber text-xs">é‡æ–°è¼‰å…¥</button>
        </div>
    ) : (
    <Fragment>

    <!-- â”€â”€ 3-Column Dashboard Layout â”€â”€ -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 animate-fade-up py-1">
        
        <!-- â•â•â• Left Column: Stats & Breadth & Volume (Col Span 4) â•â•â• -->
        <div class="lg:col-span-4 space-y-4">
            <!-- 1. Market Status Module (Molecule) -->
            <MarketStatusPanel
                dataDate={dataDate}
                totalVolume={totalVolume}
                avgChange={avgChange}
                upCount={upCount}
                downCount={downCount}
                flatCount={flatCount}
                totalStocks={totalStocks}
            />

            <!-- 2. Volume Leaders -->
            <section class="glass-card p-0 overflow-hidden border-border/40">
                <div class="terminal-toolbar py-1.5 px-4 h-auto">
                    <span class="terminal-toolbar-title text-[11px]">æˆäº¤ç†±é–€é¾é ­</span>
                </div>
                <div class="p-3">
                    <div class="grid grid-cols-2 gap-3" data-panel="volume-leaders">
                        {topVolume.slice(0, 4).map((s) => (
                            <StockCard
                                symbol={s.symbol}
                                name={s.name}
                                price={s.price}
                                changePercent={s.changePercent}
                                volume={s.volume}
                                pe={s.pe}
                                compact={true}
                            />
                        ))}
                    </div>
                </div>
            </section>
        </div>

        <!-- â•â•â• Right Side: Breadth & Movers (Col Span 8) â•â•â• -->
        <div class="lg:col-span-8 space-y-4">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Losers -->
                <div data-panel="losers">
                <MoversPanel
                    title="è·Œå¹…æ’è¡Œ"
                    stocks={losers.slice(0, 10)}
                    variant="bearish"
                    class="border-bearish/10 h-full"
                />
                </div>
                <!-- Gainers -->
                <div data-panel="gainers">
                <MoversPanel
                    title="æ¼²å¹…æ’è¡Œ"
                    stocks={gainers.slice(0, 10)}
                    variant="bullish"
                    class="border-bullish/10 h-full"
                />
                </div>
            </div>
        </div>
    </div>

    </Fragment>
    )}
</MainTerminal>

<script>
    // â•â•â• Shared Client-Side Format Helpers â•â•â•
    function fmtVolClient(v: number): string {
        const cv = Math.ceil(v);
        if (cv >= 100000000) return (cv / 100000000).toFixed(1) + 'å„„';
        if (cv >= 10000) return (cv / 10000).toFixed(1) + 'è¬';
        if (cv > 0) return cv.toLocaleString('zh-TW');
        return 'â€”';
    }
    function fmtPctClient(v: number): string {
        return (v > 0 ? '+' : '') + v.toFixed(2) + '%';
    }
    function fmtPriceClient(v: number): string {
        return v > 0 ? v.toFixed(2) : 'â€”';
    }

    // SSE updates for dashboard counts
    if (typeof EventSource !== 'undefined') {
        const es = new EventSource('/api/sse/stream');
        const headerLed = document.getElementById('connection-status-led');

        // Connection established
        es.onopen = () => {
            if (headerLed) {
                headerLed.className = 'w-1.5 h-1.5 rounded-full bg-bullish animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]';
            }
        };

        // Connection error
        es.onerror = () => {
            if (headerLed) {
                headerLed.className = 'w-1.5 h-1.5 rounded-full bg-bearish animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.4)]';
            }
        };

        es.addEventListener('tick', e => {
            try {
                const ticks = JSON.parse(e.data);
                if (!ticks || !Array.isArray(ticks)) return;

                let up = 0, down = 0, flat = 0, totalVol = 0, totalPct = 0, count = 0;
                let latestDate = '';

                ticks.forEach((t) => {
                    const price = parseFloat(t.Close || t.price || 0);
                    const chgPct = parseFloat(t.ChangePct || t.changePercent || 0);
                    const vol = parseFloat(t.Volume || t.volume || 0);
                    
                    if (price > 0) {
                        if (chgPct > 0) up++;
                        else if (chgPct < 0) down++;
                        else flat++;
                        
                        totalVol += vol;
                        totalPct += chgPct;
                        count++;
                        if (t.Date) latestDate = t.Date;
                    }
                });

                // Update Breadth Counts (Organism Detail Widgets)
                const upEl = document.querySelector('#breadth-up');
                const downEl = document.querySelector('#breadth-down');
                const flatEl = document.querySelector('#breadth-flat');
                
                // Update Breadth Ranges (Molecule Anchors)
                const rangeUpEl = document.querySelector('#breadth-range-up');
                const rangeDownEl = document.querySelector('#breadth-range-down');

                if (upEl) upEl.textContent = String(up);
                if (downEl) downEl.textContent = String(down);
                if (flatEl) flatEl.textContent = String(flat);
                if (rangeUpEl) rangeUpEl.textContent = String(up);
                if (rangeDownEl) rangeDownEl.textContent = String(down);
                
                // Update Ratio and Color (Explicitly Force Tailwind Classes)
                const ratioEl = document.getElementById('breadth-ratio');
                const ratioContainer = document.getElementById('breadth-ratio-container');
                if (ratioEl) {
                    const ratio = down > 0 ? (up / down) : 999;
                    ratioEl.textContent = down > 0 ? ratio.toFixed(2) : 'MAX';
                    
                    if (ratioContainer) {
                        const baseClasses = "text-[10px] font-mono px-2 py-0.5 rounded border-2 transition-all duration-500 font-black";
                        if (ratio >= 1) {
                            ratioContainer.className = `${baseClasses} bg-bullish/20 text-[#ff4d4d] border-bullish/40 shadow-[0_0_10px_rgba(239,68,68,0.2)]`;
                        } else {
                            ratioContainer.className = `${baseClasses} bg-bearish/20 text-[#00ff88] border-bearish/40 shadow-[0_0_10px_rgba(34,197,94,0.2)]`;
                        }
                    }
                }
                
                // Update Bar & Percentages
                const total = up + down + flat;
                if (total > 0) {
                    const pUp = (up / total) * 100;
                    const pDown = (down / total) * 100;
                    const pFlat = (flat / total) * 100;

                    const barUp = document.getElementById('breadth-bar-up');
                    const barDown = document.getElementById('breadth-bar-down');
                    const barFlat = document.getElementById('breadth-bar-flat');
                    const txtUp = document.getElementById('breadth-pct-up');
                    const txtDown = document.getElementById('breadth-pct-down');
                    const txtFlat = document.getElementById('breadth-pct-flat');

                    if (barUp) barUp.style.width = pUp + '%';
                    if (barDown) barDown.style.width = pDown + '%';
                    if (barFlat) barFlat.style.width = pFlat + '%';
                    if (txtUp) txtUp.textContent = pUp.toFixed(1) + '%';
                    if (txtDown) txtDown.textContent = pDown.toFixed(1) + '%';
                    if (txtFlat) txtFlat.textContent = pFlat.toFixed(1) + '%';
                }

                // Update Market Stats
                const dateEl = document.querySelector('#market-date');
                const volEl = document.querySelector('#market-volume');
                const chgEl = document.querySelector('#market-change');

                if (dateEl && latestDate) dateEl.textContent = latestDate;
                if (volEl) volEl.textContent = fmtVolClient(totalVol);
                if (chgEl) {
                    const avg = count > 0 ? totalPct / count : 0;
                    chgEl.textContent = (avg >= 0 ? '+' : '') + avg.toFixed(2) + '%';
                    chgEl.className = `text-lg font-mono font-bold ${avg >= 0 ? 'text-bullish' : 'text-bearish'}`;
                }
            } catch (err) {
                console.error('[SSE Client Error]', err);
            }
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEMPORAL REGISTRY: Date Picker â†’ Full Data Sync
    // Atomic Design: This orchestrates ALL organism/molecule updates
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const datePicker = document.getElementById('market-date-picker') as HTMLInputElement;
    const datePickerLabel = document.getElementById('market-date-picker-label');

    // Render a single stock row for MoversPanel (dynamically)
    function renderStockRow(s: any, index: number, variant: 'bullish' | 'bearish'): string {
        const color = variant === 'bullish' ? 'text-bullish' : 'text-bearish';
        return `
            <a href="/stocks/${s.symbol}" 
               class="flex items-center justify-between px-4 py-1.5 hover:bg-glass-hover transition-colors group no-underline"
               data-astro-prefetch>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-mono text-text-muted w-4 text-left">${index + 1}</span>
                    <div>
                        <div class="flex items-center gap-1.5">
                            <span class="text-sm font-semibold text-stock-name">${s.name}</span>
                            <span class="text-[11px] font-mono text-stock-symbol">${s.symbol}</span>
                        </div>
                        <span class="text-[10px] font-mono text-stock-volume">é‡ ${fmtVolClient(s.volume)}</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="data-value text-sm text-stock-price">${fmtPriceClient(s.price)}</div>
                    <span class="text-xs font-mono font-bold ${color}">${fmtPctClient(s.changePercent)}</span>
                </div>
            </a>`;
    }

    // Render a single StockCard for Volume Leaders (dynamically)
    function renderStockCard(s: any): string {
        const bull = s.changePercent > 0;
        const bear = s.changePercent < 0;
        const badgeColor = bull ? 'bg-bullish/10 text-bullish' : bear ? 'bg-bearish/10 text-bearish' : 'bg-surface text-text-muted';
        const lineColor = bull ? 'via-bullish/50' : bear ? 'via-bearish/50' : 'via-accent/20';
        return `
            <a href="/stocks/${s.symbol}" 
               class="stock-card glass-card glow-interactive block no-underline hover:scale-[1.02] transition-all group relative overflow-hidden p-3"
               data-astro-prefetch>
                <div class="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent ${lineColor} to-transparent"></div>
                <div class="flex items-start justify-between mb-2">
                    <div class="min-w-0">
                        <div class="font-bold text-xs text-stock-name truncate">${s.name}</div>
                        <div class="font-mono text-[10px] text-stock-symbol">${s.symbol}</div>
                    </div>
                    <span class="font-mono font-bold px-1.5 py-0.5 rounded shrink-0 ml-2 text-[9px] ${badgeColor}">${fmtPctClient(s.changePercent)}</span>
                </div>
                <div class="data-value font-bold text-base text-stock-price">${fmtPriceClient(s.price)}</div>
                <div class="flex items-center justify-between text-[11px] font-mono">
                    <span class="text-stock-volume">é‡ ${fmtVolClient(s.volume)}</span>
                </div>
            </a>`;
    }

    if (datePicker) {
        datePicker.addEventListener('change', async (e) => {
            const newDate = (e.target as HTMLInputElement).value;
            if (!newDate) return;
            
            // 1. Visual Feedback: Label pulse
            if (datePickerLabel) {
                datePickerLabel.textContent = newDate;
                datePickerLabel.classList.add('text-accent', 'animate-pulse');
                setTimeout(() => datePickerLabel.classList.remove('text-accent', 'animate-pulse'), 1500);
            }

            console.log('[Temporal Shift] Fetching market data for:', newDate);

            try {
                // 2. Fetch historical data from API
                const res = await fetch(`/api/market/history?date=${newDate}`);
                const data = await res.json();
                
                if (!res.ok || data.error) {
                    console.warn('[Temporal Shift] No data:', data.error);
                    // â•â•â• Reset ALL widgets to "No Data" state â•â•â•
                    const volEl = document.getElementById('market-volume');
                    const chgEl = document.getElementById('market-change');
                    if (volEl) volEl.textContent = 'â€”';
                    if (chgEl) { chgEl.textContent = 'ä¼‘å¸‚'; chgEl.className = 'text-lg font-mono font-bold text-text-muted leading-none tracking-tighter'; }

                    // Reset breadth
                    ['breadth-up', 'breadth-down', 'breadth-flat', 'breadth-range-up', 'breadth-range-down'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '0';
                    });
                    ['breadth-bar-up', 'breadth-bar-down', 'breadth-bar-flat'].forEach(id => {
                        const el = document.getElementById(id) as HTMLElement;
                        if (el) el.style.width = '0%';
                    });
                    const ratioEl = document.getElementById('breadth-ratio');
                    const ratioContainer = document.getElementById('breadth-ratio-container');
                    if (ratioEl) ratioEl.textContent = 'N/A';
                    if (ratioContainer) ratioContainer.className = 'text-[10px] font-mono px-2 py-0.5 rounded border-2 font-black bg-slate-700/30 text-slate-400 border-slate-600/20';

                    // Clear stock panels
                    const losersC = document.querySelector('[data-panel="losers"] .divide-y');
                    const gainersC = document.querySelector('[data-panel="gainers"] .divide-y');
                    const volumeG = document.querySelector('[data-panel="volume-leaders"]');
                    const noDataHtml = '<div class="px-5 py-8 text-center text-sm text-text-muted">æš«ç„¡è³‡æ–™</div>';
                    if (losersC) losersC.innerHTML = noDataHtml;
                    if (gainersC) gainersC.innerHTML = noDataHtml;
                    if (volumeG) volumeG.innerHTML = '<div class="col-span-2 px-5 py-8 text-center text-sm text-text-muted">æš«ç„¡è³‡æ–™</div>';
                    return;
                }

                const { summary, gainers, losers, volumeLeaders } = data;

                // â•â• 3. UPDATE ALL ORGANISMS & MOLECULES â•â•

                // 3a. Volume
                const volEl = document.getElementById('market-volume');
                if (volEl) volEl.textContent = fmtVolClient(summary.totalVolume);

                // 3b. Average Change
                const chgEl = document.getElementById('market-change');
                if (chgEl) {
                    const avg = summary.avgChange;
                    chgEl.textContent = fmtPctClient(avg);
                    chgEl.className = `text-lg font-mono font-bold leading-none tracking-tighter ${avg >= 0 ? 'text-bullish' : 'text-bearish'}`;
                }

                // 3c. Breadth Counts (Organism Detail Widgets)
                const upEl = document.getElementById('breadth-up');
                const downEl = document.getElementById('breadth-down');
                const flatEl = document.getElementById('breadth-flat');
                if (upEl) upEl.textContent = String(summary.up);
                if (downEl) downEl.textContent = String(summary.down);
                if (flatEl) flatEl.textContent = String(summary.flat);

                // 3d. Breadth Range Anchors (Molecule)
                const rangeUpEl = document.getElementById('breadth-range-up');
                const rangeDownEl = document.getElementById('breadth-range-down');
                if (rangeUpEl) rangeUpEl.textContent = String(summary.up);
                if (rangeDownEl) rangeDownEl.textContent = String(summary.down);

                // 3e. Breadth Bars
                const total = summary.up + summary.down + summary.flat;
                if (total > 0) {
                    const pUp = (summary.up / total) * 100;
                    const pDown = (summary.down / total) * 100;
                    const pFlat = (summary.flat / total) * 100;
                    const barUp = document.getElementById('breadth-bar-up');
                    const barDown = document.getElementById('breadth-bar-down');
                    const barFlat = document.getElementById('breadth-bar-flat');
                    if (barUp) barUp.style.width = pUp + '%';
                    if (barDown) barDown.style.width = pDown + '%';
                    if (barFlat) barFlat.style.width = pFlat + '%';
                }

                // 3f. Ratio with Color Coding
                const ratioEl = document.getElementById('breadth-ratio');
                const ratioContainer = document.getElementById('breadth-ratio-container');
                if (ratioEl) {
                    ratioEl.textContent = summary.ratio >= 999 ? 'MAX' : summary.ratio.toFixed(2);
                }
                if (ratioContainer) {
                    const baseClasses = "text-[10px] font-mono px-2 py-0.5 rounded border-2 transition-all duration-500 font-black";
                    if (summary.ratio >= 1) {
                        ratioContainer.className = `${baseClasses} bg-bullish/20 text-[#ff4d4d] border-bullish/40 shadow-[0_0_10px_rgba(239,68,68,0.2)]`;
                    } else {
                        ratioContainer.className = `${baseClasses} bg-bearish/20 text-[#00ff88] border-bearish/40 shadow-[0_0_10px_rgba(34,197,94,0.2)]`;
                    }
                }

                // â•â• 4. REBUILD STOCK LISTS (Gainers & Losers) â•â•
                
                // 4a. Losers Panel
                const losersContainer = document.querySelector('[data-panel="losers"] .divide-y');
                if (losersContainer && losers) {
                    losersContainer.innerHTML = losers.map((s: any, i: number) => renderStockRow(s, i, 'bearish')).join('');
                    // Update count badge
                    const losersBadge = document.querySelector('[data-panel="losers"] .font-mono.text-text-muted');
                    if (losersBadge) losersBadge.textContent = `${losers.length} æª”`;
                }

                // 4b. Gainers Panel
                const gainersContainer = document.querySelector('[data-panel="gainers"] .divide-y');
                if (gainersContainer && gainers) {
                    gainersContainer.innerHTML = gainers.map((s: any, i: number) => renderStockRow(s, i, 'bullish')).join('');
                    const gainersBadge = document.querySelector('[data-panel="gainers"] .font-mono.text-text-muted');
                    if (gainersBadge) gainersBadge.textContent = `${gainers.length} æª”`;
                }

                // 4c. Volume Leaders Grid
                const volumeGrid = document.querySelector('[data-panel="volume-leaders"]');
                if (volumeGrid && volumeLeaders) {
                    volumeGrid.innerHTML = volumeLeaders.map((s: any) => renderStockCard(s)).join('');
                }

                console.log('[Temporal Shift] ALL widgets synchronized for:', newDate);

            } catch (err) {
                console.error('[Temporal Shift] Fetch error:', err);
            }
        });
    }
</script>

