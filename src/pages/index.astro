---
/**
 * Premium Dashboard Index Page
 *
 * Clean-Slate Refactor using Spec 002 Architecture.
 */
import Layout from '../layouts/Layout.astro';
import PageHero from '../components/molecules/PageHero.astro';
import MarketBreadth from '../components/organisms/MarketBreadth.astro';
import MoversPanel from '../components/organisms/MoversPanel.astro';
import SectorMomentum from '../components/organisms/SectorMomentum.astro';
import StockCard from '../components/organisms/StockCard.astro';
import {
    getMarketBreadth,
    getTopGainers,
    getTopLosers,
    getTopVolume,
    getTopChips,
    getGrowthStars,
    getSectorPerformance,
} from '../utils/marketService';

const breadth = getMarketBreadth();
const topGainers = getTopGainers(5);
const topLosers = getTopLosers(5);
const growthStars = getGrowthStars(5);
const topChips = getTopChips(5);
const rawSectorPerf = getSectorPerformance();

// Mapping for growth/chips cards
const mapGrowthToStock = (s: any) => ({
    symbol: s.symbol,
    name: s.name,
    price: s.price || 0,
    change: 0,
    changePercent: s.change_pct || 0,
    volume: 0,
    pe: 0,
    pb: 0,
    yield: 0,
    roe: 0,
    eps: 0,
    revenueYoY: s.revenue_yoy,
});

const mapChipsToStock = (s: any) => ({
    symbol: s.symbol,
    name: s.name,
    price: 0,
    change: 0,
    changePercent: s.change_pct || 0,
    volume: 0,
    pe: 0,
    pb: 0,
    yield: 0,
    roe: 0,
    eps: 0,
    foreignInv: s.foreign_inv,
});
---

<Layout title="Premium Market Dashboard">
    <div class="dashboard-wrapper">
        <!-- Dashboard Header -->
        <PageHero
            icon="üìä"
            title="MARKET_INTELLIGENCE"
            subtitle="Premium Real-time Financial Terminal"
            glowClass="neutral-glow"
        >
            <div class="sys-status" slot="action">
                <span class="pulse-dot text-success"></span>
                <span class="mono text-success">TERMINAL ONLINE</span>
            </div>
        </PageHero>

        <!-- Market Breadth Overview (Organism) -->
        <MarketBreadth breadth={breadth} />

        <!-- Main Workspace Grid -->
        <div class="dashboard-grid cyber-reveal">
            <!-- Column 1: Price Action -->
            <div class="grid-col">
                <MoversPanel title="Price Gainers" stocks={topGainers} variant="pos" icon="üî•" />

                <MoversPanel title="Price Losers" stocks={topLosers} variant="neg" icon="üìâ" />
            </div>

            <!-- Column 2: Fundamentals & Capital -->
            <div class="grid-col">
                <!-- Sector Momentum (Organism) -->
                <SectorMomentum rawSectorPerf={rawSectorPerf} />

                <!-- Growth Stars -->
                <div class="glass-card panel glow-wrapper">
                    <div class="glow-bg accent-glow"></div>
                    <div class="panel-header">
                        <div class="panel-title-group">
                            <span class="panel-icon text-accent">üöÄ</span>
                            <h2 class="panel-title text-accent">Growth Stars</h2>
                        </div>
                    </div>
                    <div class="panel-content">
                        {
                            growthStars.map((s: any) => (
                                <div class="insight-row">
                                    <StockCard
                                        stock={mapGrowthToStock(s)}
                                        showWatchlistBtn={false}
                                    />
                                    <div class="insight-badge text-success">
                                        +{s.revenue_yoy.toFixed(1)}% Rev
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>

                <!-- Capital Flow -->
                <div class="glass-card panel glow-wrapper">
                    <div class="glow-bg accent-glow"></div>
                    <div class="panel-header">
                        <div class="panel-title-group">
                            <span class="panel-icon text-accent">üèõÔ∏è</span>
                            <h2 class="panel-title text-accent">Capital Inflow (Foreign)</h2>
                        </div>
                    </div>
                    <div class="panel-content">
                        {
                            topChips.map((s: any) => (
                                <div class="insight-row">
                                    <StockCard
                                        stock={mapChipsToStock(s)}
                                        showWatchlistBtn={false}
                                    />
                                    <div class="insight-badge text-accent">
                                        {(s.foreign_inv / 1000).toFixed(0)}k Shrs
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    .dashboard-wrapper {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding-bottom: 40px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .grid-col {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .panel {
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--c-border);
    }

    .panel-title {
        font-size: 15px;
        font-weight: 700;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .insight-row {
        position: relative;
    }

    .insight-badge {
        position: absolute;
        right: 12px;
        top: 14px;
        font-size: 10px;
        font-weight: 800;
        background: rgba(0, 0, 0, 0.4);
        padding: 2px 8px;
        border-radius: 10px;
        border: 1px solid currentColor;
        pointer-events: none;
        font-family: 'JetBrains Mono', monospace;
    }

    .text-success {
        color: var(--c-success);
    }
    .text-accent {
        color: var(--c-accent);
    }

    @media (max-width: 1024px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
