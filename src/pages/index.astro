---
/**
 * index.astro — Dashboard / 總覽 (Atomic Design Edition)
 * Professional market data dashboard with Strategic HUD, Liquidity Sidebar,
 * and Movers Matrix.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import StrategicHUD from '../components/organisms/StrategicHUD.astro';
import LiquidityLeaders from '../components/molecules/LiquidityLeaders.astro';
import MoversMatrix from '../components/organisms/MoversMatrix.astro';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';
import SentimentTrendModal from '../components/organisms/SentimentTrendModal.astro';
import { fmtVol, fmtPrice } from '../utils/format';
import type { StockFullData } from '../utils/stockDataService';

let gainers: StockFullData[] = [];
let losers: StockFullData[] = [];
let topVolume: StockFullData[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    totalStocks = all.length;
    dataDate = all.find(s => s.date)?.date || '';

    const withPrice = all.filter(s => s.price > 0);
    upCount = withPrice.filter(s => s.changePercent > 0).length;
    downCount = withPrice.filter(s => s.changePercent < 0).length;
    flatCount = withPrice.filter(s => s.changePercent === 0).length;
    totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
    avgChange =
        withPrice.length > 0
            ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
            : 0;

    gainers = withPrice
        .filter(s => s.changePercent > 0)
        .sort((a, b) => b.changePercent - a.changePercent)
        .slice(0, 10);
    losers = withPrice
        .filter(s => s.changePercent < 0)
        .sort((a, b) => a.changePercent - b.changePercent)
        .slice(0, 10);
    topVolume = withPrice.sort((a, b) => b.volume - a.volume).slice(0, 10);
} catch (e) {
    console.error('Dashboard data load error:', e);
}
---

<MainTerminal title="市場漲幅">
    <div class="space-y-6 relative pb-20">
        <!-- Strategic Intelligence HUD (Organism) -->
        <StrategicHUD
            upCount={upCount}
            downCount={downCount}
            flatCount={flatCount}
            totalStocks={totalStocks}
            totalVolume={totalVolume}
            avgChange={avgChange}
            dataDate={dataDate}
        />

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <!-- Sidebar: Liquidity Intelligence (Molecule) -->
            <aside class="lg:col-span-3 space-y-4">
                <LiquidityLeaders topVolume={topVolume} />
            </aside>

            <!-- Main Panel: Movers Grid (Organism) -->
            <div class="lg:col-span-9 space-y-6">
                <MoversMatrix gainers={gainers} losers={losers} />

                <!-- Signal Stream & Trend Actions -->
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 pt-4">
                    <ForensicTicker />
                    <button
                        id="open-breadth-chart"
                        class="px-8 py-3 rounded-xl bg-white/5 border border-white/10 text-[10px] font-bold text-white/40 hover:text-white hover:border-white/20 transition-all uppercase tracking-widest active:scale-95 flex items-center gap-3"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-accent/40"
                            ><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path
                                d="M22 12A10 10 0 0 0 12 2v10z"></path></svg
                        >
                        Analyse Sentiment Trends
                    </button>
                </div>

                <!-- Analysis Modal (Organism) -->
                <SentimentTrendModal />
            </div>
        </div>
    </div>
</MainTerminal>

<script>
    // ═══ Client-Side Data Format Helpers ═══
    function fmtVolClient(v: number): string {
        const cv = Math.ceil(v);
        if (cv >= 100000000) return (cv / 100000000).toFixed(1) + '億';
        if (cv >= 10000) return (cv / 10000).toFixed(1) + '萬';
        return cv > 0 ? cv.toLocaleString('zh-TW') : '—';
    }
    function fmtPriceClient(v: number): string {
        return v > 0 ? v.toFixed(2) : '—';
    }

    // ═══ Dashboard Synchronizer Engine ═══
    function setupDashboardSync() {
        if (typeof EventSource !== 'undefined') {
            const es = new EventSource('/api/sse/stream');
            es.addEventListener('tick', e => {
                try {
                    const ticks = JSON.parse(e.data);
                    if (!ticks || !Array.isArray(ticks)) return;

                    let up = 0,
                        down = 0,
                        flat = 0,
                        totalVol = 0,
                        totalPct = 0,
                        count = 0;
                    let latestDate = '';

                    ticks.forEach(t => {
                        const price = parseFloat(t.Close || t.price || 0);
                        const chgPct = parseFloat(t.ChangePct || t.changePercent || 0);
                        const vol = parseFloat(t.Volume || t.volume || 0);
                        if (price > 0) {
                            if (chgPct > 0) up++;
                            else if (chgPct < 0) down++;
                            else flat++;
                            totalVol += vol;
                            totalPct += chgPct;
                            count++;
                            if (t.Date) latestDate = t.Date;
                        }
                    });

                    updateHUD(
                        up,
                        down,
                        flat,
                        totalVol,
                        count > 0 ? totalPct / count : 0,
                        latestDate
                    );
                } catch (err) {
                    console.error('[SSE Error]', err);
                }
            });
        }

        const datePicker = document.getElementById('market-date-picker-hud') as HTMLInputElement;
        datePicker?.addEventListener('change', async e => {
            const newDate = (e.target as HTMLInputElement).value;
            if (!newDate) return;
            try {
                const res = await fetch(`/api/market/history?date=${newDate}`);
                const data = await res.json();
                if (res.ok && !data.error) syncDashboardData(data, newDate);
            } catch (err) {
                console.error('[Sync Error]', err);
            }
        });
    }

    function updateHUD(
        up: number,
        down: number,
        flat: number,
        vol: number,
        chg: number,
        date: string
    ) {
        const total = up + down + flat;
        const ratioEl = document.getElementById('breadth-ratio-hud');
        const upEl = document.getElementById('hud-up');
        const downEl = document.getElementById('hud-down');
        const volEl = document.getElementById('hud-volume');
        const chgEl = document.getElementById('hud-avg-change');
        const dateEl = document.getElementById('hud-date');

        if (ratioEl) ratioEl.textContent = down > 0 ? (up / down).toFixed(2) : 'MAX';
        if (upEl) upEl.textContent = String(up);
        if (downEl) downEl.textContent = String(down);
        if (volEl) volEl.textContent = fmtVolClient(vol);
        if (chgEl) {
            chgEl.textContent = (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
            chgEl.className = `text-xl font-mono font-bold ${chg >= 0 ? 'text-bullish' : 'text-bearish'}`;
        }
        if (dateEl && date) dateEl.textContent = date;

        const barUp = document.getElementById('hud-bar-up');
        const barDown = document.getElementById('hud-bar-down');
        const barFlat = document.getElementById('hud-bar-flat');
        if (barUp) barUp.style.width = (total > 0 ? (up / total) * 100 : 0) + '%';
        if (barDown) barDown.style.width = (total > 0 ? (down / total) * 100 : 0) + '%';
        if (barFlat) barFlat.style.width = (total > 0 ? (flat / total) * 100 : 0) + '%';
    }

    function syncDashboardData(data: any, date: string) {
        const { summary, gainers, losers, volumeLeaders } = data;
        updateHUD(
            summary.up,
            summary.down,
            summary.flat,
            summary.totalVolume,
            summary.avgChange,
            date
        );

        const gainersGrid = document.getElementById('hud-gainers-grid');
        const losersGrid = document.getElementById('hud-losers-grid');
        const volGrid = document.getElementById('hud-volume-grid');

        if (gainersGrid)
            gainersGrid.innerHTML = gainers
                .map((s: any, i: number) => renderRow(s, i, 'bullish'))
                .join('');
        if (losersGrid)
            losersGrid.innerHTML = losers
                .map((s: any, i: number) => renderRow(s, i, 'bearish'))
                .join('');
        if (volGrid)
            volGrid.innerHTML = volumeLeaders
                .map((s: any, i: number) => renderRow(s, i, 'accent'))
                .join('');
    }

    function renderRow(s: any, i: number, variant: string): string {
        const isBull = variant === 'bullish';
        const color = isBull
            ? 'text-bullish'
            : variant === 'bearish'
              ? 'text-bearish'
              : 'text-accent';
        const hColor = isBull
            ? 'hover:border-bullish'
            : variant === 'bearish'
              ? 'hover:border-bearish'
              : 'hover:border-accent';
        const gColor = isBull
            ? 'group-hover:text-bullish'
            : variant === 'bearish'
              ? 'group-hover:text-bearish'
              : 'group-hover:text-accent';
        return `
            <a href="/stocks/${s.symbol}" class="flex items-center gap-4 px-6 py-4 hover:bg-accent/[0.04] transition-all group no-underline border-l-2 border-transparent ${hColor}">
                <span class="text-[8px] font-mono text-white/20 w-3">${i + 1}</span>
                <div class="min-w-0 flex-1">
                    <div class="text-[11px] font-bold text-white/90 ${gColor} transition-colors truncate">${s.name}</div>
                    <div class="text-[8px] font-mono text-white/30 uppercase mt-0.5">${variant === 'accent' ? s.symbol : 'ENTITY:' + s.symbol}</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-mono font-bold text-white/70">${fmtPriceClient(s.price)}</div>
                    <div class="text-[10px] font-mono font-bold ${color}">${isBull ? '+' : ''}${s.changePercent.toFixed(2)}%</div>
                </div>
            </a>`;
    }

    document.addEventListener('astro:page-load', setupDashboardSync);
    setupDashboardSync();
</script>
