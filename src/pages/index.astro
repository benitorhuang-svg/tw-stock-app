---
import MainTerminal from '../layouts/MainTerminal.astro';
import StrategicHUD from '../components/organisms/StrategicHUD.astro';
import LiquidityLeaders from '../components/molecules/LiquidityLeaders.astro';
import MoversMatrix from '../components/organisms/MoversMatrix.astro';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';
import SentimentTrendModal from '../components/organisms/SentimentTrendModal.astro';

interface DashboardStock {
    symbol: string;
    name: string;
    market: string;
    price: number;
    change: number;
    changePercent: number;
    volume: number;
    high: number;
    low: number;
    open: number;
    close: number;
    date?: string;
    pe: number;
    pb: number;
    yield: number;
    roe: number;
    eps: number;
    revenueYoY: number;
    grossMargin: number;
    operatingMargin: number;
    netMargin: number;
    foreignStreak: number;
    trustStreak: number;
    dealerStreak: number;
    sector: string;
}

let gainers: DashboardStock[] = [];
let losers: DashboardStock[] = [];
let topVolume: DashboardStock[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    // Fast path: direct SQL aggregation (SSR mode with DB available)
    const { dbService } = await import('../lib/db/sqlite-service');

    const summary = dbService.queryOne<{
        total: number;
        up: number;
        down: number;
        flat: number;
        total_vol: number;
        avg_chg: number;
        latest_date: string;
    }>(`
        SELECT
            COUNT(*) as total,
            SUM(CASE WHEN change_pct > 0 THEN 1 ELSE 0 END) as up,
            SUM(CASE WHEN change_pct < 0 THEN 1 ELSE 0 END) as down,
            SUM(CASE WHEN change_pct = 0 AND close > 0 THEN 1 ELSE 0 END) as flat,
            SUM(volume) as total_vol,
            AVG(change_pct) as avg_chg,
            MAX(date) as latest_date
        FROM latest_prices WHERE close > 0
    `);

    if (summary) {
        totalStocks = summary.total;
        upCount = summary.up;
        downCount = summary.down;
        flatCount = summary.flat;
        totalVolume = summary.total_vol;
        avgChange = summary.avg_chg;
        dataDate = summary.latest_date || '';
    }

    const mapRow = (r: any): DashboardStock => ({
        symbol: r.symbol,
        name: r.name || r.symbol,
        market: r.market || 'TWSE',
        price: r.close,
        change: r.change || 0,
        changePercent: r.change_pct,
        volume: r.volume,
        high: r.high || 0,
        low: r.low || 0,
        open: r.open || 0,
        close: r.close,
        date: r.date,
        pe: r.pe || 0,
        pb: r.pb || 0,
        yield: r.yield || 0,
        roe: 0,
        eps: r.eps || 0,
        revenueYoY: r.revenue_yoy || 0,
        grossMargin: r.gross_margin || 0,
        operatingMargin: r.operating_margin || 0,
        netMargin: r.net_margin || 0,
        foreignStreak: 0,
        trustStreak: 0,
        dealerStreak: 0,
        sector: r.sector || 'other',
    });

    const selectCols = `s.symbol, s.name, s.market, s.sector, lp.close, lp.change, lp.change_pct, lp.volume, lp.high, lp.low, lp.open, lp.date, lp.pe, lp.pb, lp.yield, lp.eps, lp.revenue_yoy, lp.gross_margin, lp.operating_margin, lp.net_margin`;

    gainers = dbService
        .queryAll<any>(
            `SELECT ${selectCols} FROM latest_prices lp JOIN stocks s ON s.symbol = lp.symbol WHERE lp.change_pct > 0 ORDER BY lp.change_pct DESC LIMIT 10`
        )
        .map(mapRow);

    losers = dbService
        .queryAll<any>(
            `SELECT ${selectCols} FROM latest_prices lp JOIN stocks s ON s.symbol = lp.symbol WHERE lp.change_pct < 0 ORDER BY lp.change_pct ASC LIMIT 10`
        )
        .map(mapRow);

    topVolume = dbService
        .queryAll<any>(
            `SELECT ${selectCols} FROM latest_prices lp JOIN stocks s ON s.symbol = lp.symbol WHERE lp.volume > 0 ORDER BY lp.volume DESC LIMIT 10`
        )
        .map(mapRow);
} catch {
    // Fallback: JSON-based data loading (static build / no DB)
    try {
        const svc = await import('../utils/stockDataService');
        const all = await svc.getStocksWithPrices();
        totalStocks = all.length;
        dataDate = all.find(s => s.date)?.date || '';
        const withPrice = all.filter(s => s.price > 0);
        upCount = withPrice.filter(s => s.changePercent > 0).length;
        downCount = withPrice.filter(s => s.changePercent < 0).length;
        flatCount = withPrice.filter(s => s.changePercent === 0).length;
        totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
        avgChange =
            withPrice.length > 0
                ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
                : 0;
        gainers = withPrice
            .filter(s => s.changePercent > 0)
            .sort((a, b) => b.changePercent - a.changePercent)
            .slice(0, 10) as DashboardStock[];
        losers = withPrice
            .filter(s => s.changePercent < 0)
            .sort((a, b) => a.changePercent - b.changePercent)
            .slice(0, 10) as DashboardStock[];
        topVolume = [...withPrice]
            .sort((a, b) => b.volume - a.volume)
            .slice(0, 10) as DashboardStock[];
    } catch (e2) {
        console.error('Dashboard data load error:', e2);
    }
}
---

<MainTerminal title="市場漲幅">
    <div class="space-y-6 relative pb-20">
        <!-- Strategic Intelligence HUD (Organism) -->
        <StrategicHUD
            upCount={upCount}
            downCount={downCount}
            flatCount={flatCount}
            totalStocks={totalStocks}
            totalVolume={totalVolume}
            avgChange={avgChange}
            dataDate={dataDate}
        />

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <!-- Sidebar: Liquidity Intelligence (Molecule) -->
            <aside class="lg:col-span-3 space-y-4">
                <LiquidityLeaders topVolume={topVolume} />
            </aside>

            <!-- Main Panel: Movers Grid (Organism) -->
            <div class="lg:col-span-9 space-y-6">
                <MoversMatrix gainers={gainers} losers={losers} />

                <!-- Signal Stream & Trend Actions -->
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 pt-4">
                    <ForensicTicker />
                    <button
                        id="open-breadth-chart"
                        class="px-8 py-3 rounded-xl bg-white/5 border border-white/10 text-[10px] font-bold text-white/40 hover:text-white hover:border-white/20 transition-all uppercase tracking-widest active:scale-95 flex items-center gap-3"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-accent/40"
                            ><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path
                                d="M22 12A10 10 0 0 0 12 2v10z"></path></svg
                        >
                        Analyse Sentiment Trends
                    </button>
                </div>

                <!-- Analysis Modal (Organism) -->
                <SentimentTrendModal />
            </div>
        </div>
    </div>
</MainTerminal>

<script src="../scripts/dashboard-engine.ts"></script>
