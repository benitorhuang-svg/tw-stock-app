---
/**
 * index.astro â€” Dashboard / ç¸½è¦½
 * Professional market data dashboard with market breadth, top movers,
 * volume leaders, and high yield stocks.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import MarketBreadth from '../components/organisms/MarketBreadth.astro';
import MoversPanel from '../components/organisms/MoversPanel.astro';
import StockCard from '../components/organisms/StockCard.astro';
import StatCard from '../components/molecules/StatCard.astro';
import type { StockFullData } from '../utils/stockDataService';

const fmtVol = (v: number) => {
    if (v >= 1_0000_0000) return `${(v / 1_0000_0000).toFixed(1)}å„„`;
    if (v >= 10000) return `${(v / 10000).toFixed(1)}è¬`;
    if (v > 0) return v.toLocaleString('zh-TW');
    return 'â€”';
};

let gainers: StockFullData[] = [];
let losers: StockFullData[] = [];
let topVolume: StockFullData[] = [];
let highYield: StockFullData[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    totalStocks = all.length;
    dataDate = all.find(s => s.date)?.date || '';

    const withPrice = all.filter(s => s.price > 0);
    upCount = withPrice.filter(s => s.changePercent > 0).length;
    downCount = withPrice.filter(s => s.changePercent < 0).length;
    flatCount = withPrice.filter(s => s.changePercent === 0).length;
    totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
    avgChange = withPrice.length > 0
        ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
        : 0;

    gainers = withPrice
        .filter(s => s.changePercent > 0)
        .sort((a, b) => b.changePercent - a.changePercent)
        .slice(0, 10);
    losers = withPrice
        .filter(s => s.changePercent < 0)
        .sort((a, b) => a.changePercent - b.changePercent)
        .slice(0, 10);
    topVolume = withPrice
        .sort((a, b) => b.volume - a.volume)
        .slice(0, 10);
    highYield = withPrice
        .filter(s => s.yield > 0 && s.pe > 0)
        .sort((a, b) => b.yield - a.yield)
        .slice(0, 8);
} catch (e) {
    console.error('Dashboard data load error:', e);
}
---

<MainTerminal title="Dashboard">
    {totalStocks === 0 ? (
        <div class="empty-state py-20 animate-fade-up">
            <div class="empty-state-icon animate-glow-pulse">ğŸ“¡</div>
            <h2 class="text-xl font-bold text-text-primary mb-2">æš«ç„¡å¸‚å ´è³‡æ–™</h2>
            <p class="text-sm text-text-muted max-w-sm mb-6">
                å°šæœªè¼‰å…¥è‚¡ç¥¨è³‡æ–™ï¼Œè«‹ç¢ºèª <code class="font-mono text-accent">public/data/</code> ç›®éŒ„ä¸‹çš„ JSON è³‡æ–™å·²å»ºæ§‹å®Œæˆã€‚
            </p>
            <button onclick="location.reload()" class="btn-cyber text-xs">é‡æ–°è¼‰å…¥</button>
        </div>
    ) : (
    <Fragment>

    <!-- â•â•â• Dashboard Header â•â•â• -->
    <div class="flex items-end justify-between mb-6 animate-fade-up">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold tracking-tight text-text-primary">å¸‚å ´ç¸½è¦½</h1>
            <p class="text-sm text-text-muted mt-1 font-mono">
                {dataDate || 'â€”'} Â· {totalStocks.toLocaleString()} æª”è‚¡ç¥¨
            </p>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden sm:flex items-center gap-2 stat-pill">
                <span class="stat-label">Total Vol</span>
                <span class="stat-value text-accent">{fmtVol(totalVolume)}</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-bullish ring-pulse"></span>
                <span class="text-[10px] font-mono text-text-muted tracking-widest uppercase">
                    data ready
                </span>
            </div>
        </div>
    </div>

    <!-- â•â•â• Market Stats Row â•â•â• -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 stagger-children">
        <StatCard
            id="stat-up"
            label="ä¸Šæ¼²"
            value={upCount}
            change={totalStocks > 0 ? (upCount / totalStocks) * 100 : 0}
            class="border-l-2 border-l-bullish/60"
        />
        <StatCard
            id="stat-down"
            label="ä¸‹è·Œ"
            value={downCount}
            change={totalStocks > 0 ? -(downCount / totalStocks) * 100 : 0}
            class="border-l-2 border-l-bearish/60"
        />
        <StatCard
            id="stat-flat"
            label="å¹³ç›¤"
            value={flatCount}
            class="border-l-2 border-l-text-muted/30"
        />
        <div class="glass-card glow-interactive p-4">
            <span class="terminal-label">å¸‚å ´å»£åº¦</span>
            <MarketBreadth
                up={upCount}
                down={downCount}
                flat={flatCount}
                total={totalStocks}
                class="mt-3"
            />
        </div>
    </div>

    <!-- â•â•â• Top Gainers / Losers â•â•â• -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <MoversPanel
            title="æ¼²å¹…æ’è¡Œ"
            stocks={gainers}
            variant="bullish"
            class="animate-fade-up"
        />
        <MoversPanel
            title="è·Œå¹…æ’è¡Œ"
            stocks={losers}
            variant="bearish"
            class="animate-fade-up"
        />
    </div>

    <!-- â•â•â• Volume Leaders â•â•â• -->
    <section class="mb-6 animate-fade-up">
        <div class="section-divider">
            <span class="divider-label">æˆäº¤é‡æ’è¡Œ</span>
        </div>
        <div class="flex items-center justify-between mb-4">
            <p class="text-xs text-text-muted">ä¾ç•¶æ—¥æˆäº¤é‡ç”±é«˜è‡³ä½æ’åº</p>
            <a href="/stocks" class="btn-ghost text-xs" data-astro-prefetch>æŸ¥çœ‹å…¨éƒ¨ â†’</a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 stagger-children">
            {topVolume.map((s) => (
                <StockCard
                    symbol={s.symbol}
                    name={s.name}
                    price={s.price}
                    changePercent={s.changePercent}
                    volume={s.volume}
                    pe={s.pe}
                />
            ))}
        </div>
    </section>

    <!-- â•â•â• High Yield Table â•â•â• -->
    <section class="mb-6 animate-fade-up">
        <div class="section-divider">
            <span class="divider-label">é«˜æ®–åˆ©ç‡ç²¾é¸</span>
        </div>
        <div class="flex items-center justify-between mb-4">
            <p class="text-xs text-text-muted">æ®–åˆ©ç‡ç”±é«˜è‡³ä½ï¼Œæ’é™¤è™§æè‚¡</p>
            <a href="/screener" class="btn-ghost text-xs" data-astro-prefetch>ç¯©é¸æ›´å¤š â†’</a>
        </div>

        <div class="glass-card overflow-hidden">
            <!-- Table Header -->
            <div class="hidden md:grid grid-cols-12 gap-2 px-5 py-2.5 border-b border-border text-[10px] font-bold text-text-muted uppercase tracking-wider bg-surface/20">
                <div class="col-span-3">è‚¡ç¥¨</div>
                <div class="col-span-2 text-right">è‚¡åƒ¹</div>
                <div class="col-span-2 text-right">æ¼²è·Œ%</div>
                <div class="col-span-2 text-right">æ®–åˆ©ç‡</div>
                <div class="col-span-1 text-right">PE</div>
                <div class="col-span-2 text-right">PB</div>
            </div>

            <!-- Table Body -->
            <div class="divide-y divide-border/30">
                {highYield.map((s) => {
                    const bull = s.changePercent > 0;
                    const bear = s.changePercent < 0;
                    return (
                        <a
                            href={`/stocks/${s.symbol}`}
                            class="grid grid-cols-12 gap-2 px-5 py-3 hover:bg-glass-hover transition-colors group no-underline items-center"
                            data-astro-prefetch
                        >
                            <div class="col-span-6 md:col-span-3 flex items-center gap-2 min-w-0">
                                <span class="text-sm font-semibold text-text-primary group-hover:text-accent transition-colors truncate">
                                    {s.name}
                                </span>
                                <span class="text-[11px] text-text-muted font-mono shrink-0">{s.symbol}</span>
                            </div>
                            <div class="col-span-3 md:col-span-2 text-right data-value text-sm">
                                {s.price > 0 ? s.price.toFixed(2) : 'â€”'}
                            </div>
                            <div class:list={[
                                'col-span-3 md:col-span-2 text-right text-xs font-mono font-bold',
                                bull && 'text-bullish',
                                bear && 'text-bearish',
                                !bull && !bear && 'text-text-muted',
                            ]}>
                                {s.changePercent > 0 ? '+' : ''}{s.changePercent.toFixed(2)}%
                            </div>
                            <div class="hidden md:block col-span-2 text-right text-sm font-mono font-bold text-warning">
                                {s.yield.toFixed(2)}%
                            </div>
                            <div class="hidden md:block col-span-1 text-right text-xs font-mono text-text-secondary">
                                {s.pe > 0 ? s.pe.toFixed(1) : 'â€”'}
                            </div>
                            <div class="hidden md:block col-span-2 text-right text-xs font-mono text-text-secondary">
                                {s.pb > 0 ? s.pb.toFixed(2) : 'â€”'}
                            </div>
                        </a>
                    );
                })}
            </div>
        </div>
    </section>

    </Fragment>
    )}
</MainTerminal>

<script>
    // SSE updates for dashboard counts
    if (typeof EventSource !== 'undefined') {
        const es = new EventSource('/api/sse/stream');
        es.addEventListener('tick', e => {
            try {
                const ticks = JSON.parse(e.data);
                let up = 0, down = 0, flat = 0;
                ticks.forEach((t: any) => {
                    if (t.changePercent > 0) up++;
                    else if (t.changePercent < 0) down++;
                    else flat++;
                });
                const upEl = document.querySelector('#stat-up .data-value');
                const downEl = document.querySelector('#stat-down .data-value');
                const flatEl = document.querySelector('#stat-flat .data-value');
                if (upEl) upEl.textContent = String(up);
                if (downEl) downEl.textContent = String(down);
                if (flatEl) flatEl.textContent = String(flat);
            } catch {}
        });
    }
</script>
