---
/**
 * index.astro ‚Äî Dashboard / Á∏ΩË¶Ω
 * Professional market data dashboard with market breadth, top movers,
 * volume leaders, and high yield stocks.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import MarketBreadth from '../components/organisms/MarketBreadth.astro';
import MoversPanel from '../components/organisms/MoversPanel.astro';
import StockCard from '../components/organisms/StockCard.astro';
import StatCard from '../components/molecules/StatCard.astro';
import type { StockFullData } from '../utils/stockDataService';

const fmtVol = (v: number) => {
    if (v >= 1_0000_0000) return `${(v / 1_0000_0000).toFixed(1)}ÂÑÑ`;
    if (v >= 10000) return `${(v / 10000).toFixed(1)}Ëê¨`;
    if (v > 0) return v.toLocaleString('zh-TW');
    return '‚Äî';
};

let gainers: StockFullData[] = [];
let losers: StockFullData[] = [];
let topVolume: StockFullData[] = [];
let highYield: StockFullData[] = [];
let totalStocks = 0;
let upCount = 0;
let downCount = 0;
let flatCount = 0;
let dataDate = '';
let totalVolume = 0;
let avgChange = 0;

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    totalStocks = all.length;
    dataDate = all.find(s => s.date)?.date || '';

    const withPrice = all.filter(s => s.price > 0);
    upCount = withPrice.filter(s => s.changePercent > 0).length;
    downCount = withPrice.filter(s => s.changePercent < 0).length;
    flatCount = withPrice.filter(s => s.changePercent === 0).length;
    totalVolume = withPrice.reduce((sum, s) => sum + s.volume, 0);
    avgChange = withPrice.length > 0
        ? withPrice.reduce((sum, s) => sum + s.changePercent, 0) / withPrice.length
        : 0;

    gainers = withPrice
        .filter(s => s.changePercent > 0)
        .sort((a, b) => b.changePercent - a.changePercent)
        .slice(0, 10);
    losers = withPrice
        .filter(s => s.changePercent < 0)
        .sort((a, b) => a.changePercent - b.changePercent)
        .slice(0, 10);
    topVolume = withPrice
        .sort((a, b) => b.volume - a.volume)
        .slice(0, 10);
    highYield = withPrice
        .filter(s => s.yield > 0 && s.pe > 0)
        .sort((a, b) => b.yield - a.yield)
        .slice(0, 8);
} catch (e) {
    console.error('Dashboard data load error:', e);
}
---

<MainTerminal title="Â∏ÇÂ†¥Á∏ΩË¶Ω">
    {totalStocks === 0 ? (
        <div class="empty-state py-20 animate-fade-up">
            <div class="empty-state-icon animate-glow-pulse">üì°</div>
            <h2 class="text-xl font-bold text-text-primary mb-2">Êö´ÁÑ°Â∏ÇÂ†¥Ë≥áÊñô</h2>
            <p class="text-sm text-text-muted max-w-sm mb-6">
                Â∞öÊú™ËºâÂÖ•ËÇ°Á•®Ë≥áÊñôÔºåË´ãÁ¢∫Ë™ç <code class="font-mono text-accent">public/data/</code> ÁõÆÈåÑ‰∏ãÁöÑ JSON Ë≥áÊñôÂ∑≤Âª∫ÊßãÂÆåÊàê„ÄÇ
            </p>
            <button onclick="location.reload()" class="btn-cyber text-xs">ÈáçÊñ∞ËºâÂÖ•</button>
        </div>
    ) : (
    <Fragment>

    <!-- ‚îÄ‚îÄ 3-Column Dashboard Layout ‚îÄ‚îÄ -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 animate-fade-up py-1">
        
        <!-- ‚ïê‚ïê‚ïê Left Column: Stats & Breadth & Volume (Col Span 4) ‚ïê‚ïê‚ïê -->
        <div class="lg:col-span-4 space-y-4">
            <!-- 1. Market Status Module (Redesigned for Aesthetics) -->
            <div class="glass-card overflow-hidden border-border/40 group relative">
                <!-- Decorative top glow -->
                <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-accent/40 to-transparent"></div>
                
                <div class="px-4 py-3 space-y-3">
                    <!-- Header: Session Information -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-[9px] text-text-muted uppercase font-bold tracking-[0.2em] mb-0.5">Market Session</span>
                            <span class="text-base font-mono font-bold text-text-primary tracking-tighter" id="market-date">{dataDate || '2026-01-23'}</span>
                        </div>
                    </div>

                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-2 gap-2 pt-1">
                        <!-- Volume Block -->
                        <div class="flex flex-col p-2.5 rounded bg-surface border border-border/10 group-hover:border-accent/40 transition-all duration-300">
                            <div class="flex items-center gap-1.5 mb-0.5">
                                <span class="text-[9px] text-text-muted font-bold uppercase">Êàê‰∫§Èáè</span>
                                <span class="text-[10px] text-text-muted/40 font-mono">VOL</span>
                            </div>
                            <span class="text-lg font-mono font-bold text-stock-volume leading-none tracking-tighter" id="market-volume">
                                {fmtVol(totalVolume)}
                            </span>
                        </div>
                        
                        <!-- Change Block -->
                        <div class="flex flex-col p-2.5 rounded bg-surface border border-border/10 group-hover:border-accent/40 transition-all duration-300">
                            <div class="flex items-center gap-1.5 mb-0.5">
                                <span class="text-[9px] text-text-muted font-bold uppercase">Âπ≥ÂùáÊº≤Ë∑å</span>
                                <span class="text-[10px] text-text-muted/40 font-mono">VEL</span>
                            </div>
                            <span class:list={["text-lg font-mono font-bold leading-none tracking-tighter", avgChange >= 0 ? 'text-bullish' : 'text-bearish']} id="market-change">
                                {avgChange >= 0 ? '+' : ''}{avgChange.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Volume Leaders -->
            <section class="glass-card p-0 overflow-hidden border-border/40">
                <div class="terminal-toolbar py-1.5 px-4 h-auto">
                    <span class="terminal-toolbar-title text-[11px]">Êàê‰∫§ÁÜ±ÈñÄÈæçÈ†≠</span>
                </div>
                <div class="p-3">
                    <div class="grid grid-cols-2 gap-3">
                        {topVolume.slice(0, 4).map((s) => (
                            <StockCard
                                symbol={s.symbol}
                                name={s.name}
                                price={s.price}
                                changePercent={s.changePercent}
                                volume={s.volume}
                                pe={s.pe}
                                compact={true}
                            />
                        ))}
                    </div>
                </div>
            </section>
        </div>

        <!-- ‚ïê‚ïê‚ïê Right Side: Breadth & Movers (Col Span 8) ‚ïê‚ïê‚ïê -->
        <div class="lg:col-span-8 space-y-4">
            <!-- 2. Market Breadth Distribution (Reordered layout) -->
            <div class="glass-card p-4 bg-surface/30 border-border/40">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                    <!-- Left: Title + Ratio -->
                    <div class="flex items-center gap-3 shrink-0">
                        <h2 class="text-sm font-bold text-text-primary tracking-tight">Â∏ÇÂ†¥ËÑàÁµ°ÂàÜÂ∏É</h2>
                        <div class="text-[10px] font-mono bg-accent/10 text-accent px-2 py-0.5 rounded border border-accent/20">
                            Êº≤Ë∑åÊØî <span id="breadth-ratio">{downCount > 0 ? (upCount / downCount).toFixed(2) : 'MAX'}</span>
                        </div>
                    </div>
                    
                    <!-- Center: Legend -->
                    <div class="flex items-center justify-center gap-6 lg:gap-10 text-[11px] font-bold flex-1">
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-bullish"></span>
                            <span class="text-bullish" id="breadth-up">{upCount}</span>
                            <span class="text-[9px] text-text-muted font-normal uppercase">‰∏äÊº≤</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-text-muted/40"></span>
                            <span class="text-text-secondary" id="breadth-flat">{flatCount}</span>
                            <span class="text-[9px] text-text-muted font-normal uppercase">Âπ≥Áõ§</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-bearish"></span>
                            <span class="text-bearish" id="breadth-down">{downCount}</span>
                            <span class="text-[9px] text-text-muted font-normal uppercase">‰∏ãË∑å</span>
                        </div>
                    </div>

                    <!-- Right spacer for centering effect on desktop -->
                    <div class="hidden lg:block w-32 shrink-0"></div>
                </div>
                <MarketBreadth 
                    up={upCount}
                    down={downCount}
                    flat={flatCount}
                    total={totalStocks}
                />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Losers -->
                <MoversPanel
                    title="Ë∑åÂπÖÊéíË°å"
                    stocks={losers.slice(0, 6)}
                    variant="bearish"
                    class="border-bearish/10 h-full"
                />
                <!-- Gainers -->
                <MoversPanel
                    title="Êº≤ÂπÖÊéíË°å"
                    stocks={gainers.slice(0, 6)}
                    variant="bullish"
                    class="border-bullish/10 h-full"
                />
            </div>
        </div>
    </div>

    </Fragment>
    )}
</MainTerminal>

<script>
    // SSE updates for dashboard counts
    if (typeof EventSource !== 'undefined') {
        const es = new EventSource('/api/sse/stream');
        const headerLed = document.getElementById('connection-status-led');
        
        function formatVolume(v: number) {
            if (v >= 100000000) return (v / 100000000).toFixed(1) + 'ÂÑÑ';
            if (v >= 10000) return (v / 10000).toFixed(1) + 'Ëê¨';
            return v.toLocaleString('zh-TW');
        }

        // Connection established
        es.onopen = () => {
            if (headerLed) {
                headerLed.className = 'w-1.5 h-1.5 rounded-full bg-bullish animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]';
            }
        };

        // Connection error
        es.onerror = () => {
            if (headerLed) {
                headerLed.className = 'w-1.5 h-1.5 rounded-full bg-bearish animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.4)]';
            }
        };

        es.addEventListener('tick', e => {
            try {
                const ticks = JSON.parse(e.data);
                if (!ticks || !Array.isArray(ticks)) return;

                let up = 0, down = 0, flat = 0, totalVol = 0, totalPct = 0, count = 0;
                let latestDate = '';

                ticks.forEach((t) => {
                    const price = parseFloat(t.Close || t.price || 0);
                    const chgPct = parseFloat(t.ChangePct || t.changePercent || 0);
                    const vol = parseFloat(t.Volume || t.volume || 0);
                    
                    if (price > 0) {
                        if (chgPct > 0) up++;
                        else if (chgPct < 0) down++;
                        else flat++;
                        
                        totalVol += vol;
                        totalPct += chgPct;
                        count++;
                        if (t.Date) latestDate = t.Date;
                    }
                });

                // Update Breadth
                const upEl = document.querySelector('#breadth-up');
                const downEl = document.querySelector('#breadth-down');
                const flatEl = document.querySelector('#breadth-flat');
                const ratioEl = document.querySelector('#breadth-ratio');

                if (upEl) upEl.textContent = String(up);
                if (downEl) downEl.textContent = String(down);
                if (flatEl) flatEl.textContent = String(flat);
                if (ratioEl) ratioEl.textContent = down > 0 ? (up / down).toFixed(2) : 'MAX';

                // Update Bar & Percentages
                const total = up + down + flat;
                if (total > 0) {
                    const pUp = (up / total) * 100;
                    const pDown = (down / total) * 100;
                    const pFlat = (flat / total) * 100;

                    const barUp = document.getElementById('breadth-bar-up');
                    const barDown = document.getElementById('breadth-bar-down');
                    const barFlat = document.getElementById('breadth-bar-flat');
                    const txtUp = document.getElementById('breadth-pct-up');
                    const txtDown = document.getElementById('breadth-pct-down');
                    const txtFlat = document.getElementById('breadth-pct-flat');

                    if (barUp) barUp.style.width = pUp + '%';
                    if (barDown) barDown.style.width = pDown + '%';
                    if (barFlat) barFlat.style.width = pFlat + '%';
                    if (txtUp) txtUp.textContent = pUp.toFixed(1) + '%';
                    if (txtDown) txtDown.textContent = pDown.toFixed(1) + '%';
                    if (txtFlat) txtFlat.textContent = pFlat.toFixed(1) + '%';
                }

                // Update Market Stats
                const dateEl = document.querySelector('#market-date');
                const volEl = document.querySelector('#market-volume');
                const chgEl = document.querySelector('#market-change');

                if (dateEl && latestDate) dateEl.textContent = latestDate;
                if (volEl) volEl.textContent = formatVolume(totalVol);
                if (chgEl) {
                    const avg = count > 0 ? totalPct / count : 0;
                    chgEl.textContent = (avg >= 0 ? '+' : '') + avg.toFixed(2) + '%';
                    chgEl.className = `text-lg font-mono font-bold ${avg >= 0 ? 'text-bullish' : 'text-bearish'}`;
                }
            } catch (err) {
                console.error('[SSE Client Error]', err);
            }
        });
    }
</script>
