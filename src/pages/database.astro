---
/**
 * database.astro — Data Explorer Terminal
 * Quantum-grade SQLite inspection with modular architecture.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import DatabaseSidebar from '../components/organisms/DatabaseSidebar.astro';
import DatabaseExplorer from '../components/organisms/DatabaseExplorer.astro';

// SSR: Load initial table stats
import { dbService } from '../lib/db/sqlite-service';
let tables = dbService.getTables();
// Filter out dividends since it has no data and is confusing
tables = tables.filter(t => t !== 'dividends');

const tableStats = tables.map(t => {
    try {
        const count = dbService.getTableRowCount(t);
        const columns = dbService.getTableColumns(t);
        return { name: t, rows: count, cols: columns.length };
    } catch {
        return { name: t, rows: 0, cols: 0 };
    }
});

const totalRows = tableStats.reduce((s, t) => s + t.rows, 0);
---

<MainTerminal title="數據觀測 (SQLite)" fullWidth>
    <div class="fixed inset-x-0 bottom-0 top-[64px] flex overflow-hidden">
        <!-- Explorer Orchestration -->
        <DatabaseSidebar tables={tables} tableStats={tableStats} totalRows={totalRows} />

        <DatabaseExplorer />

        <!-- Mobile Sidebar UI Actions -->
        <button
            id="sidebar-toggle"
            class="md:hidden fixed top-[72px] left-2 z-30 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs font-mono text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors"
        >
            ☰ 資料表
        </button>
        <div
            id="sidebar-backdrop"
            class="md:hidden fixed inset-0 bg-black/50 z-[19] hidden"
            aria-hidden="true"
        >
        </div>
    </div>
</MainTerminal>

<style is:global>
    #data-table {
        table-layout: auto;
        min-width: 100%;
    }
    .db-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script>
    // ═══ Forensic Data Explorer Engine ═══
    function escapeHtml(str: unknown): string {
        if (str === null || str === undefined) return '';
        const s = String(str);
        // Fast path: avoid expensive replace chains if no special chars present (handles 95%+ of dataset)
        if (!/[&<>"']/.test(s)) return s;
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    let activeTable = '';
    let currentPage = 1;
    let limit = 100;
    let activeController: AbortController | null = null;
    let requestSeq = 0;

    const getEl = (id: string) => document.getElementById(id);
    const tableList = getEl('table-list');
    const welcomeMsg = getEl('welcome-message');
    const dataTable = getEl('data-table');
    const tableHead = getEl('table-head');
    const tableBody = getEl('table-body');
    const tableNameLabel = getEl('current-table-name');
    const rowCountBadge = getEl('row-count-badge');
    const loadingBar = getEl('db-loading-bar');
    const dbError = getEl('db-error');
    const errorMsg = getEl('error-message');
    const queryTimeLabel = getEl('query-time');
    const pageNumLabel = getEl('page-num');
    const tableControls = getEl('table-controls');
    const tableNameContainer = getEl('table-name-container');
    const explorerToolbar = getEl('explorer-toolbar');
    const topScrollbar = getEl('top-scrollbar');
    const topScrollContent = getEl('top-scroll-content');
    const tableScrollContainer = getEl('table-scroll-container');

    function setLoading(isLoading: boolean) {
        if (!loadingBar) return;
        if (isLoading) {
            loadingBar.style.opacity = '1';
            loadingBar.style.width = '30%';
        } else {
            loadingBar.style.width = '100%';
            setTimeout(() => {
                if (loadingBar) {
                    loadingBar.style.opacity = '0';
                    loadingBar.style.width = '0';
                }
            }, 300);
        }
    }

    async function loadTable(name: string, page = 1) {
        if (!name) return;
        const seq = ++requestSeq;
        if (activeController) activeController.abort();
        activeController = new AbortController();

        const startTime = performance.now();
        setLoading(true);
        if (dbError) dbError.classList.add('hidden');
        if (welcomeMsg) welcomeMsg.classList.add('hidden');
        if (tableNameContainer) tableNameContainer.classList.remove('hidden');
        if (explorerToolbar) {
            explorerToolbar.classList.remove('hidden', 'opacity-0');
        }
        if (tableControls) {
            tableControls.classList.remove('hidden', 'opacity-0');
        }
        if (dataTable) dataTable.classList.remove('hidden');
        if (topScrollbar) topScrollbar.classList.remove('hidden');

        try {
            const offset = (page - 1) * limit;
            const searchInput = getEl('global-search') as HTMLInputElement;
            const searchTerm = searchInput?.value || '';
            const res = await fetch(
                `/api/db/${encodeURIComponent(name)}?limit=${limit}&offset=${offset}&search=${encodeURIComponent(searchTerm)}`,
                { signal: activeController.signal }
            );
            if (seq !== requestSeq) return;
            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();

            if (tableNameLabel) tableNameLabel.textContent = name;
            if (rowCountBadge) {
                rowCountBadge.textContent = `${data.total.toLocaleString()} ENTITIES`;
                rowCountBadge.classList.remove('hidden');
            }
            if (pageNumLabel) pageNumLabel.textContent = page.toString();
            currentPage = page;

            // Handle Pagination Buttons
            const prevBtn = getEl('prev-page') as HTMLButtonElement | null;
            const nextBtn = getEl('next-page') as HTMLButtonElement | null;
            if (prevBtn) prevBtn.disabled = page <= 1;
            if (nextBtn) {
                const totalPages = Math.ceil(data.total / limit);
                nextBtn.disabled = page >= totalPages;
            }

            // Render Header
            if (tableHead) {
                tableHead.innerHTML = `<tr>${data.columns
                    .map(
                        (col: any) => `
                    <th class="cursor-pointer px-6 py-4 text-[9px] tracking-[0.2em] font-black text-text-muted border-r border-border hover:bg-accent-glow hover:text-accent transition-all uppercase" data-asc="false">
                        <div class="flex flex-col gap-1">
                            <span>${escapeHtml(col.name)}</span>
                            <span class="text-[7px] text-text-muted opacity-50 font-mono tracking-widest">${escapeHtml(col.type)}</span>
                        </div>
                    </th>`
                    )
                    .join('')}</tr>`;
            }

            // Render Body
            if (tableBody) {
                const rows = data.rows;

                // Precompute column metadata to avoid string manipulations in nested loops
                const renderableCols = data.columns.map((col: any) => {
                    const lName = col.name.toLowerCase();
                    return {
                        name: col.name,
                        isPct: lName.includes('pct'),
                        isPrice: lName.includes('price') || lName.includes('close'),
                    };
                });

                // Use robust string builder approach for performance
                tableBody.innerHTML = rows
                    .map(
                        (row: any) => `
                    <tr class="hover:bg-glass-hover transition-colors group/row">
                        ${renderableCols
                            .map((col: any) => {
                                const val = row[col.name];
                                const isNull = val === null || val === undefined;
                                let style = 'text-text-muted';
                                let display = isNull ? 'NULL' : escapeHtml(val);

                                if (!isNull && typeof val === 'number') {
                                    if (col.isPct) {
                                        style =
                                            val >= 0
                                                ? 'text-bullish font-bold'
                                                : 'text-bearish font-bold';
                                        display = (val > 0 ? '+' : '') + val.toFixed(2) + '%';
                                    } else if (col.isPrice) {
                                        style = 'text-accent font-bold';
                                    } else {
                                        style = 'text-text-secondary font-mono';
                                    }
                                }
                                return `<td class="px-6 py-4 text-[11px] border-r border-border ${isNull ? 'bg-red-500/10 text-red-500 dark:text-red-400 italic' : style}"><div class="db-cell truncate">${display}</div></td>`;
                            })
                            .join('')}
                    </tr>`
                    )
                    .join('');

                if (rows.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="99" class="py-20 text-center font-mono text-text-muted opacity-50 text-[9px] tracking-widest uppercase">Zero_Entities_Isolated</td></tr>`;
                }
            }

            if (queryTimeLabel)
                queryTimeLabel.textContent = `${Math.round(performance.now() - startTime)}ms`;
        } catch (err: any) {
            if (err.name === 'AbortError') return;
            console.error(err);
            if (dbError) dbError.classList.remove('hidden');
            if (dataTable) dataTable.classList.add('hidden');
            if (errorMsg) errorMsg.textContent = err.message;
        } finally {
            setLoading(false);
        }
    }

    function initExplorer() {
        // Table selection
        tableList?.addEventListener('click', e => {
            const btn = (e.target as HTMLElement).closest('button');
            if (!btn) return;
            tableList
                .querySelectorAll('button')
                .forEach(b =>
                    b.classList.remove('bg-white/[0.1]', 'text-accent', 'border-l-accent')
                );
            btn.classList.add('bg-white/[0.1]', 'text-accent', 'border-l-accent');
            activeTable = btn.dataset.table || '';
            currentPage = 1;
            loadTable(activeTable);
        });

        // Pagination
        getEl('prev-page')?.addEventListener('click', () => {
            if (currentPage > 1) loadTable(activeTable, currentPage - 1);
        });

        getEl('next-page')?.addEventListener('click', () => {
            loadTable(activeTable, currentPage + 1);
        });

        if (topScrollbar && tableScrollContainer) {
            let isSyncingTop = false;
            let isSyncingBottom = false;

            topScrollbar.addEventListener('scroll', function () {
                if (!isSyncingTop) {
                    isSyncingBottom = true;
                    tableScrollContainer.scrollLeft = this.scrollLeft;
                }
                isSyncingTop = false;
            });

            tableScrollContainer.addEventListener('scroll', function () {
                if (!isSyncingBottom) {
                    isSyncingTop = true;
                    topScrollbar.scrollLeft = this.scrollLeft;
                }
                isSyncingBottom = false;
            });

            // Reliable width synchronization
            if (topScrollContent && dataTable) {
                const rsObserver = new ResizeObserver(() => {
                    topScrollContent.style.width = `${dataTable.scrollWidth}px`;
                });
                rsObserver.observe(dataTable);
                rsObserver.observe(tableScrollContainer);
            }
        }

        // Global Search with debounce
        let searchTimeout: any;
        getEl('global-search')?.addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadTable(activeTable, 1);
            }, 300);
        });

        // Page Limit
        getEl('page-limit')?.addEventListener('change', e => {
            limit = parseInt((e.target as HTMLSelectElement).value);
            loadTable(activeTable, 1);
        });

        // SSE for ticks
        if (typeof EventSource !== 'undefined') {
            const es = new EventSource('/api/sse/stream');
            const tickCountEl = getEl('tick-count');
            es.addEventListener('tick', e => {
                try {
                    const ticks = JSON.parse(e.data);
                    if (tickCountEl) tickCountEl.textContent = String(ticks.length);
                } catch {}
            });
        }
    }

    document.addEventListener('astro:page-load', initExplorer);
    initExplorer();
</script>
