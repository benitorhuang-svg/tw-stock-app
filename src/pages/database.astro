---
/**
 * database.astro â€” Data Explorer Page (003-tab-database)
 * Engineering-grade SQLite inspection with data health dashboard.
 */
import MainTerminal from '../layouts/MainTerminal.astro';

// SSR: Load initial table stats
import { dbService } from '../lib/db/sqlite-service';
const tables = dbService.getTables();

const tableStats = tables.map(t => {
    try {
        const count = dbService.getTableRowCount(t);
        const columns = dbService.getTableColumns(t);
        return { name: t, rows: count, cols: columns.length };
    } catch {
        return { name: t, rows: 0, cols: 0 };
    }
});

const totalRows = tableStats.reduce((s, t) => s + t.rows, 0);
const dbStats = dbService.getDbStats();
---

<MainTerminal title="æ•¸æ“šè§€æ¸¬ (SQLite)" fullWidth>
    <div class="fixed inset-x-0 bottom-0 top-[64px] flex overflow-hidden">
        <!-- Mobile Sidebar Toggle -->
        <button
            id="sidebar-toggle"
            class="md:hidden fixed top-[72px] left-2 z-30 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs font-mono text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors"
            aria-label="åˆ‡æ›å´é‚Šæ¬„"
        >
            â˜° è³‡æ–™è¡¨
        </button>

        <!-- Mobile Sidebar Backdrop -->
        <div
            id="sidebar-backdrop"
            class="md:hidden fixed inset-0 bg-black/50 z-[19] hidden"
            aria-hidden="true"
        >
        </div>

        <!-- Sidebar: Table Navigator -->
        <aside
            id="db-sidebar"
            class="w-64 bg-base-deep border-r border-border flex flex-col z-20 flex-shrink-0 max-md:fixed max-md:inset-y-0 max-md:top-[64px] max-md:left-0 max-md:-translate-x-full max-md:transition-transform max-md:duration-200 max-md:shadow-2xl"
        >
            <!-- DB Health Summary -->
            <div class="px-5 py-4 border-b border-border/50 relative overflow-hidden">
                <!-- Decorative background glow -->
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-accent/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"
                >
                </div>

                <div class="flex items-center justify-between mb-4 relative z-10">
                    <span
                        class="text-[10px] font-bold text-text-muted uppercase tracking-widest flex items-center gap-2"
                    >
                        <span class="w-2 h-2 rounded-full bg-bullish animate-glow-pulse"></span>
                        ç³»çµ±å¢é›†ç‹€æ…‹
                    </span>
                    <span
                        class="text-[10px] font-mono text-text-muted opacity-80 border border-border/50 px-1.5 py-0.5 rounded"
                        >{dbStats.sizeMB} MB</span
                    >
                </div>
                <div class="grid grid-cols-2 gap-3 relative z-10">
                    <div
                        class="bg-surface/40 border border-border/40 rounded-lg p-2.5 backdrop-blur-sm shadow-sm transition-all hover:border-accent/30 group"
                    >
                        <div
                            class="text-[10px] text-text-muted uppercase font-bold mb-1 group-hover:text-accent/80 transition-colors"
                        >
                            è³‡æ–™è¡¨ç¸½æ•¸
                        </div>
                        <div class="font-mono text-lg text-accent font-bold leading-none">
                            {tables.length}
                        </div>
                    </div>
                    <div
                        class="bg-surface/40 border border-border/40 rounded-lg p-2.5 backdrop-blur-sm shadow-sm transition-all hover:border-accent/30 group"
                    >
                        <div
                            class="text-[10px] text-text-muted uppercase font-bold mb-1 group-hover:text-accent/80 transition-colors"
                        >
                            è³‡æ–™ç¸½ç­†æ•¸
                        </div>
                        <div
                            class="font-mono text-lg text-text-primary font-bold leading-none shrink-0"
                            style="font-size: clamp(0.9rem, 1vw, 1.125rem);"
                        >
                            {totalRows.toLocaleString()}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table List -->
            <div class="px-4 py-2 border-b border-border">
                <span class="text-[11px] font-bold text-text-muted uppercase tracking-widest"
                    >è³‡æ–™è¡¨åˆ—è¡¨</span
                >
            </div>
            <nav class="flex-1 overflow-y-auto py-1 custom-scrollbar">
                <ul class="space-y-0.5" id="table-list">
                    {
                        tableStats.map(t => (
                            <li>
                                <button
                                    class="w-full text-left px-5 py-3 text-xs font-mono text-text-secondary hover:bg-accent/5 hover:text-text-primary transition-all flex items-center justify-between group border-l-2 border-transparent"
                                    data-table={t.name}
                                >
                                    <div class="flex items-center gap-3 truncate">
                                        <span class="text-text-muted group-hover:text-accent/70 transition-colors">
                                            ğŸ—„ï¸
                                        </span>
                                        <span class="truncate">{t.name}</span>
                                    </div>
                                    <span class="text-[10px] bg-surface border border-border/40 px-1.5 py-0.5 rounded text-text-muted font-mono opacity-0 group-hover:opacity-100 transition-opacity">
                                        {t.rows.toLocaleString()}
                                    </span>
                                </button>
                            </li>
                        ))
                    }
                </ul>
            </nav>
        </aside>

        <!-- Main Content: Data Grid -->
        <main class="flex-1 flex flex-col bg-base relative">
            <!-- Loading Indicator -->
            <div id="db-loading-bar" class="loading-strip"></div>

            <!-- Toolbar -->
            <header class="terminal-toolbar sticky top-0 z-10">
                <div class="terminal-toolbar-left">
                    <h2 class="terminal-toolbar-title" id="current-table-name">è«‹é¸æ“‡è³‡æ–™è¡¨</h2>
                    <span
                        id="row-count-badge"
                        class="hidden text-[11px] bg-accent/20 text-accent font-bold px-2 py-0.5 rounded-full"
                        >0 ç­†è³‡æ–™</span
                    >
                </div>
                <div class="terminal-toolbar-right">
                    <div class="toolbar-control">
                        <span class="terminal-toolbar-meta">ç•¶å‰é ç¢¼</span>
                        <div class="flex items-center gap-2">
                            <button
                                id="prev-page"
                                class="text-text-muted hover:text-text-primary disabled:opacity-30"
                                >â—€</button
                            >
                            <span id="page-num" class="text-[11px] font-mono text-text-primary"
                                >1</span
                            >
                            <button
                                id="next-page"
                                class="text-text-muted hover:text-text-primary disabled:opacity-30"
                                >â–¶</button
                            >
                        </div>
                    </div>
                    <select id="page-limit" class="toolbar-control outline-none cursor-pointer">
                        <option value="50">æ¯é  50 ç­†</option>
                        <option value="100" selected>æ¯é  100 ç­†</option>
                        <option value="500">æ¯é  500 ç­†</option>
                    </select>
                </div>
            </header>

            <!-- Table Container -->
            <div class="flex-1 overflow-auto custom-scrollbar relative" id="grid-container">
                <!-- Welcome State -->
                <div
                    id="welcome-message"
                    class="absolute inset-0 flex flex-col items-center justify-center p-6"
                >
                    <div
                        class="glass-card p-10 max-w-xl mx-auto border-accent/20 flex flex-col items-center animate-fade-up w-full"
                    >
                        <div
                            class="w-24 h-24 mb-6 rounded-3xl bg-surface border border-accent/30 flex items-center justify-center text-5xl shadow-[0_0_30px_rgba(var(--accent-rgb),0.15)] animate-glow-pulse"
                        >
                            ğŸ—ƒï¸
                        </div>
                        <h3 class="text-2xl font-bold text-text-primary mb-3">
                            SQLite æ•¸æ“šæ ¸å¿ƒç¸½ç®¡
                        </h3>
                        <p class="text-[13px] text-text-secondary mt-2 text-center leading-relaxed">
                            æœ¬é¢æ¿æä¾›å·¥ç¨‹ç´šçš„åŸå§‹è³‡æ–™æª¢è¦–èˆ‡ç¶­è­·åŠŸèƒ½ã€‚<br />
                            è«‹å¾å·¦å´å°è¦½åˆ—é¸æ“‡ç›®æ¨™è³‡æ–™è¡¨ï¼Œä»¥å³æ™‚æª¢ç´¢å¸‚å ´æ•¸æ“šã€ç±Œç¢¼è®ŠåŒ–èˆ‡åŸºæœ¬é¢æŒ‡æ¨™ã€‚
                        </p>
                        <div
                            class="w-2/3 h-px bg-gradient-to-r from-transparent via-border/60 to-transparent my-6"
                        >
                        </div>
                        <div
                            class="flex items-center gap-6 text-[11px] font-mono text-text-muted uppercase tracking-wider"
                        >
                            <span class="flex items-center gap-2"
                                ><div class="w-1.5 h-1.5 rounded-full bg-bullish"></div> å¼•æ“é‹ä½œæ­£å¸¸</span
                            >
                            <span class="flex items-center gap-2"
                                ><div class="w-1.5 h-1.5 rounded-full bg-accent"></div> å³æ™‚é€£ç·šç‹€æ…‹</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div
                    id="db-error"
                    class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-12 bg-red-950/20"
                >
                    <span class="text-4xl mb-4">âš ï¸</span>
                    <h3 class="text-red-500 font-bold uppercase tracking-widest text-sm">
                        è³‡æ–™åº«éŒ¯èª¤
                    </h3>
                    <p id="error-message" class="text-xs text-red-400/80 mt-2 font-mono"></p>
                    <button onclick="location.reload()" class="btn-cyber mt-6">é‡è©¦</button>
                </div>

                <!-- Actual Data Table -->
                <table class="w-full text-left border-collapse hidden" id="data-table">
                    <thead class="sticky top-0 bg-base-deep shadow-lg z-10" id="table-head"></thead>
                    <tbody class="divide-y divide-border/30" id="table-body"></tbody>
                </table>
            </div>

            <!-- Footer info -->
            <footer class="h-8 border-t border-border px-6 flex items-center bg-base-deep">
                <p class="text-[11px] text-text-muted font-mono flex items-center gap-4">
                    <span
                        >æŸ¥è©¢è€—æ™‚: <span id="query-time" class="text-text-secondary">0ms</span
                        ></span
                    >
                    <span>è³‡æ–™å¼•æ“Š: SQLite (Better-Sqlite3)</span>
                    <span>{dbStats.sizeMB} MB</span>
                    <span
                        >å³æ™‚æ›´æ–°æ•¸: <span id="tick-count" class="text-text-secondary">0</span
                        ></span
                    >
                </p>
            </footer>
        </main>
    </div>
</MainTerminal>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: hsl(0 0% 100% / 0.08);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: hsl(0 0% 100% / 0.15);
    }
    #data-table {
        table-layout: auto;
        min-width: 100%;
    }
    :global(.db-cell) {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script>
    function escapeHtml(str: unknown): string {
        if (str === null || str === undefined) return '';
        const s = String(str);
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    let activeTable = '';
    let currentPage = 1;
    let limit = 100;
    let activeController: AbortController | null = null;
    let requestSeq = 0;

    const tableList = document.getElementById('table-list');
    const welcomeMsg = document.getElementById('welcome-message');
    const dataTable = document.getElementById('data-table');
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    const tableNameLabel = document.getElementById('current-table-name');
    const rowCountBadge = document.getElementById('row-count-badge');
    const loadingBar = document.getElementById('db-loading-bar');
    const dbError = document.getElementById('db-error');
    const errorMsg = document.getElementById('error-message');
    const queryTimeLabel = document.getElementById('query-time');
    const pageNumLabel = document.getElementById('page-num');

    interface ColumnDef {
        name: string;
        type: string;
    }
    interface TableDataResponse {
        total: number;
        columns: ColumnDef[];
        rows: any[];
    }

    function renderLoadingRows() {
        if (!tableBody) return;
        tableBody.innerHTML = Array.from({ length: 8 })
            .map(
                () =>
                    `<tr class="table-loading-row border-b border-border/30"><td colspan="99"><div class="skeleton"></div></td></tr>`
            )
            .join('');
    }

    function setLoading(isLoading: boolean) {
        if (!loadingBar) return;
        if (isLoading) {
            loadingBar.style.opacity = '1';
            loadingBar.style.width = '30%';
            setTimeout(() => {
                if (loadingBar && loadingBar.style.width === '30%') loadingBar.style.width = '70%';
            }, 500);
        } else {
            loadingBar.style.width = '100%';
            setTimeout(() => {
                if (loadingBar) {
                    loadingBar.style.opacity = '0';
                    loadingBar.style.width = '0';
                }
            }, 300);
        }
    }

    async function loadTable(name: string, page = 1) {
        // helper to sort columns when header clicked
        function enableTableSorting() {
            if (!tableHead || !tableBody) return;
            const headers = Array.from(tableHead.querySelectorAll('th')) as HTMLElement[];
            headers.forEach((th, idx) => {
                th.addEventListener('click', () => {
                    const asc = th.dataset.asc === 'true';
                    const rows = Array.from(tableBody.querySelectorAll('tr'));
                    rows.sort((a, b) => {
                        const aText = a.children[idx]?.textContent || '';
                        const bText = b.children[idx]?.textContent || '';
                        const aNum = parseFloat(aText.replace(/[^0-9.-]/g, ''));
                        const bNum = parseFloat(bText.replace(/[^0-9.-]/g, ''));
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return asc ? aNum - bNum : bNum - aNum;
                        }
                        return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                    });
                    rows.forEach(r => tableBody.appendChild(r));
                    th.dataset.asc = asc ? 'false' : 'true';
                });
            });
        }
        if (!name) return;
        const seq = ++requestSeq;
        if (activeController) activeController.abort();
        activeController = new AbortController();

        const startTime = performance.now();
        setLoading(true);
        renderLoadingRows();
        if (dbError) dbError.classList.add('hidden');
        if (welcomeMsg) welcomeMsg.classList.add('hidden');
        if (dataTable) dataTable.classList.remove('hidden');

        try {
            const offset = (page - 1) * limit;
            const res = await fetch(
                `/api/db/${encodeURIComponent(name)}?limit=${limit}&offset=${offset}`,
                { signal: activeController.signal }
            );
            if (seq !== requestSeq) return;
            if (!res.ok) throw new Error(await res.text());

            const data: TableDataResponse = await res.json();

            if (tableNameLabel) tableNameLabel.textContent = name;
            if (rowCountBadge) {
                rowCountBadge.textContent = `${data.total.toLocaleString()} ç­†è³‡æ–™`;
                rowCountBadge.classList.remove('hidden');
            }
            if (pageNumLabel) pageNumLabel.textContent = page.toString();
            currentPage = page;

            // Render Header (escaped)
            if (tableHead) {
                tableHead.innerHTML = `<tr>
                    ${data.columns
                        .map(
                            (col: ColumnDef) => `
                        <th class="cursor-pointer px-3 py-2 text-[11px] font-bold text-text-muted border-r border-border/50" data-asc="false">
                            <div class="flex flex-col">
                                <span class="text-text-primary">${escapeHtml(col.name)}</span>
                                <span class="text-[10px] font-normal text-text-muted uppercase">${escapeHtml(col.type)}</span>
                            </div>
                        </th>
                    `
                        )
                        .join('')}
                </tr>`;
            }

            // Render Body (escaped)
            if (tableBody) {
                tableBody.innerHTML = data.rows
                    .map(
                        (row: any) => `
                    <tr class="hover:bg-glass-hover transition-colors border-b border-border/30">
                        ${data.columns
                            .map((col: ColumnDef) => {
                                const val = row[col.name];
                                const isNull = val === null || val === undefined;
                                return `
                                <td class="px-3 py-1.5 text-xs font-mono border-r border-border/20 ${isNull ? 'bg-red-950/20 text-red-500 italic' : 'text-text-secondary'}">
                                    <div class="db-cell">${isNull ? 'NULL' : escapeHtml(val)}</div>
                                </td>
                            `;
                            })
                            .join('')}
                    </tr>
                `
                    )
                    .join('');
                // enable sorting after rendering
                enableTableSorting();
            }

            if (queryTimeLabel)
                queryTimeLabel.textContent = `${Math.round(performance.now() - startTime)}ms`;
        } catch (err) {
            if ((err as Error).name === 'AbortError') return;
            console.error(err);
            if (dbError) dbError.classList.remove('hidden');
            if (dataTable) dataTable.classList.add('hidden');
            if (errorMsg) errorMsg.textContent = (err as Error).message;
        } finally {
            setLoading(false);
        }
    }

    // Table list click handler
    if (tableList) {
        tableList.addEventListener('click', e => {
            const btn = (e.target as HTMLElement).closest('button');
            if (!btn) return;

            tableList.querySelectorAll('button').forEach(b => {
                b.classList.remove('bg-accent/10', 'text-accent', 'border-l-2', 'border-l-accent');
            });
            btn.classList.add('bg-accent/10', 'text-accent', 'border-l-2', 'border-l-accent');

            activeTable = btn.dataset.table || '';
            currentPage = 1;
            loadTable(activeTable);
        });

        // keyboard navigation (up/down arrows) between tables
        tableList.addEventListener('keydown', e => {
            const active = document.activeElement as HTMLElement;
            if (!active || active.tagName !== 'BUTTON') return;
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                const buttons = Array.from(tableList.querySelectorAll('button')) as HTMLElement[];
                const idx = buttons.indexOf(active);
                if (idx !== -1) {
                    const next = buttons[e.key === 'ArrowDown' ? idx + 1 : idx - 1];
                    if (next) next.focus();
                }
            }
        });
    }

    // Pagination
    document.getElementById('prev-page')?.addEventListener('click', () => {
        if (currentPage > 1) loadTable(activeTable, currentPage - 1);
    });
    document.getElementById('next-page')?.addEventListener('click', () => {
        loadTable(activeTable, currentPage + 1);
    });
    document.getElementById('page-limit')?.addEventListener('change', e => {
        limit = parseInt((e.target as HTMLSelectElement).value);
        if (activeTable) loadTable(activeTable, 1);
    });

    // Mobile sidebar toggle
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const dbSidebar = document.getElementById('db-sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');

    function openSidebar() {
        dbSidebar?.classList.remove('max-md:-translate-x-full');
        dbSidebar?.classList.add('max-md:translate-x-0');
        sidebarBackdrop?.classList.remove('hidden');
    }
    function closeSidebar() {
        dbSidebar?.classList.add('max-md:-translate-x-full');
        dbSidebar?.classList.remove('max-md:translate-x-0');
        sidebarBackdrop?.classList.add('hidden');
    }

    if (sidebarToggle && dbSidebar) {
        sidebarToggle.addEventListener('click', () => {
            const isHidden = dbSidebar.classList.contains('max-md:-translate-x-full');
            isHidden ? openSidebar() : closeSidebar();
        });
        dbSidebar.addEventListener('click', e => {
            if (
                (e.target as HTMLElement).closest('button[data-table]') &&
                window.innerWidth < 768
            ) {
                closeSidebar();
            }
        });
        sidebarBackdrop?.addEventListener('click', closeSidebar);
    }

    // real-time tick counter update is handled above in footer
    if (typeof EventSource !== 'undefined') {
        const es = new EventSource('/api/sse/stream');
        const tickCountEl = document.getElementById('tick-count');
        es.addEventListener('tick', e => {
            try {
                const ticks = JSON.parse(e.data);
                if (tickCountEl) tickCountEl.textContent = String(ticks.length);
            } catch {}
        });
    }
</script>
