---
/**
 * database.astro — Data Explorer Terminal
 * Quantum-grade SQLite inspection with modular architecture.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import DatabaseSidebar from '../components/organisms/DatabaseSidebar.astro';
import DatabaseExplorer from '../components/organisms/DatabaseExplorer.astro';
import DatabaseSidebarActions from '../components/molecules/DatabaseSidebarActions.astro';

// SSR: Load initial table stats
import { dbService } from '../lib/db/sqlite-service';
let tables = dbService.getTables();
// Filter out dividends since it has no data and is confusing
tables = tables.filter(t => t !== 'dividends');

const tableStats = tables.map(t => {
    try {
        const count = dbService.getTableRowCount(t);
        const columns = dbService.getTableColumns(t);
        return { name: t, rows: count, cols: columns.length };
    } catch {
        return { name: t, rows: 0, cols: 0 };
    }
});
---

<MainTerminal title="數據觀測 (SQLite)" fullWidth>
    <div class="fixed inset-x-0 bottom-0 top-[64px] flex overflow-hidden">
        <!-- Explorer Orchestration -->
        <DatabaseSidebar tables={tables} tableStats={tableStats} />

        <DatabaseExplorer />

        <DatabaseSidebarActions />
    </div>
</MainTerminal>

<style is:global>
    #data-table {
        table-layout: auto;
        min-width: 100%;
    }
    .db-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script src="../scripts/database-engine.ts"></script>
