---
/**
 * database.astro — Data Explorer Terminal
 * Quantum-grade SQLite inspection with modular architecture.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import DatabaseSidebar from '../components/organisms/DatabaseSidebar.astro';
import DatabaseExplorer from '../components/organisms/DatabaseExplorer.astro';

// SSR: Load initial table stats
import { dbService } from '../lib/db/sqlite-service';
const tables = dbService.getTables();

const tableStats = tables.map(t => {
    try {
        const count = dbService.getTableRowCount(t);
        const columns = dbService.getTableColumns(t);
        return { name: t, rows: count, cols: columns.length };
    } catch {
        return { name: t, rows: 0, cols: 0 };
    }
});

const totalRows = tableStats.reduce((s, t) => s + t.rows, 0);
---

<MainTerminal title="數據觀測 (SQLite)" fullWidth>
    <div class="fixed inset-x-0 bottom-0 top-[64px] flex overflow-hidden">
        <!-- Explorer Orchestration -->
        <DatabaseSidebar tables={tables} tableStats={tableStats} totalRows={totalRows} />

        <DatabaseExplorer />

        <!-- Mobile Sidebar UI Actions -->
        <button
            id="sidebar-toggle"
            class="md:hidden fixed top-[72px] left-2 z-30 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs font-mono text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors"
        >
            ☰ 資料表
        </button>
        <div
            id="sidebar-backdrop"
            class="md:hidden fixed inset-0 bg-black/50 z-[19] hidden"
            aria-hidden="true"
        >
        </div>
    </div>
</MainTerminal>

<style is:global>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    #data-table {
        table-layout: auto;
        min-width: 100%;
    }
    .db-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script>
    // ═══ Forensic Data Explorer Engine ═══
    function escapeHtml(str: unknown): string {
        if (str === null || str === undefined) return '';
        const s = String(str);
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    let activeTable = '';
    let currentPage = 1;
    let limit = 100;
    let activeController: AbortController | null = null;
    let requestSeq = 0;

    const getEl = (id: string) => document.getElementById(id);
    const tableList = getEl('table-list');
    const welcomeMsg = getEl('welcome-message');
    const dataTable = getEl('data-table');
    const tableHead = getEl('table-head');
    const tableBody = getEl('table-body');
    const tableNameLabel = getEl('current-table-name');
    const rowCountBadge = getEl('row-count-badge');
    const loadingBar = getEl('db-loading-bar');
    const dbError = getEl('db-error');
    const errorMsg = getEl('error-message');
    const queryTimeLabel = getEl('query-time');
    const pageNumLabel = getEl('page-num');

    function setLoading(isLoading: boolean) {
        if (!loadingBar) return;
        if (isLoading) {
            loadingBar.style.opacity = '1';
            loadingBar.style.width = '30%';
        } else {
            loadingBar.style.width = '100%';
            setTimeout(() => {
                if (loadingBar) {
                    loadingBar.style.opacity = '0';
                    loadingBar.style.width = '0';
                }
            }, 300);
        }
    }

    async function loadTable(name: string, page = 1) {
        if (!name) return;
        const seq = ++requestSeq;
        if (activeController) activeController.abort();
        activeController = new AbortController();

        const startTime = performance.now();
        setLoading(true);
        if (dbError) dbError.classList.add('hidden');
        if (welcomeMsg) welcomeMsg.classList.add('hidden');
        if (dataTable) dataTable.classList.remove('hidden');

        try {
            const offset = (page - 1) * limit;
            const res = await fetch(
                `/api/db/${encodeURIComponent(name)}?limit=${limit}&offset=${offset}`,
                { signal: activeController.signal }
            );
            if (seq !== requestSeq) return;
            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();

            if (tableNameLabel) tableNameLabel.textContent = name;
            if (rowCountBadge) {
                rowCountBadge.textContent = `${data.total.toLocaleString()} ENTITIES`;
                rowCountBadge.classList.remove('hidden');
            }
            if (pageNumLabel) pageNumLabel.textContent = page.toString();
            currentPage = page;

            // Render Header
            if (tableHead) {
                tableHead.innerHTML = `<tr>${data.columns
                    .map(
                        (col: any) => `
                    <th class="cursor-pointer px-6 py-4 text-[9px] tracking-[0.2em] font-black text-white/30 border-r border-white/5 hover:bg-accent/5 hover:text-accent transition-all uppercase" data-asc="false">
                        <div class="flex flex-col gap-1">
                            <span>${escapeHtml(col.name)}</span>
                            <span class="text-[7px] text-white/10 font-mono tracking-widest">${escapeHtml(col.type)}</span>
                        </div>
                    </th>`
                    )
                    .join('')}</tr>`;
            }

            // Render Body
            if (tableBody) {
                const searchInput = getEl('global-search') as HTMLInputElement;
                const filterText = searchInput?.value.toLowerCase() || '';
                const filteredRows = filterText
                    ? data.rows.filter((r: any) =>
                          Object.values(r).some(v => String(v).toLowerCase().includes(filterText))
                      )
                    : data.rows;

                tableBody.innerHTML = filteredRows
                    .map(
                        (row: any) => `
                    <tr class="hover:bg-white/[0.02] transition-colors group/row">
                        ${data.columns
                            .map((col: any) => {
                                const val = row[col.name];
                                const isNull = val === null || val === undefined;
                                let style = 'text-white/60';
                                let display = isNull ? 'NULL' : escapeHtml(val);
                                if (!isNull && typeof val === 'number') {
                                    if (col.name.toLowerCase().includes('pct')) {
                                        style =
                                            val >= 0
                                                ? 'text-bullish font-bold'
                                                : 'text-bearish font-bold';
                                        display = (val > 0 ? '+' : '') + val.toFixed(2) + '%';
                                    } else if (
                                        col.name.toLowerCase().includes('price') ||
                                        col.name.toLowerCase().includes('close')
                                    ) {
                                        style = 'text-accent font-bold';
                                    } else {
                                        style = 'text-white/80 font-mono';
                                    }
                                }
                                return `<td class="px-6 py-4 text-[11px] border-r border-white/5 ${isNull ? 'bg-red-950/20 text-red-500/80 italic' : style}"><div class="db-cell truncate">${display}</div></td>`;
                            })
                            .join('')}
                    </tr>`
                    )
                    .join('');

                if (filteredRows.length === 0 && filterText) {
                    tableBody.innerHTML = `<tr><td colspan="99" class="py-20 text-center font-mono text-white/10 text-[9px] tracking-widest uppercase">Zero_Entities_Isolated</td></tr>`;
                }
            }

            if (queryTimeLabel)
                queryTimeLabel.textContent = `${Math.round(performance.now() - startTime)}ms`;
        } catch (err: any) {
            if (err.name === 'AbortError') return;
            console.error(err);
            if (dbError) dbError.classList.remove('hidden');
            if (dataTable) dataTable.classList.add('hidden');
            if (errorMsg) errorMsg.textContent = err.message;
        } finally {
            setLoading(false);
        }
    }

    function initExplorer() {
        // Table selection
        tableList?.addEventListener('click', e => {
            const btn = (e.target as HTMLElement).closest('button');
            if (!btn) return;
            tableList
                .querySelectorAll('button')
                .forEach(b =>
                    b.classList.remove('bg-white/[0.1]', 'text-accent', 'border-l-accent')
                );
            btn.classList.add('bg-white/[0.1]', 'text-accent', 'border-l-accent');
            activeTable = btn.dataset.table || '';
            currentPage = 1;
            loadTable(activeTable);
        });

        // Search
        getEl('global-search')?.addEventListener(
            'input',
            () => activeTable && loadTable(activeTable, currentPage)
        );

        // Pagination
        getEl('prev-page')?.addEventListener(
            'click',
            () => currentPage > 1 && loadTable(activeTable, currentPage - 1)
        );
        getEl('next-page')?.addEventListener('click', () =>
            loadTable(activeTable, currentPage + 1)
        );
        getEl('page-limit')?.addEventListener('change', e => {
            limit = parseInt((e.target as HTMLSelectElement).value);
            if (activeTable) loadTable(activeTable, 1);
        });

        // SSE for ticks
        if (typeof EventSource !== 'undefined') {
            const es = new EventSource('/api/sse/stream');
            const tickCountEl = getEl('tick-count');
            es.addEventListener('tick', e => {
                try {
                    const ticks = JSON.parse(e.data);
                    if (tickCountEl) tickCountEl.textContent = String(ticks.length);
                } catch {}
            });
        }
    }

    document.addEventListener('astro:page-load', initExplorer);
    initExplorer();
</script>
