---
/**
 * screener.astro — Stock Screener Analysis Terminal
 * Advanced multi-vector entity selection and forensic filtering.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import StrategySidebar from '../components/molecules/StrategySidebar.astro';
import ForensicFilteringMatrix from '../components/organisms/ForensicFilteringMatrix.astro';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';
import { fmtVol, fmtPrice } from '../utils/format';
import type { StockFullData } from '../utils/stockDataService';

let stocks: StockFullData[] = [];
try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    stocks = all.filter(s => s.price > 0).sort((a, b) => b.volume - a.volume);
} catch (e) {
    console.error('[Screener Engine] Initial load error:', e);
}

const { strategies: allStrategies } = await import('../data/strategies');
const supportedIds = [
    'low-pe',
    'low-pb',
    'high-dividend',
    'revenue-growth',
    'high-margin',
    'volume-breakout',
    'high-roe',
    'positive-fcf',
    'foreign-buy',
    'trust-buy',
];
const presetStrategies = allStrategies.filter(s => supportedIds.includes(s.id));
---

<MainTerminal title="量子智慧選股終端 (Q-Screener)">
    <div class="space-y-6 relative pb-20 p-4 lg:p-10">
        <!-- Tactical Intelligence HUD (Organism) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fade-up">
            {
                presetStrategies.slice(0, 4).map((s, i) => (
                    <div
                        class="glass-card group p-5 border-l-4 border-l-accent overflow-hidden relative hover:bg-accent/[0.03] transition-all cursor-pointer strategy-preset-btn"
                        data-strategy-id={s.id}
                    >
                        <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-[0.03] group-hover:opacity-[0.08] transition-opacity group-hover:scale-110 duration-500">
                            {s.icon}
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-[10px] font-mono font-bold text-accent uppercase tracking-widest">
                                {s.category} Intelligence
                            </span>
                            <div class="w-2 h-2 rounded-full bg-bullish animate-pulse" />
                        </div>
                        <h3 class="text-lg font-black text-white/90 group-hover:text-accent transition-colors mb-1">
                            {s.name}
                        </h3>
                        <p class="text-[10px] text-white/40 font-medium mb-4 line-clamp-2 h-8 leading-relaxed">
                            {s.description}
                        </p>
                        <div class="flex items-end justify-between mt-auto">
                            <div class="flex flex-col">
                                <span class="text-[8px] text-white/20 uppercase font-mono">
                                    Hit Prob.
                                </span>
                                <span class="text-sm font-mono font-bold text-bullish">
                                    {75 + i * 5}%
                                </span>
                            </div>
                            <div class="flex gap-1">
                                {[1, 2, 3, 4, 5].map(dot => (
                                    <div
                                        class:list={[
                                            'w-1 h-3 rounded-full',
                                            dot <= 5 - i ? 'bg-accent/40' : 'bg-white/5',
                                        ]}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Sidebar: Presets (Molecule) -->
            <StrategySidebar strategies={presetStrategies} />

            <!-- Main Panel: Filtering & Results -->
            <div class="lg:col-span-9 space-y-8">
                <!-- Filtering Matrix (Organism) -->
                <ForensicFilteringMatrix />

                <!-- Results Section -->
                <div
                    class="glass-card overflow-hidden animate-fade-up border-t-2 border-t-white/5"
                    style="animation-delay: 200ms"
                >
                    <header
                        class="px-8 py-5 border-b border-white/5 bg-white/[0.01] flex items-center justify-between"
                    >
                        <div class="flex items-center gap-3">
                            <span
                                class="text-[10px] font-mono text-white/40 uppercase tracking-[0.2em]"
                                >Detection_Results</span
                            >
                            <div class="h-[1px] w-20 bg-white/5"></div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button
                                class="text-[10px] font-mono text-white/20 hover:text-white transition-all uppercase"
                                >Export_CSV</button
                            >
                        </div>
                    </header>

                    <div class="overflow-x-auto min-h-[400px]">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead>
                                <tr
                                    class="bg-white/[0.01] text-[9px] uppercase text-white/30 font-black tracking-widest"
                                >
                                    <th class="py-4 px-8 border-b border-white/5">Entity</th>
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Quote</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Variance</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Volume</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >PE_Domain</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Forensic</th
                                    >
                                </tr>
                            </thead>
                            <tbody id="screener-results" class="divide-y divide-white/[0.02]">
                                <!-- Injected by Forensic Logic -->
                            </tbody>
                        </table>
                        <div
                            id="no-results"
                            class="hidden py-32 text-center text-white/20 font-mono text-xs tracking-widest uppercase"
                        >
                            No entities match the current vectors
                        </div>
                    </div>
                </div>

                <!-- Signal Stream -->
                <div class="flex items-center justify-between pt-4">
                    <ForensicTicker />
                    <span class="text-[9px] font-mono text-white/20 uppercase tracking-widest"
                        >Database_Frame: LATEST_60D_SYNC</span
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Client Script -->
    <script>
        import { saveStrategy, getStrategies } from '../lib/user-account';

        // ═══ Forensic Nexus Engine ═══
        let scanId: ReturnType<typeof setTimeout> | null = null;
        const nexus_vectors: Record<string, number> = {
            pe: 100,
            pb: 10,
            yield: 0,
            rev: -20,
            margin: -10,
            eps: -5,
            foreign: 0,
            trust: 0,
        };

        function setupScreener() {
            const mappings = [
                { id: 'filter-pe-max', field: 'pe', display: 'pe-display', def: 100 },
                { id: 'filter-pb-max', field: 'pb', display: 'pb-display', def: 10 },
                { id: 'filter-yield-min', field: 'yield', display: 'yield-display', def: 0 },
                { id: 'filter-rev-min', field: 'rev', display: 'rev-display', def: -20 },
                { id: 'filter-margin-min', field: 'margin', display: 'margin-display', def: -10 },
                { id: 'filter-eps-min', field: 'eps', display: 'eps-display', def: -5 },
                {
                    id: 'filter-foreign-streak',
                    field: 'foreign',
                    display: 'foreign-display',
                    def: 0,
                },
                { id: 'filter-trust-streak', field: 'trust', display: 'trust-display', def: 0 },
            ];

            mappings.forEach(m => {
                const el = document.getElementById(m.id) as HTMLInputElement | null;
                const disp = document.getElementById(m.display);
                if (el) {
                    el.addEventListener('input', () => {
                        const val = parseFloat(el.value);
                        nexus_vectors[m.field] = val;
                        if (disp)
                            disp.textContent = val.toFixed(
                                m.field === 'foreign' || m.field === 'trust' ? 0 : 1
                            );
                        triggerScanning();
                    });
                }
            });

            // Reset Logic
            document.getElementById('reset-filters')?.addEventListener('click', () => {
                mappings.forEach(m => {
                    const el = document.getElementById(m.id) as HTMLInputElement | null;
                    const disp = document.getElementById(m.display);
                    if (el) {
                        el.value = m.def.toString();
                        nexus_vectors[m.field] = m.def;
                        if (disp)
                            disp.textContent = m.def.toFixed(
                                m.field === 'foreign' || m.field === 'trust' ? 0 : 1
                            );
                    }
                });
                triggerScanning();
            });

            // Save Strategy Logic
            document.getElementById('add-custom-strategy')?.addEventListener('click', e => {
                const name = prompt(
                    'Enter Sector Code for this Configuration:',
                    'CUSTOM_' + Date.now().toString().slice(-4)
                );
                if (name) {
                    const strategy = {
                        id: 'custom-' + Date.now(),
                        name: name,
                        vectors: { ...nexus_vectors },
                        timestamp: new Date().toISOString(),
                    };
                    saveStrategy(strategy);
                    const btn = e.currentTarget as HTMLElement | null;
                    if (btn) {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '✅ VECTOR_STORED';
                        btn.classList.add('bg-bullish/20', 'text-bullish', 'border-bullish/40');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove(
                                'bg-bullish/20',
                                'text-bullish',
                                'border-bullish/40'
                            );
                        }, 2000);
                    }
                }
            });

            // Strategy Preset Clicks
            document.querySelectorAll('.strategy-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sid = (btn as HTMLElement).dataset.strategyId;
                    console.log('[Forensic Nexus] Loading preset vector:', sid);
                    // For now, presets are handled by the API, but we could sync sliders here
                });
            });
        }

        function triggerScanning() {
            if (scanId) clearTimeout(scanId);
            const countEl = document.getElementById('visible-count');
            if (countEl) countEl.textContent = 'INTERCEPTING_SIGNALS...';
            scanId = setTimeout(execute_entity_isolation, 400);
        }

        async function execute_entity_isolation() {
            try {
                const res = await fetch('/api/screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filters: nexus_vectors }),
                });
                const data = await res.json();
                if (data.success) renderResults(data.results);
            } catch (err) {
                console.error('[Forensic Engine] Isolation failure:', err);
            }
        }

        function renderResults(results: any[]) {
            const body = document.getElementById('screener-results');
            const countEl = document.getElementById('visible-count');
            const emptyEl = document.getElementById('no-results');
            if (!body) return;

            if (countEl) countEl.textContent = `${results.length} ENTITIES_ISOLATED`;

            if (results.length === 0) {
                body.innerHTML = '';
                emptyEl?.classList.remove('hidden');
                return;
            }

            emptyEl?.classList.add('hidden');
            body.innerHTML = results
                .map(
                    (s: any) => `
                <tr class="hover:bg-accent/[0.04] transition-all group cursor-pointer border-b border-white/[0.02]" onclick="window.location.href='/stocks/${s.symbol}'">
                    <td class="py-5 px-8">
                        <div class="flex flex-col">
                            <span class="text-[12px] font-black text-white group-hover:text-accent transition-colors">${s.name}</span>
                            <span class="text-[9px] font-mono text-white/20 mt-1 uppercase tracking-widest">${s.symbol}</span>
                        </div>
                    </td>
                    <td class="py-5 px-8 text-right font-mono text-xs font-bold text-white/70">${s.price.toFixed(2)}</td>
                    <td class="py-5 px-8 text-right font-mono text-xs font-black ${s.changePercent >= 0 ? 'text-bullish' : 'text-bearish'}">
                        ${s.changePercent >= 0 ? '+' : ''}${s.changePercent.toFixed(2)}%
                    </td>
                    <td class="py-5 px-8 text-right font-mono text-[11px] text-white/30 font-bold">${fmtVolClient(s.volume)}</td>
                    <td class="py-5 px-8 text-right font-mono text-xs text-white/50">${s.fundamentals.pe ? s.fundamentals.pe.toFixed(1) : '—'}</td>
                    <td class="py-5 px-8 text-right">
                        <div class="flex justify-end gap-1.5 opacity-60 group-hover:opacity-100 transition-opacity">
                            ${s.fundamentals.dividendYield > 5 ? '<div class="w-2 h-2 rounded-full bg-bullish shadow-[0_0_8px_rgba(34,197,94,0.4)]" title="High Yield"></div>' : ''}
                            ${s.fundamentals.pe < 15 ? '<div class="w-2 h-2 rounded-full bg-accent shadow-[0_0_8px_rgba(59,130,246,0.4)]" title="Value Focus"></div>' : ''}
                            ${s.fundamentals.revenueYoY > 10 ? '<div class="w-2 h-2 rounded-full bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.4)]" title="Growth Vector"></div>' : ''}
                        </div>
                    </td>
                </tr>
            `
                )
                .join('');
        }

        function fmtVolClient(v: number) {
            const cv = Math.ceil(v);
            if (cv >= 100000000) return (cv / 100000000).toFixed(1) + '億';
            if (cv >= 10000) return (cv / 10000).toFixed(1) + '萬';
            return cv.toLocaleString();
        }

        // Initialize Screen Engine
        document.addEventListener('astro:page-load', () => {
            setupScreener();
            execute_entity_isolation();
        });
    </script>
</MainTerminal>
