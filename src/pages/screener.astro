---
/**
 * screener.astro — Stock Screener Analysis Terminal
 * Advanced multi-vector entity selection and forensic filtering.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import StrategySidebar from '../components/molecules/StrategySidebar.astro';
import ForensicFilteringMatrix from '../components/organisms/ForensicFilteringMatrix.astro';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';
import TacticalIntelligenceHUD from '../components/organisms/TacticalIntelligenceHUD.astro';
import BacktestHeatmap from '../components/molecules/BacktestHeatmap.astro';

try {
    const svc = await import('../utils/stockDataService');
    await svc.getStocksWithPrices();
} catch (e) {
    console.error('[Screener Engine] Initial load error:', e);
}

const { strategies: allStrategies } = await import('../data/strategies');
const supportedIds = [
    'low-pe',
    'low-pb',
    'high-dividend',
    'revenue-growth',
    'high-margin',
    'volume-breakout',
    'high-roe',
    'positive-fcf',
    'foreign-buy',
    'trust-buy',
];
const presetStrategies = allStrategies.filter(s => supportedIds.includes(s.id));
---

<MainTerminal title="量子智慧選股終端 (Q-Screener)">
    <div class="space-y-6 relative pb-20 p-4 lg:p-10">
        <TacticalIntelligenceHUD presetStrategies={presetStrategies} />

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Sidebar: Presets (Molecule) -->
            <StrategySidebar strategies={presetStrategies} />

            <!-- Main Panel: Filtering & Results -->
            <div class="lg:col-span-9 space-y-8">
                <!-- Filtering Matrix (Organism) -->
                <ForensicFilteringMatrix />

                <!-- Quantitative Backtest Matrix -->
                <BacktestHeatmap />

                <!-- Results Section -->
                <div
                    class="glass-card overflow-hidden animate-fade-up border-t-2 border-t-white/5"
                    style="animation-delay: 200ms"
                >
                    <header
                        class="px-8 py-5 border-b border-white/5 bg-white/[0.01] flex items-center justify-between"
                    >
                        <div class="flex items-center gap-3">
                            <span
                                class="text-[10px] font-mono text-white/40 uppercase tracking-[0.2em]"
                                >Detection_Results</span
                            >
                            <div class="h-[1px] w-20 bg-white/5"></div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button
                                class="text-[10px] font-mono text-white/20 hover:text-white transition-all uppercase"
                                >Export_CSV</button
                            >
                        </div>
                    </header>

                    <div class="overflow-x-auto min-h-[400px]">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead>
                                <tr
                                    class="bg-white/[0.01] text-[9px] uppercase text-white/30 font-black tracking-widest"
                                >
                                    <th class="py-4 px-8 border-b border-white/5">Entity</th>
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Quote</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Variance</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Volume</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >PE_Domain</th
                                    >
                                    <th class="py-4 px-8 border-b border-white/5 text-right"
                                        >Forensic</th
                                    >
                                </tr>
                            </thead>
                            <tbody id="screener-results" class="divide-y divide-white/[0.02]">
                                <!-- Injected by Forensic Logic -->
                            </tbody>
                        </table>
                        <div
                            id="no-results"
                            class="hidden py-32 text-center text-white/20 font-mono text-xs tracking-widest uppercase"
                        >
                            No entities match the current vectors
                        </div>
                    </div>
                </div>

                <!-- Signal Stream -->
                <div class="flex items-center justify-between pt-4">
                    <ForensicTicker />
                    <span class="text-[9px] font-mono text-white/20 uppercase tracking-widest"
                        >Database_Frame: LATEST_60D_SYNC</span
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Client Script -->
    <script src="../scripts/screener-engine.ts"></script>
</MainTerminal>
