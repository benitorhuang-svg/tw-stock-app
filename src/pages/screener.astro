---
/**
 * stocks/index.astro ‚Äî Stock Listing / Analysis Hub
 * Premium data table with real-time search and sorting.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import type { StockFullData } from '../utils/stockDataService';

const fmtVol = (v: number) => {
    const cv = Math.ceil(v);
    if (cv >= 10000) return `${(cv / 10000).toFixed(1)}Ëê¨`;
    if (cv > 0) return cv.toLocaleString('zh-TW');
    return '‚Äî';
};
const fmtPct = (v: number) => (v > 0 ? `+${v.toFixed(2)}%` : `${v.toFixed(2)}%`);
const fmtPrice = (v: number) => (v > 0 ? v.toFixed(2) : '‚Äî');

let stocks: StockFullData[] = [];
let loadError = '';

try {
    const svc = await import('../utils/stockDataService');
    const all = await svc.getStocksWithPrices();
    stocks = all.filter(s => s.price > 0).sort((a, b) => b.volume - a.volume);
} catch (e) {
    console.error('Stock list load error:', e);
    loadError = e instanceof Error ? e.message : 'Êú™Áü•ÈåØË™§';
}

const { strategies: allStrategies } = await import('../data/strategies');
const supportedIds = [
    'low-pe',
    'low-pb',
    'high-dividend',
    'revenue-growth',
    'high-margin',
    'volume-breakout',
    'high-roe',
    'positive-fcf',
];
const presetStrategies = allStrategies.filter(s => supportedIds.includes(s.id));
---

<MainTerminal title="Êô∫ÊÖßÈÅ∏ËÇ°ÂºïÊìé">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 relative items-start">
        <!-- FIRST COLUMN: Strategy Presets (Left) -->
        <aside class="lg:col-span-3 space-y-4 lg:sticky lg:top-0">
            <div class="glass-card p-5 border-l-2 border-accent">
                <div class="flex items-center justify-between mb-4 pb-2 border-b border-border/40">
                    <h2
                        class="text-[10px] font-bold text-text-muted uppercase tracking-widest flex items-center gap-2"
                    >
                        <span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>
                        Á≠ñÁï•ÊñπÊ°à
                    </h2>
                </div>

                <div
                    id="strategy-gallery"
                    class="grid grid-cols-2 gap-2 max-h-[calc(100dvh-200px)] overflow-y-auto custom-scrollbar pr-1"
                >
                    {
                        presetStrategies.map(strategy => (
                            <button
                                class="strategy-preset-btn flex flex-col items-center justify-center gap-2 px-2 py-3 rounded-xl bg-surface/30 border border-border/40 hover:border-accent/40 hover:bg-accent/5 transition-all group text-center w-full aspect-square"
                                data-strategy-id={strategy.id}
                            >
                                <span class="text-xl group-hover:scale-110 transition-transform flex-shrink-0">
                                    {strategy.icon}
                                </span>
                                <span class="text-[10px] font-bold text-text-secondary group-hover:text-accent font-mono leading-tight truncate w-full">
                                    {strategy.name}
                                </span>
                            </button>
                        ))
                    }
                    <!-- Custom Strategies Injected Here -->
                </div>
            </div>

            <div class="glass-card p-4 bg-accent/5 border border-accent/10">
                <p class="text-[10px] text-text-muted leading-relaxed font-mono opacity-60">
                    ÈªûÊìäÊñπÊ°àÂèØËá™ÂãïË™øÊï¥‰∏ãÊñπÊªëÊ°øÂèÉÊï∏ÔºåÂø´ÈÄüÁØ©ÈÅ∏ÁõÆÊ®ôÊ®ôÁöÑ„ÄÇ
                </p>
            </div>
        </aside>

        <!-- SECOND COLUMN: Filters + Results (Right) -->
        <div class="lg:col-span-9 space-y-4">
            <!-- TOP of 2nd Col: Quantitative Filters -->
            <div class="glass-card p-5 animate-fade-up">
                <div class="flex items-center justify-between mb-6">
                    <h3
                        class="text-[10px] font-bold text-text-muted uppercase tracking-widest flex items-center gap-2"
                    >
                        <span class="w-2 h-0.5 bg-accent"></span>
                        ÈáèÂåñÁâπÂæµÈÅéÊøæÂô®
                    </h3>
                    <div class="flex items-center gap-4">
                        <div
                            class="flex items-center gap-2 px-3 py-1 rounded bg-surface border border-border/40"
                        >
                            <span id="visible-count" class="text-[11px] font-mono text-accent"
                                >-- Ê™îÁ¨¶Âêà</span
                            >
                        </div>
                        <button
                            id="add-custom-strategy"
                            class="text-accent hover:text-accent-light transition-all font-bold text-[10px] flex items-center justify-center gap-1.5 px-3 py-1.5 rounded bg-accent/10 border border-accent/20 hover:bg-accent/20 active:scale-95"
                        >
                            ‚ú® ÂÑ≤Â≠òÁõÆÂâçÊ¢ù‰ª∂
                        </button>
                    </div>
                </div>

                <div
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-10 gap-y-3"
                    id="slider-container"
                >
                    <!-- PE Slider -->
                    <div class="space-y-1.5 pb-1 border-b border-border/10" data-filter-type="pe">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">Êú¨ÁõäÊØî (PE) &lt; ‚â¶</span>
                            <span class="text-accent font-bold" id="pe-display">100.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="pe"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-pe-max"
                                min="1"
                                max="100"
                                step="1"
                                value="100"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="pe"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- PB Slider -->
                    <div class="space-y-1.5 pb-1 border-b border-border/10" data-filter-type="pb">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">ËÇ°ÂÉπÊ∑®ÂÄºÊØî (PB) &lt; ‚â¶</span>
                            <span class="text-accent font-bold" id="pb-display">10.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="pb"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-pb-max"
                                min="0.1"
                                max="10"
                                step="0.1"
                                value="10"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="pb"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Yield Slider -->
                    <div
                        class="space-y-1.5 pb-1 border-b border-border/10"
                        data-filter-type="yield"
                    >
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">ÊÆñÂà©Áéá (%) > ‚âß</span>
                            <span class="text-bullish font-bold" id="yield-display">0.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="yield"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-yield-min"
                                min="0"
                                max="15"
                                step="0.5"
                                value="0"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="yield"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Volume Slider -->
                    <div
                        class="space-y-1.5 pb-1 border-b border-border/10"
                        data-filter-type="volume"
                    >
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">Êàê‰∫§Èáè (Ëê¨Âºµ) > ‚âß</span>
                            <span class="text-accent font-bold" id="volume-display">0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="volume"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-volume-min"
                                min="0"
                                max="500"
                                step="5"
                                value="0"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="volume"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Price Slider -->
                    <div
                        class="space-y-1.5 pb-1 border-b border-border/10"
                        data-filter-type="price"
                    >
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">ËÇ°ÂÉπÁØÑÂúç (ÂÖÉ) &lt; ‚â¶</span>
                            <span class="text-accent font-bold" id="price-display">2000</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="price"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-price-max"
                                min="10"
                                max="2000"
                                step="10"
                                value="2000"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="price"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- EPS Slider (NEW) -->
                    <div class="space-y-1.5 pb-1 border-b border-border/10" data-filter-type="eps">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">EPS (ÂÖÉ) > ‚âß</span>
                            <span class="text-accent font-bold" id="eps-display">-20.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="eps"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-eps-min"
                                min="-20"
                                max="100"
                                step="0.5"
                                value="-20"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="eps"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Gross Margin Slider (NEW) -->
                    <div
                        class="space-y-1.5 pb-1 border-b border-border/10"
                        data-filter-type="margin"
                    >
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">ÊØõÂà©Áéá (%) > ‚âß</span>
                            <span class="text-accent font-bold" id="margin-display">0.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="margin"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-margin-min"
                                min="0"
                                max="100"
                                step="1"
                                value="0"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="margin"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Revenue YoY Slider (NEW) -->
                    <div class="space-y-1.5 pb-1 border-b border-border/10" data-filter-type="rev">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">ÁáüÊî∂Âπ¥Â¢û (%) > ‚âß</span>
                            <span class="text-accent font-bold" id="rev-display">-100</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="rev"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-rev-min"
                                min="-100"
                                max="500"
                                step="5"
                                value="-100"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="rev"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Net Margin Slider (NEW) -->
                    <div class="space-y-1.5 pb-1 border-b border-border/10" data-filter-type="net">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">Êú¨Ê•≠Áç≤Âà© (ÁáüÁõäÁéá%) > ‚âß</span>
                            <span class="text-accent font-bold" id="net-display">0.0</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="net"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-net-min"
                                min="-20"
                                max="100"
                                step="1"
                                value="0"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="net"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>

                    <!-- Change Slider -->
                    <div
                        class="space-y-1.5 pb-1 border-b border-border/10"
                        data-filter-type="change"
                    >
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-text-muted">‰ªäÊó•Êº≤Ë∑åÂπÖ (%) > ‚âß</span>
                            <span class="font-bold" id="change-display">0.0%</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all font-mono"
                                data-target="change"
                                data-dir="dn">-</button
                            >
                            <input
                                type="range"
                                id="filter-change-min"
                                min="-10"
                                max="10"
                                step="0.5"
                                value="0"
                                class="flex-1 custom-range"
                            />
                            <button
                                class="w-7 h-7 flex items-center justify-center rounded bg-surface/80 border border-border/40 text-text-muted hover:text-accent hover:border-accent/40 active:scale-90 transition-all"
                                data-target="change"
                                data-dir="up">+</button
                            >
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-4">
                    <select
                        id="filter-sector"
                        class="flex shadow-lg bg-surface border border-border/60 rounded px-4 py-3 text-xs font-mono text-text-primary outline-none focus:border-accent"
                    >
                        <option value="">ÂÖ®ÈÉ®Áî¢Ê•≠ÂàÜÈ°û (ALL SECTORS)</option>
                        <option value="semiconductor">ÂçäÂ∞éÈ´î</option>
                        <option value="electronics">ÈõªÂ≠ê</option>
                        <option value="computer">ÈõªËÖ¶ÂèäÈÄ±ÈÇä</option>
                        <option value="communication">ÈÄö‰ø°Á∂≤Ë∑Ø</option>
                        <option value="optoelectronics">ÂÖâÈõª</option>
                        <option value="finance">ÈáëËûçÈáëËûç</option>
                        <option value="biotech">ÁîüÊäÄÈÜ´ÁôÇ</option>
                        <option value="shipping">Ëà™ÈÅã</option>
                        <option value="steel">ÈãºÈêµ</option>
                        <option value="plastic">Â°ëËÜ†</option>
                        <option value="food">È£üÂìÅ</option>
                        <option value="construction">ÁáüÂª∫</option>
                        <option value="auto">Ê±ΩËªä</option>
                        <option value="tourism">ËßÄÂÖâ</option>
                        <option value="energy">ËÉΩÊ∫êÁí∞‰øù</option>
                        <option value="other">ÂÖ∂‰ªñ</option>
                    </select>
                    <div class="flex flex-[2] gap-3">
                        <button
                            id="reset-filters"
                            class="flex-1 btn-ghost border border-border/40 hover:border-accent/40 text-text-muted hover:text-accent py-3 text-[10px] font-mono transition-all uppercase tracking-wider"
                        >
                            RESET ALL
                        </button>
                        <button
                            id="apply-filters"
                            class="flex-[3] btn-cyber py-3 text-xs tracking-[0.2em] font-bold"
                        >
                            Âü∑Ë°åÂ§öÈáçÊ¢ù‰ª∂ÂêåÊ≠•ÊéÉÊèè
                        </button>
                    </div>
                </div>
            </div>

            <!-- BOTTOM of 2nd Col: Target Info table -->
            <div class="glass-card overflow-hidden animate-fade-up" style="animation-delay: 150ms">
                <div
                    class="grid grid-cols-12 gap-2 px-5 py-3 border-b border-border bg-surface/30 text-[11px] font-bold text-text-muted uppercase tracking-wider sticky top-0 z-10 font-mono"
                >
                    <div class="col-span-4 lg:col-span-3">Ê®ôÁöÑ‰ª£Ëôü/ÂêçÁ®±</div>
                    <div class="col-span-2 text-right">Âç≥ÊôÇÁèæÂÉπ</div>
                    <div class="col-span-2 text-right">‰ªäÊó•Êº≤Ë∑å</div>
                    <div class="col-span-2 text-right hidden md:block">Êàê‰∫§(Ëê¨Âºµ)</div>
                    <div class="col-span-1 text-right hidden lg:block">PE</div>
                    <div class="col-span-1 text-right hidden lg:block">ÊÆñÂà©Áéá</div>
                    <div class="col-span-1 text-right hidden lg:block">PB</div>
                </div>

                <div
                    class="divide-y divide-border/20 max-h-[650px] overflow-y-auto custom-scrollbar"
                    id="stock-list-grid"
                >
                    {
                        stocks.map(s => {
                            const bull = s.changePercent > 0;
                            const bear = s.changePercent < 0;
                            return (
                                <a
                                    href={`/stocks/${s.symbol}`}
                                    class="grid grid-cols-12 gap-2 px-5 py-4 hover:bg-glass-hover transition-all group no-underline items-center stock-row border-l-2 border-transparent hover:border-accent"
                                    data-symbol={s.symbol}
                                    data-name={s.name}
                                    data-sector={s.sector}
                                    data-pe={s.pe}
                                    data-pb={s.pb}
                                    data-yield={s.yield}
                                    data-volume={s.volume}
                                    data-price={s.price}
                                    data-change-pct={s.changePercent}
                                    data-eps={s.eps}
                                    data-margin={s.grossMargin}
                                    data-net={s.operatingMargin}
                                    data-rev={s.revenueYoY}
                                    data-astro-prefetch
                                >
                                    <div class="col-span-4 lg:col-span-3 flex items-center gap-3 min-w-0">
                                        <button
                                            class="watchlist-toggle-btn text-text-muted hover:text-accent p-1 transition-colors flex-shrink-0"
                                            data-symbol={s.symbol}
                                        >
                                            <span class="text-sm">‚òÜ</span>
                                        </button>
                                        <div class="min-w-0">
                                            <div class="text-sm font-semibold text-text-primary group-hover:text-accent transition-colors truncate">
                                                {s.name}
                                            </div>
                                            <div class="text-[10px] font-mono text-text-muted opacity-60">
                                                {s.symbol}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-span-2 text-right data-value text-sm font-mono">
                                        {fmtPrice(s.price)}
                                    </div>
                                    <div
                                        class:list={[
                                            'col-span-2 text-right text-xs font-mono font-bold',
                                            bull && 'text-bullish',
                                            bear && 'text-bearish',
                                            !bull && !bear && 'text-text-muted',
                                        ]}
                                    >
                                        {fmtPct(s.changePercent)}
                                    </div>
                                    <div class="col-span-2 text-right text-xs font-mono text-text-secondary hidden md:block">
                                        {s.volume >= 10000
                                            ? (s.volume / 10000).toFixed(1)
                                            : (s.volume / 10000).toFixed(2)}
                                    </div>
                                    <div class="col-span-1 text-right text-xs font-mono text-text-secondary hidden lg:block opacity-70">
                                        {s.pe > 0 ? s.pe.toFixed(1) : '‚Äî'}
                                    </div>
                                    <div class="col-span-1 text-right text-xs font-mono text-accent hidden lg:block">
                                        {s.yield > 0 ? `${s.yield.toFixed(2)}%` : '‚Äî'}
                                    </div>
                                    <div class="col-span-1 text-right text-xs font-mono text-text-secondary hidden lg:block opacity-70">
                                        {s.pb > 0 ? s.pb.toFixed(2) : '‚Äî'}
                                    </div>
                                </a>
                            );
                        })
                    }
                </div>
            </div>
            <div class="text-center py-2">
                <button id="load-more-btn" class="btn-cyber text-xs px-8 py-2 block mx-auto"
                    >Â±ïÈñãÊõ¥Â§öÊï∏Êìö</button
                >
            </div>
        </div>
    </div>

    {/* Error Handling Placeholder */}
    {
        loadError && (
            <div class="glass-card p-10 text-center border-bearish/30 text-bearish font-mono text-sm uppercase mb-4 animate-shake">
                {loadError}
            </div>
        )
    }

    <script>
        let rows: NodeListOf<Element>;
        let displayLimit = 10;

        const updateUI = (id: string, val: string) => {
            const el = document.getElementById(`${id}-display`);
            if (el) el.textContent = val + (id === 'change' ? '%' : '');
            if (id === 'change') {
                const v = parseFloat(val);
                el?.classList.toggle('text-bullish', v > 0);
                el?.classList.toggle('text-bearish', v < 0);
                el?.classList.toggle('text-text-muted', v === 0);
            }
        };

        function updateVisibilityLimit() {
            if (!rows) return;
            let visible = 0;
            const wlStr = localStorage.getItem('watchlist');
            const wl = wlStr ? JSON.parse(wlStr) : [];
            const container = document.getElementById('stock-list-grid');

            if (container) {
                // Read and sort rows, prioritizing watchlist
                const rowArray = Array.from(rows) as HTMLElement[];
                rowArray.sort((a, b) => {
                    const symA = a.dataset.symbol || '';
                    const symB = b.dataset.symbol || '';
                    const aStar = wl.includes(symA);
                    const bStar = wl.includes(symB);
                    if (aStar && !bStar) return -1;
                    if (!aStar && bStar) return 1;
                    return 0;
                });

                // Re-append sorted rows to container
                rowArray.forEach(row => container.appendChild(row));
            }

            rows.forEach((row, i) => {
                const el = row as HTMLElement;
                const sym = el.dataset.symbol || '';
                const starBtn = el.querySelector('.watchlist-toggle-btn span');
                if (starBtn) {
                    const isStarred = wl.includes(sym);
                    starBtn.textContent = isStarred ? '‚òÖ' : '‚òÜ';
                    el.querySelector('.watchlist-toggle-btn')?.classList.toggle(
                        'text-accent',
                        isStarred
                    );
                }

                if (el.classList.contains('filter-hidden')) {
                    el.style.display = 'none';
                    return;
                }
                el.style.display = visible < displayLimit ? '' : 'none';
                if (visible < displayLimit) visible++;
            });
        }

        function initFilters() {
            rows = document.querySelectorAll('.stock-row');
            const vc = document.getElementById('visible-count');

            const ranges = {
                pe: document.getElementById('filter-pe-max') as HTMLInputElement,
                pb: document.getElementById('filter-pb-max') as HTMLInputElement,
                yield: document.getElementById('filter-yield-min') as HTMLInputElement,
                volume: document.getElementById('filter-volume-min') as HTMLInputElement,
                price: document.getElementById('filter-price-max') as HTMLInputElement,
                change: document.getElementById('filter-change-min') as HTMLInputElement,
                eps: document.getElementById('filter-eps-min') as HTMLInputElement,
                margin: document.getElementById('filter-margin-min') as HTMLInputElement,
                net: document.getElementById('filter-net-min') as HTMLInputElement,
                rev: document.getElementById('filter-rev-min') as HTMLInputElement,
            };

            const sectorSelect = document.getElementById('filter-sector') as HTMLSelectElement;

            const applyFilters = () => {
                const filters = {
                    pe: parseFloat(ranges.pe.value),
                    pb: parseFloat(ranges.pb.value),
                    yield: parseFloat(ranges.yield.value),
                    volume: parseFloat(ranges.volume.value) * 10000,
                    price: parseFloat(ranges.price.value),
                    change: parseFloat(ranges.change.value),
                    eps: parseFloat(ranges.eps.value),
                    margin: parseFloat(ranges.margin.value),
                    net: parseFloat(ranges.net.value),
                    rev: parseFloat(ranges.rev.value),
                    sector: sectorSelect.value,
                };

                let count = 0;
                rows.forEach(row => {
                    const el = row as HTMLElement;
                    const d = {
                        pe: parseFloat(el.dataset.pe || '0'),
                        pb: parseFloat(el.dataset.pb || '0'),
                        yield: parseFloat(el.dataset.yield || '0'),
                        volume: parseFloat(el.dataset.volume || '0'),
                        price: parseFloat(el.dataset.price || '0'),
                        changePct: parseFloat(el.dataset.changePct || '0'),
                        eps: parseFloat(el.dataset.eps || '0'),
                        margin: parseFloat(el.dataset.margin || '0'),
                        net: parseFloat(el.dataset.net || '0'),
                        rev: parseFloat(el.dataset.rev || '0'),
                        sector: el.dataset.sector || '',
                    };

                    let match = true;
                    if (filters.sector && d.sector !== filters.sector) match = false;
                    if (d.pe > filters.pe && d.pe > 0) match = false;
                    if (d.pb > filters.pb && d.pb > 0) match = false;
                    if (d.yield < filters.yield) match = false;
                    if (d.volume < filters.volume) match = false;
                    if (d.price > filters.price) match = false;
                    if (d.changePct < filters.change) match = false;
                    if (d.eps < filters.eps) match = false;
                    if (d.margin < filters.margin) match = false;
                    if (d.net < filters.net) match = false;
                    if (d.rev < filters.rev) match = false;

                    if (match) {
                        el.classList.remove('filter-hidden');
                        count++;
                    } else {
                        el.classList.add('filter-hidden');
                    }
                });

                if (vc) vc.textContent = `${count} Ê™îÁ¨¶Âêà`;
                updateVisibilityLimit();
            };

            // Sync Slider Display and Logic
            Object.entries(ranges).forEach(([key, input]) => {
                input.addEventListener('input', () => {
                    updateUI(key, input.value);
                });
            });

            // Adjust Buttons (+ / -)
            document.querySelectorAll('button[data-target]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = (btn as HTMLElement).dataset.target;
                    const dir = (btn as HTMLElement).dataset.dir;
                    if (!target) return;
                    const input = ranges[target as keyof typeof ranges];
                    const step = parseFloat(input.step) || 1;
                    if (dir === 'up') input.value = (parseFloat(input.value) + step).toString();
                    else input.value = (parseFloat(input.value) - step).toString();
                    updateUI(target, input.value);
                });
            });

            document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
            document.getElementById('reset-filters')?.addEventListener('click', () => {
                location.reload();
            });

            // Strategy Clicks
            document.querySelectorAll('.strategy-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sid = (btn as HTMLElement).dataset.strategyId;

                    // Reset Active States
                    document
                        .querySelectorAll('.strategy-preset-btn, .custom-strat button')
                        .forEach(b => {
                            b.classList.remove('border-accent', 'bg-accent/10', 'active-strategy');
                        });
                    btn.classList.add('border-accent', 'bg-accent/10', 'active-strategy');

                    ranges.pe.value = '100';
                    updateUI('pe', '100');
                    ranges.pb.value = '10';
                    updateUI('pb', '10');
                    ranges.yield.value = '0';
                    updateUI('yield', '0');
                    ranges.volume.value = '0';
                    updateUI('volume', '0');
                    ranges.price.value = '2000';
                    updateUI('price', '2000');
                    updateUI('price', '2000');
                    ranges.change.value = '0';
                    updateUI('change', '0');
                    ranges.eps.value = '-20';
                    updateUI('eps', '-20');
                    ranges.margin.value = '0';
                    updateUI('margin', '0');
                    ranges.net.value = '-20';
                    updateUI('net', '-20');
                    ranges.rev.value = '-100';
                    updateUI('rev', '-100');
                    sectorSelect.value = '';

                    // Apply specific strategy constraints
                    if (sid === 'low-pe') {
                        ranges.pe.value = '15';
                        updateUI('pe', '15');
                    } else if (sid === 'low-pb') {
                        ranges.pb.value = '1.2';
                        updateUI('pb', '1.2');
                    } else if (sid === 'high-dividend') {
                        ranges.yield.value = '5';
                        updateUI('yield', '5');
                    } else if (sid === 'high-roe') {
                        ranges.eps.value = '5';
                        ranges.margin.value = '15';
                        updateUI('eps', '5');
                        updateUI('margin', '15');
                    } else if (sid === 'revenue-growth') {
                        ranges.rev.value = '15';
                        updateUI('rev', '15');
                    } else if (sid === 'high-margin') {
                        ranges.margin.value = '25';
                        updateUI('margin', '25');
                    } else if (sid === 'volume-breakout') {
                        ranges.volume.value = '100';
                        updateUI('volume', '100');
                    } else if (sid === 'positive-fcf') {
                        ranges.net.value = '10';
                        updateUI('net', '10');
                    }

                    // Add more mappings as needed for other IDs...

                    applyFilters();
                });
            });

            // Custom Strategy Loader
            const gallery = document.getElementById('strategy-gallery');
            const loadCustom = () => {
                const stored = localStorage.getItem('custom_strategies');
                if (!stored || !gallery) return;
                const strategies = JSON.parse(stored);
                document.querySelectorAll('.custom-strat').forEach(el => el.remove());
                strategies.forEach((s: any) => {
                    const btn = document.createElement('div');
                    btn.className = 'relative group custom-strat flex-shrink-0';
                    btn.innerHTML = `
                         <button class="flex flex-col items-center justify-center gap-2 px-2 py-3 rounded-xl bg-accent/5 border border-accent/20 hover:border-accent/40 transition-all group text-center w-full aspect-square text-accent">
                            <span class="text-xl group-hover:scale-110 transition-transform flex-shrink-0">üë§</span>
                            <span class="text-[10px] font-bold font-mono leading-tight truncate w-full">${s.name}</span>
                        </button>
                        <button class="del-strat absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">√ó</button>
                    `;
                    btn.querySelector('button')?.addEventListener('click', () => {
                        // Custom logic for custom strategied could be more complex, currently just triggers PE
                        if (s.filters.peMax) {
                            ranges.pe.value = s.filters.peMax;
                            updateUI('pe', s.filters.peMax);
                        }
                        applyFilters();
                    });
                    btn.querySelector('.del-strat')?.addEventListener('click', () => {
                        const updated = JSON.parse(
                            localStorage.getItem('custom_strategies') || '[]'
                        ).filter((i: any) => i.name !== s.name);
                        localStorage.setItem('custom_strategies', JSON.stringify(updated));
                        loadCustom();
                    });
                    gallery.appendChild(btn);
                });
            };
            document.getElementById('add-custom-strategy')?.addEventListener('click', () => {
                const n = prompt('ÊñπÊ°àÂêçÁ®±:');
                if (n) {
                    const current = JSON.parse(localStorage.getItem('custom_strategies') || '[]');
                    current.push({ name: n, filters: { peMax: ranges.pe.value } });
                    localStorage.setItem('custom_strategies', JSON.stringify(current));
                    loadCustom();
                }
            });
            loadCustom();
            applyFilters();
        }

        function init() {
            initFilters();
            document.getElementById('load-more-btn')?.addEventListener('click', () => {
                displayLimit += 50;
                updateVisibilityLimit();
            });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();
        document.addEventListener('astro:page-load', init);

        document.addEventListener('click', e => {
            const btn = (e.target as HTMLElement).closest('.watchlist-toggle-btn');
            if (btn) {
                e.preventDefault();
                const code = (btn as HTMLElement).dataset.symbol;
                if (!code) return;

                let wlStr = localStorage.getItem('watchlist');
                let wl: string[] = wlStr ? JSON.parse(wlStr) : [];

                if (wl.includes(code)) {
                    wl = wl.filter(c => c !== code);
                } else {
                    wl.push(code);
                }
                localStorage.setItem('watchlist', JSON.stringify(wl));

                const star = btn.querySelector('span')!;
                const isStarred = wl.includes(code);
                star.textContent = isStarred ? '‚òÖ' : '‚òÜ';
                btn.classList.toggle('text-accent', isStarred);

                updateVisibilityLimit(); // Re-sort and render
            }
        });
    </script>
    <style>
        .custom-range {
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            transition: all 0.2s;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        .custom-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
    </style>
</MainTerminal>
