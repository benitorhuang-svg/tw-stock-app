---
/**
 * screener.astro — Stock Screener Analysis Terminal
 * Advanced multi-vector entity selection and forensic filtering.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import ScreenerController from '../components/organisms/ScreenerController.svelte';
import ForensicTicker from '../components/molecules/ForensicTicker.astro';

try {
    const svc = await import('../utils/stockDataService');
    await svc.getStocksWithPrices();
} catch (e) {
    console.error('[Screener Engine] Initial load error:', e);
}

const { strategies: allStrategies } = await import('../data/strategies');
const supportedIds = [
    'low-pe',
    'low-pb',
    'high-dividend',
    'revenue-growth',
    'high-margin',
    'volume-breakout',
    'high-roe',
    'positive-fcf',
    'foreign-buy',
    'trust-buy',
];
const presetStrategies = allStrategies.filter(s => supportedIds.includes(s.id));
---

<MainTerminal title="選股中心">
    <div slot="header-actions" class="flex items-center gap-2">
        <button
            id="ai-screener-btn"
            class="flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.15em] uppercase border backdrop-blur-md group bg-accent/10 border-accent/30 text-accent hover:bg-accent/20 hover:border-accent/50 hover:shadow-[0_0_20px_rgba(var(--accent-rgb),0.2)] cursor-pointer"
        >
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a4 4 0 0 1 4 4v1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h0a8 8 0 0 1-8 0h0a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2V6a4 4 0 0 1 4-4z"/>
                <path d="M9 18v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2"/>
                <circle cx="10" cy="8" r="1" fill="currentColor"/>
                <circle cx="14" cy="8" r="1" fill="currentColor"/>
            </svg>
            <span>執行AI選股</span>
        </button>
    </div>

    <div class="relative pb-20 pt-0 px-4 lg:px-6">
        <ScreenerController client:load presetStrategies={presetStrategies} />

        <!-- Signal Stream -->
        <div
            class="flex items-center justify-between pt-4 px-4 bg-surface/5 rounded-xl border border-border/5 mb-6"
        >
            <ForensicTicker />
            <span class="text-[9px] font-mono text-text-muted/40 uppercase tracking-widest"
                >Database_Frame: LATEST_60D_SYNC</span
            >
        </div>
    </div>

    <!-- Client Script -->
    <script src="../scripts/screener-engine.ts"></script>
</MainTerminal>
