---
import Layout from '../../layouts/Layout.astro';
import StrategyCard from '../../components/molecules/StrategyCard.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageHero from '../../components/molecules/PageHero.astro';
import { getStrategiesByCategory } from '../../data/strategies';
import { getDb } from '../../utils/db';

const fundamentalStrategies = getStrategiesByCategory('fundamental');
const technicalStrategies = getStrategiesByCategory('technical');
const sentimentStrategies = getStrategiesByCategory('sentiment');

const db = getDb();

function getStrategyCount(sql?: string): number {
    if (!sql) return 0;
    try {
        const stmt = db.prepare(sql);
        const result = stmt.get() as { count: number };
        return result.count;
    } catch (e) {
        return 0;
    }
}

const categories = [
    { value: 'fundamental', label: 'FUNDAMENTAL' },
    { value: 'technical', label: 'TECHNICAL' },
    { value: 'sentiment', label: 'SENTIMENT' },
];
---

<Layout title="Strategy Matrix | TW Stock App">
    <div class="strategy-container">
        <!-- Hero Header -->
        <PageHero
            icon="üéØ"
            title="STRATEGY_MATRIX"
            subtitle="Algorithmic screening modules & preset conditions"
            glowClass="accent-glow"
        >
            <div class="sys-status" slot="action">
                <span class="pulse-dot"></span>
                <span class="mono">DB_CONNECTED</span>
            </div>
        </PageHero>

        <!-- Filter Bar -->
        <div class="cyber-reveal" style="animation-delay: 0.2s;">
            <FilterBar categories={categories} />
        </div>

        <!-- Strategy Sections -->
        <div id="strategies-container" class="cyber-reveal" style="animation-delay: 0.3s;">
            <!-- Fundamental -->
            <section class="strategy-section" data-category="fundamental">
                <header class="section-header">
                    <h2 class="mono"><span class="text-accent">üèõÔ∏è</span> FUNDAMENTAL_ALGORITHMS</h2>
                    <p class="mono text-muted">Value & Growth driven analysis</p>
                </header>
                <div class="matrix-grid">
                    {
                        fundamentalStrategies.map((strategy, i) => (
                            <div class="matrix-item" style={`animation-delay: ${0.1 * i}s`}>
                                <StrategyCard
                                    strategy={strategy}
                                    count={getStrategyCount(strategy.sql)}
                                />
                            </div>
                        ))
                    }
                </div>
            </section>

            <!-- Technical -->
            <section class="strategy-section" data-category="technical">
                <header class="section-header">
                    <h2 class="mono"><span class="text-pos">üìà</span> TECHNICAL_ALGORITHMS</h2>
                    <p class="mono text-muted">Price action & momentum driven</p>
                </header>
                <div class="matrix-grid">
                    {
                        technicalStrategies.map((strategy, i) => (
                            <div class="matrix-item" style={`animation-delay: ${0.1 * i}s`}>
                                <StrategyCard
                                    strategy={strategy}
                                    count={getStrategyCount(strategy.sql)}
                                />
                            </div>
                        ))
                    }
                </div>
            </section>

            <!-- Sentiment -->
            <section class="strategy-section" data-category="sentiment">
                <header class="section-header">
                    <h2 class="mono">
                        <span class="text-warn" style="color:#f59e0b;">üí∞</span> SENTIMENT_ALGORITHMS
                    </h2>
                    <p class="mono text-muted">Institutional flow tracking</p>
                </header>
                <div class="matrix-grid">
                    {
                        sentimentStrategies.map((strategy, i) => (
                            <div class="matrix-item" style={`animation-delay: ${0.1 * i}s`}>
                                <StrategyCard
                                    strategy={strategy}
                                    count={getStrategyCount(strategy.sql)}
                                />
                            </div>
                        ))
                    }
                </div>
            </section>
        </div>
    </div>
</Layout>

<style>
    .strategy-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
        max-width: 1400px;
        margin: 0 auto;
        padding-bottom: 60px;
    }

    /* Glass Base & Glows */
    .glass-card {
        background: var(--c-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--c-border-glass, rgba(60, 80, 120, 0.2));
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }
    .glow-wrapper {
        position: relative;
    }
    .glow-bg {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        transition: opacity 0.3s ease;
        background: radial-gradient(
            400px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
            var(--glow-color, rgba(255, 255, 255, 0.05)),
            transparent 40%
        );
    }
    .glow-wrapper:hover .glow-bg {
        opacity: 1;
    }
    .accent-glow {
        --glow-color: rgba(59, 130, 246, 0.1);
    }

    /* Hero */
    .page-hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        z-index: 10;
    }
    .hero-left {
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 1;
    }
    .icon-box {
        width: 56px;
        height: 56px;
        background: rgba(var(--c-accent-rgb), 0.1);
        border: 1px solid rgba(var(--c-accent-rgb), 0.3);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .hero-left h1 {
        font-size: 16px;
        margin: 0;
        letter-spacing: 2px;
    }
    .hero-left p {
        font-size: 11px;
        margin: 4px 0 0;
    }
    .sys-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        z-index: 1;
        color: var(--c-text-muted);
    }
    .pulse-dot {
        width: 6px;
        height: 6px;
        background: var(--c-success);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--c-success);
    }

    /* Sections */
    .strategy-section {
        transition:
            opacity 0.3s,
            transform 0.3s;
        margin-bottom: 40px;
    }
    .strategy-section.hidden {
        display: none;
    }

    .section-header {
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding-bottom: 12px;
    }
    .section-header h2 {
        font-size: 16px;
        margin: 0 0 4px 0;
        letter-spacing: 2px;
    }
    .section-header p {
        font-size: 10px;
        margin: 0;
    }

    .matrix-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .matrix-item {
        animation: cyber-reveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
    }
</style>

<script>
    // Glow Tracker
    document.addEventListener('mousemove', e => {
        const wrappers = document.querySelectorAll('.glow-wrapper');
        wrappers.forEach(wrapper => {
            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            (wrapper as HTMLElement).style.setProperty('--mouse-x', `${x}px`);
            (wrapper as HTMLElement).style.setProperty('--mouse-y', `${y}px`);
        });
    });

    window.addEventListener('filter-change', ((e: CustomEvent) => {
        const category = e.detail.category;
        document.querySelectorAll('.strategy-section').forEach(section => {
            const sectionCategory = section.getAttribute('data-category');
            if (category === 'all' || sectionCategory === category) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });
    }) as EventListener);
</script>
