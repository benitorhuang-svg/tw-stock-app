---
import Layout from '../layouts/Layout.astro';
---

<Layout title="TWSE å³æ™‚è³‡æ–™">
    <h1>ğŸ“¡ TWSE å³æ™‚è³‡æ–™</h1>
    <p class="page-desc">å¾è­‰äº¤æ‰€ API å–å¾—æœ€æ–°è‚¡ç¥¨è³‡æ–™</p>

    <!-- çµæœé¡¯ç¤ºå€ -->

    <!-- çµæœé¡¯ç¤ºå€ -->
    <div id="result" class="result-container hidden">
        <div class="stock-header">
            <h2 id="stock-name">--</h2>
            <div class="price-group">
                <span id="stock-price" class="price">--</span>
                <span id="stock-change" class="change">--</span>
            </div>
            <div id="update-time" class="update-time">--</div>
        </div>

        <div id="info-grid" class="info-grid">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div id="error" class="error hidden"></div>

    <!-- è³‡æ–™çµ±è¨ˆ -->
    <div id="stats" class="stats hidden">
        <div class="stat-item">
            <span class="stat-label">è³‡æ–™æ—¥æœŸ</span>
            <span id="stat-date" class="stat-value">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">è‚¡ç¥¨æ•¸é‡</span>
            <span id="stat-count" class="stat-value">-</span>
        </div>
    </div>

    <!-- è³‡æ–™è¡¨æ ¼ -->
    <div id="table-container" class="table-container hidden">
        <div class="table-controls">
            <input
                type="text"
                id="table-search"
                placeholder="ğŸ” æœå°‹ä»£è™Ÿæˆ–åç¨±..."
                class="search-input"
            />
            <select id="sort-select" class="sort-select">
                <option value="symbol">ä¾ä»£è™Ÿæ’åº</option>
                <option value="yield-desc">æ®–åˆ©ç‡ é«˜â†’ä½</option>
                <option value="pe-asc">æœ¬ç›Šæ¯” ä½â†’é«˜</option>
                <option value="pb-asc">æ·¨å€¼æ¯” ä½â†’é«˜</option>
            </select>
        </div>
        <div class="table-scroll">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>æ®–åˆ©ç‡ %</th>
                        <th>æœ¬ç›Šæ¯”</th>
                        <th>æ·¨å€¼æ¯”</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</Layout>

<style>
    .page-desc {
        color: var(--text-secondary);
        margin-bottom: 32px;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 32px;
    }

    .controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
    }

    .controls input[type='date'] {
        padding: 10px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .btn-primary {
        padding: 10px 24px;
        background: var(--accent, #00d4aa);
        color: #000;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 24px;
        background: var(--bg-card);
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .error {
        padding: 16px 24px;
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 12px;
        color: #ff4757;
        margin-bottom: 24px;
    }

    .hidden {
        display: none !important;
    }

    .stats {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }

    .stat-item {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 24px;
    }

    .stat-label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--accent);
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
    }

    .table-controls {
        display: flex;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid var(--border);
    }

    .search-input,
    .sort-select {
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .search-input {
        flex: 1;
        max-width: 300px;
    }

    .table-scroll {
        max-height: 600px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.85rem;
        color: var(--text-secondary);
        position: sticky;
        top: 0;
    }

    tr:hover {
        background: rgba(0, 212, 170, 0.05);
    }

    .symbol {
        font-weight: 700;
        color: var(--accent);
    }

    .yield-high {
        color: var(--positive);
        font-weight: 600;
    }

    .pe-low {
        color: var(--positive);
        font-weight: 600;
    }
</style>

<script>
    // Get Elements
    // const symbolInput = document.getElementById('symbol-input') as HTMLInputElement; // Removed
    // const fetchBtn = document.getElementById('fetch-btn'); // Removed
    const resultEl = document.getElementById('result');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');

    // Initialize
    if (loadingEl) loadingEl.classList.add('hidden');
    if (errorEl) errorEl.classList.add('hidden');

    // Auto-fetch from URL param
    const urlParams = new URLSearchParams(window.location.search);
    const symbolParam = urlParams.get('symbol');

    if (symbolParam) {
        fetchData(symbolParam.trim());
    } else {
        // Show empty state or instructions
        if (resultEl) {
            resultEl.innerHTML =
                '<div style="text-align:center; padding:60px 20px; color:var(--text-secondary);"><div style="font-size:48px; margin-bottom:16px;">ğŸ”</div><div style="font-size:18px;">è«‹ä½¿ç”¨ä¸Šæ–¹å°èˆªåˆ—è¼¸å…¥ä»£è™Ÿ<br>æŸ¥è©¢å³æ™‚è‚¡åƒ¹</div></div>';
            resultEl.classList.remove('hidden');
        }
    }

    /*
    // Event Listeners - Removed
    fetchBtn?.addEventListener('click', () => handleSearch());
    symbolInput?.addEventListener('keypress', e => {
        if (e.key === 'Enter') handleSearch();
    });

    function handleSearch() {
        const symbol = symbolInput?.value.trim();
        if (symbol) {
            fetchData(symbol);
        }
    }
    */

    async function fetchData(symbol: string) {
        showLoading(true);
        showError(null); // Clear error
        if (resultEl) resultEl.classList.add('hidden');

        try {
            // Add timestamp to prevent caching
            const response = await fetch(`/api/live-quote.json?symbol=${symbol}&t=${Date.now()}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'ç„¡æ³•å–å¾—è³‡æ–™');
            }

            renderData(data);
        } catch (err: any) {
            showError(`${err.message} (Symbol: ${symbol})`);
        } finally {
            showLoading(false);
        }
    }

    function renderData(data: any) {
        if (!resultEl) return;

        const nameEl = document.getElementById('stock-name');
        const priceEl = document.getElementById('stock-price');
        const changeEl = document.getElementById('stock-change');
        const updateTimeEl = document.getElementById('update-time');
        const infoGridEl = document.getElementById('info-grid');

        if (nameEl) nameEl.textContent = `${data.symbol} å³æ™‚è¡Œæƒ…`;
        if (priceEl) priceEl.textContent = data.price.toFixed(2);

        if (changeEl) {
            const changeSign = data.change > 0 ? '+' : '';
            const changeClass = data.change > 0 ? 'up' : data.change < 0 ? 'down' : '';
            changeEl.textContent = `${changeSign}${data.change.toFixed(2)} (${changeSign}${data.changePercent.toFixed(2)}%)`;
            changeEl.className = `stock-change ${changeClass}`;
        }

        if (updateTimeEl) {
            updateTimeEl.textContent = `è³‡æ–™æ™‚é–“: ${new Date(data.time).toLocaleString('zh-TW')}`;
        }

        if (infoGridEl) {
            infoGridEl.innerHTML = `
                <div class="info-item">
                    <span class="label">é–‹ç›¤</span>
                    <span class="value">${formatNumber(data.open)}</span>
                </div>
                <div class="info-item">
                    <span class="label">æœ€é«˜</span>
                    <span class="value">${formatNumber(data.high)}</span>
                </div>
                <div class="info-item">
                    <span class="label">æœ€ä½</span>
                    <span class="value">${formatNumber(data.low)}</span>
                </div>
                <div class="info-item">
                    <span class="label">æ˜¨æ”¶</span>
                    <span class="value">${formatNumber(data.previousClose)}</span>
                </div>
                <div class="info-item">
                    <span class="label">æˆäº¤é‡</span>
                    <span class="value">${formatVolume(data.volume)} å¼µ</span>
                </div>
            `;
        }

        resultEl.classList.remove('hidden');
    }

    function showLoading(show: boolean) {
        // Since fetchBtn is removed, we could add a global loading indicator here if needed.
        // For now, the previous content is hidden and we just wait.
        if (loadingEl) {
            if (show) loadingEl.classList.remove('hidden');
            else loadingEl.classList.add('hidden');
        }
    }

    function showError(message: string | null) {
        if (!errorEl) return;
        if (message) {
            errorEl.textContent = `âŒ ${message}`;
            errorEl.classList.remove('hidden');
        } else {
            errorEl.classList.add('hidden');
        }
    }

    function formatNumber(num: number) {
        return num ? num.toFixed(2) : '-';
    }

    function formatVolume(vol: number) {
        return vol ? (vol / 1000).toFixed(0) : '0';
    }
</script>
