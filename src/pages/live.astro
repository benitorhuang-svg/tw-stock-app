---
/**
 * live.astro â€” Momentum_Nexus (FORCE_FIELD) Terminal
 * High-fidelity real-time data orchestration with modular architecture.
 */
import MainTerminal from '../layouts/MainTerminal.astro';
import LiveFilterPanel from '../components/organisms/LiveFilterPanel.astro';
import LiveControlPanel from '../components/organisms/LiveControlPanel.astro';
import LiveDataTable from '../components/organisms/LiveDataTable.svelte';
import SyncHourglass from '../components/atoms/SyncHourglass.astro';
---

<MainTerminal title="Momentum_Nexus (FORCE_FIELD)" fullWidth>
    <div slot="header-actions" class="flex items-center justify-center mr-2 gap-2">
        <div class="flex items-center gap-1.5 font-mono text-text-muted shrink-0 mr-1">
            <span class="opacity-40 text-[9px] hidden sm:inline uppercase">Uplink_Sync:</span>
            <span id="last-update-time" class="text-accent tracking-widest font-black text-[10px]"
                >--:--:--</span
            >
        </div>
        <SyncHourglass size="small" />
    </div>

    <div class="bg-base relative">
        <main class="p-4 lg:p-6 lg:pb-0 flex flex-col">
            <span id="live-indicator" class="hidden"></span>

            <!-- Unified Command HUD -->
            <div
                class="flex flex-col border border-border rounded-2xl overflow-hidden bg-surface/20 shadow-elevated"
            >
                <!-- Dashboard Toolbar (sticky) -->
                <div
                    id="live-toolbar-nexus"
                    class="flex flex-wrap lg:flex-nowrap items-center gap-3 px-6 py-4 bg-surface/95 border-b border-border sticky top-0 z-30 backdrop-blur-md shadow-sm"
                >
                    <div class="flex-1 min-w-0">
                        <LiveFilterPanel />
                    </div>
                    <div
                        class="flex items-center justify-end gap-4 shrink-0 border-l border-border pl-4"
                    >
                        <LiveControlPanel />
                    </div>
                </div>

                <!-- Momentum Grid -->
                <div class="bg-surface/5">
                    <LiveDataTable client:load />
                </div>
            </div>

            <!-- System Status Line -->
            <div
                class="flex items-center justify-between px-2 py-3 text-[8px] font-mono text-text-muted/30 uppercase tracking-[0.2em]"
            >
                <div>Session_ID: {Math.random().toString(36).slice(7).toUpperCase()}</div>
                <div class="flex items-center gap-4">
                    <span>Frame_Rate: 60FPS</span>
                    <span class="text-accent/40">Data_Source: TWSE_Realtime_Nexus</span>
                </div>
            </div>
        </main>
    </div>

    <script src="../scripts/live-engine.ts"></script>
    <script>
        // Precision Sync for Sticky Offset
        const updateToolbarHeight = () => {
            const toolbar = document.getElementById('live-toolbar-nexus');
            if (toolbar) {
                document.documentElement.style.setProperty(
                    '--toolbar-nexus-height',
                    `${toolbar.offsetHeight}px`
                );
            }
        };

        const observer = new ResizeObserver(updateToolbarHeight);
        const toolbar = document.getElementById('live-toolbar-nexus');
        if (toolbar) {
            observer.observe(toolbar);
            updateToolbarHeight();
        }

        document.addEventListener('astro:page-load', updateToolbarHeight);
    </script>
</MainTerminal>

<style is:global>
    @keyframes hourglass-flip {
        0%,
        90% {
            transform: rotate(0deg);
        }
        92% {
            transform: rotate(-10deg);
        }
        98% {
            transform: rotate(190deg);
        }
        100% {
            transform: rotate(180deg);
        }
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
        height: 5px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Restore natural scrolling for the main workspace */
    #main-workspace {
        overflow-y: auto !important;
        height: auto !important;
        display: block;
    }
    #main-workspace > div {
        flex: none;
        display: block;
        min-height: auto;
    }
</style>
