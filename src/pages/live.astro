---
import Layout from "../layouts/Layout.astro";
---

<Layout title="TWSE å³æ™‚è³‡æ–™">
    <h1>ğŸ“¡ TWSE å³æ™‚è³‡æ–™</h1>
    <p class="page-desc">å¾è­‰äº¤æ‰€ API å–å¾—æœ€æ–°è‚¡ç¥¨è³‡æ–™</p>

    <!-- æ—¥æœŸé¸æ“‡ -->
    <div class="controls">
        <label>
            æŸ¥è©¢æ—¥æœŸï¼š
            <input type="date" id="date-input" />
        </label>
        <button id="fetch-btn" class="btn-primary">å–å¾—è³‡æ–™</button>
    </div>

    <!-- è¼‰å…¥ç‹€æ…‹ -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <span>æ­£åœ¨å¾è­‰äº¤æ‰€å–å¾—è³‡æ–™...</span>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div id="error" class="error hidden"></div>

    <!-- è³‡æ–™çµ±è¨ˆ -->
    <div id="stats" class="stats hidden">
        <div class="stat-item">
            <span class="stat-label">è³‡æ–™æ—¥æœŸ</span>
            <span id="stat-date" class="stat-value">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">è‚¡ç¥¨æ•¸é‡</span>
            <span id="stat-count" class="stat-value">-</span>
        </div>
    </div>

    <!-- è³‡æ–™è¡¨æ ¼ -->
    <div id="table-container" class="table-container hidden">
        <div class="table-controls">
            <input
                type="text"
                id="table-search"
                placeholder="ğŸ” æœå°‹ä»£è™Ÿæˆ–åç¨±..."
                class="search-input"
            />
            <select id="sort-select" class="sort-select">
                <option value="symbol">ä¾ä»£è™Ÿæ’åº</option>
                <option value="yield-desc">æ®–åˆ©ç‡ é«˜â†’ä½</option>
                <option value="pe-asc">æœ¬ç›Šæ¯” ä½â†’é«˜</option>
                <option value="pb-asc">æ·¨å€¼æ¯” ä½â†’é«˜</option>
            </select>
        </div>
        <div class="table-scroll">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>æ®–åˆ©ç‡ %</th>
                        <th>æœ¬ç›Šæ¯”</th>
                        <th>æ·¨å€¼æ¯”</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</Layout>

<style>
    .page-desc {
        color: var(--text-secondary);
        margin-bottom: 32px;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 32px;
    }

    .controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
    }

    .controls input[type="date"] {
        padding: 10px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .btn-primary {
        padding: 10px 24px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 24px;
        background: var(--bg-card);
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .error {
        padding: 16px 24px;
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 12px;
        color: #ff4757;
        margin-bottom: 24px;
    }

    .hidden {
        display: none !important;
    }

    .stats {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }

    .stat-item {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 24px;
    }

    .stat-label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--accent);
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
    }

    .table-controls {
        display: flex;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid var(--border);
    }

    .search-input,
    .sort-select {
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .search-input {
        flex: 1;
        max-width: 300px;
    }

    .table-scroll {
        max-height: 600px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.85rem;
        color: var(--text-secondary);
        position: sticky;
        top: 0;
    }

    tr:hover {
        background: rgba(0, 212, 170, 0.05);
    }

    .symbol {
        font-weight: 700;
        color: var(--accent);
    }

    .yield-high {
        color: var(--positive);
        font-weight: 600;
    }

    .pe-low {
        color: var(--positive);
        font-weight: 600;
    }
</style>

<script>
    let allData: any[] = [];

    // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
    const dateInput = document.getElementById("date-input") as HTMLInputElement;
    const today = new Date();
    dateInput.value = today.toISOString().split("T")[0];

    // å–å¾—è³‡æ–™æŒ‰éˆ•
    document.getElementById("fetch-btn")?.addEventListener("click", fetchData);

    async function fetchData() {
        const dateInput = document.getElementById(
            "date-input",
        ) as HTMLInputElement;
        const loading = document.getElementById("loading")!;
        const error = document.getElementById("error")!;
        const stats = document.getElementById("stats")!;
        const tableContainer = document.getElementById("table-container")!;
        const fetchBtn = document.getElementById(
            "fetch-btn",
        ) as HTMLButtonElement;

        // æ ¼å¼åŒ–æ—¥æœŸ
        const date = dateInput.value.replace(/-/g, "");

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        loading.classList.remove("hidden");
        error.classList.add("hidden");
        stats.classList.add("hidden");
        tableContainer.classList.add("hidden");
        fetchBtn.disabled = true;

        try {
            const res = await fetch(`/api/pe-ratios.json?date=${date}`);
            const json = await res.json();

            if (!res.ok) {
                throw new Error(json.error || "å–å¾—è³‡æ–™å¤±æ•—");
            }

            allData = json.data;

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById("stat-date")!.textContent = json.date;
            document.getElementById("stat-count")!.textContent =
                `${json.count} æª”`;
            stats.classList.remove("hidden");

            // æ¸²æŸ“è¡¨æ ¼
            renderTable(allData);
            tableContainer.classList.remove("hidden");
        } catch (err: any) {
            error.textContent = `âŒ éŒ¯èª¤ï¼š${err.message}`;
            error.classList.remove("hidden");
        } finally {
            loading.classList.add("hidden");
            fetchBtn.disabled = false;
        }
    }

    function renderTable(data: any[]) {
        const tbody = document.getElementById("table-body")!;
        tbody.innerHTML = data
            .map(
                (row) => `
            <tr>
                <td class="symbol">${row.symbol}</td>
                <td>${row.name}</td>
                <td class="${row.yield >= 5 ? "yield-high" : ""}">${row.yield || "-"}</td>
                <td class="${row.pe > 0 && row.pe < 15 ? "pe-low" : ""}">${row.pe || "-"}</td>
                <td>${row.pb || "-"}</td>
            </tr>
        `,
            )
            .join("");
    }

    // æœå°‹åŠŸèƒ½
    document.getElementById("table-search")?.addEventListener("input", (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();
        const filtered = allData.filter(
            (row) =>
                row.symbol.toLowerCase().includes(query) ||
                row.name.toLowerCase().includes(query),
        );
        renderTable(filtered);
    });

    // æ’åºåŠŸèƒ½
    document.getElementById("sort-select")?.addEventListener("change", (e) => {
        const value = (e.target as HTMLSelectElement).value;
        let sorted = [...allData];

        switch (value) {
            case "yield-desc":
                sorted.sort((a, b) => (b.yield || 0) - (a.yield || 0));
                break;
            case "pe-asc":
                sorted.sort((a, b) => {
                    if (!a.pe || a.pe <= 0) return 1;
                    if (!b.pe || b.pe <= 0) return -1;
                    return a.pe - b.pe;
                });
                break;
            case "pb-asc":
                sorted.sort((a, b) => {
                    if (!a.pb || a.pb <= 0) return 1;
                    if (!b.pb || b.pb <= 0) return -1;
                    return a.pb - b.pb;
                });
                break;
            default:
                sorted.sort((a, b) => a.symbol.localeCompare(b.symbol));
        }

        renderTable(sorted);
    });
</script>
