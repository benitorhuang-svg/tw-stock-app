---
import { ClientRouter } from 'astro:transitions';
import SidebarNav from '../components/Layout/SidebarNav.astro';

interface Props {
    title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content="台灣股票分析與選股策略平台" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <!-- Preload Third-Party Libraries -->
        <link
            rel="preload"
            as="script"
            href="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"
        />
        <link rel="dns-prefetch" href="https://unpkg.com" />

        <!-- Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@800;900&display=swap"
            rel="stylesheet"
        />
        <title>{title} | TW Stock App</title>
        <ClientRouter />
        <script is:inline>
            // Initialize theme before page render to avoid flash
            const theme = localStorage.getItem('tw-stock-theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        </script>
    </head>
    <body>
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="開啟選單">
            <span class="hamburger"></span>
        </button>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="mobile-overlay"></div>

        <div class="app-layout">
            <!-- New Professional Sidebar Navigation -->
            <SidebarNav />

            <!-- Main Workspace with Content (Header is now in Sidebar) -->
            <div class="main-workspace">
                <!-- Page Content Area -->
                <main class="main-content">
                    <slot />
                </main>
            </div>
        </div>
    </body>
</html>

<style is:global>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap');

    :root {
        /* Cyber-Premium Vibrant Palette */
        --h-main: 230;
        --s-main: 30%;
        --l-main: 8%;

        --c-bg-app: #030305;
        --c-bg-glass: hsla(var(--h-main), var(--s-main), 12%, 0.75);
        --c-bg-glass-hover: hsla(var(--h-main), var(--s-main), 20%, 0.6);

        --c-border: hsla(0, 0%, 100%, 0.1);
        --c-border-active: hsla(var(--h-main), 100%, 70%, 0.5);

        --c-text-primary: #ffffff;
        --c-text-secondary: #cbd5e1;
        --c-text-muted: #64748b;

        --c-accent: #3b82f6;
        --c-accent-secondary: #a855f7;
        --c-accent-rgb: 59, 130, 246;
        --c-success: #10b981;
        --c-success-rgb: 16, 185, 129;
        --c-danger: #f43f5e;
        --c-danger-rgb: 244, 63, 94;

        --glass-blur: blur(20px);
        --glow-shadow: 0 0 30px rgba(var(--c-accent-rgb), 0.25);
        --panel-shadow: 0 16px 48px rgba(0, 0, 0, 0.8);

        --w-sidebar: 260px;
        --nav-h: 0px; /* Header is fully consolidated into Sidebar */
        --radius: 14px;
        --radius-sm: 8px;

        --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        --transition-smooth: 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        --transition-premium: 0.6s cubic-bezier(0.16, 1, 0.3, 1);

        /* Theme-aware Background Effects */
        --c-bg-glow-1: hsla(230, 80%, 15%, 0.12);
        --c-bg-glow-2: hsla(280, 80%, 15%, 0.1);
        --c-bg-vignette: rgba(3, 3, 5, 0.85);
    }

    [data-theme='light'] {
        --c-bg-app: #f8fafc;
        --c-bg-glass: rgba(255, 255, 255, 0.75);
        --c-bg-glass-heavy: rgba(255, 255, 255, 0.95);
        --c-bg-glass-hover: rgba(255, 255, 255, 0.85);

        --c-border: rgba(148, 163, 184, 0.15);
        --c-text-primary: #0f172a;
        --c-text-secondary: #475569;
        --c-text-muted: #94a3b8;

        --c-accent: #2563eb;
        --c-accent-rgb: 37, 99, 235;

        --panel-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);

        --c-bg-glow-1: hsla(210, 100%, 80%, 0.15);
        --c-bg-glow-2: hsla(250, 100%, 80%, 0.1);
        --c-bg-vignette: rgba(248, 250, 252, 0.1);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', system-ui, sans-serif;
        background-color: var(--c-bg-app);
        /* Refined Minimalist Mesh Background */
        background-image:
            radial-gradient(at 0% 0%, var(--c-bg-glow-1) 0px, transparent 50%),
            radial-gradient(at 100% 0%, var(--c-bg-glow-2) 0px, transparent 50%),
            radial-gradient(at 100% 100%, var(--c-bg-glow-1) 0px, transparent 50%),
            radial-gradient(at 0% 100%, var(--c-bg-glow-2) 0px, transparent 50%);
        background-attachment: fixed;
        color: var(--c-text-primary);
        font-size: 13px;
        line-height: 1.5;
        min-height: 100vh;
        overflow-y: auto;
        -webkit-font-smoothing: antialiased;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed;
        inset: 0;
        /* Vignette that preserves corners */
        background: radial-gradient(circle at center, transparent 30%, var(--c-bg-vignette) 100%);
        pointer-events: none;
        z-index: -1;
    }

    /* Breathing Animation for Mesh */
    @keyframes mesh-pulse {
        0%,
        100% {
            transform: scale(1);
            opacity: 0.5;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.8;
        }
    }

    a {
        text-decoration: none;
        color: inherit;
        transition: 0.2s;
    }
    button {
        border: none;
        background: none;
        cursor: pointer;
        font-family: inherit;
    }

    /* Layout Frame */
    .app-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
        animation: fadeIn 0.8s var(--ease-out);
    }

    /* Main Workspace Container */
    .main-workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: transparent;
        position: relative;
        min-width: 0;
        margin-left: 70px; /* Sidebar default collapsed width */
        transition: margin-left 0.3s var(--ease-out);
    }

    /* 
       Note: We no longer shift the margin-left on hover (240px) 
       because the sidebar now floats above the content when expanded 
       to provide a more premium feel and avoid layout jumping.
    */

    /* Main Content Area - scrollable page content */
    .main-content {
        flex: 1;
        background: transparent;
        position: relative;
        min-width: 0;
        display: flex;
        flex-direction: column;
        padding: 24px; /* Clean padding without header offset */
    }

    /* Custom scrollbar for main content */
    .main-content::-webkit-scrollbar {
        width: 6px;
    }

    .main-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .main-content::-webkit-scrollbar-thumb {
        background: var(--c-border);
        border-radius: 3px;
    }

    .main-content::-webkit-scrollbar-thumb:hover {
        background: var(--c-text-muted);
    }

    /* Utility */
    .mono {
        font-family: 'JetBrains Mono', monospace;
        font-variant-numeric: tabular-nums;
    }
    .text-pos {
        color: var(--c-success);
        text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
    }
    .text-neg {
        color: var(--c-danger);
        text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }

    .section-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--c-text-muted);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }

    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    @keyframes glow {
        0%,
        100% {
            box-shadow: 0 0 5px rgba(var(--c-accent-rgb), 0.2);
        }
        50% {
            box-shadow: 0 0 20px rgba(var(--c-accent-rgb), 0.4);
        }
    }

    @media (max-width: 768px) {
        .app-layout {
            flex-direction: column;
        }

        .main-workspace {
            margin-left: 0 !important;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        :global(.sidebar-nav) {
            position: fixed;
            left: -100%;
            top: 0;
            height: 100vh;
            width: 85vw;
            max-width: 400px;
            z-index: 1000;
            transition: left 0.3s var(--ease-out);
        }

        :global(.sidebar-nav.mobile-open) {
            left: 0;
        }

        .mobile-menu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background: var(--c-bg-glass);
            border: 1px solid var(--c-border);
            color: var(--c-text-primary);
        }

        .hamburger {
            width: 24px;
            height: 18px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        .hamburger span {
            width: 100%;
            height: 2px;
            background: currentColor;
            border-radius: 2px;
            transition: 0.3s;
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .mobile-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
    }

    @media (max-width: 480px) {
        body {
            font-size: 12px;
        }

        .main-content {
            padding: 15px;
        }
    }
</style>

<script>
    // Dynamic mobile menu (keeping original for now)
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileOverlay = document.getElementById('mobile-overlay');
    const sidebar = document.getElementById('sidebar');
    const closeSidebarBtn = document.getElementById('close-sidebar');

    // Keep existing mobile functionality...
    /**
     * TODO Phase 2: Integrate with new SidebarNav for mobile responsiveness
     * For Phase 1, focusing on desktop layout
     */

    // PWA Service Worker Registration
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
        }
    });

    // PWA Service Worker Registration & Update Logic
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker
                .register('/sw.js')
                .then(reg => {
                    console.log('SW registered');
                    // Reload if a new SW is found and takes control
                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        if (newWorker) {
                            newWorker.onstatechange = () => {
                                if (
                                    newWorker.state === 'installed' &&
                                    navigator.serviceWorker.controller
                                ) {
                                    window.location.reload();
                                }
                            };
                        }
                    };
                })
                .catch(err => console.error('SW registration failed:', err));
        });

        // Ensure we handle controller changes
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
                window.location.reload();
                refreshing = true;
            }
        });
    }
</script>
