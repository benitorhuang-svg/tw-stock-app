---
/**
 * MainTerminal.astro ‚Äî Quantum Terminal Shell (Top-Nav Edition)
 * The outermost layout for all pages.
 * Full-width viewport + top navigation bar (desktop) / bottom-nav (mobile)
 */
import { ClientRouter } from 'astro:transitions';
import BaseHead from './BaseHead.astro';
import DesktopNavTabs from '../components/molecules/DesktopNavTabs.astro';
import MobileNavTabs from '../components/molecules/MobileNavTabs.astro';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
    /** If true, removes content padding (e.g. for chart-heavy pages) */
    fullWidth?: boolean;
}

const { title, description, fullWidth = false } = Astro.props;
---

<!doctype html>
<html lang="zh-TW" class="dark">
    <head>
        <BaseHead title={title} description={description} />
        <ClientRouter />
    </head>
    <body class="flex flex-col h-[100dvh] overflow-hidden bg-base text-text-primary">
        <!-- Skip to main content (accessibility) -->
        <a
            href="#main-workspace"
            class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:text-sm focus:font-bold"
            >Ë∑≥Âà∞‰∏ªË¶ÅÂÖßÂÆπ</a
        >

        <!-- ‚ïê‚ïê‚ïê Top Navigation Bar ‚ïê‚ïê‚ïê -->
        <header class="top-nav-bar flex-shrink-0 z-50" id="top-header">
            <div
                class="flex items-center justify-between h-16 px-4 lg:px-6 max-w-[1800px] mx-auto w-full"
            >
                <!-- Left: Brand + Nav Tabs -->
                <div class="flex items-center gap-1 lg:gap-2">
                    <!-- Brand -->
                    <a
                        href="/"
                        class="flex items-center gap-2 no-underline mr-4 lg:mr-6 flex-shrink-0 group"
                        data-astro-prefetch
                    >
                        <div class="flex items-baseline gap-1">
                            <span
                                class="font-mono text-base lg:text-lg font-extrabold tracking-tight text-text-primary"
                            >
                                TWStock
                            </span>
                        </div>
                    </a>

                    <!-- Refresh Button Inserted Here -->
                    <button
                        id="refresh-data-btn"
                        class="hidden md:flex items-center gap-1 btn-cyber py-1.5 px-3 text-sm h-[32px] shrink-0 font-bold tracking-wider hover:shadow-[0_0_15px_rgba(var(--accent-rgb),0.3)] transition-shadow mr-3"
                    >
                        <span>‚ö°</span>
                        <span class="hidden lg:inline">Ë≥áÊñôÊõ¥Êñ∞</span>
                        <span class="lg:hidden">Êõ¥Êñ∞</span>
                    </button>

                    <!-- Desktop Navigation Tabs -->
                    <DesktopNavTabs />
                </div>

                <!-- Right: System Status -->
                <div class="flex items-center gap-3">
                    <slot name="header-actions" />
                    <!-- Mobile Refresh Button -->
                    <button
                        id="mobile-refresh-data-btn"
                        class="md:hidden btn-cyber py-1 px-2 text-xs h-[28px] shrink-0 font-bold tracking-wider hover:shadow-[0_0_15px_rgba(var(--accent-rgb),0.3)] transition-shadow"
                    >
                        ‚ö°Êõ¥Êñ∞
                    </button>
                    <!-- Theme toggle -->
                    <button
                        id="theme-toggle"
                        class="flex items-center justify-center w-8 h-8 rounded-lg bg-glass border border-border hover:border-accent/30 text-text-muted hover:text-text-secondary transition-all cursor-pointer"
                        aria-label="ÂàáÊèõ‰∏ªÈ°å"
                    >
                        <span id="theme-icon">üåô</span>
                    </button>
                </div>
            </div>

            <!-- Subtle bottom gradient line -->
            <div class="nav-glow-line"></div>
        </header>

        <!-- Refresh Terminal Overlay (Global) -->
        <div
            id="refresh-overlay"
            class="hidden fixed inset-0 bg-base-deep/90 backdrop-blur-md z-[100] flex-col flex items-center justify-center p-6"
        >
            <div
                class="w-full max-w-2xl bg-surface border border-border/50 rounded-xl shadow-[0_0_40px_rgba(0,0,0,0.5)] overflow-hidden flex flex-col"
            >
                <div
                    class="bg-base-deep px-4 py-2 border-b border-border/50 flex items-center justify-between"
                >
                    <span class="text-xs font-mono text-text-muted flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-accent animate-glow-pulse"></span>
                        SYSTEM UPDATE TERMINAL
                    </span>
                    <button
                        id="close-refresh"
                        class="hidden hover:bg-red-500/20 text-text-muted hover:text-red-400 px-3 py-1 rounded transition-colors text-xs font-bold border border-transparent hover:border-red-500/30"
                        >‚úï ÈóúÈñâË¶ñÁ™ó</button
                    >
                </div>
                <div
                    id="refresh-terminal"
                    class="p-4 bg-[#0a0a0a] h-80 overflow-y-auto text-[11px] text-text-secondary font-mono leading-relaxed custom-scrollbar whitespace-pre-wrap"
                >
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê Main Workspace ‚ïê‚ïê‚ïê -->
        <script>
            // theme toggle logic
            function initTheme() {
                const icon = document.getElementById('theme-icon');
                const saved = localStorage.getItem('theme');

                if (saved === 'light') {
                    document.documentElement.classList.remove('dark');
                } else {
                    document.documentElement.classList.add('dark');
                }

                if (icon) {
                    icon.textContent = document.documentElement.classList.contains('dark')
                        ? 'üåô'
                        : '‚òÄÔ∏è';
                }
            }

            // Runs on initial load and after every page transition
            initTheme();
            document.addEventListener('astro:page-load', initTheme);

            // Toggle button listener (manually re-bind due to script execution)
            document.addEventListener('click', e => {
                const target = e.target as HTMLElement;
                const toggle = target.closest('#theme-toggle');
                if (toggle) {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    const icon = document.getElementById('theme-icon');
                    if (icon) icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                }
            });
        </script>
        <main
            class:list={[
                'flex-1 overflow-y-auto overflow-x-hidden',
                fullWidth ? 'p-0' : 'p-4 lg:p-6',
            ]}
            id="main-workspace"
        >
            <div class:list={[fullWidth ? '' : 'max-w-[1400px] mx-auto w-full']}>
                <slot />
            </div>
        </main>

        <!-- ‚ïê‚ïê‚ïê Mobile Bottom Navigation ‚ïê‚ïê‚ïê -->
        <MobileNavTabs />

        <!-- ‚ïê‚ïê‚ïê Global Scripts ‚ïê‚ïê‚ïê -->
        <script>
            import { registerServiceWorker } from '../lib/pwa';
            import { initPerformanceMode } from '../lib/performance-mode';

            // PWA Service Worker registration
            registerServiceWorker();

            // Performance mode detection
            initPerformanceMode();

            // Interactive Glow Tracker ‚Äî follows cursor on .glow-interactive elements
            let ticking = false;
            document.addEventListener('mousemove', (e: MouseEvent) => {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(() => {
                    const elements = document.querySelectorAll<HTMLElement>('.glow-interactive');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        el.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
                        el.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
                    });
                    ticking = false;
                });
            });

            // Global Refresh Data Handler
            const refreshBtn = document.getElementById(
                'refresh-data-btn'
            ) as HTMLButtonElement | null;
            const mobileRefreshBtn = document.getElementById(
                'mobile-refresh-data-btn'
            ) as HTMLButtonElement | null;
            const refreshOverlay = document.getElementById('refresh-overlay');
            const refreshTerminal = document.getElementById('refresh-terminal');
            const closeRefresh = document.getElementById('close-refresh');

            if (refreshOverlay && refreshTerminal && closeRefresh) {
                // Ensure no duplicate listener on page transitions
                const startRefresh = async () => {
                    if (!confirm('Âç≥Â∞áÂü∑Ë°åË≥áÊñôÂ∫´Ë≥áÊñôÊõ¥Êñ∞ÔºåÂ∞áÈ°ØÁ§∫ÁµÇÁ´ØÊ©üÂç≥ÊôÇÈÄ≤Â∫¶Áï´Èù¢ÔºåÊòØÂê¶ÁπºÁ∫åÔºü'))
                        return;

                    if (refreshBtn) refreshBtn.disabled = true;
                    if (mobileRefreshBtn) mobileRefreshBtn.disabled = true;
                    refreshOverlay.classList.remove('hidden');
                    closeRefresh.classList.add('hidden');
                    refreshTerminal.textContent = '>> Ê≠£Âú®Âª∫Á´ãÈÄ£Á∑ö...\n';

                    try {
                        const res = await fetch('/api/db/refresh', { method: 'POST' });
                        if (!res.body)
                            throw new Error('‰º∫ÊúçÂô®Êú™ËøîÂõûÂèØËÆÄÂèñÁöÑ‰∏≤ÊµÅ(ReadableStream)„ÄÇ');

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder('utf-8');
                        let currentText = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, { stream: true });

                            for (const char of chunk) {
                                if (char === '\r') {
                                    const lastNewline = currentText.lastIndexOf('\n');
                                    if (lastNewline !== -1) {
                                        currentText = currentText.substring(0, lastNewline + 1);
                                    } else {
                                        currentText = '';
                                    }
                                } else {
                                    currentText += char;
                                }
                            }
                            refreshTerminal.textContent = currentText;
                            refreshTerminal.scrollTop = refreshTerminal.scrollHeight;
                        }
                    } catch (err) {
                        console.error(err);
                        refreshTerminal.textContent += `\n[‰∏≠Êñ∑] ÁôºÁîüÊú™È†êÊúüÁöÑÈåØË™§: ${(err as Error).message}\n`;
                    } finally {
                        if (refreshBtn) refreshBtn.disabled = false;
                        if (mobileRefreshBtn) mobileRefreshBtn.disabled = false;
                        closeRefresh.classList.remove('hidden');
                        refreshTerminal.scrollTop = refreshTerminal.scrollHeight;
                    }
                };

                // Remove existing listener if any and add new one
                if (refreshBtn) {
                    refreshBtn.removeEventListener('click', startRefresh);
                    refreshBtn.addEventListener('click', startRefresh);
                }

                if (mobileRefreshBtn) {
                    mobileRefreshBtn.removeEventListener('click', startRefresh);
                    mobileRefreshBtn.addEventListener('click', startRefresh);
                }

                const reloadPage = () => window.location.reload();
                closeRefresh.removeEventListener('click', reloadPage);
                closeRefresh.addEventListener('click', reloadPage);
            }
        </script>
    </body>
</html>
