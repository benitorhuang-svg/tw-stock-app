---
/**
 * MainTerminal.astro ‚Äî Quantum Terminal Shell (Top-Nav Edition)
 * The outermost layout for all pages.
 * Full-width viewport + top navigation bar (desktop) / bottom-nav (mobile)
 */
import { ClientRouter } from 'astro:transitions';
import BaseHead from './BaseHead.astro';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
    /** If true, removes content padding (e.g. for chart-heavy pages) */
    fullWidth?: boolean;
}

const { title, description, fullWidth = false } = Astro.props;
const currentPath = Astro.url.pathname;
const isActive = (path: string) =>
    currentPath === path || (path !== '/' && currentPath.startsWith(path));

const navItems = [
    { label: 'DASHBOARD', zh: 'Á∏ΩË¶Ω', path: '/', icon: 'üìä' },
    { label: 'SCREENER', zh: 'ÈÅ∏ËÇ°', path: '/screener', icon: 'üîç' },
    { label: 'ANALYSIS', zh: 'ÂàÜÊûê', path: '/stocks', icon: 'üìà' },
    { label: 'EXPLORER', zh: 'Êï∏ÊìöËßÄÊ∏¨', path: '/database', icon: 'üóÉÔ∏è' },
];
---

<!doctype html>
<html lang="zh-TW" class="dark">
    <head>
        <BaseHead title={title} description={description} />
        <ClientRouter />
    </head>
    <body class="flex flex-col h-[100dvh] overflow-hidden bg-base text-text-primary">
        <!-- Skip to main content (accessibility) -->
        <a href="#main-workspace" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:text-sm focus:font-bold">Ë∑≥Âà∞‰∏ªË¶ÅÂÖßÂÆπ</a>

        <!-- ‚ïê‚ïê‚ïê Top Navigation Bar ‚ïê‚ïê‚ïê -->
        <header class="top-nav-bar flex-shrink-0 z-50" id="top-header">
            <div
                class="flex items-center justify-between h-14 px-4 lg:px-6 max-w-[1800px] mx-auto w-full"
            >
                <!-- Left: Brand + Nav Tabs -->
                <div class="flex items-center gap-1 lg:gap-2">
                    <!-- Brand -->
                    <a
                        href="/"
                        class="flex items-center gap-2 no-underline mr-4 lg:mr-6 flex-shrink-0"
                        data-astro-prefetch
                    >
                        <span
                            class="font-mono text-base lg:text-lg font-extrabold tracking-tight text-text-primary"
                        >
                            TWStock
                        </span>
                        <span
                            class="text-[9px] lg:text-[10px] font-black tracking-[0.2em] uppercase px-1.5 py-0.5 rounded-sm bg-accent/20 text-accent"
                        >
                            PRO
                        </span>
                    </a>

                    <!-- Desktop Navigation Tabs -->
                    <nav class="hidden md:flex items-center" aria-label="‰∏ªË¶ÅÂ∞éË¶Ω" id="desktop-nav">
                        <div class="top-nav-tabs">
                            {
                                navItems.map(item => (
                                    <a
                                        href={item.path}
                                        class:list={[
                                            'top-nav-tab',
                                            isActive(item.path) && 'active',
                                        ]}
                                        data-astro-prefetch
                                    >
                                        <span class="tab-icon">{item.icon}</span>
                                        <span class="tab-label">{item.label}</span>
                                        <span class="tab-zh">{item.zh}</span>
                                    </a>
                                ))
                            }
                            <div class="tab-indicator" id="tab-indicator"></div>
                        </div>
                    </nav>
                </div>

                <!-- Right: System Status -->
                <div class="flex items-center gap-3">
                    <!-- Search shortcut hint -->
                    <button
                        class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-glass border border-border hover:border-accent/30 text-text-muted hover:text-text-secondary transition-all cursor-pointer text-xs"
                        id="search-trigger"
                        aria-label="ÊêúÂ∞ãËÇ°Á•®"
                    >
                        <span>üîç</span>
                        <span class="font-mono text-[11px]">ÊêúÂ∞ãËÇ°Á•®...</span>
                        <kbd class="text-[9px] font-mono bg-surface px-1.5 py-0.5 rounded border border-border ml-1">Ctrl+K</kbd>
                    </button>
                    <div class="hidden md:flex items-center gap-2 text-xs text-text-muted">
                        <span class="w-1.5 h-1.5 rounded-full bg-bullish animate-glow-pulse"></span>
                        <span class="font-mono text-[11px] tracking-wider">LIVE</span>
                    </div>
                </div>
            </div>

            <!-- Subtle bottom gradient line -->
            <div class="nav-glow-line"></div>
        </header>

        <!-- ‚ïê‚ïê‚ïê Main Workspace ‚ïê‚ïê‚ïê -->
        <main
            class:list={[
                'flex-1 overflow-y-auto overflow-x-hidden',
                fullWidth ? 'p-0' : 'p-4 lg:p-6',
            ]}
            id="main-workspace"
        >
            <div class:list={[fullWidth ? '' : 'max-w-[1400px] mx-auto w-full']}>
                <slot />
            </div>
        </main>

        <!-- ‚ïê‚ïê‚ïê Mobile Bottom Navigation ‚ïê‚ïê‚ïê -->
        <nav
            class="md:hidden fixed bottom-0 inset-x-0 z-50 mobile-bottom-nav"
            id="mobile-bottom-nav"
            aria-label="Ë°åÂãïË£ùÁΩÆÂ∞éË¶Ω"
        >
            {
                navItems.map(item => (
                    <a
                        href={item.path}
                        class:list={['mobile-nav-item', isActive(item.path) && 'active']}
                        data-astro-prefetch
                    >
                        <span class="text-lg">{item.icon}</span>
                        <span class="text-[11px] font-semibold tracking-wider">{item.zh}</span>
                    </a>
                ))
            }
        </nav>

        <!-- ‚ïê‚ïê‚ïê Global Scripts ‚ïê‚ïê‚ïê -->
        <script>
            import { keyboard } from '../lib/keyboard';
            import { registerServiceWorker } from '../lib/pwa';
            import { initPerformanceMode } from '../lib/performance-mode';

            // Initialize keyboard shortcuts (Ctrl+K search)
            keyboard.initSearchModal();

            // Search trigger button click
            document.getElementById('search-trigger')?.addEventListener('click', () => {
                keyboard.openSearchModal();
            });

            // PWA Service Worker registration
            registerServiceWorker();

            // Performance mode detection
            initPerformanceMode();
            // Tab indicator positioning
            function updateTabIndicator() {
                const activeTab = document.querySelector('.top-nav-tab.active') as HTMLElement;
                const indicator = document.getElementById('tab-indicator') as HTMLElement;
                if (activeTab && indicator) {
                    const tabsContainer = activeTab.parentElement as HTMLElement;
                    const containerRect = tabsContainer.getBoundingClientRect();
                    const tabRect = activeTab.getBoundingClientRect();
                    indicator.style.width = `${tabRect.width}px`;
                    indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
                    indicator.style.opacity = '1';
                }
            }

            // Run on load and after view transitions
            updateTabIndicator();
            document.addEventListener('astro:page-load', updateTabIndicator);

            // Hover preview for tabs
            document.querySelectorAll<HTMLElement>('.top-nav-tab').forEach(tab => {
                tab.addEventListener('mouseenter', () => {
                    const indicator = document.getElementById('tab-indicator') as HTMLElement;
                    const tabsContainer = tab.parentElement as HTMLElement;
                    if (indicator && tabsContainer) {
                        const containerRect = tabsContainer.getBoundingClientRect();
                        const tabRect = tab.getBoundingClientRect();
                        indicator.style.width = `${tabRect.width}px`;
                        indicator.style.transform = `translateX(${tabRect.left - containerRect.left}px)`;
                    }
                });
            });

            // Reset indicator on mouse leave from tab container
            document.querySelector('.top-nav-tabs')?.addEventListener('mouseleave', () => {
                updateTabIndicator();
            });

            // Interactive Glow Tracker ‚Äî follows cursor on .glow-interactive elements
            let ticking = false;
            document.addEventListener('mousemove', (e: MouseEvent) => {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(() => {
                    const elements = document.querySelectorAll<HTMLElement>('.glow-interactive');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        el.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
                        el.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
                    });
                    ticking = false;
                });
            });
        </script>
    </body>
</html>
