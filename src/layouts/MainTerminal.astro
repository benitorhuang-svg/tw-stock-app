---
/**
 * MainTerminal.astro ‚Äî Quantum Terminal Shell (Top-Nav Edition)
 * The outermost layout for all pages.
 * Full-width viewport + top navigation bar (desktop) / bottom-nav (mobile)
 */
import { ClientRouter } from 'astro:transitions';
import BaseHead from './BaseHead.astro';
import DesktopNavTabs from '../components/molecules/DesktopNavTabs.astro';
import MobileNavTabs from '../components/molecules/MobileNavTabs.astro';
import { dbService } from '../lib/db/sqlite-service';
import '../styles/global.css';

const dbStats = dbService.getDbStats();

interface Props {
    title: string;
    description?: string;
    /** If true, removes content padding (e.g. for chart-heavy pages) */
    fullWidth?: boolean;
}

const { title, description, fullWidth = false } = Astro.props;
---

<!doctype html>
<html lang="zh-TW" class="dark">
    <head>
        <BaseHead title={title} description={description} />
        <ClientRouter />
    </head>
    <body class="flex flex-col h-[100dvh] overflow-hidden bg-base text-text-primary">
        <!-- Skip to main content (accessibility) -->
        <a
            href="#main-workspace"
            class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:text-sm focus:font-bold"
            >Ë∑≥Âà∞‰∏ªË¶ÅÂÖßÂÆπ</a
        >

        <!-- ‚ïê‚ïê‚ïê Top Navigation Bar ‚ïê‚ïê‚ïê -->
        <header class="top-nav-bar flex-shrink-0 z-50" id="top-header">
            <div
                class="flex items-center justify-between h-16 px-4 lg:px-6 max-w-[1800px] mx-auto w-full"
            >
                <!-- Left: Brand + Nav Tabs -->
                <div class="flex items-center gap-1 lg:gap-2">
                    <!-- Brand -->
                    <a
                        href="/"
                        class="flex items-center gap-2 no-underline mr-4 lg:mr-6 flex-shrink-0 group"
                        data-astro-prefetch
                    >
                        <div class="flex items-baseline gap-1">
                            <span
                                class="font-mono text-base lg:text-lg font-extrabold tracking-tight text-text-primary"
                            >
                                TWStock
                            </span>
                        </div>
                    </a>

                    <!-- Consolidated Refresh & Standalone Data Obs -->
                    <div class="hidden md:flex items-center gap-3 mr-3 lg:mr-5">
                        <!-- Data Update Group -->
                        <div class="flex flex-col items-start group">
                            <button
                                id="refresh-data-btn"
                                class="flex items-center gap-1 btn-cyber py-1 px-3 text-[11px] h-[26px] shrink-0 font-bold tracking-wider hover:shadow-[0_0_15px_rgba(var(--accent-rgb),0.3)] transition-shadow"
                            >
                                <span>Ë≥áÊñôÊõ¥Êñ∞</span>
                            </button>
                            <div
                                class="flex items-center gap-2 mt-1 ml-0.5 opacity-40 group-hover:opacity-100 transition-opacity"
                            >
                                <span
                                    class="text-[9px] font-mono font-bold text-accent tracking-tighter uppercase leading-none"
                                    >{dbStats.sizeMB} MB</span
                                >
                                <span
                                    class="text-[7px] font-mono text-white/20 uppercase tracking-[0.1em]"
                                    >DISK_USAGE</span
                                >
                            </div>
                        </div>

                        <!-- Data Observation (Extracted Standalone) -->
                        <a
                            href="/database"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group',
                                Astro.url.pathname === '/database'
                                    ? 'bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Êï∏ÊìöËßÄÊ∏¨</span>
                        </a>
                    </div>

                    <!-- Desktop Navigation Tabs -->
                    <DesktopNavTabs />
                </div>

                <!-- Right: System Status -->
                <div class="flex items-center gap-3">
                    <slot name="header-actions" />
                    <!-- Mobile Refresh Button -->
                    <button
                        id="mobile-refresh-data-btn"
                        class="md:hidden btn-cyber py-1 px-2 text-xs h-[28px] shrink-0 font-bold tracking-wider hover:shadow-[0_0_15px_rgba(var(--accent-rgb),0.3)] transition-shadow"
                    >
                        ‚ö°Êõ¥Êñ∞
                    </button>
                    <!-- Theme toggle -->
                    <div class="flex items-center gap-2">
                        <button
                            id="theme-toggle"
                            class="flex items-center justify-center w-8 h-8 rounded-lg bg-glass border border-border hover:border-accent/30 text-text-muted hover:text-text-secondary transition-all cursor-pointer"
                            aria-label="ÂàáÊèõ‰∏ªÈ°å"
                        >
                            <span id="theme-icon">üåô</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Subtle bottom gradient line -->
            <div class="nav-glow-line"></div>
        </header>

        <!-- Refresh Terminal Overlay (Global) -->
        <div
            id="refresh-overlay"
            class="hidden fixed inset-0 bg-base-deep/95 backdrop-blur-xl z-[100] flex-col flex items-center justify-center p-6"
        >
            <div
                class="w-full max-w-3xl bg-surface border border-border/50 rounded-2xl shadow-[0_0_80px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col relative"
            >
                <div class="absolute inset-0 bg-glow-radial opacity-10 pointer-events-none"></div>

                <!-- Terminal Header -->
                <div
                    class="bg-base-deep px-5 py-3 border-b border-border/50 flex items-center justify-between relative z-10"
                >
                    <div class="flex items-center gap-3">
                        <div class="flex gap-1.5">
                            <div
                                class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/40"
                            >
                            </div>
                            <div
                                class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/40"
                            >
                            </div>
                            <div class="w-3 h-3 rounded-full bg-accent/20 border border-accent/40">
                            </div>
                        </div>
                        <span
                            class="text-[10px] font-mono font-black text-text-muted tracking-[0.2em] flex items-center gap-2"
                        >
                            CORE_DATA_SYNCHRONIZER_V2
                        </span>
                        <div
                            id="refresh-eta-container"
                            class="flex items-center gap-1.5 ml-4 opacity-0 transition-opacity duration-500 translate-x-3 no-display group"
                        >
                            <span
                                class="text-[9px] font-mono font-bold text-accent/80 tracking-widest uppercase"
                                >Estimated Completion:</span
                            >
                            <span
                                id="refresh-eta"
                                class="text-[10px] font-mono font-black text-accent bg-accent/10 border border-accent/20 px-2 py-0.5 rounded shadow-[0_0_10px_rgba(var(--accent-rgb),0.2)]"
                                >--:--</span
                            >
                        </div>
                    </div>
                    <button
                        id="close-refresh"
                        class="hidden hover:bg-red-500/20 text-text-muted hover:text-red-400 px-3 py-1 rounded-lg transition-colors text-[10px] font-black border border-border/50 hover:border-red-500/30"
                        >‚úï ÈóúÈñâË¶ñÁ™ó</button
                    >
                </div>

                <!-- Graphical Stage Progress -->
                <div class="p-6 bg-base mt-2 relative z-10">
                    <div class="flex justify-between relative">
                        <!-- Connecting Line -->
                        <div
                            class="absolute top-1/2 left-0 w-full h-[2px] bg-white/5 -translate-y-1/2 z-0"
                        >
                        </div>
                        <div
                            id="stage-progress-line"
                            class="absolute top-1/2 left-0 w-0 h-[2px] bg-accent shadow-[0_0_10px_rgba(var(--accent-rgb),0.5)] -translate-y-1/2 z-0 transition-all duration-700"
                        >
                        </div>

                        <!-- Stages -->
                        {
                            [
                                { step: 1, label: 'Ê∏ÖÂñÆÊõ¥Êñ∞', icon: 'üìã' },
                                { step: 2, label: 'Êï∏ÊìöÂêåÊ≠•', icon: 'üîÑ' },
                                { step: 3, label: 'Âø´ÁÖßÂª∫ÁΩÆ', icon: 'üì∏' },
                                { step: 4, label: 'Á¥¢ÂºïÂÑ™Âåñ', icon: '‚ö°' },
                                { step: 5, label: 'ÂêåÊ≠•ÂÆåÊàê', icon: '‚úÖ' },
                            ].map(s => (
                                <div
                                    class="flex flex-col items-center gap-3 relative z-10 stage-item"
                                    data-step={s.step}
                                    id={`stage-step-${s.step}`}
                                >
                                    <div class="w-10 h-10 rounded-xl bg-surface border border-border/50 flex items-center justify-center text-lg transition-all duration-500 stage-icon grayscale opacity-40 shadow-inner">
                                        {s.icon}
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-[9px] font-mono text-white/20 font-bold uppercase tracking-tighter">
                                            Step {s.step}
                                        </span>
                                        <span class="text-[11px] font-black text-white/30 transition-colors stage-label">
                                            {s.label}
                                        </span>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>

                <!-- Terminal Content -->
                <div class="p-4 bg-black/60 relative z-10">
                    <div
                        id="refresh-terminal"
                        class="h-64 overflow-y-auto text-[11px] text-accent/80 font-mono leading-relaxed custom-scrollbar whitespace-pre-wrap p-4 border border-white/5 rounded-lg bg-black/40 shadow-inner"
                    >
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê Main Workspace ‚ïê‚ïê‚ïê -->
        <script>
            // theme toggle logic
            function initTheme() {
                const icon = document.getElementById('theme-icon');
                const saved = localStorage.getItem('theme');

                if (saved === 'light') {
                    document.documentElement.classList.remove('dark');
                } else {
                    document.documentElement.classList.add('dark');
                }

                if (icon) {
                    icon.textContent = document.documentElement.classList.contains('dark')
                        ? 'üåô'
                        : '‚òÄÔ∏è';
                }
            }

            // Runs on initial load and after every page transition
            initTheme();
            document.addEventListener('astro:page-load', initTheme);

            // Toggle button listener (manually re-bind due to script execution)
            document.addEventListener('click', e => {
                const target = e.target as HTMLElement;
                const toggle = target.closest('#theme-toggle');
                if (toggle) {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    const icon = document.getElementById('theme-icon');
                    if (icon) icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                }
            });
        </script>
        <main
            class:list={[
                'flex-1 overflow-y-auto overflow-x-hidden',
                fullWidth ? 'p-0' : 'p-4 lg:p-6',
            ]}
            id="main-workspace"
        >
            <div class:list={[fullWidth ? '' : 'max-w-[1400px] mx-auto w-full']}>
                <slot />
            </div>
        </main>

        <!-- ‚ïê‚ïê‚ïê Mobile Bottom Navigation ‚ïê‚ïê‚ïê -->
        <MobileNavTabs />

        <!-- ‚ïê‚ïê‚ïê Global Scripts ‚ïê‚ïê‚ïê -->
        <script>
            import { registerServiceWorker } from '../lib/pwa';
            import { initPerformanceMode } from '../lib/performance-mode';

            // PWA Service Worker registration
            registerServiceWorker();

            // Performance mode detection
            initPerformanceMode();

            // Interactive Glow Tracker ‚Äî follows cursor on .glow-interactive elements
            let ticking = false;
            document.addEventListener('mousemove', (e: MouseEvent) => {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(() => {
                    const elements = document.querySelectorAll<HTMLElement>('.glow-interactive');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        el.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
                        el.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
                    });
                    ticking = false;
                });
            });

            // Global Refresh Data Handler - MUST be bound on page load for View Transitions
            document.addEventListener('astro:page-load', () => {
                const refreshBtn = document.getElementById(
                    'refresh-data-btn'
                ) as HTMLButtonElement | null;
                const mobileRefreshBtn = document.getElementById(
                    'mobile-refresh-data-btn'
                ) as HTMLButtonElement | null;
                const refreshOverlay = document.getElementById('refresh-overlay');
                const refreshTerminal = document.getElementById('refresh-terminal');
                const closeRefresh = document.getElementById('close-refresh');

                if (refreshOverlay && refreshTerminal && closeRefresh) {
                    const startRefresh = async () => {
                        if (
                            !confirm('Âç≥Â∞áÂü∑Ë°åË≥áÊñôÂ∫´Ë≥áÊñôÊõ¥Êñ∞ÔºåÂ∞áÈ°ØÁ§∫ÁµÇÁ´ØÊ©üÂç≥ÊôÇÈÄ≤Â∫¶Áï´Èù¢ÔºåÊòØÂê¶ÁπºÁ∫åÔºü')
                        )
                            return;

                        if (refreshBtn) refreshBtn.disabled = true;
                        if (mobileRefreshBtn) mobileRefreshBtn.disabled = true;
                        refreshOverlay.classList.remove('hidden');
                        closeRefresh.classList.add('hidden');
                        refreshTerminal.textContent = '>> Ê≠£Âú®Âª∫Á´ãÈÄ£Á∑ö...\n';

                        const timeToSec = (str: string) => {
                            const parts = str.split(':');
                            if (parts.length === 2)
                                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                            return 0;
                        };

                        const etaEl = document.getElementById('refresh-eta')!;
                        const etaContainer = document.getElementById('refresh-eta-container')!;
                        let etaSeconds = 600;
                        let etaTimerId: any = null;

                        const renderETA = () => {
                            const m = Math.floor(etaSeconds / 60);
                            const s = etaSeconds % 60;
                            etaEl.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        };

                        etaTimerId = setInterval(() => {
                            if (etaSeconds > 0) {
                                etaSeconds--;
                                renderETA();
                            }
                        }, 1000);

                        const calibrateETA = (newSeconds: number) => {
                            if (Math.abs(etaSeconds - newSeconds) > 15) {
                                etaSeconds = newSeconds;
                                renderETA();
                            }
                        };

                        const forceETA = (newSeconds: number) => {
                            etaSeconds = newSeconds;
                            renderETA();
                        };

                        etaContainer.classList.remove('opacity-0', 'translate-x-3');
                        renderETA();

                        const updateStage = (step: number) => {
                            const line = document.getElementById('stage-progress-line');
                            if (line) line.style.width = `${(step - 1) * 25}%`;

                            document.querySelectorAll('.stage-item').forEach(el => {
                                const s = parseInt((el as HTMLElement).dataset.step || '0');
                                const icon = el.querySelector('.stage-icon');
                                const label = el.querySelector('.stage-label');

                                if (s < step) {
                                    icon?.classList.remove(
                                        'grayscale',
                                        'opacity-40',
                                        'border-border/50',
                                        'bg-surface'
                                    );
                                    icon?.classList.add(
                                        'border-accent/40',
                                        'bg-accent/10',
                                        'text-accent'
                                    );
                                    label?.classList.remove('text-white/30');
                                    label?.classList.add('text-accent');
                                } else if (s === step) {
                                    icon?.classList.remove(
                                        'grayscale',
                                        'opacity-40',
                                        'border-border/50',
                                        'bg-surface'
                                    );
                                    icon?.classList.add('border-accent', 'bg-accent/20');
                                    label?.classList.remove('text-white/30');
                                    label?.classList.add('text-white', 'font-black');
                                } else {
                                    icon?.classList.add(
                                        'grayscale',
                                        'opacity-40',
                                        'border-border/50',
                                        'bg-surface'
                                    );
                                    icon?.classList.remove(
                                        'border-accent',
                                        'bg-accent/20',
                                        'text-accent'
                                    );
                                    label?.classList.add('text-white/30');
                                    label?.classList.remove(
                                        'text-white',
                                        'font-black',
                                        'text-accent'
                                    );
                                }
                            });
                        };
                        updateStage(1);

                        try {
                            const res = await fetch('/api/db/refresh', { method: 'POST' });
                            if (!res.body)
                                throw new Error('‰º∫ÊúçÂô®Êú™ËøîÂõûÂèØËÆÄÂèñÁöÑ‰∏≤ÊµÅ(ReadableStream)„ÄÇ');

                            const reader = res.body.getReader();
                            const decoder = new TextDecoder('utf-8');
                            let currentText = '';
                            const triggeredStages = new Set<number>();

                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                const chunk = decoder.decode(value, { stream: true });

                                for (const char of chunk) {
                                    if (char === '\r') {
                                        const lastNewline = currentText.lastIndexOf('\n');
                                        if (lastNewline !== -1) {
                                            currentText = currentText.substring(0, lastNewline + 1);
                                        } else {
                                            currentText = '';
                                        }
                                    } else {
                                        currentText += char;
                                    }
                                }
                                refreshTerminal.textContent = currentText;
                                refreshTerminal.scrollTop = refreshTerminal.scrollHeight;

                                if (currentText.includes('È†êË®àÂâ©È§ò:')) {
                                    const lines = currentText.split('\n');
                                    const lastLine = lines[lines.length - 1];
                                    const match = lastLine.match(/È†êË®àÂâ©È§ò: ([^\|\n]+)/);
                                    if (match) {
                                        const yahooSec = timeToSec(match[1].trim());
                                        calibrateETA(yahooSec + 90);
                                    }
                                }

                                const checkStage = (marker: string, step: number, eta?: number) => {
                                    if (
                                        !triggeredStages.has(step) &&
                                        currentText.includes(marker)
                                    ) {
                                        triggeredStages.add(step);
                                        updateStage(step);
                                        if (eta !== undefined) forceETA(eta);
                                    }
                                };
                                checkStage('[1/4]', 1);
                                checkStage('[2/4]', 2);
                                checkStage('[3/4]', 3, 60);
                                checkStage('[4/4]', 4, 30);
                                checkStage('[ÂÆåÊàê]', 5, 0);
                            }
                        } catch (err) {
                            console.error(err);
                            refreshTerminal.textContent += `\n[‰∏≠Êñ∑] ÁôºÁîüÊú™È†êÊúüÁöÑÈåØË™§: ${(err as Error).message}\n`;
                        } finally {
                            if (etaTimerId) clearInterval(etaTimerId);
                            if (refreshBtn) refreshBtn.disabled = false;
                            if (mobileRefreshBtn) mobileRefreshBtn.disabled = false;
                            closeRefresh.classList.remove('hidden');
                            refreshTerminal.scrollTop = refreshTerminal.scrollHeight;
                        }
                    };

                    if (refreshBtn) {
                        refreshBtn.removeEventListener('click', startRefresh);
                        refreshBtn.addEventListener('click', startRefresh);
                    }

                    if (mobileRefreshBtn) {
                        mobileRefreshBtn.removeEventListener('click', startRefresh);
                        mobileRefreshBtn.addEventListener('click', startRefresh);
                    }

                    const reloadPage = () => window.location.reload();
                    closeRefresh.removeEventListener('click', reloadPage);
                    closeRefresh.addEventListener('click', reloadPage);
                }
            });
        </script>
    </body>
</html>
