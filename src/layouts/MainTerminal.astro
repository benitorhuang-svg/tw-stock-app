---
/**
 * MainTerminal.astro ‚Äî Quantum Terminal Shell (Top-Nav Edition)
 * The outermost layout for all pages.
 * Full-width viewport + top navigation bar (desktop) / bottom-nav (mobile)
 */
import { ClientRouter, fade } from 'astro:transitions';
import BaseHead from './BaseHead.astro';
import DesktopNavTabs from '../components/molecules/DesktopNavTabs.astro';
import MobileNavTabs from '../components/molecules/MobileNavTabs.astro';
import SignalNexus from '../components/organisms/SignalNexus.svelte';

import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
    /** If true, removes content padding (e.g. for chart-heavy pages) */
    fullWidth?: boolean;
}

const { title, description, fullWidth = false } = Astro.props;
---

<!doctype html>
<html lang="zh-TW" class="dark">
    <head>
        <BaseHead title={title} description={description} />
        <ClientRouter />
        <script is:inline src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"
        ></script>
    </head>
    <body class="flex flex-col h-[100dvh] overflow-hidden bg-base text-text-primary">
        <!-- Skip to main content (accessibility) -->
        <a
            href="#main-workspace"
            class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:text-sm focus:font-bold"
            >Ë∑≥Âà∞‰∏ªË¶ÅÂÖßÂÆπ</a
        >

        <!-- ‚ïê‚ïê‚ïê Top Navigation Bar ‚ïê‚ïê‚ïê -->
        <header class="top-nav-bar flex-shrink-0 z-50" id="top-header">
            <div
                class="flex items-center justify-between h-16 px-4 lg:px-6 max-w-[1800px] mx-auto w-full"
            >
                <!-- Left: Brand + Nav Tabs -->
                <div class="flex items-center gap-1 lg:gap-2">
                    <!-- Brand -->
                    <a
                        href="/"
                        class="flex items-center gap-2 no-underline mr-4 lg:mr-6 flex-shrink-0 group"
                        data-astro-prefetch
                    >
                        <div class="flex items-baseline gap-1">
                            <span
                                class="font-mono text-base lg:text-lg font-extrabold tracking-tight text-text-primary"
                            >
                                TWStock
                            </span>
                        </div>
                    </a>

                    <!-- Consolidated Standalone Capsules -->
                    <div class="hidden md:flex items-center gap-2 mr-3 lg:mr-5">
                        <!-- Data Observation -->
                        <a
                            href="/database"
                            id="nav-db-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group',
                                Astro.url.pathname === '/database'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Êï∏ÊìöËßÄÊ∏¨</span>
                        </a>

                        <!-- Real-time Opening -->
                        <a
                            href="/live"
                            id="nav-live-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/live'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Âç≥ÊôÇÈñãÁõ§</span>
                        </a>

                        <!-- Market Breadth (Â∏ÇÂ†¥Êº≤ÂπÖ) -->
                        <a
                            href="/"
                            id="nav-market-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Â∏ÇÂ†¥Êº≤ÂπÖ</span>
                        </a>

                        <!-- Institutional Monitoring (Ê≥ï‰∫∫Áõ£Êéß) -->
                        <a
                            href="/institutional"
                            id="nav-inst-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/institutional'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Ê≥ï‰∫∫Áõ£Êéß</span>
                        </a>

                        <!-- Stock Screener (ÈÅ∏ËÇ°Á≠ñÁï•) -->
                        <a
                            href="/screener"
                            id="nav-screener-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/screener'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>ÈÅ∏ËÇ°Á≠ñÁï•</span>
                        </a>

                        <!-- Individual Stock Analysis (ÂÄãËÇ°ÂàÜÊûê) -->
                        <a
                            href="/stocks"
                            id="nav-stocks-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/stocks'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>ÂÄãËÇ°ÂàÜÊûê</span>
                        </a>

                        <!-- Watchlist (Ëá™ÈÅ∏Ê∏ÖÂñÆ) -->
                        <a
                            href="/watchlist"
                            id="nav-watchlist-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/watchlist'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Ëá™ÈÅ∏Ê∏ÖÂñÆ</span>
                        </a>

                        <!-- Backtest (Á≠ñÁï•ÂõûÊ∏¨) -->
                        <a
                            href="/strategy"
                            id="nav-backtest-btn"
                            class:list={[
                                'flex items-center gap-2 px-4 h-[32px] rounded-lg transition-all text-[11px] font-black tracking-[0.2em] uppercase border backdrop-blur-md group relative',
                                Astro.url.pathname === '/strategy'
                                    ? 'active bg-accent/15 border-accent/40 text-accent shadow-[0_0_20px_rgba(var(--accent-rgb),0.15)] shadow-inner'
                                    : 'bg-glass border-border text-text-muted hover:text-text-primary hover:border-border-highlight hover:bg-glass-hover',
                            ]}
                            data-astro-prefetch
                        >
                            <span>Á≠ñÁï•ÂõûÊ∏¨</span>
                        </a>
                    </div>

                    <!-- Desktop Navigation Tabs -->
                    <DesktopNavTabs />
                </div>

                <!-- Right: System Status -->
                <div class="flex items-center gap-3">
                    <slot name="header-actions" />
                    <!-- Notification Bell -->
                    <button
                        id="notification-bell"
                        class="flex items-center justify-center w-8 h-8 rounded-lg bg-glass border border-border hover:border-accent/30 text-text-muted hover:text-accent transition-all cursor-pointer relative"
                        aria-label="ÈÄöÁü•ÊèêÈÜí"
                    >
                        <svg
                            class="w-4 h-4"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
                        </svg>
                        <!-- Indicator -->
                        <span
                            class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-accent rounded-full border border-base"
                        ></span>
                    </button>

                    <!-- Theme toggle -->
                    <div class="flex items-center gap-2">
                        <button
                            id="theme-toggle"
                            class="flex items-center justify-center w-8 h-8 rounded-lg bg-glass border border-border hover:border-accent/30 text-text-muted hover:text-text-secondary transition-all cursor-pointer"
                            aria-label="ÂàáÊèõ‰∏ªÈ°å"
                        >
                            <span id="theme-icon">üåô</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Subtle bottom gradient line -->
            <div class="nav-glow-line"></div>
        </header>

        <!-- ‚ïê‚ïê‚ïê Main Workspace ‚ïê‚ïê‚ïê -->

        <main
            class:list={[
                'flex-1 overflow-y-auto overflow-x-hidden main-scrollbar',
                fullWidth ? 'p-0' : 'p-4 lg:p-6',
            ]}
            id="main-workspace"
            transition:animate={fade({ duration: '0.15s' })}
        >
            <div class:list={[fullWidth ? '' : 'max-w-[1400px] mx-auto w-full']}>
                <slot />
            </div>
        </main>

        <!-- ‚ïê‚ïê‚ïê Mobile Bottom Navigation ‚ïê‚ïê‚ïê -->
        <MobileNavTabs />

        <!-- Signal Hub ‚Äî Global Alerts -->
        <SignalNexus client:load />

        <!-- ‚ïê‚ïê‚ïê Global Scripts ‚ïê‚ïê‚ïê -->

        <script src="../scripts/global-engine.ts"></script>
    </body>
</html>
