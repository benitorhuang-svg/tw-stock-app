# TW Stock App - SQLite é·ç§»å®Œæˆå ±å‘Š

## æ—¥æœŸ: 2026-02-01

## âœ… é·ç§»ç‹€æ…‹: å®Œæˆ

---

## ğŸ“ å·²æ›´æ–°çš„æª”æ¡ˆ

### æ ¸å¿ƒæœå‹™å±¤
| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `src/lib/sqlite-service.ts` | æ–°å»ºï¼šçµ±ä¸€çš„ SQLite è³‡æ–™å­˜å–æœå‹™ |
| `src/utils/stockDataService.ts` | å®Œå…¨é‡å¯«ï¼šæ”¹ç”¨ SQLite ä½œç‚ºè³‡æ–™ä¾†æº |
| `src/utils/priceService.ts` | å®Œå…¨é‡å¯«ï¼šæ”¹ç”¨ SQLite ä½œç‚ºè³‡æ–™ä¾†æº |

### å»ºç½®å·¥å…·
| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `scripts/build-sqlite-db.js` | æ–°å»ºï¼šCSV/JSON â†’ SQLite è½‰æ›å·¥å…· |
| `package.json` | æ–°å¢ `better-sqlite3` ä¾è³´å’Œ `build:db` è…³æœ¬ |

### é é¢ (ç„¡éœ€ä¿®æ”¹ import)
ä»¥ä¸‹é é¢çš„ import èªå¥ä¿æŒä¸è®Šï¼Œå› ç‚ºåº•å±¤æœå‹™å·²ç›´æ¥æ›¿æ›ï¼š

- âœ… `src/pages/index.astro`
- âœ… `src/pages/filter.astro`
- âœ… `src/pages/stocks/index.astro`
- âœ… `src/pages/stocks/[symbol].astro`
- âœ… `src/pages/portfolio.astro`
- âœ… `src/pages/watchlist.astro`
- âœ… `src/pages/industries.astro`
- âœ… `src/components/Heatmap.astro`
- âœ… `src/pages/api/prices/[symbol].ts`

### é¡å‹å®šç¾©
| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `src/types/better-sqlite3.d.ts` | æ–°å»ºï¼šTypeScript é¡å‹å®šç¾© |

### æ–‡æª”
| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `PERFORMANCE_AUDIT.md` | æ›´æ–°ï¼šå®Œæ•´çš„æ•ˆèƒ½å¯©æŸ¥å ±å‘Š |

---

## ğŸ—‘ï¸ å·²ç§»é™¤çš„æª”æ¡ˆ

- `src/utils/stockDataService-sqlite.ts` (æš«æ™‚ç‰ˆæœ¬ï¼Œå·²æ•´åˆ)

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. å®‰è£ä¾è³´
```bash
npm install
```

### 2. å»ºç«‹ SQLite è³‡æ–™åº«
```bash
npm run build:db
```

è¼¸å‡ºï¼š`public/data/stocks.db`

### 3. é–‹ç™¼æ¨¡å¼
```bash
npm run dev
```

### 4. ç”Ÿç”¢å»ºç½®
```bash
npm run build
```

---

## ğŸ“Š è³‡æ–™æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è³‡æ–™ä¾†æº (å‚™ä»½ç”¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CSV: public/data/prices/*.csv (1077 æª”æ¡ˆ)                  â”‚
â”‚  JSON: public/data/latest_prices.json                       â”‚
â”‚  JSON: src/content/stocks/list.json                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ npm run build:db
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SQLite è³‡æ–™åº«                              â”‚
â”‚                 public/data/stocks.db                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Table: stocks         (1077 ç­†)                            â”‚
â”‚  Table: latest_prices  (1077 ç­†)                            â”‚
â”‚  Table: price_history  (~400K+ ç­†)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼               â–¼               â–¼
   Server-side      Client-side      é›¢ç·šä½¿ç”¨
  (better-sqlite3)   (sql.js WASM)   (IndexedDB)
```

---

## ğŸ”§ API åƒè€ƒ

### åŸºæœ¬æŸ¥è©¢
```typescript
import { 
    getStocksWithPrices,    // å–å¾—æ‰€æœ‰è‚¡ç¥¨å«åƒ¹æ ¼
    getTopGainers,          // æ¼²å¹…æ’è¡Œ
    getTopLosers,           // è·Œå¹…æ’è¡Œ
    searchStocks,           // æœå°‹è‚¡ç¥¨
    getStockBySymbol        // å–å¾—å–®ä¸€è‚¡ç¥¨
} from '../utils/stockDataService';
```

### é€²éšåŠŸèƒ½
```typescript
import { 
    screenStocks,           // æ¢ä»¶ç¯©é¸ (é¸è‚¡å™¨)
    getStockHistory,        // æ­·å²åƒ¹æ ¼
    getDbStats,             // è³‡æ–™åº«çµ±è¨ˆ
    clearCache              // æ¸…é™¤å¿«å–
} from '../utils/stockDataService';

// é¸è‚¡ç¯„ä¾‹
const filtered = await screenStocks({
    peMax: 15,              // PE < 15
    yieldMin: 5,            // æ®–åˆ©ç‡ > 5%
    volumeMin: 1000000      // æˆäº¤é‡ > 100è¬
});
```

---

## âš¡ æ•ˆèƒ½æ¯”è¼ƒ

| æ“ä½œ | èˆŠç‰ˆ (JSON/CSV) | æ–°ç‰ˆ (SQLite) | æ”¹å–„ |
|------|-----------------|---------------|------|
| è¼‰å…¥é¦–é  | 17MB JSON parse | SQL query | **~90% faster** |
| è‚¡ç¥¨æœå°‹ | è¼‰å…¥å…¨éƒ¨ â†’ filter | SQL LIKE | **~10x faster** |
| é¸è‚¡ç¯©é¸ | è¼‰å…¥å…¨éƒ¨ â†’ filter | SQL WHERE | **~10x faster** |
| æ­·å²æŸ¥è©¢ | è®€å– CSV | Indexed query | **~5x faster** |
| é¦–æ¬¡ Client è¼‰å…¥ | N/A | ä¸‹è¼‰ DB â†’ IndexedDB | ä¸€æ¬¡æ€§ |
| å¾ŒçºŒ Client å­˜å– | æ¯æ¬¡ fetch | IndexedDB å¿«å– | **å³æ™‚** |

---

## ğŸ“ å‚™è¨»

1. **å‚™ä»½ç­–ç•¥**: CSV/JSON æª”æ¡ˆä¿ç•™ä½œç‚ºç·Šæ€¥å‚™ä»½
2. **é›¢ç·šæ”¯æ´**: Client ç«¯æœƒå¿«å–è‡³ IndexedDB
3. **æ›´æ–°è³‡æ–™**: æ›´æ–° CSV å¾ŒåŸ·è¡Œ `npm run build:db`
