---
applyTo: "**"
---

# TW-Stock Agent 調度指引 (Skill Orchestration Guide)

當使用者提出與台股量化系統相關的需求時，依照以下規則選擇適當的 Skill 模組。

## Skill 選擇矩陣

| 使用者意圖 (關鍵字) | 載入的 Skill | 備註 |
|---------------------|-------------|------|
| 大盤環境、寬度、TRIN、紅綠燈、系統性風險 | `market_breadth_analysis` | Phase 1 閘門 |
| 基本面、EPS、毛利率、營收、財報、法醫 | `fundamental_analysis` | Phase 3 觀察池 |
| 估值、河流圖、PE/PB/殖利率、低估/高估 | `valuation_river` | Phase 3 估值位階 |
| 產業輪動、板塊、強勢產業、資金流向 | `sector_rotation` | Phase 2 產業掃描 |
| 技術指標、均線、RSI、MACD、KD、籌碼 | `technical_analysis` | Phase 5 進場觸發 |
| 法人、外資、投信、自營商、融資融券、借券 | `institutional_forensic` | Phase 4 法人鑑識 |
| 當沖、隔日沖、日內交易、盤中、VWAP | `day_trading_momentum` | Phase 5 極短線 |
| 停損、部位、資金控管、ATR、Kelly | `risk_management` | Phase 6 出場防護 |
| 回測、績效、勝率、夏普、MDD、策略驗證 | `backtest_engine` | 歷史驗證 |
| 資料品質、缺值、異常、健康檢查、DB 修復 | `data_quality` | 基礎設施 |
| 警示、通知、SSE、推播、觸發 | `alert_notification` | 即時通知 |

## 組合載入規則

某些需求需要同時載入多個 Skill：

- **「選股」** → `fundamental_analysis` + `valuation_river` + `technical_analysis`
- **「買哪檔」** → `market_breadth_analysis` (環境) + `sector_rotation` (產業) + `technical_analysis` (觸發)
- **「買多少張」** → `risk_management`
- **「何時賣」** → `risk_management` + `technical_analysis`
- **「回測某策略」** → `backtest_engine` + 該策略對應的 Skill
- **「資料有問題」** → `data_quality`
- **「盤中通知」** → `alert_notification` + `day_trading_momentum`

## 策略生命週期 (Pipeline Order)

完整的量化決策遵循 6 個 Phase，詳見 `skills/README.md`。

```
Phase 1: market_breadth_analysis → 大盤環境 (紅/綠/黃/藍燈)
Phase 2: sector_rotation → 強勢產業篩選
Phase 3: fundamental_analysis + valuation_river → 觀察池
Phase 4: institutional_forensic → 法人行為解碼
Phase 5: technical_analysis / day_trading_momentum → 進場觸發
Phase 6: risk_management → 部位計算 + 停損
```

## 資料庫架構速查

所有模型共用 `stocks.db` (SQLite)，4 層 27 表，schema 定義於 `scripts/db/schema.sql`。

- **原始層 (14 表)**：`stocks`, `price_history`, `chips`, `margin_short`, `shareholder_distribution`, `government_chips`, `major_broker_chips`, `director_holdings`, `security_lending`, `dealer_details`, `valuation_history`, `fundamentals`, `monthly_revenue`, `dividends`
- **運算層 (5 表)**：`market_index`, `daily_indicators`, `chip_features`, `tech_features`, `valuation_features`
- **聚合層 (3 表)**：`market_breadth_history`, `institutional_trend`, `sector_daily`
- **快照層 (5 表)**：`latest_prices`, `institutional_snapshot`, `ai_reports`, `screener_scores`, `backtest_results`

## 重要慣例

- 前端查詢一律走 **快照/聚合層**，禁止在 API 中對原始層做全表 JOIN/GROUP BY。
- 所有 SQL 涉及除法必須用 `NULLIF` 防除零。
- ETL 操作必須冪等 (`INSERT OR REPLACE`)。
- DB 啟動時執行 `PRAGMA integrity_check`，失敗則 fallback 至 `public/data/stocks.db`。
- `fundamentals.year` 使用民國年曆 (ROC)，如 114 = 西元 2025。SQL 中比較年份需轉換：`year + 1911`。
- ~~`chips`、`institutional_trend`、`institutional_snapshot` 日期格式混合~~ ✅ 已修復：`build-sqlite-db.js` 重建時 `normalizeDate()` 統一為 `YYYY-MM-DD`；`generate-all-features.mjs` 在 ETL 啟動時亦會正規化殘留 compact 日期。
- ~~`latest_prices` 缺上櫃 OTC~~ ✅ 已修復：`fetch-yahoo.mjs` 支援 `.TWO` 後綴。
